var lastupdated 04/18/2025

var buffs |aa|ab|aeg|ags|art|as|aus|auspice|awaken|bc|benediction|bloodthorns|blur|botf|bg|bs|bue|care|centering|ch|clarity|cv|col|cotc|courage|da|dig|dc|db|dr|drum|echo|ease|ecry|eli|em|emc|enrichment|es|etc|etf|ey|fin|fotf|gf|gg|gi|ghoulflesh|gol|harm|hes|hol|ic|inst|iots|ivm|ks|lgv|lw|maf|mapp|mef|meg|mis|mo|mof|mon|mpp|name|nexus|non|nou|oath|obfuscation|pfe|pg|phk|php|pom|pop|psy|rage|refresh|rei|repr|rits|rm|rw|seer|shadowling|shadows|sk|sks|sol|solace|sos|sott|soul|sp|sr|stw|substratum|suf|sw|tk|tksh|tranquility|trc|turi|tw|vigor|voi|will|ws|worm|wotp|ys|
var ombuffs |auspice|benediction|bless|centering|dr|gg|halo|mapp|mpp|mf|pfe|pom|sl|sol|
var abuffs |etf|nexus|rm|
var cyctms |aban|ars|fr|gs|iz|pyre|rim|ros|sa|sls|usol|
var cycdbs |alb|dalu|dema|ee|hyh|shw|
var cyclics |ac|ad|af|bes|botf|cs|eye|fae|ghs|gj|hodi|how|mg|mom|regenerate|rev|roc|rog|sanctuary|sov|tr|
var allcyclics %cyclics-%cyctms-%cycdbs
var rituals |absolution|aeg|all|ag|bc|bloodthorns|cos|dc|echo|eli|ev|mf|mof|mon|iots|mf|mon|pom|pop|rtr|soul|vos|will|word|
var augmentation |ease|botf|drum|echo|ecry|fae|harm|mis|rage|soul|wotm|will|word|auspice|benediction|centering|gg|mapp|pom|rev|sap|sol|ad|ags|gol|mef|refresh|tranquility|vigor|art|aus|cv|iots|mt|sco|seer|shadows|ts|tv|bue|emc|ivm|ks|obfuscation|php|rei|rpu|clarity|crc|dig|hes|mo|rw|sr|tr|athleticism|bes|cs|cotc|em|hol|inst|oath|pls|stw|sott|sks|sk|wotp|ws|ava|blur|enrichment|fin|lgv|meg|phk|turi|aeg|mof|substratum|suf|sw|tw|ys|
var debilitation |burden|dispel|aewo|alb|dalu|dmrs|dema|coz|halo|hulp|hyh|it|malediction|mc|ps|sb|sick|spit|compel|lethargy|nb|calm|dazzle|mb|ms|rend|set|shw|sleep|sod|tf|tv|hp|pv|rof|vs|vod|halt|shatter|sf|cotw|df|de|griz|hb|swarm|flu|anc|al|ee|frostbite|ip|moa|tc|ti|trem|vertigo|wb|
var targetedmagic |stra|bonegrinder|sif|aban|bos|btn|pyre|ae|chs|fou|ff|hot|he|hh|paralysis|burn|do|pd|tks|tkt|acs|blb|sv|vivisection|fst|reb|smh|cac|devi|ec|stampede|crd|star|aethrolysis|ala|cl|fb|fs|fls|frs|gz|geyser|lb|pw|shockwave|sts|
var utility |gaf|imbue|sec|alb|aot|care|eye|hodi|nexus|resonance|sanctuary|all|bf|bless|ef|it|mre|mf|om|rejuv|rezz|rev|sol|uncurse|vigil|absolution|ad|awaken|bs|cos|cd|ev|fp|foc|gs|heal|hs|hw|hl|innocence|rp|regenerate|vh|bc|contingency|dc|dg|fm|locate|moonblade|mg|pg|rtr|rf|rend|rs|seer|shm|ss|shadowling|sm|sov|tf|teleport|th|unleash|bb|cfb|cfw|cf|devour|eotb|nr|qe|resection|roc|rof|rog|ag|as|bot|ba|crc|da|hoj|how|rue|tr|vos|af|bes|blend|compost|em|mon|sks|nou|rega|stc|ab|etf|foi|ignite|rm|zephyr|
var warding |lw|maf|fotf|gj|name|repr|ghs|halo|mpp|pfe|sl|sos|spit|ic|pop|tranquility|col|psy|shear|tksh|wd|ch|emc|ghoulflesh|solace|worm|aa|courage|how|sp|tk|bloodthorns|etc|ey|fwb|rits|eli|ir|mom|non|trc|ac|es|gi|gf|voi|
var targeted |stra|bonegrinder|sif|bos|btn|ae|chs|fou|ff|hot|he|hh|paralysis|burn|do|pd|tks|tkt|acs|blb|sv|vivisection|fst|reb|smh|cac|devi|ec|stampede|crd|star|aethrolysis|ala|cl|fb|fs|fls|frs|gz|geyser|lb|pw|shockwave|sts|
var staraura ava|blur|ir|rega|stc|trc

var heavytm bos|ms
var transnecro |ivm|ks|bue|worm|ch|php|
var aimweapons bow|xbow|sling
var researches fundamental|stream|augmentation|utility|warding|sorcery|energy|field|plane|planes|road|spell|symbiosis strengthen|symbiosis endure|symbiosis avoid|symbiosis spring|symbiosis remember|symbiosis resolve|symbiosis impress|symbiosis discern|symbiosis explore|symbiosis watch|symbiosis harvest|symbiosis heal|symbiosis learn|symbiosis examine|symbiosis perform|symbiosis cast|symbiosis harness|symbiosis activate

var combatpresetp1 p1-shiprats|p1-muskhogs|p1-goblins|p1-fellhogs|p1-badgers|p1-origami|p1-pothanits|p1-giantwasps|p1-trollkin|p1-cougarsgrendels|p1-grasseels|p1-woodtrolls|p1-animateditems|p1-beisswurms|p1-cavebears|p1-copperheads|p1-rocktrolls|p1-endrusserpents|p1-snowbeasts|p1-crocodiles|p1-direbears|p1-vipers|p1-leucros|p1-guardians|p1-giantbears|p1-onyxgargoyles|p1-emberbulls|p1-warklins|p1-scuttlers|p1-stormbulls|p1-lavadrakes
var combatpresetp2 p2-brocketdeeryoung|p2-marauders|p2-swamptrolls|p2-piruatiserpents|p2-brocketdeer|p2-brocketdeerelder|p2-gryphonsbaby|p2-gryphonsyoung|p2-seordmaors
var combatpresetp3 p3-snippets|p3-rocktrolls1|p3-snowbeasts|p3-rocktrolls2|p3-gargoyles|p3-eidolonsteeds|p3-crocodiles|p3-sylphs|p3-quartzgargoyles|p3-prereniyoung|p3-redleucros|p3-prereni|p3-windbags|p3-windbags2|p3-frostcrones|p3-prerenielder|p3-gryphons|p3-beltunumshi|p3-adanfblood|p3-cloudrats|p3-dragonpriests|p3-adanfspirit|p3-malchata|p3-stormbulls|p3-wyvernsyoung|p3-wyvernsjuve|p3-wyvernsadult|p3-icearchons|p3-adanfsorcs|p3-adanfblades
var combatpresetp4 p4-merkreshcelpeze1|p4-merkreshcelpeze2|p4-merkreshcelpeze3|p4-merkreshcelpeze4|p4-armadillosjuve|p4-armadillosadult|p4-armadilloselder
var combatpresetp5 p5-maidenstress|p5-matronstress|p5-dryads|p5-nyads1|p5-blightogres1|p5-nyads2|p5-blightogres2|p5-iceadders|p5-dpcrones|p5-mountaingiants|p5-marblegargoyles|p5-shalswars|p5-stompers|p5-maulers|p5-headsplitters|p5-blackapes|p5-fuliginmoths|p5-voidmoths|p5-shadowmoths
var combatpresetlist none|%combatpresetp1|%combatpresetp2|%combatpresetp3|%combatpresetp4|%combatpresetp5


var townpresetlist muspari|theren|rossman|riverhaven|dirge|kaerna|crossing|leth|ilaya|fangcove|shard|fangcove|hibarnhvidar|boarclan|ratha|merkresh
#|aesry|merkresh|jeihrem
var townvaultpresetlist muspari|theren|riverhaven|dirge|crossing|leth|shard|fangcove|hibarnhvidar|boarclan|ratha|aesry|merkresh|jeihrem
var townportalpresetlist muspari|therenborough|langenfirth|riverhaven|crossing|leth|shard|hibarnhvidar|ainghazal|ratha|mriss|aesry
var ammopresetlist crossing|shard|ratha
var lockpickpresetlist crossing|shard|riverhaven

var burgletownlist none|muspari|theren|rossman|riverhaven|dirge|crossing|leth|ilaya|shard|hibarnhvidar|boarclan|ratha|merkresh|mriss
var pawntownlist none|crossing|riverhaven|shard|hibarnhvidar
var performtownlist none|muspari|theren|rossman|riverhaven|dirge|crossing|leth|ilaya|fangcove|shard|hibarnhvidar|boarclan|ratha|merkresh|mriss
var forgingtownlist none|crossing|shard|merkresh|hibarnhvidar

var Ordinal none|first|second|third|fourth|fifth|sixth|seventh|eighth|ninth|tenth|eleventh|twelfth|thirteenth|fourteenth
var waitstring  ^\.\.\.wait|^Sorry\, you may only type ahead|^You are still stunned|^You can\'t do that while|^You don\'t seem to be able|Between the ringing in your head|Strangely, you don't feel like fighting right now\.|Your desire to prepare this offensive spell suddenly slips away\.|You're unconscious!|There is no need for violence here\.|Sorry, system is slow\.  No type ahead allowed\.

#action (combo) var elapsed $gametime; math elapsed subtract %gametimestart; put #echo Yellow Elapsed: %elapsed; 10put #var %manenamelast $unixtime; put #var save; put #echo Yellow Maneuver %manename complete! when ^You take a step back and (heft|ready) your \w+ behind you\.|^Taking a full step back, you plant your feet and .*\.|^You lower your shoulders and .*\.|^You take a step back and ready an upraised palm\.|^You angle to the side and .*\.|^You crouch down and draw your weapons close\.|^You step to the side and adjust your stance\.|^You take a step back and .*\.|^You square up your feet and arch your back while searching for an engaged enemy to target\.|You raise .* before you and prepare to strike\.|^You brace your shoulder against the .* to increase the power of the next shot\.
action (combo) put #var %manenamelast $unixtime; put #var save; put #echo Yellow Maneuver %manename complete! when ^You take a step back and (heft|ready) your \w+ behind you\.|^Taking a full step back, you plant your feet and .*\.|^You lower your shoulders and .*\.|^You take a step back and ready an upraised palm\.|^You angle to the side and .*\.|^You crouch down and draw your weapons close\.|^You step to the side and adjust your stance\.|^You take a step back and .*\.|^You square up your feet and arch your back while searching for an engaged enemy to target\.|You raise .* before you and prepare to strike\.|^You brace your shoulder against the .* to increase the power of the next shot\.
action (combo) var barbmane $unixtime; math barbmane subtract 30; put #var %manenamelast %barbmane; put #var save;put #echo Yellow Barbarian Maneuver %manename cooldown reduction! when With expert skill you end the attack and maneuver into a better position\.
action (combo) var failtest $unixtime; math failtest subtract 80; put #var %manenamelast %failtest; send #echo Yellow ACM is still on cooldown! when You must rest a bit longer before attempting that maneuver again\.
action (combo) off

goto LIBEND


TITLE:
  put #echo
	put #echo mono ------------------------------------------------
	put #echo mono -------------- TRAIN SCRIPT SUITE --------------
	put #echo mono ------------------------------------------------
	put #echo mono Last Updated: %lastupdated
	put #echo
  return

SETDEFAULTS:
  #MULTI_AND_VARFIX
  if !def(varset) then
  {
    put #var varset 1
  }
  if !matchre("$varset", "\b(1|2|3|4)\b") then put #var varset 1
  #MULTITRAIN
  if !matchre("$multiarea", "\b(YES|NO)\b") then put #var multiarea NO
  if !matchre("$multiareapriority", "\b(1|2)\b") then put #var multiareapriority 2
  if (($multimindstep > 0) && ($multimindstep < 35)) then
  else put #var multimindstep 10
  if !def(mode1list) then put #var mode1list thb|bow|sling|sb|lb
  if $mode1step > 0 then
  else put #var mode1step 10 
  if !matchre("$mode1priority", "\b(YES|NO)\b") then put #var mode1priority NO
  if !def(mode2list) then put #var mode2list se|stave|brawl|xbow|lt|pole|ht|le|the
  if $mode2step > 0 then
  else put #var mode2step 10 
  if !matchre("$mode2priority", "\b(YES|NO)\b") then put #var mode2priority NO
  
  if (($mode1priority = "YES") && ($mode2priority = "YES")) then
  {
    put #var mode1priority NO
    put #var mode2priority NO
  }
  
  #GUILD
  if !def(guild) then
  {
    action (info) put #var guild $m1 when Guild:\s+(Barbarian|Bard|Cleric|Commoner|Empath|Moon Mage|Necromancer|Paladin|Ranger|Thief|Trader|Warrior Mage)$
    gosub INFOCHECK
    pause 2
  }
  if !matchre("$guild", "\b(Barbarian|Bard|Cleric|Commoner|Empath|Moon Mage|Necromancer|Paladin|Ranger|Thief|Trader|Warrior Mage)\b") then
  {
    action (info) put #var guild $1 when Guild:\s+(Barbarian|Bard|Cleric|Commoner|Empath|Moon Mage|Necromancer|Paladin|Ranger|Thief|Trader|Warrior Mage)$
    gosub INFOCHECK
    pause 2
  }
  var checkmode 1
  gosub VARCHECKS
  var checkmode 2
  gosub VARCHECKS
  gosub VARCHECKOTHER
  put #var save 
  return
  

VARCHECKS:
  #GENERAL 
  #DEATH_DISCO
  if !matchre("$deathaction", "\b(logout|alert)\b") then put #var deathaction logout
  if !matchre("$disconnectaction", "\b(reconnect|quit)\b") then put #var disconnectaction reconnect
  if !matchre("$arrestaction", "\b(logout|quit)\b") then put #var arrestaction logout
  
  #ALERTS
  if !matchre("$alertwindow", "\b(Main|Log|Conversation)\b") then put #var alertwindow Log
  if !matchre("$healthalerts", "\b(YES|NO)\b") then put #var healthalerts YES
  if !matchre("$healthalertnum", "\b(1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24|25|26|27|28|29|30|31|32|33|34|35|36|37|38|39|40|41|42|43|44|45|46|47|48|49|50|51|52|53|54|55|56|57|58|59|60|61|62|63|64|65|66|67|68|69|70|71|72|73|74|75|76|77|78|79|80|81|82|83|84|85|86|87|88|89|90|91|92|93|94|95|96|97|98|99)\b") then put #var healthalertnum 85
  if !matchre("$nervealerts", "\b(YES|NO)\b") then put #var nervealerts YES
  if !matchre("$backfirealerts", "\b(YES|NO)\b") then put #var backfirealerts YES
  if !matchre("$sorceryalerts", "\b(YES|NO)\b") then put #var sorceryalerts YES
  if !matchre("$speechalerts", "\b(YES|NO)\b") then put #var speechalerts YES
  if !matchre("$arrivalalerts", "\b(YES|NO)\b") then put #var arrivalalerts NO
  if !matchre("$emotealerts", "\b(YES|NO)\b") then put #var emotealerts YES
  if !matchre("$gmalerts", "\b(YES|NO)\b") then put #var gmalerts YES
  if !matchre("$pvpalerts", "\b(YES|NO)\b") then put #var pvpalerts YES
  if !matchre("$pvpstealthalerts", "\b(YES|NO)\b") then put #var pvpstealthalerts NO
  if !matchre("$inventoryalerts", "\b(YES|NO)\b") then put #var inventoryalerts YES
  if !matchre("$paranoiaalerts", "\b(YES|NO)\b") then put #var paranoiaalerts NO
  if !matchre("$tendarea", "\b(YES|NO)\b") then put #var tendarea NO
  if !matchre("$tendobject", "\b(YES|NO)\b") then put #var tendobject NO
  if !matchre("$bugout", "\b(YES|NO)\b") then put #var bugout NO
  if $bugoutnum > 0 then
  else put #var bugoutnum 1
  if !matchre("$bugoutonbleed", "\b(YES|NO)\b") then put #var bugoutonbleed NO
  if !matchre("$bugoutonsend", "\b(YES|NO)\b") then put #var bugoutonsend YES
  if (!def(whitelist)) then put #var whitelist Saragos|Navesi
  
  if (!def(blacklist)) then put #var blacklist Zehira|Agalea
  
  if !matchre("$textbook", "\b(YES|NO)\b") then put #var textbook NO
  if $textbooktimer >= 0 then
  else put #var textbooktimer 60
  if !def(textbookitem) then put #var textbookitem tome
  if !def(textbooklist) then put #var textbooklist human|elf|elothean 
  if !matchre("$tomeoflore", "\b(YES|NO)\b") then put #var tomeoflore NO
  if !def(tomeofloreitem) then put #var tomeofloreitem spiritwood tome
  
  if !matchre("$almanac", "\b(YES|NO)\b") then put #var almanac NO
  if !def(almanacitem) then put #var almanacitem almanac
  if !matchre("$almanacalerts", "\b(YES|NO)\b") then put #var almanacalerts NO
  if !matchre("$ejournal", "\b(YES|NO)\b") then put #var ejournal NO
  if !def(ejournalitem) then put #var ejournalitem journal
  if $ejournalstates > 0 then
  else put #var ejournalstates 600
  if !def(nextejournal) then put #var nextejournal 0
  if !matchre("$tarantula", "\b(YES|NO)\b") then put #var tarantula NO  
  if !def(tarantulaitem) then put #var tarantulaitem tarantula
  if !def(tarantulaskill1) then put #var tarantulaskill1 evasion
  if !def(tarantulaskill2) then put #var tarantulaskill2 shield
  if !matchre("$locksmithbox", "\b(YES|NO)\b") then put #var locksmithbox NO
  if $locksmithboxtimer >= 0 then
  else put #var locksmithboxtimer 120
  if !def(locksmithboxitem) then put #var locksmithboxitem training box
  if !matchre("$skinfatrainer", "\b(YES|NO)\b") then put #var skinfatrainer NO
  if $skinfatrainertimer >= 0 then
  else put #var skinfatrainertimer 120
  if !def(skinfatraineritem) then put #var skinfatraineritem blue-belly crocodile
  if !matchre("$windboard", "\b(YES|NO)\b") then put #var windboard NO
  if $windboardtimer >= 0 then
  else put #var windboardtimer 120
  if !def(windboardtrick) then put #var windboardtrick tilt
  if ($windboardcharge >= 0) then
  else put #var windboardcharge 50
  
  

  #MULTI
  if !matchre("$huntingaream2", "%combatpresetlist") then put #var huntingaream2 none
  if !matchre("$upkeeptownm2", "\b(%townpresetlist)\b") then put #var upkeeptownm2 crossing
  if !matchre("$burgletownm2", "\b(%townpresetlist)\b") then put #var burgletownm2 crossing
  if !matchre("$pawntownm2", "\b(%townpresetlist)\b") then put #var pawntownm2 crossing
  if !matchre("$performtownm2", "\b(%townpresetlist)\b") then put #var performtownm2 crossing
  if !matchre("$forgingtownm2", "\b(%townpresetlist)\b") then put #var forgingtownm2 crossing
  
  #MOVEMENT
  if !matchre("$movevanish", "\b(YES|NO)\b") then put #var movevanish NO

  if !matchre("$killbeforemove", "\b(YES|NO)\b") then put #var killbeforemove YES
  if !matchre("$sleepontravel", "\b(YES|NO)\b") then put #var sleepontravel YES
  if $movetimeout > 0 then
  else put #var movetimeout 300
  if !matchre("$huntingpremium", "\b(YES|NO|ONLY)\b") then put #var huntingpremium NO
  if !matchre("$prefergroup", "\b(YES|NO)\b") then put #var prefergroup NO
  if !matchre("$premiumring", "\b(YES|NO)\b") then put #var premiumring NO
  if !def(premiumringitem) then put #var premiumringitem band
  
  if !matchre("$huntingarea", "%combatpresetlist") then put #var huntingarea none
  if !matchre("$upkeeptown", "\b(%townpresetlist)\b") then put #var upkeeptown crossing
  if !matchre("$burgletown", "\b(%townpresetlist)\b") then put #var burgletown crossing
  if !matchre("$pawntown", "\b(%townpresetlist)\b") then put #var pawntown crossing
  if !matchre("$performtown", "\b(%townpresetlist)\b") then put #var performtown crossing
  if !matchre("$forgingtown", "\b(%townpresetlist)\b") then put #var forgingtown crossing
  
  if !matchre("$vaulttown", "\b(%townvaultpresetlist)\b") then put #var vaulttown crossing
  if !matchre("$ammobuytown", "\b(%ammopresetlist)\b") then put #var ammobuytown crossing
  if !matchre("$lockpickbuytown", "\b(%lockpickpresetlist)\b") then put #var lockpickbuytown crossing
  
  #UPKEEP
  if !matchre("$autoupkeep", "\b(YES|NO)\b") then put #var autoupkeep YES
  if !matchre("$auonhealth", "\b(YES|NO)\b") then put #var auonhealth YES
  if $auhealthnum >= 0 then
  else put #var auhealthnum 70
  if !matchre("$auonbleed", "\b(YES|NO)\b") then put #var auonbleed YES
  if !matchre("$auonpoison", "\b(YES|NO)\b") then put #var auonpoison YES
  if !matchre("$auonfire", "\b(YES|NO)\b") then put #var auonfire YES
  if !matchre("$auonnerves", "\b(YES|NO)\b") then put #var auonnerves YES
  if !matchre("$auonburden", "\b(YES|NO)\b") then put #var auonburden YES
  if $auburdennum >= 0 then
  else put #var auburdennum 3
  if !matchre("$auonammo", "\b(YES|NO)\b") then put #var auonammo NO
  if !matchre("$auonboxes", "\b(YES|NO)\b") then put #var auonboxes NO
  if $minmoney >= 0 then
  else put #var minmoney 2
  if !matchre("$exchange", "\b(YES|NO)\b") then put #var exchange YES
  if !matchre("$autopath", "\b(YES|NO|PREMIUM)\b") then put #var autopath YES
  if !matchre("$repair", "\b(YES|NO)\b") then put #var repair YES
  if !matchre("$bundlesell", "\b(YES|NO)\b") then put #var bundlesell YES
  if !matchre("$bundlevault", "\b(YES|NO)\b") then put #var bundlevault NO
  if (($bundlevault = "YES") && ($bundlesell = "YES")) then put #var bundlesell NO
  if !matchre("$vaultmove", "\b(YES|NO)\b") then put #var vaultmove NO
  if $bundlerope >= 0 then
  else put #var bundlerope 3
  if !matchre("$gemsell", "\b(YES|NO)\b") then put #var gemsell NO
  if !matchre("$gemvault", "\b(YES|NO)\b") then put #var gemvault YES
  if $gempouches >= 0 then
  else put #var gempouches 5
  if !matchre("$nuggetsell", "\b(YES|NO)\b") then put #var nuggetsell YES
  if !matchre("$barsell", "\b(YES|NO)\b") then put #var barsell YES
  if !matchre("$ammobuy", "\b(YES|NO)\b") then put #var ammobuy NO
  if !def(ammobuylist) then put #var ammobuylist bow|xbow|sling
  if !def(ammocontainer) then put #var ammocontainer backpack
  if $ammomin >= 0 then
  else put #var ammomin 100
  if !matchre("$lockpickbuy", "\b(YES|NO)\b") then put #var lockpickbuy NO
  if !def(lockpickstacker) then put #var lockpickstacker lockpick ring
  if !def(lockpickitem) then put #var lockpickitem stout lockpick
  if !matchre("$boxpopping", "\b(YES|NO)\b") then put #var boxpopping NO
  if !matchre("$skeletonkey", "\b(YES|NO)\b") then put #var skeletonkey NO
  if !def(bucketitem) then put #var bucketitem none
  if !matchre("$dismantletype", "\b(none|bash|bunny|caravan|chomp|claw|crush|fire|focus|jump|pray|press|roar|salvage|shriek|slam|slip|stomp|thump|tinker|whistle)\b") then put #var dismantletype none
  if !matchre("$boxpopbuff", "\b(none|drum|hol|mt)\b") then put #var boxpopbuff none
  if $boxpopbuffprepmana >= 0 then
  else put #var boxpopbuffprepmana 1
  if $boxpopbuffaddmana >= 0 then
  else put #var boxpopbuffaddmana 0
  if !matchre("$appfocus", "\b(YES|NO)\b") then put #var appfocus NO
  if !def(appfocusitem) then put #var appfocusitem shark
  if !matchre("$spiderfeed", "\b(YES|NO)\b") then put #var spiderfeed NO
  if $incense >= 0 then
  else put #var incense 0

  #LOOT
  if !def(storage) then put #var storage backpack
  if !matchre("$boxstorage", "\b(YES|NO)\b") then put #var boxstorage portal
  if !matchre("$lootalerts", "\b(YES|NO)\b") then put #var lootalerts YES
  if !matchre("$lootalldead", "\b(YES|NO)\b") then put #var lootalldead NO
  if !matchre("$collectcoin", "\b(YES|NO)\b") then put #var collectcoin YES
  if !matchre("$collectscroll", "\b(YES|NO)\b") then put #var collectscroll YES
  if !matchre("$collectmaps", "\b(YES|NO)\b") then put #var collectmaps YES
  if !matchre("$collectnuggets", "\b(YES|NO)\b") then put #var collectnuggets YES
  if !matchre("$collectbars", "\b(YES|NO)\b") then put #var collectbars YES
  if !matchre("$collectmaterials", "\b(YES|NO)\b") then put #var collectmaterials YES
  if !matchre("$collectgem", "\b(YES|NO)\b") then put #var collectgem YES
  if !matchre("$savegwethstones", "\b(YES|NO)\b") then put #var savegwethstones NO
  if !matchre("$collectboxes", "\b(YES|NO)\b") then put #var collectboxes YES
  if !def(misckeeplist) then put #var misckeeplist none
  if !matchre("$skinafterlock", "\b(YES|NO)\b") then put #var skinafterlock YES
  if !matchre("$dropskins", "\b(YES|NO)\b") then put #var dropskins NO

  if !matchre("$loottype", "\b(treasure|boxes|equipment|goods|all)\b") then put #var loottype treasure
  if !matchre("$skinning", "\b(YES|NO|AUTO)\b") then put #var skinning YES
  if !matchre("$arrange", "\b(0|1|2|3|4|5)\b") then put #var arrange 0
  if !matchre("$arrangeforpart", "\b(YES|NO)\b") then put #var arrangeforpart NO
  if !matchre("$dissect", "\b(YES|NO)\b") then put #var dissect YES

  if !matchre("$loottypem2", "\b(treasure|boxes|equipment|goods|all)\b") then put #var loottypem2 treasure
  if !matchre("$skinningm2", "\b(YES|NO|AUTO)\b") then put #var skinningm2 YES
  if !matchre("$arrangem2", "\b(0|1|2|3|4|5)\b") then put #var arrangem2 0
  if !matchre("$arrangeforpartm2", "\b(YES|NO)\b") then put #var arrangeforpartm2 NO
  if !matchre("$dissectm2", "\b(YES|NO)\b") then put #var dissectm2 YES


  #COMBAT
  if !matchre("$weapons", "\b(YES|NO)\b") then put #var weapons YES
  if !matchre("$weaponsm2", "\b(YES|NO)\b") then put #var weaponsm2 YES
  if (!def(weaponlist)) then put #var weaponlist se|le|the|sb|lb|thb|stave|pole|brawl|lt|ht|bow|xbow|sling
  if (def(weaponlist)) then
  {
    gosub WEAPONLISTCHECK $weaponlist
    if (%weaponlistcheckresult = 0) then put #var weaponlist se|le|the|sb|lb|thb|stave|pole|brawl|lt|ht|bow|xbow|sling
  }
  if (!def(weaponlistm2)) then put #var weaponlistm2 se|le|the|sb|lb|thb|stave|pole|brawl|lt|ht|bow|xbow|sling
  if (def(weaponlistm2)) then
  {
    gosub WEAPONLISTCHECK $weaponlistm2
    if (%weaponlistcheckresult = 0) then put #var weaponlistm2 se|le|the|sb|lb|thb|stave|pole|brawl|lt|ht|bow|xbow|sling
  }

  
  if (!def(stancemain)) then put #var stancemain custom
  if !matchre("$lowestfirst", "\b(YES|NO)\b") then put #var lowestfirst YES
  if !matchre("$killafterlock", "\b(YES|NO)\b") then put #var killafterlock YES  
  if !matchre("$offhand", "\b(YES|NO)\b") then put #var offhand YES
  if !matchre("$acms", "\b(YES|NO)\b") then put #var acms YES
  if !def(seweapon) then put #var seweapon scimitar
  if !matchre("$seoffhand", "\b(YES|NO)\b") then put #var seoffhand YES
  if !matchre("$secombo", "\b(slice|puncture)\b") then put #var secombo slice
  if !def(leweapon) then put #var leweapon broadsword
  if !matchre("$leoffhand", "\b(YES|NO)\b") then put #var leoffhand NO
  if !def(theweapon) then put #var theweapon claymore
  if !def(sbweapon) then put #var sbweapon mace
  if !matchre("$sboffhand", "\b(YES|NO)\b") then put #var sboffhand YES
  if !def(lbweapon) then put #var lbweapon hammer
  if !matchre("$lboffhand", "\b(YES|NO)\b") then put #var lboffhand NO
  if !def(thbweapon) then put #var thbweapon maul
  if !def(staveweapon) then put #var staveweapon nightstick
  if !matchre("$staveoffhand", "\b(YES|NO)\b") then put #var staveoffhand NO
  if !matchre("$staveworn", "\b(YES|NO)\b") then put #var staveworn NO
  if !matchre("$stavetied", "\b(YES|NO)\b") then put #var stavetied NO
  if !def(poleweapon) then put #var poleweapon spear
  if !matchre("$poleworn", "\b(YES|NO)\b") then put #var poleworn NO
  if !matchre("$poletied", "\b(YES|NO)\b") then put #var poletied NO
  if !matchre("$polecombo", "\b(slice|puncture)\b") then put #var polecombo puncture
  if !def(bastardsworditem) then put #var bastardsworditem bastard sword
  if !def(barmaceitem) then put #var barmaceitem bar mace
  if !def(holyiconitem) then put #var holyiconitem icon
  if !def(risteitem) then put #var risteitem darkstone riste
  if !def(hhristeitem) then put #var hhristeitem half-handled riste
  if !def(ltweapon) then put #var ltweapon bola
  if !matchre("$ltoffhand", "\b(YES|NO)\b") then put #var ltoffhand NO
  if !matchre("$ltbond", "\b(YES|NO)\b") then put #var ltbond NO
  if !matchre("$ltverb", "\b(lob|throw|hurl)\b") then put #var ltverb lob
  if !def(htweapon) then put #var htweapon spear
  if !matchre("$htoffhand", "\b(YES|NO)\b") then put #var htoffhand NO
  if !matchre("$htbond", "\b(YES|NO|SPECIAL)\b") then put #var htbond NO
  if !matchre("$htverb", "\b(lob|throw|hurl)\b") then put #var htverb lob
  if !def(xbowweapon) then put #var xbowweapon crossbow
  if !def(xbowammo) then put #var xbowammo crossbow bolt
  if !matchre("$xbowworn", "\b(YES|NO)\b") then put #var xbowworn NO
  if !def(bowweapon) then put #var bowweapon bow
  if !def(bowammo) then put #var bowammo boar-tusk arrow
  if !matchre("$bowworn", "\b(YES|NO)\b") then put #var bowworn NO
  if !def(slingweapon) then put #var slingweapon sling
  if !def(slingammo) then put #var slingammo small rock
  if !matchre("$collectammo", "\b(YES|NO)\b") then put #var collectammo YES
  if !matchre("$armorcheck", "\b(YES|NO)\b") then put #var armorcheck NO
  if !def(shielditem) then put #var shielditem round sipar
  if !def(parrystickitem) then put #var parrystickitem parry stick
  if !matchre("$armornum", "\b(1|2|3|4|5|6)\b") then put #var armornum 4
  if !def(armor1item) then put #var armor1item quilted hauberk
  if !def(armor2item) then put #var armor2item scale gloves
  if !def(armor3item) then put #var armor3item ring helm
  if !def(armor4item) then put #var armor4item plate mask
  if !def(armor5item) then put #var armor5item none
  if !def(armor6item) then put #var armor6item none
  if !def(knucklesitem) then put #var knucklesitem knuckles
  if !matchre("$attune", "\b(YES|NO)\b") then put #var attune YES
  if !matchre("$recall", "\b(YES|NO)\b") then put #var recall YES
  if !matchre("$hunting", "\b(YES|NO)\b") then put #var hunting YES
  if $huntingtimer >=75 then
  else put #var huntingtimer 75
  if !matchre("$stealth", "\b(YES|NO)\b") then put #var stealth NO
  if !matchre("$stealthm2", "\b(YES|NO)\b") then put #var stealthm2 NO
  if !matchre("$tactics", "\b(YES|NO)\b") then put #var tactics YES
  if !matchre("$tacticsm2", "\b(YES|NO)\b") then put #var tacticsm2 YES
  if !matchre("$collectm2", "\b(YES|NO)\b") then put #var collectm2 YES
  if !matchre("$retreatdelay", "\b(YES|NO)\b") then put #var retreatdelay NO
  if !matchre("$appraise", "\b(YES|NO)\b") then put #var appraise YES
  if !matchre("$appraisetarget", "\b(bundle|creature)\b") then put #var appraisetarget creature
  if $appraisetimer >= 75 then
  else put #var appraisetimer 75
  if !matchre("$appsaveitem", "\b(none|tight|lumpy)\b") then put #var appsaveitem none
  if !def(appsaveitemstorage) then put #var appsaveitemstorage haversack
  if !matchre("$collect", "\b(YES|NO)\b") then put #var collect YES
  if $collecttimer >= 0 then
  else put #var collecttimer 120
  if !matchre("$collectitem", "\b(rock|bunny)\b") then put #var collectitem rock
  if !matchre("$teaching", "\b(YES|NO)\b") then put #var teaching NO
  if !def(teachskill) then put #var teachskill skinning
  if !def(teachtargets) then put #var teachtargets Saragos|Navesi
  
  if !matchre("$combatsanowret", "\b(YES|NO)\b") then put #var combatsanowret NO
  if !def(sanowretitem) then put #var sanowretitem crystal
  
  #NONCOMBAT
  if !matchre("$noncombat", "\b(YES|NO)\b") then put #var noncombat NO
  if !matchre("$burgle", "\b(YES|NO)\b") then put #var burgle NO
  if !matchre("$perform", "\b(YES|NO)\b") then put #var perform NO
  if !matchre("$crafting", "\b(YES|NO)\b") then put #var crafting NO
  if !matchre("$forging", "\b(YES|NO)\b") then put #var forging NO
  if !matchre("$outfitting", "\b(YES|NO)\b") then put #var outfitting NO
  if !matchre("$noncombatm2", "\b(YES|NO)\b") then put #var noncombatm2 NO
  if !matchre("$burglem2", "\b(YES|NO)\b") then put #var burglem2 NO
  if !matchre("$performm2", "\b(YES|NO)\b") then put #var performm2 NO
  if !matchre("$craftingm2", "\b(YES|NO)\b") then put #var craftingm2 NO
  if !matchre("$forgingm2", "\b(YES|NO)\b") then put #var forgingm2 NO
  if !matchre("$outfittingm2", "\b(YES|NO)\b") then put #var outfittingm2 NO

  
  if !def(burglestorage) then put #var burglestorage haversack
  if !matchre("$burgletool", "\b(pick|rope|both)\b") then put #var burgletool both
  if !def(burglepickitem) then put #var burglepickitem lockpick
  if !matchre("$burglepickworn", "\b(YES|NO)\b") then put #var burglepickworn NO
  if !def(burgleropeitem) then put #var burgleropeitem heavy rope
  if !matchre("$burglemaxgrabs", "\b(0|1|2|3|4|5|6)\b") then put #var burglemaxgrabs 6
  if !matchre("$burgleloot", "\b(YES|NO)\b") then put #var burgleloot NO
  if $burglekeeplist = "%burglekeeplist" then put #var burglekeeplist none
  if !def(burglekeeplist) then put #var burglekeeplist none
  if !matchre("$burglepawn", "\b(YES|NO)\b") then put #var burglepawn NO
  
  if !matchre("$performcyclic", "\b(YES|NO)\b") then put #var performcyclic NO
  if ((!def(instrument)) && (def(m1instrument))) then put #var instrument $m1instrument
  if !def(instrument) then put #var instrument zills
  if !matchre("$instrumentworn", "\b(YES|NO)\b") then put #var instrumentworn NO
  if (($instrumenthands >= 1) && ($instrumenthands < 3)) then
  else put #var instrumenthands 2
  if !matchre("$instruments", "\b(YES|NO)\b") then put #var instrumentassess YES
  if !matchre("$instclean", "\b(YES|NO)\b") then put #var instclean YES
  if !def(instcleancloth) then put #var instcleancloth cloth
  if ((!def(songtype)) && (def(m1songtype))) then put #var songtype $m1songtype
  if !def(songtype) then put #var songtype scales
  if !matchre("$climbingrope", "\b(YES|NO)\b") then put #var climbingrope NO
  if !def(climbingropename) then put #var climbingropename rope
  if !matchre("$climbingropehum", "\b(YES|NO)\b") then put #var climbingropehum YES
  if !def(humsong) then put #var humsong scales
  if !matchre("$studyart", "\b(YES|NO)\b") then put #var studyart NO
  if !matchre("$noncomsanowret", "\b(YES|NO)\b") then put #var noncomsanowret NO
  
  if !def(craftingstorage) then put #var craftingstorage crafting satchel
  if !matchre("$craftingstoragelocation", "\b(none|portal|vault)\b") then put #var craftingstoragelocation none
  if !matchre("$forgingdifficulty", "\b(easy|challenging|hard)\b") then put #var forgingdifficulty challenging
  if !matchre("$forgingdiscipline", "\b(weaponsmithing|armorsmithing|blacksmithing)\b") then put #var forgingdiscipline weaponsmithing
  if !def(forgingmaterial) then put #var forgingmaterial bronze
  if !matchre("$forgingrepair", "\b(YES|NO)\b") then put #var forgingrepair YES
  if !matchre("$forgingprivateroom", "\b(YES|NO)\b") then put #var forgingprivateroom NO
  if $forgingmaxvolumes >= 0 then
  else put #var forgingmaxvolumes 200
  if $forgingmaxquantity >= 0 then
  else put #var forgingmaxquantity 4
  if !matchre("$forgingsmelting", "\b(YES|NO)\b") then put #var forgingsmelting YES
  if !matchre("$outfittingdifficulty", "\b(easy|challenging|hard)\b") then put #var outfittingdifficulty challenging
  if !def(outfittingcloth) then put #var outfittingcloth burlap
  if !def(outfittingleather) then put #var outfittingleather cougar-pelt
  if !matchre("$outfittingrepair", "\b(YES|NO)\b") then put #var outfittingrepair YES
  if $outfittingmaxyards >= 0 then
  else put #var outfittingmaxyards 100
  if $outfittingmaxquantity >= 0 then
  else put #var outfittingmaxquantity 4
  if !def(awl) then put #var awl awl
  if !def(bellows) then put #var bellows leather bellows
  if !def(hammer) then put #var hammer diagonal-peen hammer
  if !def(knittingneedles) then put #var knittingneedles knitting needles
  if !def(pliers) then put #var pliers pliers
  if !def(scissors) then put #var scissors scissors
  if !def(sewingneedles) then put #var sewingneedles sewing needles
  if !def(shovel) then put #var shovel curved shovel
  if !def(slickstone) then put #var slickstone slickstone
  if !def(rod) then put #var rod stirring rod
  if !def(tongs) then put #var tongs tongs
  if !def(yardstick) then put #var yardstick yardstick

  
  #MAGIC
  if $minconcentration >= 0 then
  else put #var minconcentration 80
  if $minmana >= 10 then
  else put #var minmana 30
  if !matchre("$straightcast", "\b(YES|NO)\b") then put #var straightcast NO
  if $difficulty1percent >= 0 then
  else put #var difficulty1percent 100
  if $difficulty2percent >= 0 then
  else put #var difficulty2percent 100
  if $difficulty3percent >= 0 then
  else put #var difficulty3percent 100
  if $difficulty4percent >= 0 then
  else put #var difficulty4percent 100
  if $difficulty5percent >= 0 then
  else put #var difficulty5percent 100
  
  if !matchre("$harnessing", "\b(YES|NO)\b") then put #var harnessing YES
  if $harnessmax >= 5 then
  else put #var harnessmax 20
  if !matchre("$cambrinth", "\b(YES|NO)\b") then put #var cambrinth NO
  if !matchre("$dedicatedcambrinth", "\b(YES|NO)\b") then put #var dedicatedcambrinth NO
  if (($cambitems >= 0) && ($cambitems < 3)) then
  else put #var cambitems 1
  if !def(cambitem1) then put #var cambitem1 armband
  if $cambitem1mana >= 1 then
  else put #var cambitem1mana 1
  if !matchre("$cambitem1worn", "\b(YES|NO)\b") then put #var cambitem1worn YES
  if !def(cambitem2) then put #var cambitem2 armband
  if $cambitem2mana >= 1 then
  else put #var cambitem2mana 1
  if !matchre("$cambitem2worn", "\b(YES|NO)\b") then put #var cambitem2worn YES
  if !def(ritualfocus) then put #var ritualfocus rod
  if !matchre("$ritualfocusworn", "\b(YES|NO)\b") then put #var ritualfocusworn NO
  if !matchre("$ritualfocusstorage", "\b(YES|NO)\b") then put #var ritualfocusstorage NO
  if !def(ritualfocuscontainer) then put #var ritualfocuscontainer backpack
  if !matchre("$tmfocus", "\b(YES|NO)\b") then put #var tmfocus NO
  if !def(tmfocusitem) then put #var tmfocusitem wand
  if !matchre("$tmfocusstorage", "\b(YES|NO)\b") then put #var tmfocusstorage NO
  if !matchre("$tmfocusworn", "\b(YES|NO)\b") then put #var tmfocusworn NO
  if !matchre("$tattoo", "\b(YES|NO)\b") then put #var tattoo NO
  if !matchre("$tattootype", "\b(runic|heroic)\b") then
  {
    echo changing tattoo type
    put #var tattootype runic
  }
  if !def(tattoospell) then put #var tattoospell none
  if $tattooprepmana >= 1 then
  else put #var tattooprepmana 5

#SPELL
  if !matchre("$spell", "\b(YES|NO)\b") then put #var spell YES
  if !matchre("$spellm2", "\b(YES|NO)\b") then put #var spellm2 YES
  if !matchre("$spellnum", "\b(1|2|3|4)\b") then put #var spellnum 3
  if !matchre("$spellnumm2", "\b(1|2|3|4)\b") then put #var spellnumm2 3
  if !def(spell1) then put #var spell1 ys
  if $spell1mana >= 0 then
  else put #var spell1mana 0
  if !matchre("$spell1symb", "\b(YES|NO)\b") then put #var spell1symb NO
  if !def(spell2) then put #var spell2 ab
  if $spell2mana >= 0 then
  else put #var spell2mana 0
  if !matchre("$spell2symb", "\b(YES|NO)\b") then put #var spell2symb NO
  if !def(spell3) then put #var spell3 maf
  if $spell3mana >= 0 then
  else put #var spell3mana 0
  if !matchre("$spell3symb", "\b(YES|NO)\b") then put #var spell3symb NO
  if !def(spell4) then put #var spell4 bless
  if $spell4mana >= 0 then
  else put #var spell4mana 0
  if !matchre("$spell4symb", "\b(YES|NO)\b") then put #var spell4symb NO
  if !matchre("$tmdbprior", "\b(YES|NO)\b") then put #var tmdbprior NO
  if !matchre("$tm", "\b(YES|NO)\b") then put #var tm NO
  if !matchre("$tmm2", "\b(YES|NO)\b") then put #var tmm2 NO
  if !def(spelltm) then put #var spelltm fb
  if $spelltmmana >= 0 then
  else put #var spelltmmana 0
  if !matchre("$debil", "\b(YES|NO)\b") then put #var debil NO
  if !matchre("$debilm2", "\b(YES|NO)\b") then put #var debilm2 NO
  if !def(spelldebil) then put #var spelldebil frb
  if $spelldebilmana >= 0 then
  else put #var spelldebilmana 0
  if !matchre("$cyclic", "\b(YES|NO)\b") then put #var cyclic NO
  if !matchre("$cyclicm2", "\b(YES|NO)\b") then put #var cyclicm2 NO
  if !matchre("$cyclicbuff", "\b(YES|NO)\b") then put #var cyclicbuff NO
  if !matchre("$spellcnum", "\b(1|2|3)\b") then put #var spellcnum 1
  if !matchre("$spellcnumm2", "\b(1|2|3)\b") then put #var spellcnumm2 1
  if !def(spellc1) then put #var spellc1 ac
  if $spellc1prepmana >= 1 then
  else put #var spellc1prepmana 1
  if !def(spellc2) then put #var spellc2 sov
  if $spellc2prepmana >= 1 then
  else put #var spellc2prepmana 1
  if !def(spellc3) then put #var spellc3 how
  if $spellc3prepmana >= 1 then
  else put #var spellc3prepmana 1
  if !matchre("$cyctm", "\b(YES|NO)\b") then put #var cyctm NO
  if !matchre("$cyctmm2", "\b(YES|NO)\b") then put #var cyctmm2 NO
  if !def(spellcyctm) then put #var spellcyctm rim
  if $spellcyctmmana >= 1 then
  else put #var spellcyctmmana 1
  if !matchre("$cycdebil", "\b(YES|NO)\b") then put #var cycdebil NO
  if !matchre("$cycdebilm2", "\b(YES|NO)\b") then put #var cycdebilm2 NO
  if !def(spellcycdebil) then put #var spellcycdebil ee
  if $spellcycdebilmana >= 1 then
  else put #var spellcycdebilmana 1
  if !matchre("$buff", "\b(YES|NO)\b") then put #var buff NO
  if (($buffnum >= 0) && ($buffnum <= 16)) then
  else put #var buffnum 0
  if !def(buff1) then put #var buff1 maf
  if $buff1mana >= 0 then
  else put #var buff1mana 100
  if !def(buff2) then put #var buff2 maf
  if $buff2mana >= 0 then
  else put #var buff2mana 100
  if !def(buff3) then put #var buff3 maf
  if $buff3mana >= 0 then
  else put #var buff3mana 100
  if !def(buff4) then put #var buff4 maf
  if $buff4mana >= 0 then
  else put #var buff4mana 100
  if !def(buff5) then put #var buff5 maf
  if $buff5mana >= 0 then
  else put #var buff5mana 100
  if !def(buff6) then put #var buff6 maf
  if $buff6mana >= 0 then
  else put #var buff6mana 100
  if !def(buff7) then put #var buff7 maf
  if $buff7mana >= 0 then
  else put #var buff7mana 100
  if !def(buff8) then put #var buff8 maf
  if $buff8mana >= 0 then
  else put #var buff8mana 100
  if !def(buff9) then put #var buff9 maf
  if $buff9mana >= 0 then
  else put #var buff9mana 100
  if !def(buff10) then put #var buff10 maf
  if $buff10mana >= 0 then
  else put #var buff10mana 100
  if !def(buff11) then put #var buff11 maf
  if $buff11mana >= 0 then
  else put #var buff11mana 100
  if !def(buff12) then put #var buff12 maf
  if $buff12mana >= 0 then
  else put #var buff12mana 100
  if !def(buff13) then put #var buff13 maf
  if $buff13mana >= 0 then
  else put #var buff13mana 100
  if !def(buff14) then put #var buff14 maf
  if $buff14mana >= 0 then
  else put #var buff14mana 100
  if !def(buff15) then put #var buff15 maf
  if $buff15mana >= 0 then
  else put #var buff15mana 100
  if !def(buff16) then put #var buff16 maf
  if $buff16mana >= 0 then
  else put #var buff16mana 100
  if !matchre("$symbiosisbuff", "\b(YES|NO)\b") then put #var symbiosisbuff NO
  if !def(symbiosisspell) then put #var symbiosisspell ab
  if $symbiosismana >= 0 then
  else put #var symbiosismana 100
  if !matchre("$tattoobuff", "\b(YES|NO)\b") then put #var tattoobuff NO
  if $tattooaddmana >= 0 then
  else put #var tattooaddmana 0
  if !matchre("$wandbuff", "\b(YES|NO)\b") then put #var wandbuff NO
  if !matchre("$wandbuffnum", "\b(1|2|3|4)\b") then put #var wandbuffnum 1
  if !def(wandstorage) then put #var wandstorage backpack
  if !def(wand1spell) then put #var wand1spell mef 
  if !def(wand1item) then put #var wand1item bloodwood branch
  if $wand1num > 0 then
  else put #var wand1num 2
  if !def(wand2spell) then put #var wand2spell rage
  if !def(wand2item) then put #var wand2item indurium phoenix
  if $wand2num > 0 then
  else put #var wand2num 2
  if !def(wand3spell) then put #var wand3spell hes
  if !def(wand3item) then put #var wand3item ironwood wand
  if $wand3num > 0 then
  else put #var wand3num 2
  if !def(wand4spell) then put #var wand4spell will
  if !def(wand4item) then put #var wand4item crystal
  if $wand4num > 0 then
  else put #var wand4num 2
  if !matchre("$wand1spell", "\b(hes|mef|rage|rw|will|wotp)\b") then put #var wand1spell mef
  if !matchre("$wand2spell", "\b(hes|mef|rage|rw|will|wotp)\b") then put #var wand2spell rage
  if !matchre("$wand3spell", "\b(hes|mef|rage|rw|will|wotp)\b") then put #var wand2spell hes
  if !matchre("$wand4spell", "\b(hes|mef|rage|rw|will|wotp)\b") then put #var wand2spell will
  
  if !matchre("$gbuff", "\b(YES|NO)\b") then put #var gbuff NO
  if (($gbuffnum >= 0) && ($gbuffnum <= 8)) then
  else put #var gbuffnum 0
  if !def(gbuff1) then put #var gbuff1 maf
  if $gbuff1prepmana >= 0 then
  else put #var gbuff1prepmana 1
  if $gbuff1addmana >= 0 then
  else put #var gbuff1addmana 0
  if !def(gbuff2) then put #var gbuff2 maf
  if $gbuff2prepmana >= 0 then
  else put #var gbuff2prepmana 1
  if $gbuff2addmana >= 0 then
  else put #var gbuff2addmana 0
  if !def(gbuff3) then put #var gbuff3 maf
  if $gbuff3prepmana >= 0 then
  else put #var gbuff3prepmana 1
  if $gbuff3addmana >= 0 then
  else put #var gbuff3addmana 0
  if !def(gbuff4) then put #var gbuff4 maf
  if $gbuff4prepmana >= 0 then
  else put #var gbuff4prepmana 1
  if $gbuff4addmana >= 0 then
  else put #var gbuff4addmana 0
  if !def(gbuff5) then put #var gbuff5 maf
  if $gbuff5prepmana >= 0 then
  else put #var gbuff5prepmana 1
  if $gbuff5addmana >= 0 then
  else put #var gbuff5addmana 0
  if !def(gbuff6) then put #var gbuff6 maf
  if $gbuff6prepmana >= 0 then
  else put #var gbuff6prepmana 1
  if $gbuff6addmana >= 0 then
  else put #var gbuff6addmana 0
  if !def(gbuff7) then put #var gbuff7 maf
  if $gbuff7prepmana >= 0 then
  else put #var gbuff7prepmana 1
  if $gbuff7addmana >= 0 then
  else put #var gbuff7addmana 0
  if !def(gbuff8) then put #var gbuff8 maf
  if $gbuff8prepmana >= 0 then
  else put #var gbuff8prepmana 1
  if $gbuff8addmana >= 0 then
  else put #var gbuff8addmana 0
  
  if !matchre("$debilassist", "\b(YES|NO)\b") then put #var debilassist NO
  if !matchre("$dbanum", "\b(0|1|2|3)\b") then put #var dbanum 0
  if !def(dbalist) then put #var dbalist xbow|se
  if !def(dbaspell1) then put #var dbaspell1 anc
  if $dbaspell1mana > -1 then
  else put #var dbaspell1mana 0
  if !def(dbaspell2) then put #var dbaspell2 vertigo
  if $dbaspell2mana > -1 then
  else put #var dbaspell2mana 0
  if !def(dbaspell3) then put #var dbaspell3 tremor
  if $dbaspell3mana > -1 then
  else put #var dbaspell3mana 0
  
  
  
  if !matchre("$research", "\b(YES|NO)\b") then put #var research NO
  if $gafmana >= 5 then
  else put #var gafmana 100
  if $gafaddmana >= 0 then
  else put #var gafaddmana 0
  if !matchre("$researchnum", "\b(1|2|3|4|5)\b") then put #var researchnum 1
  #if !matchre("$researchtype1", "\b(fundamental|augmentation|stream|sorcery|utility|warding|energy|field|plane|spell)\b") then put #var researchtype1 fundamental
  #if !matchre("$researchtype2", "\b(fundamental|augmentation|stream|sorcery|utility|warding|energy|field|plane|spell)\b") then put #var researchtype2 fundamental
  #if !matchre("$researchtype3", "\b(fundamental|augmentation|stream|sorcery|utility|warding|energy|field|plane|spell)\b") then put #var researchtype3 fundamental
  #if !matchre("$researchtype4", "\b(fundamental|augmentation|stream|sorcery|utility|warding|energy|field|plane|spell)\b") then put #var researchtype4 fundamental
  #if !matchre("$researchtype5", "\b(fundamental|augmentation|stream|sorcery|utility|warding|energy|field|plane|spell)\b") then put #var researchtype5 fundamental
  
  
  #GUILD-BARBARIAN
  if !matchre("$expertise", "\b(YES|NO)\b") then put #var expertise NO
  if !matchre("$expaccuracy", "\b(YES|NO)\b") then put #var expaccuracy NO
  if !matchre("$expdamage", "\b(YES|NO)\b") then put #var expdamage NO
  if !matchre("$whirlwind", "\b(YES|NO)\b") then put #var whirlwind NO
  if !matchre("$dualload", "\b(YES|NO)\b") then put #var dualload NO
  if !matchre("$warhorn", "\b(YES|NO)\b") then put #var warhorn NO
  if !def(warhornitem) then put #var warhornitem warhorn
  
  if $mininnerfire >= 0 then
  else put #var mininnerfire 20
  if !matchre("$berserkava", "\b(YES|NO)\b") then put #var berserkava NO
  if $avafatigue >= 0 then
  else put #var avafatigue 90
  if !matchre("$berserkfamine", "\b(YES|NO)\b") then put #var berserkfamine NO
  if $faminevit >= 0 then
  else put #var faminevit 90
  if !matchre("$meditatestaunch", "\b(YES|NO)\b") then put #var meditatestaunch NO
  
  if !matchre("$berserkblizzard", "\b(YES|NO)\b") then put #var berserkblizzard NO
  if !matchre("$berserkcyclone", "\b(YES|NO)\b") then put #var berserkcyclone NO
  if !matchre("$berserkdrought", "\b(YES|NO)\b") then put #var berserkdrought NO
  if !matchre("$berserkearthquake", "\b(YES|NO)\b") then put #var berserkearthquake NO
  if !matchre("$berserkflashflood", "\b(YES|NO)\b") then put #var berserkflashflood NO
  if !matchre("$berserkhurricane", "\b(YES|NO)\b") then put #var berserkhurricane NO
  if !matchre("$berserklandslide", "\b(YES|NO)\b") then put #var berserklandslide NO
  if !matchre("$landslidetraining", "\b(YES|NO)\b") then put #var landslidetraining NO
  if !matchre("$berserktornado", "\b(YES|NO)\b") then put #var berserktornado NO
  if !matchre("$tornadotraining", "\b(YES|NO)\b") then put #var tornadotraining NO
  if !matchre("$berserktsunami", "\b(YES|NO)\b") then put #var berserktsunami NO
  if !matchre("$berserkvolcano", "\b(YES|NO)\b") then put #var berserkvolcano NO
  if !matchre("$berserkwildfire", "\b(YES|NO)\b") then put #var berserkwildfire NO
  if !matchre("$bearform", "\b(YES|NO)\b") then put #var bearform NO
  if !matchre("$buffaloform", "\b(YES|NO)\b") then put #var buffaloform NO
  if !matchre("$dragonform", "\b(YES|NO)\b") then put #var dragonform NO
  if !matchre("$eagleform", "\b(YES|NO)\b") then put #var eagleform NO
  if !matchre("$monkeyform", "\b(YES|NO)\b") then put #var monkeyform NO
  if !matchre("$owlform", "\b(YES|NO)\b") then put #var owlform NO
  if !matchre("$pantherform", "\b(YES|NO)\b") then put #var pantherform NO
  if !matchre("$piranhaform", "\b(YES|NO)\b") then put #var piranhaform NO
  if !matchre("$pythonform", "\b(YES|NO)\b") then put #var pythonform NO
  if !matchre("$wolverineform", "\b(YES|NO)\b") then put #var wolverineform NO
  if !matchre("$meditatebastion", "\b(YES|NO)\b") then put #var meditatebastion NO
  if !matchre("$meditatecontemplation", "\b(YES|NO)\b") then put #var meditatecontemplation NO
  if !matchre("$meditateserenity", "\b(YES|NO)\b") then put #var meditateserenity NO
  if !matchre("$meditatetenacity", "\b(YES|NO)\b") then put #var meditatetenacity NO
  if !matchre("$roaranger", "\b(YES|NO)\b") then put #var roaranger NO
  if !matchre("$roarembrace", "\b(YES|NO)\b") then put #var roarembrace NO
  if !matchre("$roarkuniyo", "\b(YES|NO)\b") then put #var roarkuniyo NO
  if !matchre("$roarrage", "\b(YES|NO)\b") then put #var roarrage NO
  if !matchre("$roarscreech", "\b(YES|NO)\b") then put #var roarscreech NO
  if !matchre("$roarshriek", "\b(YES|NO)\b") then put #var roarshriek NO
  if !matchre("$roarwail", "\b(YES|NO)\b") then put #var roarwail NO
  
  
  #GUILD-BARD
  if !matchre("$whistlepiercing", "\b(YES|NO)\b") then put #var whistlepiercing NO
  if !matchre("$movewhistle", "\b(YES|NO)\b") then put #var movewhistle NO
  if !matchre("$movescream", "\b(YES|NO)\b") then put #var movescream NO
  if !matchre("$eilliescry", "\b(YES|NO)\b") then put #var eilliescry NO
  if $eilliescrymana >= 1 then
  else put #var eilliescrymana 1
  if !matchre("$misdirection", "\b(YES|NO)\b") then put #var misdirection NO
  if $misdirectionmana >= 0 then
  else put #var misdirectionmana 100
  #GUILD-CLERIC
  if !matchre("$theurgy", "\b(YES|NO)\b") then put #var theurgy NO
  if !matchre("$pray", "\b(YES|NO)\b") then put #var pray NO
  if !def(praydeity) then put #var praydeity meraud
  if !matchre("$anloralpin", "\b(YES|NO)\b") then put #var anloralpin NO
  if !def(anloralpinitem) then put #var anloralpinitem pin
  if !matchre("$pilgrimbadge", "\b(YES|NO)\b") then put #var pilgrimbadge NO
  if !def(pilgrimbadgeitem) then put #var pilgrimbadgeitem badge
  if !matchre("$meraudcommune", "\b(YES|NO)\b") then put #var meraudcommune NO
  if !matchre("$elunedcommune", "\b(YES|NO)\b") then put #var elunedcommune NO
  if !matchre("$tamsinecommune", "\b(YES|NO)\b") then put #var tamsinecommune NO
  if $blessdelay >= 0 then
  else put #var blessdelay 2
  if !matchre("$dirtstacker", "\b(YES|NO)\b") then put #var dirtstacker NO
  if !def(dirtstackeritem) then put #var dirtstackeritem pouch
  if !matchre("$lighter", "\b(YES|NO)\b") then put #var lighter NO
  if !def(lighteritem) then put #var lighteritem dragon
  if !def(watercontainer) then put #var watercontainer chalice
  if !matchre("$recite", "\b(YES|NO)\b") then put #var recite NO
  if !matchre("$dance", "\b(YES|NO)\b") then put #var dance NO
  if !matchre("$prayermat", "\b(YES|NO)\b") then put #var prayermat NO
  if !def(prayermatitem) then put #var prayermatitem mat
  if !matchre("$hyhcast", "\b(coz|male|male offense|male defense)\b") then put #var hyhcast male
  if !matchre("$osrelmeraud", "\b(YES|NO)\b") then put #var osrelmeraud NO
  if $ommana >= 30 then
  else put #var ommana 30
  if $ombuffnum >= 0 then
  else put #var ombuffnum 0
  
  #GUILD-EMPATH
  if !matchre("$avoidshock", "\b(YES|NO)\b") then put #var avoidshock YES
  if !matchre("$perchealth", "\b(YES|NO)\b") then put #var perchealth NO
  if !matchre("$manipulate", "\b(YES|NO)\b") then put #var manipulate NO
  if !matchre("$manipnum", "\b(1|2)\b") then put #var manipnum 2
  if !matchre("$paralysis", "\b(YES|NO)\b") then put #var paralysis NO
  if $paralysismana >= 10 then
  else put #var paralysismana 2
  if !matchre("$vitheal", "\b(YES|NO)\b") then put #var vitheal NO
  if $vithealmana >= 5 then
  else put #var vithealmana 5
  if !matchre("$heal", "\b(YES|NO)\b") then put #var heal NO
  if $healmana >= 15 then
  else put #var healmana 15
  if !matchre("$curedisease", "\b(YES|NO)\b") then put #var curedisease NO
  if $curediseasemana >= 15 then
  else put #var curediseasemana 15
  if !matchre("$flushpoisons", "\b(YES|NO)\b") then put #var flushpoisons NO
  if $flushpoisonsmana >= 15 then
  else put #var flushpoisonsmana 15
  if !matchre("$adcheal", "\b(YES|NO)\b") then put #var adcheal NO
  if !matchre("$adcdisease", "\b(YES|NO)\b") then put #var adcdisease NO
  if !matchre("$adcpoison", "\b(YES|NO)\b") then put #var adcpoison NO
  if !matchre("$upkeepregen", "\b(YES|NO)\b") then put #var upkeepregen NO
  if $upkeepregenmana >= 0 then
  else put #var upkeepregenmana 5
  if !matchre("$absolution", "\b(YES|NO)\b") then put #var absolution NO
  if $absolutionmana >= 150 then
  else put #var absolutionmana 150
  if !matchre("$iztouch", "\b(YES|NO)\b") then put #var iztouch NO
  if $izmana >= 0 then
  else put #var izmana 15
  if $iztimer >= 0 then
  else put #var iztimer 30
  #GUILD-MM
  if !matchre("$astro", "\b(YES|NO)\b") then put #var astro NO
  if $astrotimer >= 0 then
  else put #var astrotimer 60
  if !def(tktitem) then put #var tktitem dagger
  if !def(shadowlingnoun) then put #var shadowlingnoun shadowling
  if !matchre("$predictiontool", "\b(none|bones|mirror)\b") then put #var predictiontool none
  if !def(predictiontoolitem) then put #var predictiontoolitem bones
  if !matchre("$piercinggaze", "\b(YES|NO)\b") then put #var piercinggaze YES
  if $piercinggazemana >= 5 then
  else put #var piercinggazemana 5
  if !matchre("$mindshout", "\b(YES|NO)\b") then put #var mindshout NO
  if $mindshoutmana >= 5 then
  else put #var mindshoutmana 20
  if !matchre("$burglerf", "\b(YES|NO)\b") then put #var burglerf NO
  if $burglerfdelay >= 0 then
  else put #var burglerfdelay 10 
  
  #GUILD-NECRO
  if !matchre("$necrostate", "\b(unsullied|forsaken|redeemed)\b") then put #var necrostate unsullied
  if !matchre("$necrosafety", "\b(YES|NO)\b") then put #var necrosafety NO
  if !def(necrowhitelist) then put #var necrowhitelist person1|person2
  if !matchre("$riteofgrace", "\b(YES|NO)\b") then put #var riteofgrace NO
  if $rogmana > 4 then
  else put #var rogmana 5
  if !matchre("$rogcycle", "\b(YES|NO)\b") then put #var rogcycle NO
  if !matchre("$devour", "\b(YES|NO)\b") then put #var devour NO
  if $devourmana >= 30 then
  else put #var devourmana 30
  if !matchre("$siphonvit", "\b(YES|NO)\b") then put #var siphonvit NO
  if $siphonvitmana >= 30 then
  else put #var siphonvitmana 10
  if $siphonvitnum >= 0 then
  else put #var siphonvitnum 80
  
  if !matchre("$preserve", "\b(YES|NO)\b") then put #var preserve NO
  if !matchre("$harvest", "\b(YES|NO)\b") then put #var harvest NO
  if !matchre("$harveststore", "\b(YES|NO)\b") then put #var harveststore NO
  if $harveststorenum >= 0 then
  else put #var harveststorenum 5
  if !matchre("$eotbrel", "\b(YES|NO)\b") then put #var eotbrel NO
  if !matchre("$burgleeotb", "\b(YES|NO)\b") then put #var burgleeotb NO
  if $burgleeotbdelay >= 0 then
  else put #var burgleeotbdelay 10
  
  #GUILD-PALADIN  
  if !matchre("$smite", "\b(YES|NO)\b") then put #var smite YES
  if !matchre("$tithe", "\b(YES|NO)\b") then put #var tithe NO
  #GUILD-RANGER
  if !matchre("$pounce", "\b(YES|NO)\b") then put #var pounce YES
  if !matchre("$ritstype", "\b(any|low|mid|high)\b") then put #var ritstype mid
  #GUILD-THIEF
  if !matchre("$backstab", "\b(YES|NO)\b") then put #var backstab NO
  if !matchre("$snipe", "\b(YES|NO)\b") then put #var snipe NO
  if (($khrimax >= 1) && ($khrimax <= 8)) then
  else put #var khrimax 1
  if !matchre("$khriadaptation", "\b(YES|NO)\b") then put #var khriadaptation NO
  if !matchre("$khriavoidance", "\b(YES|NO)\b") then put #var khriavoidance NO
  if !matchre("$khricunning", "\b(YES|NO)\b") then put #var khricunning NO
  if !matchre("$khridampen", "\b(YES|NO)\b") then put #var khridampen NO
  if !matchre("$khridarken", "\b(YES|NO)\b") then put #var khridarken NO
  if !matchre("$khrielusion", "\b(YES|NO)\b") then put #var khrielusion NO
  if !matchre("$khriendure", "\b(YES|NO)\b") then put #var khriendure NO
  if !matchre("$khrievanescence", "\b(YES|NO)\b") then put #var khrievanescence NO
  if !matchre("$khriflight", "\b(YES|NO)\b") then put #var khriflight NO
  if !matchre("$khrifright", "\b(YES|NO)\b") then put #var khrifright NO
  if !matchre("$khrifocus", "\b(YES|NO)\b") then put #var khrifocus NO
  if !matchre("$khriharrier", "\b(YES|NO)\b") then put #var khriharrier NO
  if !matchre("$khrihasten", "\b(YES|NO)\b") then put #var khrihasten NO
  if !matchre("$khriinsight", "\b(YES|NO)\b") then put #var khriinsight NO
  if !matchre("$khriplunder", "\b(YES|NO)\b") then put #var khriplunder NO
  if !matchre("$khrisagacity", "\b(YES|NO)\b") then put #var khrisagacity NO
  if !matchre("$khrisensing", "\b(YES|NO)\b") then put #var khrisensing NO
  if !matchre("$khriserenity", "\b(YES|NO)\b") then put #var khriserenity NO
  if !matchre("$khrishadowstep", "\b(YES|NO)\b") then put #var khrishadowstep NO
  if !matchre("$khrisight", "\b(YES|NO)\b") then put #var khrisight NO
  if !matchre("$khristeady", "\b(YES|NO)\b") then put #var khristeady NO
  if !matchre("$khristrike", "\b(YES|NO)\b") then put #var khristrike NO
  if !matchre("$khriguile", "\b(YES|NO)\b") then put #var khriguile NO
  if !matchre("$khriprowess", "\b(YES|NO)\b") then put #var khriprowess NO
  if !matchre("$khriterrify", "\b(YES|NO)\b") then put #var khriterrify NO
  if !matchre("$khridebil", "\b(YES|NO)\b") then put #var khridebil NO
  if !matchre("$khridebiltype", "\b(prowess|guile|credence|terrify|intimidate|eliminate)\b") then put #var khridebiltype prowess
  if !matchre("$movevanish", "\b(YES|NO)\b") then put #var movevanish NO
  if !matchre("$burglethiefbin", "\b(YES|NO)\b") then put #var burglethiefbin NO
  if !matchre("$burglekhrihasten", "\b(YES|NO)\b") then put #var burglekhrihasten NO
  if !matchre("$burglekhriplunder", "\b(YES|NO)\b") then put #var burglekhriplunder NO
  if !matchre("$burglekhrisilence", "\b(YES|NO)\b") then put #var burglekhrisilence NO
  if !matchre("$burglekhrislight", "\b(YES|NO)\b") then put #var burglekhrislight NO
  if !matchre("$boxpopkhrifocus", "\b(YES|NO)\b") then put #var boxpopkhrifocus NO
  if !matchre("$boxpopkhrihasten", "\b(YES|NO)\b") then put #var boxpopkhrihasten NO
  if !matchre("$boxpopkhriplunder", "\b(YES|NO)\b") then put #var boxpopkhriplunder NO
  if !matchre("$boxpopkhrisafe", "\b(YES|NO)\b") then put #var boxpopkhrisafe NO
  if !matchre("$boxpopkhrisight", "\b(YES|NO)\b") then put #var boxpopkhrisight NO
  #GUILD-TRADER
  if !matchre("$invest", "\b(YES|NO)\b") then put #var invest NO
  if !matchre("$tradingsell", "\b(YES|NO)\b") then put #var tradingsell NO
  if !matchre("$tradingselltown", "\b(%townvaultpresetlist)\b") then put #var tradingselltown none
  if !matchre("$tradingsellsource", "\b(vault|portal)\b") then put #var tradingsellsource vault
  if !matchre("$tradingtasks", "\b(YES|NO)\b") then put #var tradingtasks NO
  #GUILD-WM
  if !matchre("$summoning", "\b(YES|NO)\b") then put #var summoning YES
  if !matchre("$summonweapon", "\b(YES|NO)\b") then put #var summonweapon NO
  if $summonweapontimer >= 0 then
  else put #var summonweapontimer 120
  if !matchre("$pathway", "\b(YES|NO)\b") then put #var pathway NO
  if !def(pathwaytype) then put #var pathwaytype precise
  if !matchre("$domain", "\b(YES|NO)\b") then put #var domain NO
  if !matchre("$domaintype", "\b(fire|air|earth|water|electricity|aether|metal)\b") then put #var domaintype fire
  if !matchre("$chargeafterlock", "\b(YES|NO)\b") then put #var chargeafterlock NO
  if !def(calspell) then put #var calspell ab
  if $calprepmana >= 1 then
  else put #var calprepmana 100
  if $caladdmana >= 1 then
  else put #var caladdmana 0
  if !def(ignitebackup) then put #var ignitebackup scimitar
  if !matchre("$platring", "\b(YES|NO)\b") then put #var platring NO
  if !def(platringitem) then put #var platringitem scimitar
  
  #CONDITIONAL_VARIABLE_SWITCHES
  if $premiumring = "YES" then put #var upkeeptown fangcove
  if (($bugoutonbleed = "YES") && ($auonbleed = "YES") && ($autoupkeep = "YES")) then put #var bugoutonbleed NO
  if $harvest = "YES" then put #var preserve YES
  if $tmfocus = "YES" then put #var tmdbprior YES
  if %necrostate = "forsaken" then
  {
    put #var autopath NO
  }
  if (($necrosafety = "YES") && ($riteofgrace = "YES")) then
  {
    put #var cyctm NO
    put #var cycdebil NO
    put #var cyclic NO
  }
  if %iztouch = "YES" then
  {
    put #var cyclic NO
    put #var cyctm NO
    put #var cycdebil NO
  }
  if (($tmfocusworn = "YES") && ($tmfocusstorage = "YES")) then put #var tmfocusstorage NO
  if (($ritualfocusworn = "YES") && ($ritualfocusstorage = "YES")) then put #var ritualfocusstorage NO
  if (($expertise = "YES") && ($acms = "YES")) then 
  {
    put #var expertise NO
    put #var expaccuracy NO
    put #var expdamage NO
  }
  if (($guild = "Barbarian") || ($guild = "Thief")) then
  {
    put #var attune NO
    put #var spellprepping NO
    put #var cyclic NO
    put #var cycdebil NO
    put #var cyctm NO
    put #var buff NO
    #put #var gbuff NO
    #if !def(gbufftarget) then put #var gbufftarget Saragos
  }
  return


WEAPONLISTCHECK:
  var weaponlistcheckresult 1
  eval weaponliststring replace("$0", "weaponlist ", "")
  eval weaponlistcount count("%weaponliststring", "|")
  eval weaponlistlength length("%weaponlist")
  #echo weaponliststring %weaponliststring
  #echo weaponlistcount: %weaponlistcount
  if (%weaponlistlength < 1) then
  {
    var weaponlistcheckresult 0
    return
  }
  var weaponlistcheckcounter 0
  goto WEAPONLISTCHECKMAIN
WEAPONLISTCHECKMAIN:
  if (%weaponlistcheckcounter > %weaponlistcount) then return
  #echo weaponliststring(%weaponlistcheckcounter): %weaponliststring(%weaponlistcheckcounter)
  if (!matchre("%weaponliststring(%weaponlistcheckcounter)", "se|le|the|sb|lb|thb|stave|pole|brawl|lt|ht|bow|xbow|sling")) then
  {
    var weaponlistcheckresult 0
    return
  }
  math weaponlistcheckcounter add 1
  goto WEAPONLISTCHECKMAIN

  
VARCHECKOTHER:
  #KILL_SCRIPT_CONDITIONALS
  if $m%checkmodekilltmfocus = "YES" then put #var m%checkmodekillweapon NO
  if $m%checkmodebgdbcombo = "YES" then
  {
    put #var m%checkmodekilltm YES
    put #var m%checkmodekilltmspell bg
    if $m%checkmodekilltmprepmana < 30 then put #var m%checkmodekilltmprepmana 30
    if $m%checkmodekilltmaddmana > 70 then put #var m%checkmodekilltmaddmana 70 
  }
  
  #OTHER-ASTRAL
  if !matchre("$astralsafe", "\b(YES|NO)\b") then put #var astralsafe YES
  if !matchre("$hundredth", "\b(YES|NO)\b") then put #var hundredth NO
  #OTHER-COMBO
  if !def(maneuverlist) then put #var maneuverlist cleave|crash|twirl|impale|palmstrike|doublestrike|powershot
  if !def(cleaveweapon) then put #var cleaveweapon zweihander
  if !def(crashweapon) then put #var crashweapon dragonwood mallet
  if !def(twirlweapon) then put #var twirlweapon spiritwood staff
  if !def(impaleweapon) then put #var impaleweapon senci spear
  if !def(doublestrikeweapon) then put #var doublestrikeweapon broadsword
  if !def(doublestrikeweapon2) then put #var doublestrikeweapon2 scimitar
  if !def(powershotammo) then put #var powershotammo crossbow bolt
  if !def(powershotweapon) then put #var powershotweapon latchbow  
  #OTHER-SLIDE
  if !matchre("$summonelement", "\b(electric|cold|fire)\b") then put #var summonelement electric
  if !def(summoningot) then put #var summoningot none
  if !def(summonlist) then put #var summonlist cleave|crash|twirl|impale|doublestrike|palmstrike
  if !def(summoncleave) then put #var summoncleave 2he
  if !def(summoncrash then put #var summoncrash 2hb
  if !def(summondoublestrike) then put #var summondoublestrike se
    
  #OTHER-KILL
  #if !matchre("$killtype", "\b(TMFOCUS)\b") then put #var killtype TMFOCUS
  if !matchre("$killloot", "\b(YES|NO)\b") then put #var killloot YES
  if !matchre("$killadvance", "\b(YES|NO)\b") then put #var killadvance YES
  if !matchre("$killretreat", "\b(YES|NO)\b") then put #var killretreat NO
  if !matchre("$killtmfocus", "\b(YES|NO)\b") then put #var killtmfocus NO
  if !matchre("$killbuffing", "\b(YES|NO)\b") then put #var killbuffing NO
  if !matchre("$killcyclic", "\b(YES|NO)\b") then put #var killcyclic NO
  if !def(killcycspell) then put #var killcycspell rim
  if $killcycprepmana >= 0 then
  else put #var killcycprepmana 0
  if !matchre("$killdb", "\b(YES|NO)\b") then put #var killdb NO
  if !def(killdbspell) then put #var killdbspell ip
  if $killdbprepmana >= 0 then
  else put #var killdbprepmana 0
  if $killdbaddmana >= 0 then
  else put #var killdbaddmana 0
  if !matchre("$killtm", "\b(YES|NO)\b") then put #var killtm NO
  if !def(killtmspell) then put #var killtmspell cl
  if $killtmprepmana >= 0 then
  else put #var killtmprepmana 0
  if $killtmaddmana >= 0 then
  else put #var killtmaddmana 0
  
  if !matchre("$beckonthenaga", "\b(YES|NO)\b") then put #var beckonthenaga NO
  if $btnprepmana >= 30 then
  else put #var btnprepmana 30
  if $btnaddmana >= 0 then
  else put #var btnaddmana 0
  if !matchre("$dragonsbreath", "\b(YES|NO)\b") then put #var dragonsbreath NO
  if $dbprepmana >= 30 then
  else put #var dbprepmana 15
  if $dbaddmana >= 0 then
  else put #var dbaddmana 0
  if !matchre("$blufmorgaraen", "\b(YES|NO)\b") then put #var blufmorgaraen NO
  if $bgprepmana >= 30 then
  else put #var bgprepmana 15
  if $bgaddmana >= 0 then
  else put #var bgaddmana 0
  if !matchre("$magneticballista", "\b(YES|NO)\b") then put #var magneticballista NO
  if $mabprepmana >= 30 then
  else put #var mabprepmana 15
  if $mabaddmana >= 0 then
  else put #var mabaddmana 0
  
  if !matchre("$killweapon", "\b(YES|NO)\b") then put #var killweapon NO
  if !matchre("$killweapontype", "\b(melee|brawl|thrown|aimed)\b") then put #var killweapontype brawl
  if !def(killweaponitem) then put #var killweaponitem scimitar
  if !def(killweaponammo) then put #var killweaponammo bolt
  if !matchre("$killweaponcombo", "\b(edged|blunt|piercing)\b") then put #var killweaponcombo edged
  if !matchre("$killthrownverb", "\b(lob|throw|hurl)\b") then put #var killthrownverb lob
  if !matchre("$killthrownbond", "\b(YES|NO)\b") then put #var killthrownbond NO
  return

BOOSTCRAFTINGP:
  pause
BOOSTCRAFTING:
  match BOOSTCRAFTINGP %waitstring
  match BOOSTCRAFTINGSTOW A lumpy canvas sack appears in your right hand!
  match RETURN You don't have enough credits for the Crafting Material Sack boost.
  put boost crafting
  matchwait
  
BOOSTCRAFTINGSTOW:
  gosub STOWITEM canvas sack
  goto BOOSTCRAFTING  

NEWTOWNPRESET:
  var towncheck $1
  var towntype $2
  put #echo Yellow towncheck: %towncheck
  put #echo Yellow towntype: %towntype
  var rttargetroom 0
  if ("%towncheck" = "muspari") then
	{
		var rtzone 47
		var rttravel YES
		var rttraveldest muspari
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 47
		if (%towntype = "burgle") then var rttargetroom 0
		if (%towntype = "perform") then var rttargetroom 0
		if (%towntype = "forging") then var rttargetroom 0
		if (%towntype = "pawn") then var rttargetroom 0
	}
  if ("%towncheck" = "theren") then
	{
		var rtzone 42
		var rttravel YES
		var rttraveldest theren
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 42
		if (%towntype = "burgle") then var rttargetroom 239
		if (%towntype = "perform") then var rttargetroom 242
	}
	if ("%towncheck" = "rossman") then
	{
		var rtzone 34a
		var rttravel YES
		var rttraveldest rossman
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 34a
		if (%towntype = "burgle") then var rttargetroom 128
		if (%towntype = "perform") then var rttargetroom 95
	}
  if ("%towncheck" = "riverhaven") then
	{
		var rtzone 30
		var rttravel YES
		var rttraveldest riverhaven
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 47
		if (%towntype = "burgle") then var rttargetroom 250
		if (%towntype = "perform") then var rttargetroom 219
		if (%towntype = "pawn") then var rttargetroom Ioun
	}
	if ("%towncheck" = "dirge") then
	{
		var rtzone 13
		var rttravel YES
		var rttraveldest dirge
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 13
		if (%towntype = "burgle") then var rttargetroom 0
		if (%towntype = "perform") then var rttargetroom 55
	}
	if ("%towncheck" = "kaerna") then
	{
		var rtzone 7
		var rttravel YES
		var rttraveldest caravansary
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 7
		if (%towntype = "burgle") then var rttargetroom 480
		if (%towntype = "perform") then var rttargetroom 511
	}
	if ("%towncheck" = "crossing") then
	{
		var rtzone 1
		var rttravel YES
		var rttraveldest crossing
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 1
		if (%towntype = "burgle") then var rttargetroom 388
		if (%towntype = "perform") then var rttargetroom 227
		if (%towntype = "studyart") then var rttargetroom 534
		if (%towntype = "pawn") then var rttargetroom Cormyn
	}
	if ("%towncheck" = "leth") then
	{
		var rtzone 61
		var rttravel YES
		var rttraveldest leth
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 61
		if (%towntype = "burgle") then var rttargetroom 206
		if (%towntype = "perform") then var rttargetroom 207
	}
	if ("%towncheck" = "ilaya") then
	{
		var rtzone 112
		var rttravel YES
		var rttraveldest ilaya
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 112
		if (%towntype = "burgle") then var rttargetroom 190
		if (%towntype = "perform") then var rttargetroom 185
	}
	if ("%towncheck" = "fangcove") then
	{
		var rtzone 150
		var rttravel YES
		var rttraveldest fangcove
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 150
		if (%towntype = "burgle") then var rttargetroom 0
		if (%towntype = "perform") then var rttargetroom 189
		if (%towntype = "pawn") then var rttargetroom Ioun
	}
	if ("%towncheck" = "shard") then
	{
		var rtzone 67
		var rttravel YES
		var rttraveldest shard
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 67
		if (%towntype = "burgle") then var rttargetroom 194
		if (%towntype = "pawn") then var rttargetroom Aelik
		if (%towntype = "perform") then var rttargetroom 180
		if (%towntype = "forging") then var rttargetroom forging
	}
	if ("%towncheck" = "hibarnhvidar") then
	{
		var rtzone 116
		var rttravel YES
		var rttraveldest hib
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 116
		if (%towntype = "burgle") then var rttargetroom 439
		if (%towntype = "perform") then var rttargetroom 442
		if (%towntype = "pawn") then var rttargetroom Relf
		if (%towntype = "forging") then var rttargetroom forging
	}
	if ("%towncheck" = "boarclan") then
	{
		var rtzone 127
		var rttravel YES
		var rttraveldest boar
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 127
		if (%towntype = "burgle") then var rttargetroom 29
		if (%towntype = "perform") then var rttargetroom 233
	}
  if ("%towncheck" = "ratha") then
	{
		var rtzone 90
		var rttravel YES
		var rttraveldest ratha
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 90
		if (%towntype = "burgle") then var rttargetroom 579
		if (%towntype = "perform") then var rttargetroom 578
		if (%towntype = "pawn") then var rttargetroom Paedraig
	}
	if ("%towncheck" = "aesry") then
	{
		var rtzone 99
		var rttravel YES
		var rttraveldest aesry
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 99
		if (%towntype = "burgle") then var rttargetroom 144
		if (%towntype = "perform") then var rttargetroom 130
	}
	if ("%towncheck" = "merkresh") then
	{
		var rtzone 107
		var rttravel YES
		var rttraveldest merkresh
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 107
		if (%towntype = "burgle") then var rttargetroom 19
		if (%towntype = "perform") then var rttargetroom 300
	}
  if ("%towncheck" = "mriss") then
	{
		var rtzone 108
		var rttravel YES
		var rttraveldest mriss
		var rtmove NO
		#if (%towntype = "upkeep") then var upkeepzone 107
		if (%towntype = "burgle") then var rttargetroom 309
		if (%towntype = "perform") then var rttargetroom 310
	}
  if ("%towncheck" = "jeihrem") then
	{
		var rtzone 90f
		var rttravel YES
		var rttraveldest jeihrem
		var rtmove NO
		if (%towntype = "upkeep") then var upkeepzone 90f
		if (%towntype = "burgle") then var rttargetroom 0
		if (%towntype = "perform") then var rttargetroom 0
	}
	var rtfindroom NO
  return


SPELLSTATCHECK:
  var spelldiffname $0
  var spellmana -1
  var spelldifficulty 0
  var spellminmana 0
  var spellcapmana 0
  
  #AP
  if ("%spelldiffname" = "burden") then
  {
    var spellmana 0
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "dispel") then
  {
    var spellmana 0
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ease") then
  {
    var spellmana 0
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "gaf") then
  {
    var spellmana 0
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "imbue") then
  {
    var spellmana 0
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "lw") then
  {
    var spellmana 0
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "maf") then
  {
    var spellmana 0
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "sec") then
  {
    var spellmana 0
    var spelldifficulty 2
    var spellminmana 50
    var spellcapmana 600
  }
  if ("%spelldiffname" = "stra") then
  {
    var spellmana 0
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 50
  }

  #MISC
  if ("%spelldiffname" = "bonegrinder") then
  {
    var spellmana 6
    var spelldifficulty 4
    var spellminmana 20
    var spellcapmana 66
  }
  if ("%spelldiffname" = "sif") then
  {
    var spellmana 6
    var spelldifficulty 3
    var spellminmana 7
    var spellcapmana 50
    var spellskill targeted
  }

  #BARD
  if ("%spelldiffname" = "aban") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 7
    var spellcapmana 37
  }
  if ("%spelldiffname" = "aewo") then
  {
    var spellmana 1
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "alb") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "aot") then
  {
    var spellmana 1
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "btn") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "botf") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "bos") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 2
    var spellcapmana 50
  }
  if ("%spelldiffname" = "care") then
  {
    var spellmana 1
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "dalu") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 6
    var spellcapmana 31
  }
  if ("%spelldiffname" = "dmrs") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 3
    var spellcapmana 66
  }
  if ("%spelldiffname" = "dema") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 20
    var spellcapmana 66
  }
  if ("%spelldiffname" = "drum") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "echo") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ecry") then
  {
    var spellmana 1
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "eye") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "fae") then
  {
    var spellmana 1
    var spelldifficulty 1
    var spellminmana 2
    var spellcapmana 15
  }
  if ("%spelldiffname" = "fotf") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "gj") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "harm") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "hodi") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "mis") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 10
    var spellcapmana 66
  }
  if ("%spelldiffname" = "name") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "nexus") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "pyre") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 7
    var spellcapmana 37
  }
  if ("%spelldiffname" = "rage") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "repr") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "resonance") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "sanctuary") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "soul") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 300
    var spellcapmana 800
  }
  if ("%spelldiffname" = "wotm") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "will") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 150
    var spellcapmana 700
  }
  if ("%spelldiffname" = "word") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 50
    var spellcapmana 600
  }

  #CLERIC
  if ("%spelldiffname" = "ae") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "all") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 50
    var spellcapmana 600
  }
  if ("%spelldiffname" = "auspice") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "benediction") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "bless") then
  {
    var spellmana 2
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "centering") then
  {
    var spellmana 2
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "chs") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 7
    var spellcapmana 50
  }
  if ("%spelldiffname" = "coz") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 33
  }
  if ("%spelldiffname" = "dr") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 2
    var spellcapmana 50
  }
  if ("%spelldiffname" = "ef") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "fou") then
  {
    var spellmana 2
    var spelldifficulty 4
    var spellminmana 300
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ff") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 2
    var spellcapmana 50
  }
  if ("%spelldiffname" = "ghs") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "gg") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "halo") then
  {
    var spellmana 2
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "hot") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 7
    var spellcapmana 50
  }
  if ("%spelldiffname" = "he") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 2
    var spellcapmana 50
  }
  if ("%spelldiffname" = "hh") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "horn") then
  {
    var spellmana 2
    var spelldifficulty 6
    var spellminmana 2
    var spellcapmana 50
  }
  if ("%spelldiffname" = "hulp") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "hyh") then
  {
    var spellmana 2
    var spelldifficulty 4
    var spellminmana 6
    var spellcapmana 31
  }
  if ("%spelldiffname" = "it") then
  {
    var spellmana 2
    var spelldifficulty 4
    var spellminmana 20
    var spellcapmana 66
  }
  if ("%spelldiffname" = "mapp") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "malediction") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 33
  }
  if ("%spelldiffname" = "mre") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "mc") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 10
    var spellcapmana 66
  }
  if ("%spelldiffname" = "mpp") then
  {
    var spellmana 2
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "mf") then
  {
    var spellmana 2
    var spelldifficulty 4
    var spellminmana 300
    var spellcapmana 800
  }
  if ("%spelldiffname" = "om") then
  {
    var spellmana 2
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 200
  }
  if ("%spelldiffname" = "pom") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 150
    var spellcapmana 700
  }
  if ("%spelldiffname" = "ps") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 10
    var spellcapmana 66
  }
  if ("%spelldiffname" = "pfe") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "rejuv") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "rezz") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 50
  }
  if ("%spelldiffname" = "rev") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "sap") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "sl") then
  {
    var spellmana 2
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "sol") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "sa") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 6
    var spellcapmana 31
  }
  if ("%spelldiffname" = "sb") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "sos") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "sick") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "spit") then
  {
    var spellmana 2
    var spelldifficulty 4
    var spellminmana 20
    var spellcapmana 66
  }
  if ("%spelldiffname" = "uncurse") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "vigil") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }

  #EMPATH
  if ("%spelldiffname" = "absolution") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 150
    var spellcapmana 700
  }
  if ("%spelldiffname" = "ad") then
  {
    var spellmana 3
    var spelldifficulty 4
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "ags") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "awaken") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "bs") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "cr") then
  {
    var spellmana 3
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "cos") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 150
    var spellcapmana 700
  }
  if ("%spelldiffname" = "compel") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 33
  }
  if ("%spelldiffname" = "cd") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ev") then
  {
    var spellmana 3
    var spelldifficulty 4
    var spellminmana 300
    var spellcapmana 800
  }
  if ("%spelldiffname" = "fp") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "foc") then
  {
    var spellmana 3
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "gol") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "gs") then
  {
    var spellmana 3
    var spelldifficulty 4
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "heal") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "hs") then
  {
    var spellmana 3
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "hw") then
  {
    var spellmana 3
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "hl") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "iz") then
  {
    var spellmana 3
    var spelldifficulty 5
    var spellminmana 15
    var spellcapmana 45
  }
  if ("%spelldiffname" = "innocence") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ic") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "lethargy") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "mef") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "nb") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 10
    var spellcapmana 66
  }
  if ("%spelldiffname" = "paralysis") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 2
    var spellcapmana 50
  }
  if ("%spelldiffname" = "pop") then
  {
    var spellmana 3
    var spelldifficulty 4
    var spellminmana 300
    var spellcapmana 800
  }
  if ("%spelldiffname" = "rp") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "refresh") then
  {
    var spellmana 3
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "regenerate") then
  {
    var spellmana 3
    var spelldifficulty 4
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "tranquility") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "vigor") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "vh") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  
  #MOON_MAGE
  if ("%spelldiffname" = "art") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "aus") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "bc") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 150
    var spellcapmana 700
  }
  if ("%spelldiffname" = "burn") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 7
    var spellcapmana 50
  }
  if ("%spelldiffname" = "col") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "calm") then
  {
    var spellmana 4
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "cv") then
  {
    var spellmana 4
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "contingency") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "dazzle") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "dc") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 50
    var spellcapmana 600
  }
  if ("%spelldiffname" = "do") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 2
    var spellcapmana 50
  }
  if ("%spelldiffname" = "dg") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "fm") then
  {
    var spellmana 4
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "iots") then
  {
    var spellmana 4
    var spelldifficulty 4
    var spellminmana 300
    var spellcapmana 800
  }
  if ("%spelldiffname" = "locate") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "mt") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "mb") then
  {
    var spellmana 4
    var spelldifficulty 4
    var spellminmana 20
    var spellcapmana 66
  }
  if ("%spelldiffname" = "ms") then
  {
    var spellmana 4
    var spelldifficulty 4
    var spellminmana 20
    var spellcapmana 66
  }
  if ("%spelldiffname" = "moonblade") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "mg") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "pd") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 2
    var spellcapmana 50
  }
  if ("%spelldiffname" = "pg") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "psy") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "rtr") then
  {
    var spellmana 4
    var spelldifficulty 4
    var spellminmana 300
    var spellcapmana 800
  }
  if ("%spelldiffname" = "rf") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "rend") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "rs") then
  {
    var spellmana 4
    var spelldifficulty 5
    var spellminmana 40
    var spellcapmana 120
  }
  if ("%spelldiffname" = "sco") then
  {
    var spellmana 4
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "seer") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "set") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 3
    var spellcapmana 66
  }
  if ("%spelldiffname" = "shm") then
  {
    var spellmana 4
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ss") then
  {
    var spellmana 4
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "shw") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 6
    var spellcapmana 31
  }
  if ("%spelldiffname" = "shadowling") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "shadows") then
  {
    var spellmana 4
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "shear") then
  {
    var spellmana 4
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "sm") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "sleep") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "sod") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 33
  }
  if ("%spelldiffname" = "sls") then
  {
    var spellmana 4
    var spelldifficulty 4
    var spellminmana 6
    var spellcapmana 33
  }
  if ("%spelldiffname" = "sov") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "tf") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "tksh") then
  {
    var spellmana 4
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "tks") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "tkt") then
  {
    var spellmana 4
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 50
  }
  if ("%spelldiffname" = "teleport") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ts") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "tv") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "th") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "unleash") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "wd") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 6
    var spellcapmana 100
  }
  
  #NECROMANCER
  if ("%spelldiffname" = "acs") then
  {
    var spellmana 5
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 50
  }
  if ("%spelldiffname" = "blb") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 10
    var spellcapmana 66
  }
  if ("%spelldiffname" = "bb") then
  {
    var spellmana 5
    var spelldifficulty 4
    var spellminmana 300
    var spellcapmana 800
  }
  if ("%spelldiffname" = "bue") then
  {
    var spellmana 5
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ch") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "cfb") then
  {
    var spellmana 5
    var spelldifficulty 2
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "cfw") then
  {
    var spellmana 5
    var spelldifficulty 4
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "cf") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "devour") then
  {
    var spellmana 5
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "emc") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "eotb") then
  {
    var spellmana 5
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ghoulflesh") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "hp") then
  {
    var spellmana 5
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "ivm") then
  {
    var spellmana 5
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ks") then
  {
    var spellmana 5
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "nr") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "obfuscation") then
  {
    var spellmana 5
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "pv") then
  {
    var spellmana 5
    var spelldifficulty 2
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "php") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "qe") then
  {
    var spellmana 5
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "rei") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "resection") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "rpu") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "roc") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "rof") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 5
  }
  if ("%spelldiffname" = "rog") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "sv") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 10
    var spellcapmana 66
  }
  if ("%spelldiffname" = "solace") then
  {
    var spellmana 5
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "usol") then
  {
    var spellmana 5
    var spelldifficulty 4
    var spellminmana 7
    var spellcapmana 37
  }
  if ("%spelldiffname" = "vs") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 10
    var spellcapmana 66
  }
  if ("%spelldiffname" = "vod") then
  {
    var spellmana 5
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 33
  }
  if ("%spelldiffname" = "vivisection") then
  {
    var spellmana 5
    var spelldifficulty 4
    var spellminmana 20
    var spellcapmana 66
  }
  if ("%spelldiffname" = "worm") then
  {
    var spellmana 5
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  
  #PALADIN
  if ("%spelldiffname" = "ag") then
  {
    var spellmana 2
    var spelldifficulty 4
    var spellminmana 300
    var spellcapmana 800
  }
  if ("%spelldiffname" = "as") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "aa") then
  {
    var spellmana 2
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "bot") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ba") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "clarity") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "courage") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "crc") then
  {
    var spellmana 2
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "da") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "dig") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "fst") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 2
    var spellcapmana 50
  }
  if ("%spelldiffname" = "halt") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "hoj") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "hes") then
  {
    var spellmana 2
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "how") then
  {
    var spellmana 2
    var spelldifficulty 4
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "mo") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "reb") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 10
    var spellcapmana 66
  }
  if ("%spelldiffname" = "rw") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "rue") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "sr") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "shatter") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "smh") then
  {
    var spellmana 2
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "sp") then
  {
    var spellmana 2
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "sf") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "tk") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "vos") then
  {
    var spellmana 2
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 25
  }
  
  #RANGER
  if ("%spelldiffname" = "athleticism") then
  {
    var spellmana 3
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "af") then
  {
    var spellmana 3
    var spelldifficulty 4
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "bes") then
  {
    var spellmana 3
    var spelldifficulty 4
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "blend") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "bloodthorns") then
  {
    var spellmana 3
    var spelldifficulty 4
    var spellminmana 300
    var spellcapmana 800
  }
  if ("%spelldiffname" = "cac") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 2
    var spellcapmana 50
  }
  if ("%spelldiffname" = "cs") then
  {
    var spellmana 3
    var spelldifficulty 4
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "cotc") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "compost") then
  {
    var spellmana 3
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "cotw") then
  {
    var spellmana 3
    var spelldifficulty 4
    var spellminmana 10
    var spellcapmana 33
  }
  if ("%spelldiffname" = "devi") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 10
    var spellcapmana 66
  }
  if ("%spelldiffname" = "df") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "devi") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 10
    var spellcapmana 66
  }
  if ("%spelldiffname" = "de") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 33
  }
  if ("%spelldiffname" = "ec") then
  {
    var spellmana 3
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 50
  }
  if ("%spelldiffname" = "em") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "etc") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ey") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "fwb") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "griz") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 10
    var spellcapmana 66
  }
  if ("%spelldiffname" = "hol") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "hb") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 3
    var spellcapmana 66
  }
  if ("%spelldiffname" = "inst") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "mon") then
  {
    var spellmana 3
    var spelldifficulty 4
    var spellminmana 300
    var spellcapmana 800
  }
  if ("%spelldiffname" = "oath") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "rits") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "stw") then
  {
    var spellmana 3
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "sott") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "sks") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "stampede") then
  {
    var spellmana 3
    var spelldifficulty 2
    var spellminmana 2
    var spellcapmana 50
  }
  if ("%spelldiffname" = "swarm") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 10
    var spellcapmana 66
  }
  if ("%spelldiffname" = "sk") then
  {
    var spellmana 3
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "wotp") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ws") then
  {
    var spellmana 3
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 100
  }

  #TRADER
  if ("%spelldiffname" = "ars") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 6
    var spellcapmana 31
  }
  if ("%spelldiffname" = "ava") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 10
    var spellcapmana 66
  }
  if ("%spelldiffname" = "blur") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "crd") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 2
    var spellcapmana 50
  }
  if ("%spelldiffname" = "eli") then
  {
    var spellmana 4
    var spelldifficulty 5
    var spellminmana 400
    var spellcapmana 900
  }
  if ("%spelldiffname" = "enrichment") then
  {
    var spellmana 4
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "fin") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "flu") then
  {
    var spellmana 4
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 66
  }
  if ("%spelldiffname" = "ir") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "lgv") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "mom") then
  {
    var spellmana 4
    var spelldifficulty 4
    var spellminmana 5
    var spellcapmana 25
  }
  if ("%spelldiffname" = "meg") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "non") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "nou") then
  {
    var spellmana 4
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "phk") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "rega") then
  {
    var spellmana 4
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "star") then
  {
    var spellmana 4
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "stc") then
  {
    var spellmana 4
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "trc") then
  {
    var spellmana 4
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "turi") then
  {
    var spellmana 4
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }

  #WM
  if ("%spelldiffname" = "aeg") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 300
    var spellcapmana 800
  }
  if ("%spelldiffname" = "ac") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 4
    var spellcapmana 25
  }
  if ("%spelldiffname" = "aethrolysis") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 2
    var spellcapmana 50
  }
  if ("%spelldiffname" = "ab") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ala") then
  {
    var spellmana 1
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 50
  }
  if ("%spelldiffname" = "anc") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "al") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "bg") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "cl") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "db") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ee") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 6
    var spellcapmana 31
  } 
  if ("%spelldiffname" = "etf") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "es") then
  {
    var spellmana 1
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 100
  }
  if ("%spelldiffname" = "fb") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "fr") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 7
    var spellcapmana 37
  }
  if ("%spelldiffname" = "fs") then
  {
    var spellmana 1
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 50
  }
  if ("%spelldiffname" = "foi") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "frs") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 7
    var spellcapmana 50
  }
  if ("%spelldiffname" = "frb") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "gi") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "gz") then
  {
    var spellmana 1
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 50
  }
  if ("%spelldiffname" = "geyser") then
  {
    var spellmana 1
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 50
  }
  if ("%spelldiffname" = "gf") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "ip") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "ignite") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "lb") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 7
    var spellcapmana 50
  }
  if ("%spelldiffname" = "mab") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "mof") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 300
    var spellcapmana 800
  }
  if ("%spelldiffname" = "moa") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "pw") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 7
    var spellcapmana 50
  }
  if ("%spelldiffname" = "rim") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 6
    var spellcapmana 31
  }
  if ("%spelldiffname" = "ros") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 7
    var spellcapmana 37
  }
  if ("%spelldiffname" = "rm") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "shockwave") then
  {
    var spellmana 1
    var spelldifficulty 4
    var spellminmana 30
    var spellcapmana 100
  }
  if ("%spelldiffname" = "sts") then
  {
    var spellmana 1
    var spelldifficulty 1
    var spellminmana 1
    var spellcapmana 50
  }
  if ("%spelldiffname" = "substratum") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "suf") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "sw") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "tw") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  if ("%spelldiffname" = "tc") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 10
    var spellcapmana 66
  }
  if ("%spelldiffname" = "ti") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 33
  }
  if ("%spelldiffname" = "trem") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 10
    var spellcapmana 66
  }
  if ("%spelldiffname" = "voi") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "vertigo") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 5
    var spellcapmana 33
  }
  if ("%spelldiffname" = "wb") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 1
    var spellcapmana 33
  }
  if ("%spelldiffname" = "ys") then
  {
    var spellmana 1
    var spelldifficulty 3
    var spellminmana 15
    var spellcapmana 100
  }
  if ("%spelldiffname" = "zephyr") then
  {
    var spellmana 1
    var spelldifficulty 2
    var spellminmana 5
    var spellcapmana 100
  }
  return






#==============STATUS_CHECKS==============  



STATUSCHECK:
  #DEATH_AND_CONNECTION_CHECKING
  if ($dead = 1) then goto DEADLOGIC
  if ($connected = 0) then gosub CONNECTEDLOGIC
  #MAELDRYTH
  if matchre("$roomobjs", "a maeldryth") then
  {
    put #echo %alertwindow Yellow [GM]: Maeldryth in the area.
    pause .5
    put #play Evil
    pause .5
    put #flash
  }
  #ROOMID_CHECKING
  if (%scriptmode = 1) then
  {
    if ((%autoupkeep = "YES") || (%bugout = "YES")) then
    {
      if $roomid = 0 then
      {
        put #mapper reset
        pause 2
        if $roomid = 0 then
        {
          put #flash
          put #play JustArrived
          put #echo %alertwindow Yellow [Upkeep]: Genie has lost track of your room number!
        }
      }
    }
  }
  #STANDING
  if (%scriptmode = 1) then
  {
    if ($sitting = 1) then gosub STAND
    if ($kneeling = 1) then gosub STAND
    if ($prone = 1) then gosub STAND
  }
  #SCRIPT_AREA_CHECKING_AUTOUPKEEP
  if ((%scriptmode = 1) && (%buffingonly != 1)) then 
  {
    gosub NEWAREADECISION
    gosub NEWAREAMOVEMENT
  }
  #COLLECTAMMO
  if ((%scriptmode = 1) && (%buffingonly != 1) then
  {
    gosub COLLECTINGAMMO
    if %feetcheck = 1 then
    {
      var feetcheck 0
      gosub STOWFEET
    }
  }
  #DEAD_MONSTER
  if ((%scriptmode = 1) && (%buffingonly != 1)) then
  {
    gosub MONTEST
    if %tmdead = 1 then
    {
      if %casting = 1 then
      {
        if %tmcast = 1 then gosub RETARGET
      }
      var tmdead 0
    }
    if %eotbrel = "YES" then
    {
      if $SpellTimer.EyesoftheBlind.active = 1 then
      {
        if %t > %nexteotbrel then
        {
          gosub RELINVIS
          var nexteotbrel %t
          math nexteotbrel add 30
        }
      }
    }
    if %aimready = 1 then gosub FIRE
  }
  #TARGET_SELECTION
  if ((%scriptmode = 1) && (%buffingonly != 1) && (%upkeepactive != 1) && (%noncombatactive != 1)) then
  {
    if (%goodtarget = 0) then
    {
      if ("%avoidshock" = "YES") then gosub TARGETSELECT
      else gosub FACE
    }
  }
  #BUFFING_COMBAT_ONLY
  if (%scriptmode = 1) then 
  {
    if (%buffingonly != 1) then
    {
      #BARBARIAN
      if ("$guild" = "Barbarian") then
      {
        gosub BARBBUFFLOGIC
        gosub BARBROARLOGIC
      }
      #KHRI
      if ("$guild" = "Thief") then
      {
        gosub KHRILOGIC
      }
      #DEVICE_BUFFS       
      gosub DEVICEBUFFLOGIC
    }
  }
  #ALFAR_COMMAND
  if (%alfarcommand = 1) then
  {
    var warriorcommand behavior aggressive
    gosub COMMANDWARRIOR
    var alfarcommand 0
  }
  #TMFOCUS
  if ((%tmfocus = "YES") && (%scriptmode = 1)) then
  {
    if %tmfocusinuse = 1 then
    {
      if (matchre("$righthand", "%tmfocusitem")) then
      else
      {
        gosub STOW right
        gosub GETITEM %tmfocusitem
        gosub TMFOCUSINVOKE
      }
    }
  }
  #SPELL_CANCEL
  if (%scancel = 1) then
  { 
    gosub SPELLCANCEL
  }
  #SPELL_PREPPING
  if (%scriptmode = 1) then gosub MAINSPELLLOGIC
  #CASTING
  if (%casting = 1) then gosub CASTINGLOGIC
  return

AUTOUPKEEPCHECKS:
  #put #echo Yellow auonhealth: %auonhealth
  if ("%auonhealth" = "YES") then
  {
    #put #echo Yellow health: $health <= auhealthnum: %auhealthnum
    if ($health <= %auhealthnum) then
    {
      var goupkeep 1
      var autype health
    }
  }
  #BLEEDING
  if ("%auonbleed" = "YES") then
  {
    if ($bleeding = 1) then
    {
      var autype bleed
      var goupkeep 1
    }
    if (%t > %nextbleed) then gosub BLEEDCHECK
  }
  #BURDEN
  if (%auonburden = "YES") then
  {
    #echo t: %t
    #echo nextburdencheck: %nextburdencheck
    if (%t > %nextburdencheck) then
    {
      gosub BURDENCHECK
      pause 1
      #put #echo Yellow encumbrance: %encumbrance
      #put #echo Yellow auburdennum: %auburdennum
      if (%encumbrance >= %auburdennum) then
      {
        var goupkeep 1
        var autype burden
      }
      var nextburdencheck %t
      math nextburdencheck add 120
    }
  }
  #NERVES_POISON
  if (("%auonnerves" = "YES") || ("%auonpoison" = "YES") || ("%auonfire" = "YES")) then
  {
    if (%t > %nexthealthcheck) then
    {
      var badnerves 0
      var poisoned 0
      var onfire 0
      action (nerves) on
      action (poison) on
      gosub HEALTHCHECK
      pause 1
      action (nerves) off
      action (poison) off
      var nexthealthcheck %t
      math nexthealthcheck add 120
    }
    if ("%auonnerves" = "YES") then
    {
      if (%badnerves = 1) then
      {
        var goupkeep 1
        var autype nerves
        var badnerves 0
      }
    }
    if ("%auonpoison" = "YES") then
    {
      if (%poisoned = 1) then
      {
        var goupkeep 1
        var autype poison
        var poisoned 0
      }
    }
    if ("%auonfire" = "YES") then
    {
      if (%onfire = 1) then
      {
        var goupkeep 1
        var autype fire
        var poisoned 0
      }
    }   
  }
  return

#==============GENERAL_SUBS==============  


EXIT:
  exit


RPLAYERSCRUB:
  eval roomplayers replace("%roomplayers", " who has coalesced into a battle of light and shadow, each warring for dominance", "") 
  eval roomplayers replace("%roomplayers", " and ", ", ")
  eval roomplayers replace("%roomplayers", ", ", "|")
  eval roomplayers replace("%roomplayers", "Also here: ", "")
  eval roomplayers replace("%roomplayers", ".", "")
  eval roomplayers replace("%roomplayers", "a webbed ", "")
  eval roomplayers replace("%roomplayers", " who is hiding", "")
  eval roomplayers replace("%roomplayers", " who is sitting", "")
  eval roomplayers replace("%roomplayers", " who is kneeling", "")
  eval roomplayers replace("%roomplayers", " who is lying down", "")
  eval roomplayers replace("%roomplayers", " who is stunned", "")
  eval roomplayers replace("%roomplayers", " who is immobilized", "")
  eval roomplayers replace("%roomplayers", " who is webbed", "")
  eval roomplayers replace("%roomplayers", " (sitting)", "")
  eval roomplayers replace("%roomplayers", " (kneeling)", "")
  eval roomplayers replace("%roomplayers", " (prone)", "")
  eval roomplayers replace("%roomplayers", " who has a stony visage", "")
  eval roomplayers replace("%roomplayers", " who has a fiery visage", "")
  eval roomplayers replace("%roomplayers", " is surrounded by swirling flames", "")
  eval roomplayers replace("%roomplayers", " who is surrounded by a shimmering shield", "")
  eval roomplayers replace("%roomplayers", " who is darkened by an unnatural shadow", "")
  eval roomplayers replace("%roomplayers", " who is shining with a dark golden glow", "")
  eval roomplayers replace("%roomplayers", " who is shrouded in ghostly flames", "")
  eval roomplayers replace("%roomplayers", " who is shrouded by swirling grey fog", "")
  eval roomplayers replace("%roomplayers", " the body of", "")
  #echo roomplayers: %roomplayers

  #POSTFIX_REMOVAL
  eval roomplayers replacere("%roomplayers", " who (is|has) [A-Za-z\s-]+", "")
  eval roomplayers replacere("%roomplayers", " whose [A-Za-z\s-]+", "")
  #PRETITLE_REMOVAL
  eval roomplayers replace("%roomplayers", "'", ""
  eval roomplayers replacere("%roomplayers", "([A-Za-z]+) ([A-Za-z]+) ([A-Za-z]+) ([A-Z][a-z]+)", "\$4")
  eval roomplayers replacere("%roomplayers", "([A-Za-z]+) ([A-Z][a-z]+)", "\$2")
  eval roomplayers replacere("%roomplayers", "([A-Za-z]+) ([A-Za-z]+) ([A-Z][a-z]+)", "\$3")
  eval roomplayers replacere("%roomplayers", "([A-Za-z]+) ([A-Z][a-z]+)", "\$2")
  #eval roomplayers replacere("%roomplayers", "([A-Z][A-Za-z\s]+) ([A-Za-z]+)", "\$2")
  #eval roomplayers replacere("%roomplayers", "([A-Z][a-z]+) ([A-Z][a-z]+) ([A-Z][a-z]+)", "\$3")
  #eval roomplayers replacere("%roomplayers", "([A-Z][a-z]+) ([A-Z][a-z]+)", "\$2")
  return
	
RPLAYERSORT:
  if %rcounter > %nsafenum then return
  if %rplayernum > 0 then eval roomplayers replace("%roomplayers", "%necrowhitelist(%rcounter)|", "")
  else eval roomplayers replace("%roomplayers", "%necrowhitelist(%rcounter)", "")
  math rcounter add 1
  goto RPLAYERSORT

RETURN:
  delay 0.001
  pause 0.001
  var timeoutcount 0
  return

TIMEOUT:
  if ($dead = 1) then goto DEADLOGIC
  if ($connected = 0) then gosub CONNECTEDLOGIC
  math timeoutcount add 1
  if %timeoutcount >= 1 then 
  {
    var timeouttext %timeoutsub has timed out!  Trying again.  If you see this repeatedly, there is a problem with the script that needs to be addressed.  Input text was "%timeoutcommand".
    if !def(alertwindow) then put #echo Yellow %timeouttext
    else put #echo >$alertwindow Yellow %timeouttext
    put #flash
    put #play JustArrived
    if %timeoutcount >= 10 then
    {
      if ("%bugout" = "YES") then
      {
        goto BUGOUT
      }
    }
	}
	goto %timeoutsub

DEADLOGIC:
  if ("%deathaction" = "logout") then
  {
    put #echo %alertwindow Yellow You are dead!  Logging out!
    put quit
    exit
  }
  else goto DEADWAIT
  
DEADWAIT:
  put #flash
  put #play JustArrived
  pause 4
  goto DEADWAIT

CONNECTEDLOGIC:
  if ("%disconnectaction" = "quit") then
  {
    put #echo %alertwindow Yellow Disconnected!  Quitting.
    put #flash
    put #play JustArrived
    exit
  }
  else goto RECONNECTLOOP
  
RECONNECTLOOP:
  put #connect $characternamedr
  pause 4 
  if ($connected = 1) then return
  pause 30
  goto RECONNECTLOOP


####THIEVERY_SUBS####

BURGLEP:
  pause
BURGLE:
  if (($invisible = 0) && ($hidden = 0)) then gosub HIDE
  matchre BURGLEP \.\.\.wait|type ahead|stunned|while entangled in a web\.|You don't seem to be able to move
  match BURGLEPICKRETURN You make short work of the lock on the window and slip inside.
  match BURGLEATHRETURN You scale up the side of a wall, quickly slipping inside.
  match RETURN With aid from your group, you scale up the side of a wall, quickly disabling the lock on the window and slip inside, leaving a rope for your group to follow.
  match RETURN Before you really realize what's going on, your hands are firmly bound behind you and you are marched off.
  match BURGLENOTOOL And how were you planning to get in?
  match BURGLEBAD You don't see any likely marks in the area.
  put burgle
  matchwait 5
  var timeoutsub BURGLE
  var timeoutcommand burgle
	goto TIMEOUT

BURGLEATHRETURN:
  if ("%burgletoolchosen" = "pick") then
  {
    put #echo %alertwindow Yellow Climbed to burgle when you were meant to use a pick!  Please investigate!
  }
  return
  
BURGLEPICKRETURN:
  if ("%burgletoolchosen" = "rope") then
  {
    put #echo %alertwindow Yellow Picked to burgle when you were meant to use a rope!  Please investigate!
  }
  return

BURGLENOTOOL:
  if (("%burgletoolchosen" = "rope") || ("%burgletoolchosen" = "pick")) then
  {
    put #echo %alertwindow Yellow Failed to burgle because you had no tool!  Turning off burgling.  Please investigate.
    var burgle NO
    put #var burgle NO
  }
  return

BURGLEBAD:
  var justice 0
  return


BURGLESTEALP:
  pause
BURGLESTEAL:
  matchre BURGLESTEALP \.\.\.wait|type ahead|stunned|while entangled in a web\.|You don't seem to be able to move
  match RETURN Roundtime
  matchre RETURN I could not find what you were referring to\.|You've already picked the counter clean\.
  put search %surface
  matchwait


BURGLERECALLP:
  pause
BURGLERECALL:
  matchre BURGLERECALLP \.\.\.wait|type ahead|stunned|while entangled in a web\.|You don't seem to be able to move
  match BURGLERECALLGOOD The heat has died down from your last caper.
  matchre RETURN You should wait at least \d* roisaen for the heat to die down\.
  put burgle recall
  matchwait

BURGLERECALLGOOD:
  if (($Athletics.Ranks >= 1750) && ($Locksmithing.Ranks >= 1750) && ($Thievery.Ranks >= 1750) && ($Stealth.Ranks >= 1750)) then var burgleready 0
  else var burgleready 1
  return


BURGLEEXITP:
  pause
BURGLEEXIT:
  matchre BURGLEEXITP \.\.\.wait|type ahead|stunned|while entangled in a web\.|You don't seem to be able to move
  match RETURN You take a moment to reflect on the caper you just pulled as you slip out the kitchen window...
  match RETURN Just as you get clear of the window, you see a guard approaching.  Too late now.
  put go window
  matchwait


MARKP:
  pause
MARK:
  matchre MARKP %waitstring
  matchre RETURN Roundtime
  put mark %stealitem
  matchwait 5
	var timeoutsub DEPOSITCOIN
  var timeoutcommand mark %stealitem
	goto TIMEOUT


STEALP:
	pause
STEAL:
  matchre STEALP %waitstring
	matchre RETURN Roundtime 
	put steal %stealitem
	matchwait 5
	var timeoutsub DEPOSITCOIN
  var timeoutcommand steal %stealitem
	goto TIMEOUT


TOUCHVELA:
  var touchvelastring $0
  goto TOUCHVELAMAIN
TOUCHVELAP:
  pause
TOUCHVELAMAIN:
  match TOUCHVELAP %waitstring
  match RETURN You reach out to touch
  match RETURN You feel a brief flare of warmth where your skin previously made contact with a healing plant.
  match RETURN As you reach for the thicket you feel a brief flare of warmth where your skin previously made contact with a healing plant.
  put touch %touchvelastring
  matchwait 5
	var timeoutsub TOUCHVELAMAIN
  var timeoutcommand mark %stealitem
	goto TIMEOUT


#####ITEM_HANDLING_SUBS#####
ACTIVEWEAPONS:
  var activeweaponlist
  var activeweaponscount 1
  goto ACTIVEWEAPONSLOOP
  
ACTIVEWEAPONSLOOP:
  if %weaponnum < %activeweaponscount then return
  if %activeweaponscount =  1 then
  {
    eval tempawl tolower(%weapon1)
    var activeweaponslist |%tempawl|
  }
  else 
  {
    eval tempawl tolower(%weapon%activeweaponscount)
    var activeweaponslist %activeweaponslist%tempawl|
  }
  math activeweaponscount add 1
  goto ACTIVEWEAPONSLOOP

AMMOGET:
  var ammogetstring $0
  goto AMMOGETMAIN

AMMOGETMAINP:
	pause
AMMOGETMAIN:
  #put #echo roomobjs: $roomobjs
  #put #echo ubowammo: %ubowammo
  if matchre ("$roomobjs", "\b%ubowammo\b") then
  {
	  matchre AMMOGETMAINP %waitstring
	  matchre AMMOGETMAIN You pick up|You pull a|out of the pile of rubble.|You pull a small rock out|You fade in|You put your
	  matchre RETURN You must unload|You stop as you realize the|Stow what?|You stop as|What were you referring to?
	  match AMMOGETINJURED You can't pick that up with your hands that damaged.
	  match AMMOGETINJURED You can't pick that up with your hand that damaged.
	  matchre AMMOGETBAD You need a free hand to pick that up.
	  put stow %ammogetstring
	  matchwait 5
	  var timeoutsub AMMOGETMAIN
	  var timeoutcommand stow %ammogetstring
	  goto TIMEOUT
	}
	else return

AMMOGETINJURED:
  if ("%autoupkeep" = "YES") then
  {
    var goupkeep 1
    var autype wounds
  }
  else
  {
    put #echo >$alertwindow Yellow Tried to stow %ammogetstring hand, but you're too injured!  Please address!
    put #flash
    put #play Advance
    if ("%bugout" = "YES") then goto BUGOUT
    else goto AMMOGETINJURED2
  }
  return

AMMOGETINJURED2:
  put #echo Yellow ===FAILED TO STOW %ammogetstring DUE TO WOUNDS!===
  put #flash
  put #play Advance
  pause 5
  goto AMMOGETINJURED2

AMMOGETBAD:
  gosub STOW left
  goto AMMOGETMAIN


BUYAMMOLOOP:
  var buyammo $0
  goto BUYAMMOLOOPMAIN
BUYAMMOLOOPMAIN:
  gosub BUY %buyammo
  gosub STOWALL
  gosub COUNTITEM my %buyammo
  #echo %countitemtotal %buyammos.
  if (%countitemtotal >= %ammomin) then return
  goto BUYAMMOLOOPMAIN

BUYAMMOLOOP2:
  var buyammotype $0
  goto BUYAMMOLOOP2MAIN
BUYAMMOLOOP2MAIN:
  echo buyammotype: %buyammotype
  echo %%buyammotypetotalcount >= %ammomin
  if (%%buyammotypetotalcount >= %ammomin) then return
  gosub BUY %%buyammotypeammo
  var boughtammo 1
  gosub STOWALL
  gosub AMMOCOUNTTOTAL
  

  goto BUYAMMOLOOP2MAIN

BUY:
  var buytarget $0
  goto BUYMAIN
BUYP:
  pause
BUYMAIN:
  matchre BUYP %waitstring
  match BUYP Ragge exclaims, "Slow down!  Slow down!  Do you see any Halfling assistants in the shop?  I can only process one order at a time."
  matchre RETURN Brother Durantine nods slowly|Friar Othorp grins broadly|Sister Nongwen smiles and nods|Sister Imadrail smiles and nods|The sales clerk hands you your
  matchre BUYOFFER Ragge sighs.  "Despite the rarity of this lockpick, I'm prepared to offer it to you for (\d+) kronars\."
  matchre BUYOFFER Kilam says, "I'll give that to you for (\d+) dokoras\."
  matchre BUYOFFER Ss'Thran smiles, baring his fangs. "Ahh, the lockpick\.  That'll cost you (\d+) lirums\."
  match RETURN You realize you don't have that much.
  matchre BUYOTHER That .* is not for sale\.
  put order %buytarget
  matchwait 5
	var timeoutsub BUY
  var timeoutcommand order %buytarget
	goto TIMEOUT

BUYOFFER:
  var offeramount $1
  goto BUYOFFERMAIN

BUYOTHER:
  var buytarget other %buytarget
  goto BUYMAIN
  
BUYOFFERMAINP:
  pause
BUYOFFERMAIN:
  matchre BUYOFFERMAINP %waitstring
  match RETURN Ragge hands over your lockpick.
  match RETURN Kilam hands over your purchase.
  match RETURN Ss'Thran hands you
  matchre RETURN ^(\w+) hands over your .*\.
  put offer $1
  matchwait
  return

BUNDLEPULLP:
  pause
BUNDLEPULL:
  matchre BUNDLEPULLP %waitstring
  matchre WEARITEM You adjust the ropes of your
  put pull my bundle
  matchwait 5
  var timeoutsub BUNDLEPULL
  var timeoutcommand pull my bundle
	goto TIMEOUT


CLOSEITEM:
  var closeitemstring $0
  goto CLOSEITEMMAIN
CLOSEITEMP:
  pause
CLOSEITEMMAIN:
  matchre CLOSEITEMP %waitstring
  matchre RETURN What were you referring to?|You close your|That is already closed\.
  put close %closeitemstring
  matchwait 5
	var timeoutsub CLOSEITEMMAIN
	var timeoutcommand close %closeitemstring
	goto TIMEOUT


COILROPEP:
  pause
COILROPE:
  matchre COILROPEP %waitstring
  match RETURN You can't do that.
  match RETURN You coil up your rope.
  match RETURN What were you referring to?
  put coil heavy rope
  matchwait 5
  var timeoutsub COILROPE
  var timeoutcommand coil heavy rope
	goto TIMEOUT

COLLECTINGAMMO:
  #put #echo Yellow activeweaponslist: %activeweaponslist
  if %collectammo = "YES" then
  {
    if contains("%activeweaponslist", "|bow|") then
    {
      if matchre ("$roomobjs", "%bowammo") then
      {
        gosub AMMOGET %bowammo
      }
    }
    if contains("%activeweaponslist", "|xbow|") then
    {
      if matchre ("$roomobjs", "%xbowammo") then
      {
        gosub AMMOGET %xbowammo
      }
    }
    if contains("%activeweaponslist", "|sling|") then
    {
      if matchre ("$roomobjs", "%slingammo") then
      {
        gosub AMMOGET %slingammo
      }
    }
  }
  if contains("%activeweaponslist", "|ht|") then
  {
    if matchre ("$roomobjs", "%htweapon") then
    {
      if %htbond = "YES" then put invoke bond
      else
      {
        gosub GETITEM %htweapon 
      }
    }
  }
  if contains("%activeweaponslist", "|lt|") then
  {
    if matchre ("$roomobjs", "%ltweapon") then
    {  
      if %ltbond = "YES" then put invoke bond
      else
      {
        gosub GETITEM %ltweapon 
      }
    }
  }
  return

COINWITHDRAWP:
	pause
COINWITHDRAW:
	matchre COINWITHDRAWP %waitstring
	matchre RETURN ^The clerk counts out
	put withdraw $0
	matchwait 5
	var timeoutsub COINWITHDRAW
  var timeoutcommand withdraw $0
	goto TIMEOUT
	

DEPOSITCOINP:
	pause
DEPOSITCOIN:
	matchre DEPOSITCOINP %waitstring
	matchre RETURN You find your jar with little effort, thankfully, and drop your coins inside
	put deposit %depositamount
	matchwait 5
	var timeoutsub DEPOSITCOIN
  var timeoutcommand deposit %depositamount
	goto TIMEOUT
	

DROPITEM:
  var dropitemstring $0
  goto DROPITEMMAIN
DROPITEMP:
	pause
DROPITEMMAIN:
	matchre DROPITEMP %waitstring
	match DROPLOWER Trying to go unnoticed, are you?
	match DROPLOWER Doing that would give away your hiding place!
  match DROPITEMMAIN Whoah!
  match DROPITEMTHROW You really shouldn't litter.  If you wish to discard the
	matchre RETURN What were you referring to?|You drop|You wince as the|You spread|You drop your
	put drop my %dropitemstring
	matchwait 5
	var timeoutsub DROPITEMMAIN
	var timeoutcommand drop my %dropitemstring
	goto TIMEOUT
	
DROPUNHIDE:
  gosub UNHIDE
  goto DROPITEMMAIN

DROPLOWER:
	gosub LOWERITEM %dropitemstring
	gosub EMPTYFEET
	return

DROPITEMTHROW:
  gosub THROWITEM %dropitemstring
  return


THROWITEM:
  var throwitemstring $0
  goto THROWITEMMAIN
THROWITEMP:
  pause
THROWITEMMAIN:
  match THROWITEMP %waitstring
  match RETURN You throw away your
  match RETURN I could not find what you were referring to.
  match THROWITEMOPEN It's not even open!  Are you really sure nothing is still inside?
  put throw %throwitemstring
  matchwait 5
	var timeoutsub THROWITEMMAIN
	var timeoutcommand drop my %throwitemstring
	goto TIMEOUT

THROWITEMOPEN:
  gosub OPENITEM my %throwitemstring
  goto THROWITEMMAIN


DUMPITEM:
  var dumpitemstring $0
  goto DUMPITEMMAIN
DUMPITEMMAIN:
	if matchre ("$roomobjs", "(bucket|large stone turtle|disposal bin|waste bin|tree hollow|oak crate|firewood bin|ivory urn|pit|trash receptacle|marble statue|waste basket)") then
	{
	  gosub PUTITEM %dumpitemstring in $1
	}
	else gosub DROPITEM %dumpitemstring
  return

EMPTYFEETP:
  pause
EMPTYFEET:
  matchre EMPTYFEETP %waitstring
  match EMPTYFEET You consider kicking the contents at your feet onto the ground.
	matchre RETURN You kick .* onto the ground in front of you\.|But there's nothing at your feet\!
	put empty feet
	matchwait 5
	var timeoutsub EMPTYFEET
	var timeoutcommand empty feet
	goto TIMEOUT

GETITEM:
  var getitemstring $0
  goto GETITEMMAIN
GETITEMP:
  pause
GETITEMMAIN:
  matchre GETITEMP %waitstring|You don't seem to be able to moveYou grab hold|You try to grab your
  matchre GETUNTIE You pull at it, but the ties prevent you.  Maybe if you untie it, first?|You should untie the
  matchre RETURN You get|You're already holding|You are already holding that.|You pick up|What were you referring to?|You stop as you realize|You must unload|You fade in for a moment|You remove|You pull|What were you referring to?|You try to grab your|Please rephrase that command\.|You are already holding that\.|You deftly remove the
  match RETURN Get what?
  match RETURN You reach for your sack and retrieve the equipment stored inside.
  matchre GETINJURED ^You can't pick that up with your (hand|hands) that damaged\.
  matchre GETITEMBAD You need a free hand to pick that up.
  matchre GETCLIMBPRACBAD You should stop practicing 
  matchre GETITEMADV Sheesh, it's still alive! 
  match GETITEMREM But that is already in your inventory.
  matchre GETITEMPLAYSTOP You should stop playing before you do that\.|You are a bit too busy performing to do that\.
  put get %getitemstring
  matchwait 5
  var timeoutsub GETITEMMAIN
	var timeoutcommand get %getitemstring
	goto TIMEOUT

GETINJURED:
  if ("%autoupkeep" = "YES") then
  {
    var goupkeep 1
    var autype wounds
  }
  else
  {
    put #echo >$alertwindow Yellow Tried to get %getitemstring hand, but it's too heavy or you're too injured!  Please address!
    put #flash
    put #play Advance
    if ("%bugout" = "YES") then goto BUGOUT
    else goto GETINJURED2
  }
  return

GETINJURED2:
  put #echo Yellow ===FAILED TO GET %getitemstring DUE TO WOUNDS!===
  put #flash
  put #play Advance
  pause 5
  goto GETINJURED2
 
GETUNTIE:
  gosub UNTIEITEM %getitemstring
  return

GETITEMREM:
  gosub REMITEM %getitemstring
  return
 
GETITEMPLAYSTOP:
  gosub PLAYSTOP
  goto GETITEMMAIN

GETCLIMBPRACBAD:
  pause 10
  goto GETITEM
  
GETITEMADV:  
  gosub ADV
  goto GETITEMMAIN

GETITEMBAD:
  gosub STOW left
  goto GETITEMMAIN

LOWERITEM:
  var loweritemstring $0
  var lowereditem -1
  goto LOWERITEMMAIN
LOWERITEMP:
  pause
LOWERITEMMAIN:
  matchre LOWERITEMP %waitstring
  matchre LOWERRETURN What did you want to lower\?
  matchre LOWERSUCCESS You lower the (.*) and place it on the ground at your feet\.
  put lower my %loweritemstring ground
  matchwait 5
	var timeoutsub LOWERITEMMAIN
	var timeoutcommand lower %loweritemstring ground
	goto TIMEOUT

LOWERRETURN:
  var lowereditem 0
  return

LOWERSUCCESS:
  var lowereditem %loweritemstring
  return

OPENITEM:
  var openitemstring $0
  goto OPENITEMMAIN
OPENITEMP:
  pause
OPENITEMMAIN:
  matchre OPENITEMP %waitstring
  matchre RETURN That is already open\.|You open|The green sack feels momentarily heavier as you open it\.
  put open %openitemstring
  matchwait 5
	var timeoutsub OPENITEMMAIN
	var timeoutcommand open %openitemstring
	goto TIMEOUT

PLATRINGP:
  pause
PLATRING:
  matchre PLATRINGP %waitstring
  matchre RETURN You touch your platinum ring
  match PLATRINGLP The magical energy within your platinum ring
  put touch platinum ring
  matchwait 5
  var timeoutsub PLATRING
  var timeoutcommand touch platinum ring
	goto TIMEOUT

PLATRINGLP:
  pause 10
  goto PLATRING  

PUTITEM:
  var putitemstring $0
  var putsucceed 0
  goto PUTITEMMAIN
PUTITEMP:
	pause
PUTITEMMAIN:
	matchre PUTITEMP %waitstring
	matchre RETURN What were you referring to?|Perhaps you should be holding that first.|There doesn't seem to be any more room left|is too long, even after stuffing it, to fit in the|There isn't any more room in|But that's closed\.|You just can't get the .* to fit in the \w*, no matter how you arrange it\.|Perhaps you should be holding that first\.|is too long to fit in the|already has as many lockpicks in it as you can get to fit\.|That is far too hot to touch\!|As you attempt to place your
	matchre PUTRETURN You put|You drop|You briefly twist the top off of|Raffle Attendant Tizzeg examines your ticket and exclaims|A bored-looking Human boy says
	match PUTITEMSTOW There's no room in the
	match RETURN That's too heavy to go in there!
	matchre RETURN You just can't get the .* to fit in the .*\, no matter how you arrange it\.
  matchre PUTITEMSTOW A bored-looking Human boy raises an eyebrow in your direction.
  matchre RETURN The anvil already has a \w+ ingot on it\.
	put put %putitemstring
	matchwait 5
	var timeoutsub PUTITEMMAIN
  var timeoutcommand put %putitemstring
	goto TIMEOUT

PUTRETURN:
  var putsucceed 1
  return

PUTITEMSTOW:
  gosub STOWITEM %remitemstring
  return
  
REMITEM:
  var remitemstring $0
  goto REMITEMMAIN
REMITEMP:
  pause
REMITEMMAIN:
  matchre REMITEMP %waitstring
  matchre RETURN You sling|You remove|You pull off|You work your way|You loosen|Remove what?|You slide|You take|You aren't wearing that\.|You detach
  match REMOVESTOW You need a free hand for that.
  put remove %remitemstring
  matchwait 5
  var timeoutsub REMITEMMAIN
  var timeoutcommand remove %remitemstring
  goto TIMEOUT

REMOVESTOW:
  gosub STOWALL
  goto REMITEMMAIN

RUMMAGE:
  var rummagestring $0
  goto RUMMAGEMAIN
RUMMAGEP:
  pause
RUMMAGEMAIN:
  matchre RUMMAGEP %waitstring
  matchre RETURN I don't know what you are referring to.|You rummage|While it's closed?
  put rummage %rummagestring
	matchwait 5
	var timeoutsub RUMMAGEMAIN
  var timeoutcommand rummage %rummagestring
	goto TIMEOUT

SHEATHEHAND:
  var sheathehandstring $0
  goto SHEATHEHANDMAIN
SHEATHEHANDP:
  pause
SHEATHEHANDMAIN:
  matchre SHEATHEHANDP %waitstring
  matchre SHEATHEBAD ^Sheathe your .* where\?$|There's no room in the
  matchre RETURN Sheathe what?|You sheathe|You hang|You secure|You easily strap|Sheathing a
  matchre SHEATHEUNLOAD You should unload the .* first\.
  if ("%sheathehandstring" = "right") then var sheatheitemstring $righthandnoun
  else var sheatheitemstring $lefthandnoun
  put sheathe %sheatheitemstring
  matchwait 5
  var timeoutsub SHEATHEHANDMAIN
  var timeoutcommand %sheatheitemstring
	goto TIMEOUT

SHEATHEBAD:
  var cleanstow 1
  if ("%stowhand" = "right") then gosub STOWITEM $righthandnoun
  else gosub STOWITEM $lefthandnoun
  gosub STOWITEM
  return

SHEATHEUNLOAD:
  if (matchre("%sheatheitemstring", "$lefthand")) then
  {
    if ("$righthand" != "Empty") then
    {
      gosub TAPSHORTEN $righthand
      gosub STOWITEM my %shorttap
    }
  }
  else
  {
    if ("$lefthand" != "Empty") then
    {
      gosub TAPSHORTEN $lefthand
      gosub STOWITEM my %shorttap
    }
  }
  gosub UNLOAD
  gosub STOWALL
  return

SLIPITEMP:
	pause
SLIPITEM:
	matchre SLIPITEMP %waitstring
	matchre RETURN You silently slip|You put
	put slip my %putitemname in %putlocation
	matchwait 5
	var timeoutsub SLIPITEM
	var timeoutcommand slip my %putitemname in %putlocation
	goto TIMEOUT


STOREDEFAULT:
  var storedefaultsuccess 0
  var storedefaultitemstring $0
  goto STOREDEFAULTMAIN
STOREDEFAULTP:
  pause
STOREDEFAULTMAIN:
  matchre STOREDEFAULTP %waitstring
  matchre STOREDEFAULTGOOD You will now use your .* to store any items you haven't categorized\.
  match RETURN I could not find that container.
  put store default %storedefaultitemstring
  matchwait 5
	var timeoutsub STOREDEFAULT
	var timeoutcommand store default %storedefaultitemstring
	goto TIMEOUT

STOREDEFAULTGOOD:
  var storedefaultsuccess 1
  return

STORE:
  var storestring $0
  goto STOREMAIN
STOREP:
  pause
STOREMAIN:
	matchre STOREP %waitstring
	match RETURN You will now store gems in your gem pouch.
  match RETURN I could not find that container.
  put store %storestring
  matchwait 5
  var timeoutsub STOREMAIN
  var timeoutcommand store %storestring
	goto TIMEOUT

STOW:
  var stowsucceed 0
  var stowhandstring $0
  goto STOWMAIN
STOWP:
  pause
STOWMAIN:
  if ("%stowhandstring" = "left") then
  {
    if ("$lefthand" = "Empty") then return
  }
  if ("%stowhandstring" = "right") then
  {
    if ("$righthand" = "Empty") then return
  }
  if (%cleanstow != 1) then
  {
    var stowcustomsuccess 0
    gosub STOWCUSTOM $%stowhandstringhand
    if %stowcustomsuccess = 1 then return
  }
  var cleanstow 0
  matchre STOWP %waitstring
  matchre STOWFAIL ^That's too heavy to go in there\!|^There isn't any more room in the \w+ for that\.|^There's no room in the \w+\.
  matchre STOWSKINBAD You try to stuff your
  matchre STOWGEMBAD You think the .* pouch is too full to fit another gem into\.
  matchre STOWUNLOAD ^You need to unload|^You should unload the .* first\.$
  match STOWSTOPPLAY You should stop playing before you do that.
  matchre STOWCOIL The \S+ rope is too long, even after stuffing it, to fit in the
  matchre RETURN You put your|Stow what\?|You open your pouch|You stop as|What were you referring to?|You think the gem pouch|You stop as you realize|You easily strap your
  match STOWINJURED You can't pick that up with your hands that damaged.
  put stow %stowhandstring
  matchwait 5
  var timeoutsub STOWMAIN
  var timeoutcommand stow %stowhandstring
	goto TIMEOUT

STOWINJURED:
  if ("%autoupkeep" = "YES") then
  {
    var goupkeep 1
    var autype wounds
  }
  else
  {
    put #echo >$alertwindow Yellow Tried to stow %stowhandstring hand, but you're too injured!  Please address!
    put #flash
    put #play Advance
    if ("%bugout" = "YES") then goto BUGOUT
    else goto STOWINJURED2
  }
  return

STOWINJURED2:
  put #echo Yellow ===FAILED TO STOW %stowhandstring DUE TO WOUNDS!===
  put #flash
  put #play Advance
  pause 5
  goto STOWINJURED2

STOWFAIL:
  gosub DEEPSLEEP
  put #echo >$alertwindow Yellow Tried to stow %stowhandstring hand, but it's too heavy or unable to fit!  Please address!
  put #flash
  put #play Advance
  if ("%bugout" = "YES") then
  {
    if (%buggingout = 1) then return
    var bugoutnostow 1
    goto BUGOUT
  }
  else goto STOWFAIL2

STOWFAIL2:
  put #echo Yellow ===FAILED TO STOW %stowhandstring HAND!===
  put #flash
  put #play Advance
  pause 5
  goto STOWFAIL2

STOWUNLOADP:
  pause
STOWUNLOAD:
  if ("%stowhandstring" = "left") then
  {
    if ("$righthand" != "Empty") then
    {
      gosub TAPSHORTEN $righthand
      gosub STOWITEM my %shorttap
    }
  }
  else
  {
    if ("$lefthand" != "Empty") then
    {
      gosub TAPSHORTEN $lefthand
      gosub STOWITEM my %shorttap
    }
  }
  gosub UNLOAD
  gosub STOWALL
  return

STOWCOIL:
  gosub COILROPE
  goto STOW

STOWGEMBAD:
  if (%stowhandstring = "right") then gosub DUMPITEM $righthandnoun
  else gosub DUMPITEM $lefthandnoun
  return

STOWSKINBAD:
  if (%stowhandstring = "right") then gosub DUMPITEM $righthandnoun
  else gosub DUMPITEM $lefthandnoun
  return

STOWSTOPPLAY:
  gosub PLAYSTOP
  goto STOWMAIN

STOWFEETP:
  pause
STOWFEET:
  matchre STOWFEETP %waitstring
  match STOWFEET You pick up
  match RETURN Stow what?
  match STOWFEETFULL You need a free hand to pick that up.
  put stow feet  
  matchwait 5
  var timeoutsub STOWFEET
  var timeoutcommand stow feet
	goto TIMEOUT
  
STOWFEETFULL:
  gosub STOWALL
  goto STOWFEET
  
STOWCUSTOM:
  var stowcustomstring $0
  if matchre ("%stowcustomstring", "%tomeofloreitem") then 
  {
    var tomeofloreready 1
  }
  if matchre ("%stowcustomstring", "%monsterskins") then
  {
    gosub BUNDLE
    return
  }
  if %platring = "YES" then
  {
    if matchre ("%stowcustomstring", "%platringitem") then
    {
      if %stowhandstring = "left" then gosub SWAP
      gosub PLATRING
      var stowcustomsuccess 1
      return
    }
  }
  if matchre ("%stowcustomstring", "%cambitem1") then
  {
    if %cambitem1worn = "YES" then
    {
      gosub WEARITEM %cambitem1
      var stowcustomsuccess 1
      return
    }
  }
  if matchre ("%stowcustomstring", "%cambitem2") then
  {
    if %cambitem2worn = "YES" then
    {
      gosub WEARITEM %cambitem2
      var stowcustomsuccess 1
      return
    }
  }
  if matchre ("%stowcustomstring", "%bowweapon") then 
  {
    if %bowworn = "YES" then
    {
      gosub WEARITEM %bowweapon
      var stowcustomsuccess 1
      return
    }
  }
  if matchre ("%stowcustomstring", "%xbowweapon") then
  {
    if %xbowworn = "YES" then
    {
      gosub WEARITEM %xbowweapon
      var stowcustomsuccess 1
      return
    }
    return
  }
  if matchre ("%stowcustomstring", "%poleweapon") then
  {
    if %poleworn = "YES" then
    {
      gosub WEARITEM %poleweapon
      var stowcustomsuccess 1
      return
    }
    if %poletied = "YES" then
    {
      var wearitemname %poleweapon
      gosub TIEITEM
      var stowcustomsuccess 1
      return
    }
  }
  if matchre ("%stowcustomstring", "%staveweapon") then
  {
    if %staveworn = "YES" then
    {
      gosub WEARITEM %staveweapon
      var stowcustomsuccess 1
      return
    }
    if %stavetied = "YES" then
    {
      var wearitemname %staveweapon
      gosub TIEITEM
      var stowcustomsuccess 1
      return
    }
  }
  if %ritualfocusstorage = "YES" then
  {
    if matchre ("%stowcustomstring", "%ritualfocus") then
    {
      gosub PUTITEM my %ritualfocus in my %ritualfocuscontainer
      var stowcustomsuccess 1
      return
    }
  }
  if %ritualfocusworn = "YES" then
  {
    if matchre ("%stowcustomstring", "%ritualfocus") then
    {
      gosub WEARITEM %ritualfocus
      var stowcustomsuccess 1
      return
    }
  }
  if %tmfocusstorage = "YES" then
  {
    if matchre ("%stowcustomstring", "%tmfocusitem") then
    {
      gosub PUTITEM my %tmfocusitem in my %tmfocuscontainer
      var stowcustomsuccess 1
      return
    }
  }
  if %tmfocusworn = "YES" then
  {
    if matchre ("%stowcustomstring", "%tmfocus") then
    {
      gosub WEARITEM %tmfocusitem
      var stowcustomsuccess 1
      return     
    }
  }
  if matchre ("%stowcustomstring", "%wand1item") then
  {
    gosub PUTITEM my %wand1item in my %wandstorage
    var stowcustomsuccess 1
    return
  }
  if matchre ("%stowcustomstring", "%wand2item") then
  {
    gosub PUTITEM my %wand2item in my %wandstorage
    var stowcustomsuccess 1
    return
  }
  if matchre ("%stowcustomstring", "%nonwornweapons") then
  {
    gosub SHEATHEHAND %stowhandstring
    var stowcustomsuccess 1
    return
  }
  return
  
STOWALL:
  #echo lefthand: $lefthand
  if ("$lefthand" != "Empty") then
  {
    gosub STOW left
  }
  #echo righthand: $righthand
  if ("$righthand" != "Empty") then
  {
    gosub STOW right
  }
  return

STOWITEM:
  var stowsucceed 0
  var stowitemstring $0
  goto STOWITEMMAIN
STOWITEMP:
  pause
STOWITEMMAIN:
  if (%cleanstow != 1) then
  {
    var stowcustomsuccess 0
    gosub STOWCUSTOM %stowitemstring
    if (%stowcustomsuccess = 1) then return
  }
  var cleanstow 0
  matchre STOWITEMP %waitstring
  match STOWITEMSTOPPLAY You should stop playing before you do that.
  matchre STOWITEMFAIL ^That's too heavy to go in there\!|^There isn't any more room in the \w+ for that\.|^There's no room in the \w+\.
  matchre STOWRETURN You put your|You sling|You attach|You open your pouch|You stop as
  matchre STOWITEMINJURED You can't pick that up with your (hand|hands) that damaged.
  match RETURN Stow what?  Type 'STOW HELP' for details.
  matchre STOWITEMUNLOAD ^You should unload the .* first\.$
  match STOWITEMMAINFULL You need a free hand to pick that up.
  put stow %stowitemstring
  matchwait 5
  var timeoutsub STOWITEMMAIN
  var timeoutcommand stow %stowitemstring
	goto TIMEOUT

STOWRETURN:
  var stowsucceed 1
  return

STOWITEMSTOPPLAY:
  gosub PLAYSTOP
  goto STOWITEMMAIN

STOWITEMINJURED:
  if ("%autoupkeep" = "YES") then
  {
    var goupkeep 1
    var autype wounds
  }
  else
  {
    put #echo >$alertwindow Yellow Tried to stow %stowitemstring hand, but you're too injured!  Please address!
    put #flash
    put #play Advance
    if ("%bugout" = "YES") then goto BUGOUT
    else goto STOWITEMINJURED2
  }
  return

STOWITEMINJURED2:
  put #echo Yellow ===FAILED TO STOW %stowitemstring DUE TO WOUNDS!===
  put #flash
  put #play Advance
  pause 5
  goto STOWITEMINJURED2

STOWITEMFAIL:
  if (($righthand = "tight bundle") || ($lefthand = "tight bundle")) then
  {
    if ("%autoupkeep" = "YES") then
    { 
      gosub WEARITEM my tight bundle
      var goupkeep 1
      var autype bundle
      return
    }
  }
  gosub DEEPSLEEP
  put #echo >$alertwindow Yellow Tried to stow %stowitemstring, but failed because it's too heavy or won't fit!  Please address!
  put #flash
  put #play Advance
  if ("%bugout" = "YES") then
  {
    if (%buggingout = 1) then return
    var bugoutnostow 1
    goto BUGOUT
  }
  else goto STOWITEMFAIL2

STOWITEMFAIL2:
  put #echo Yellow ===FAILED TO STOW %stowitemstring!===
  put #flash
  put #play Advance
  pause 5
  goto STOWITEMFAIL2

STOWITEMUNLOAD:
  if (matchre("%stowitemstring", "$lefthand")) then
  {
    if ("$righthand" != "Empty") then
    {
      gosub TAPSHORTEN $righthand
      gosub STOWITEM my %shorttap
    }
  }
  else
  {
    if ("$lefthand" != "Empty") then
    {
      gosub TAPSHORTEN $lefthand
      gosub STOWITEM my %shorttap
    }
  }
  gosub UNLOAD
  gosub STOWALL
  return


STOWITEMMAINFULL:
  gosub STOW left
  goto STOWITEMMAIN

SWAPP:
  pause
SWAP:
  matchre SWAPP %waitstring
  match RETURN You move
  match RETURN You have nothing to swap!
  matchre SWAPINJURED Your (right|left) hand is too injured to do that\.
  matchre SWAPINJURED Excruciating pain swells up inside you as your maimed limbs fail you.
  matchre SWAPNERVES Will alone cannot conquer the paralysis that has wracked your body\.
  put swap
  matchwait 5
  var timeoutsub SWAP
  var timeoutcommand swap
	goto TIMEOUT

SWAPINJURED:
  if ("%autoupkeep" = "YES") then
  {
    var goupkeep 1
    var autype wounds
  }
  else
  {
    if ("%bugout" = "YES") then goto BUGOUT
    else goto SWAPTOOINJURED
  }
  return

SWAPNERVES:
  if ("%autoupkeep" = "YES") then
  {
    var goupkeep 1
    var autype nerves
  }
  else
  {
    if ("%bugout" = "YES") then
    {
      put #echo >$alertwindow Yellow Tried to swap weapons, but you're too injured!  Please address!
      goto BUGOUT
    }
    else goto SWAPTOOINJURED
  }

SWAPTOOINJURED:
  echo ===TOO INJURED TO SWAP WEAPON===
  put #flash
  put #play Advance
  pause 5
  goto SWAPTOOINJURED
  return

FINDITEM:
  var finditemitem $0
  var finditemfound 0
  goto FINDITEMMAIN
FINDITEMP:
  pause
FINDITEMMAIN:
  matchre FINDITEMP %waitstring
  matchre FINDITEMGOOD ^You tap .* that you are wearing\.|^A faltering wisp of light dances around you, bubbling out a token amount of water\.  The .* needs more time to build up a charge\.|^A ribbon of light darts around you, leaving a trail of elemental water in its wake\.  It quckly forms a pressurized sphere of water that explodes outward\!
  matchre RETURN ^I could not find what you were referring to\.|^You tap .* that you are holding\.|^You tap .* inside your .*\.|^I don't think that's such a good idea\.|^Tap what\?|I could not find that container\.
  put tap my %finditemitem
  matchwait 5
  var timeoutsub FINDITEM
  var timeoutcommand tap my %finditemitem
	goto TIMEOUT

FINDITEMGOOD:
  var finditemfound 1
  return

WEARARMOR:
  var weararmoritem $0
  var weararmorworn 0
  goto WEARARMORMAIN
WEARARMORP:
  pause
WEARARMORMAIN:
  if ("%weararmoritem" = "none") then goto WEARARMORGOOD
  matchre WEARARMORP %waitstring
  matchre WEARARMORGOOD ^You slide|^You put|^You slip|^You work
  match WEARARMORGOOD You are already wearing that.
  matchre RETURN ^I could not find what you were referring to\.|^Wear what\?
  put wear my %weararmoritem
  matchwait 5
  var timeoutsub WEARARMOR
  var timeoutcommand wear my %weararmoritem
	goto TIMEOUT

WEARARMORGOOD:
  var weararmorworn 1
  return
  

TIEITEMP:
  pause
TIEITEM:
  matchre TIEITEMP %waitstring
  matchre STUDYCONTAINER There's no more room on
  matchre TIEUNHIDE That would give away your hiding place!
  matchre RETURN Sheathing a|You attach
  put tie %wearitemname to my %storage
  matchwait 5
  var timeoutsub TIEITEM
  var timeoutcommand tie %wearitemname to my %storage
	goto TIMEOUT
  
TIEUNHIDE:
  gosub UNHIDE
  goto TIEITEM

STUDYCONTAINER:
  put study %storage
  goto TIEITEM

SELLITEM:
  var sellstring $0
  goto SELLITEMMAIN
SELLITEMP:
  pause
SELLITEMMAIN:
  matchre SELLITEMP %waitstring
  matchre RETURN You ask|You hold up your|There is no merchant here to buy that\.|Sell what?|^.* takes your|Cormyn whistles and says|Relf briefly glances at|\S+ shakes his head and says|Tanner Falken waggles his eyebrows and looks puzzled\.
  #|Please rephrase that command\.
  match SELLITEMWAIT There doesn't seem to be anyone around.
  match SELLITEMDUMP Aelik whistles and says, "There's folk around 
  matchre SELLITEMDUMP ^\S+ glances at your \S+\.  "Looks like you've got stuff in there," he says\.  "I only deal in one item at a time\."
  match SELLITEMDUMP Aelik scowls and says, "You'll want to empty that first.  For all I know you've put some curse on the contents or stuffed it full of stolen goods!"
  match SELLITEMDUMP "Of all the idiots... EMPTY it first, dolt!"  He takes a deep breath, then adds, in a sweet tone, "Please."
  match SELLITEMDUMP Cormyn scowls and says, "You'll want to empty that first.  For all I know you've put some curse on the contents or stuffed it full of stolen goods!"
  put sell my %sellstring
  matchwait 5
  var timeoutsub SELLITEMMAIN
  var timeoutcommand sell my %sellstring
	goto TIMEOUT

SELLITEMWAIT:
  pause 10
  goto SELLITEM

SELLITEMDUMP:
  gosub DUMPITEM %sellstring
  return


SWAPSWORD:
  var swapstring $0
  goto SWAPSWORDMAIN
SWAPSWORDP:
  pause
SWAPSWORDMAIN:
  if tolower("%weapon%currentweapon") = "le" then
  {
    if %bastardsword = 1 then return
  }
  if tolower("%weapon%currentweapon") = "the" then
  {
    if %bastardsword = 2 then return
  }
  match SWAPSWORDSTOW You must have two free hands
  matchre SSWAPLE as a heavy edged weapon|to a heavy edged grip
  matchre SSWAPTHE as a two-handed edged weapon|to a two-handed edged grip
  matchre SWAPSWORDP %waitstring
  match SWAPSWORDNOTHELD You must hold the
  match RETURN Will alone cannot conquer the paralysis that has wracked your body.
  put swap %swapstring
  matchwait 5
  var timeoutsub SWAPSWORDMAIN
  var timeoutcommand swap %swapstring
	goto TIMEOUT
  

SSWAPLE:
  var bastardsword 1
  goto SWAPSWORDMAIN

SSWAPTHE:
  var bastardsword 2
  GOTO SWAPSWORDMAIN
  
SWAPSWORDSTOW:
  if %getitemhand = "right" then
  {
    gosub STOW left
  }
  else
  {
    gosub STOW right
  }
  goto SWAPSWORDMAIN

SWAPSWORDNOTHELD:
  return

SWAPBARMACE:
  var swapbarstring $0
  goto SWAPBARMACEMAIN
SWAPBARMACEP:
  pause
SWAPBARMACEMAIN:
  if tolower("%weapon%currentweapon") = "lb" then
  {
    if %barmace = 1 then return
  }
  if tolower("%weapon%currentweapon") = "thb" then
  {
    if %barmace = 2 then return
  }
  matchre SWAPBARMACEP %waitstring
  match SWAPBMSTOW You must have two free hands
  match SWAPBARMACEGET You must hold
  matchre SWAPBMLB to a heavy blunt grip|as a heavy blunt weapon
  matchre SWAPBMTHB to a two-handed blunt grip|as a two-handed blunt weapon
  match SWAPBARMACENOTHELD You must hold the
  match RETURN Will alone cannot conquer the paralysis that has wracked your body.
  put swap %swapbarstring
  matchwait 5
  var timeoutsub SWAPBARMACEMAIN
  var timeoutcommand swap %swapbarstring
	goto TIMEOUT

SWAPBARMACEGET:
  gosub STOWALL
  gosub WIELD %hand %weaponname
  goto SWAPBARMACEMAIN

SWAPBMSTOW:
  if %hand = "right" then
  {
    gosub STOW left
  }
  else
  {
    gosub STOW right
  }
  goto SWAPBARMACEMAIN

SWAPBMLB:
  var barmace 1
  goto SWAPBARMACEMAIN

SWAPBMTHB:
  var barmace 2
  goto SWAPBARMACEMAIN

SWAPBARMACENOTHELD:
  return
  

SWAPRISTE:
  var swapristestring $0
  goto SWAPRISTEMAIN
SWAPRISTEP:
  pause
SWAPRISTEMAIN:
  if tolower("%weapon%currentweapon") = "lb" then
  {
    if %nriste = 1 then return
  }
  if tolower("%weapon%currentweapon") = "le" then
  {
    if %nriste = 2 then return
  }
  if tolower("%weapon%currentweapon") = "thb" then
  {
    if %nriste = 3 then return
  }
  match SWAPRSTOW You must have two free hands
  matchre SWAPRLB as a heavy blunt weapon|to a heavy blunt grip
  matchre SWAPRTHB as a two-handed blunt weapon|to a two-handed blunt grip
  matchre SWAPRLE as a heavy edged weapon|to a heavy edged grip
  match SWAPRISTENOTHELD You must hold the
  matchre SWAPRISTEP %waitstring
  put swap %swapristestring
  matchwait 5
  var timeoutsub SWAPRISTEMAIN
  var timeoutcommand swap %swapristestring
	goto TIMEOUT
	
SWAPRSTOW:
  if %getitemhand = "right" then
  {
    gosub STOW left
  }
  else
  {
    gosub STOW right
  }
  goto SWAPRISTEMAIN
	
SWAPRLB:
  var nriste 1
  goto SWAPRISTEMAIN

SWAPRLE:
  var nriste 2
  goto SWAPRISTEMAIN

SWAPRTHB:
  var nriste 3
  goto SWAPRISTEMAIN

SWAPRISTENOTHELD:
  return

SWAPHHRISTE:
  var swaphhstring $0
  goto SWAPHHRISTEMAIN
SWAPHHRISTEP:
  pause
SWAPHHRISTEMAIN:
  #echo weapon%currentweapon: %weapon%currentweapon
  #echo hhriste: %hhriste
  if tolower("%weapon%currentweapon") = "sb" then
  {
    if %hhriste = 1 then return
  }
  if tolower("%weapon%currentweapon") = "se" then
  {
    if %hhriste = 2 then return
  }
  if tolower("%weapon%currentweapon") = "thb" then
  {
    if %hhriste = 3 then return
  }
  match SWAPHHSTOW You must have two free hands
  matchre SWAPHHRTHB as a two-handed blunt weapon|to a two-handed blunt grip
  matchre SWAPHHRSB as a medium blunt weapon|to a medium blunt grip
  matchre SWAPHHRSE as a medium edged weapon|to a medium edged grip
  match SWAPHHRISTENOTHELD You must hold the
  matchre SWAPHHRISTEP %waitstring
  put swap %swaphhstring
  matchwait 5
  var timeoutsub SWAPHHRISTEMAIN
  var timeoutcommand swap %swaphhstring
	goto TIMEOUT

SWAPHHRSB:
  var hhriste 1
  goto SWAPHHRISTEMAIN
  
SWAPHHRSE:
  var hhriste 2
  goto SWAPHHRISTEMAIN

SWAPHHRTHB:
  var hhriste 3
  goto SWAPHHRISTEMAIN

SWAPHHSTOW:
  if %getitemhand = "right" then
  {
    gosub STOW left
  }
  else
  {
    gosub STOW right
  }
  goto SWAPHHRISTEMAIN

SWAPHHRISTENOTHELD:
  return


SWAPICON:
  var swapiconstring $0
  goto SWAPICONMAIN
SWAPICONP:
  pause
SWAPICONMAIN:
  if tolower("%weapon%currentweapon") = "the" then
  {
    if %waricon = 1 then return
  }
    if tolower("%weapon%currentweapon") = "thb" then
  {
    if %waricon = 2 then return
  }
  match SWAPISTOW You must have two free hands
  matchre SWAPITHE as a two-handed edged weapon|to a two-handed edged grip
  matchre SWAPITHB as a two-handed blunt weapon|to a two-handed blunt grip
  match SWAPICONNOTHELD You must hold the
  matchre SWAPICONP %waitstring
  put swap %swapiconstring
  matchwait 5
  var timeoutsub SWAPICONMAIN
  var timeoutcommand swap %swapiconstring
	goto TIMEOUT

SWAPITHE:
  var waricon 1
  goto SWAPICONMAIN
  
SWAPITHB:
  var waricon 2
  goto SWAPICONMAIN

SWAPISTOW:
  if %getitemhand = "right" then
  {
    gosub STOW left
  }
  else
  {
    gosub STOW right
  }
  goto SWAPICONMAIN
  
SWAPICONNOTHELD:
  return
  

UNCOILROPEP:
  pause
UNCOILROPE:
  matchre UNCOILROPEP %waitstring
  matchre RETURN You can't do that\.|You uncoil your rope\.
  put uncoil heavy rope
  matchwait 5
  var timeoutsub UNCOILROPE
  var timeoutcommand uncoil heavy rope
	goto TIMEOUT

UNLOAD:
  var unloadstring
UNLOADP:
  pause
UNLOADMAIN:
  matchre UNLOADP %waitstring
  matchre RETURN You unload|isn't loaded!|You remain concealed by your surroundings
  match UNLOADLEFT You don't have a ranged weapon to unload.
  put unload %unloadstring
  matchwait 5
  var timeoutsub UNLOAD
  var timeoutcommand unload %unloadstring
	goto TIMEOUT

UNLOADLEFT:
  if ("$lefthand" != "Empty") then
  {
    var unloadstring $lefthandnoun
    goto UNLOADMAIN
  }
  return

UNTIEITEM:
  var untieitemstring $0
  goto UNTIEITEMMAIN
UNTIEITEMP:
  pause
UNTIEITEMMAIN:
  matchre UNTIEITEMP %waitstring
  matchre RETURN You untie|Please rephrase that command.|Untie what?
  put untie %untieitemstring
  matchwait 5
  var timeoutsub UNTIEITEM
  var timeoutcommand untie %untieitemstring
	goto TIMEOUT

WEARITEM:
  var wearstring $0
  goto WEARITEMMAIN
WEARITEMP:
  pause
WEARITEMMAIN:
  matchre WEARITEMP %waitstring
  matchre RETURN You put|You slip|You sling|You work your way into|You attach|You slide your|You hang|You are already wearing that.|You slide|You drape
  matchre WEARCANT You can't wear any more items like that.
  matchre WEARUNLOAD You need to unload|You should unload
  match RETURN But that is already in your inventory.
  put wear %wearstring
  matchwait 5
  var timeoutsub WEARITEMMAIN
  var timeoutcommand untie %wearstring
	goto TIMEOUT

WEARCANT:
  if (%wearitemname = "bundle") then goto BUNDLEPULL
  else return

WEARUNLOADP:
  pause
WEARUNLOAD:
  if ($lefthand != "Empty") then gosub STOW left
  gosub UNLOAD
  gosub STOWALL
  return

WIELD:
  var wieldhandstring $1
  var wielditemstring $2 $3 $4
  #echo wieldhandstring: %wieldhandstring
  #echo wielditemstring: %wielditemstring
  goto WIELDMAIN
WIELDP:
  pause
WIELDMAIN:
  matchre WIELDP %waitstring
  matchre RETURN You draw out your|You're already holding|You draw your
  matchre WIELDGET You can't seem|You find it difficult to wield|Your (right|left) hand is too injured to draw
  #match WIELDBOND Wield what?
  match RETURN Wield what?
  match WIELDSTOW You need to have your
  matchre WIELDREM You'll need to remove it first!|You're wearing
  put wield %wieldhandstring %wielditemstring
  matchwait 5
  var timeoutsub WIELD
  var timeoutcommand wield %wieldhandstring %wielditemstring
	goto TIMEOUT

WIELDGET:
  gosub GETITEM %wielditemstring
  return

WIELDBOND:
  if matchre ("%wielditemstring", "%ltweapon") then
  {
    if %ltbond = "YES" then goto THROWBOND
  }
  if matchre ("%wielditemstring", "%htweapon") then
  {
    if %htbond = "YES" then goto THROWBOND
  }
  return

WIELDSTOW:
  gosub STOWALL
  goto WIELDMAIN
  
WIELDREM:
  gosub REMITEM %wielditemstring
  return


##########

#####COMBAT_LOGIC#####

BRAWLCOMBO:
  var lowfatattack punch
  var lowattack bob
  var medattack punch
  var highattack kick
  return
  	
BLUNTCOMBO:
  var lowfatattack swing
  var lowattack feint
  var medattack draw
  var highattack chop
	return
	
EDGEDCOMBO:
  var lowfatattack slice
  var lowattack feint
  var medattack draw
  var highattack chop
  return
  
PIERCECOMBO:
  var lowfatattack thrust
  var lowattack jab
  var medattack draw
  var highattack lunge
  return


BOWLOADLOGIC:
  var usingdualload 0
	#BARBARIAN_DL
	if ($guild = "Barbarian") then
	{
		if ((%dualload = "YES") && ($SpellTimer.Eagle.active = 1) && (%weapontype = "bow")) then var usingdualload 1
	}
	#RANGER_DL
	if ($guild = "Ranger") then
	{
		if ((%dualload = "YES") && ($SpellTimer.SeetheWind.active = 1) && (%weapontype = "bow")) then var usingdualload 1
	}
	#THIEF_DL
	if ($guild = "Thief") then
	{
		if ((%dualload = "YES") && ($SpellTimer.KhriSteady.active = 1) && (%weapontype = "bow")) then var usingdualload 1
	}
  if %usingacm = 1 then var usingdualload 0
  #echo usingdualload: %usingdualload
  if %usingdualload != 1 then
  {
    gosub GETITEM my %ubowammo
    if matchre ("$righthand", "(%ubowammo)") then gosub SWAP
    if matchre ("$lefthand", "(%ubowammo)") then
    {
      gosub BOWLOAD %ubowammo
      if (%goupkeep = 1) then return
      gosub STOW left
      if %usingacm = 1 then goto ATTACKACM
      else goto BOWAIM
    }
    else
    {  
      gosub FINDITEM %ubowammo
      if ((%finditemfound = 1) && ("%autoupkeep" = "YES")) then
      {
        var goupkeep 1
        var autype wounds
      }
      else goto BOWNOAMMO
    }
  }
  else
  {
		gosub BOWLOAD %ubowammo
		if (%goupkeep = 1) then return
		if ("$lefthand" != "Empty") then gosub STOW left
		goto BOWAIM
  }
  return


#####COMBAT_SUBS#####

ADVP:
	pause
ADV:
  if %avoidshock = "YES" then gosub TARGETSELECT
  matchre FACE You stop advancing|You have lost sight|advance towards?
  matchre ADVRETURN to melee range|already at melee|You are already advancing|You begin to|^The .* is already quite dead\.$
  matchre ADVP %waitstring
  match ADVSTAND You had better stand up first.
  put advance
  matchwait 5
	var timeoutsub ADV
  var timeoutcommand advance
	goto TIMEOUT
  
ADVRETURN:
  pause 2
  return

ADVSTAND:
  gosub STAND
  goto ADV


ANALYZEP:
  pause
ANALYZE:
  var lasthit 1
  matchre ANALYZEP %waitstring
  matchre ANAADV ^You must be closer
  match ANAFACE There is nothing else to face!
  match ANAFACENEXT Analyze what?
  matchre ANAFLYING is flying too high for you to attack.|is flying far too high to hit with your fists\.
  matchre ANAPRONE You should stand up first.
  matchre RETURN Face what?  
  
  matchre ANALYZEAGAIN You fail to find any holes|Your analysis reveals a slight|You reveal a tiny weakness|You reveal a small|Your analysis reveals a small|Your analysis reveals a moderate|Your analysis reveals a good|Your analysis reveals a substantial|Your analysis reveals a large|Your analysis reveals a great|Your analysis reveals an exceptional|You reveal a moderate|You reveal a slight
	matchre ANALYZEAGAIN ^You fail to find any
  matchre RETURN Your analysis reveals a massive
  put analyze
  matchwait 5
	var timeoutsub ANALYZE
  var timeoutcommand analyze
	goto TIMEOUT

ANALYZEAGAIN:
  gosub STATUSCHECK
  #gosub AUTOUPKEEPCHECKS
  if (%goupkeep = 1) then return
  goto ANALYZE

ANAPRONE:
  gosub STAND
  goto ANALYZE

ANAFLYING:
  gosub FACE
  if (%badface = 1) then
  {
    var badface 0
    return
  }
  goto ANALYZE

ANAFACE:
  if $monstercount < 1 then RETURN
  gosub FACE
  if %badface = 1 then
  {
    var badface 0
    return
  }
  goto ANALYZE
 
ANAFACENEXT:
  if $monstercount < 1 then RETURN
  gosub FACENEXT
  if %badface = 1 then
  {
    var badface 0
    return
  }
  goto ANALYZE
 
ANAADV:
  gosub ADV
  goto ANALYZE


ATTACKACMP:
  pause
ATTACKACM:
  matchre ATTACKACMP %waitstring
  match ATTACKACMSUCCESS Roundtime:
  match ATTACKACMSUCCESS With a loud twang, you let fly your
  match ATTACKACMBARBSUCCESS With expert skill you end the attack and maneuver into a better position.
  match ATTACKACMSTOW You must free up your left hand first.
  matchre ATTACKACMSTAND ^You'll need to stand up first\.|^You must be standing to perform that maneuver\.
	matchre ADV You aren't close enough to attack\.
  #match BOWLOADLOGIC You prepare the shot, but stop when you realize the
  matchre ATTACKACMWRONG With your fist\?  That might hurt\.|This weapon lacks the edge necessary to cleave your enemy with\.|Your hands must be empty to deliver such a blow\.|A pike or halberd weapon is necessary to impale your enemy with\.|Only a staff is suitable for the complex motions of the twirl maneuver\.|This works best when you use a suitable ranged weapon\.|This works best when you use a suitable weapon\.|This works best when you are dual wielding suitable weapons\.
  matchre BOWLOADLOGIC You prepare the shot, but stop when you realize the .* is unloaded\.
  matchre ATTACKACMFACE What are you trying to attack\?
  matchre ATTACKACMFAIL You must rest a bit longer before attempting that maneuver again\.
  match ATTACKACMBADNAME You cannot figure out how to do that.
  put maneuver %acmtype
  matchwait 5
	var timeoutsub ATTACKACM
  var timeoutcommand maneuver %acmtype
	goto TIMEOUT

ATTACKACMSTOW:
  gosub STOW left
  goto ATTACKACM

ATTACKACMWRONG:
  put #echo %alertwindow Yellow Tried to use ACM %acmtype with the wrong weapon!  righthand: $righthand  lefthand: $lefthand  weapontype: %weapontype  weaponname: %weaponname  offhand: %%offhandlowestweapon
  return
  
ATTACKACMSTAND:
  gosub STAND
  goto ATTACKACM

ATTACKACMLOAD:
  gosub GETITEM my %ubowammo
  if matchre ("$righthand", "(%ubowammo)") then gosub SWAP
  gosub BOWLOAD %ubowammo
  if (%goupkeep = 1) then return
  if matchre ("$lefthand", "(%ubowammo)") then gosub STOW left
  goto ATTACKACM

ATTACKACMSUCCESS:
  #put #echo %alertwindow Yellow Used ACM %acmtype!
  var nextacm%acmtype %t
  math nextacm%acmtype add 90
  if %acmtype = "doublestrike" then
  {
    if (%hand = "right") then gosub STOW left
    else gosub STOW right
  }
  return

ATTACKACMBARBSUCCESS:
  #put #echo %alertwindow Yellow Used ACM %acmtype with Barbarian success!
  var nextacm%acmtype %t
  math nextacm%acmtype add 55
  if %acmtype = "doublestrike" then
  {
    if (%hand = "right") then gosub STOW left
    else gosub STOW right
  }
  return

ATTACKACMFAIL:
  #put #echo %alertwindow Yellow Guessed wrong on timer for ACM %acmtype.  t: %t  nextacm%acmtype: %nextacm%acmtype
  var nextacm%acmtype %t
  math nextacm%acmtype add 20
  return

ATTACKACMBADNAME:
  put #echo %alertwindow Yellow Tried to use ACM %acmtype, but it's an invalid type.
  return

ATTACKACMFACE:
  gosub FACE
  if %badface = 1 then
  {
    var badface 0
    return
  }
  else goto ATTACKACM


ATTACKMELEEP:
	pause
ATTACKMELEE:
  #ACM's 
  if (%usingacm = 1) then goto ATTACKACM
  if (%usingwhirlwind = 1) then goto ATTACKWHIRLWIND
  if ((%usingstealth = 1) && ($guild != "Paladin")) then 
  { 
    gosub HIDELOGIC
  }
	var lasthit 0
	matchre ATTACKMELEEP %waitstring
	matchre ATTACKSTAND You'll need to stand up first.
	matchre ATTACKFACE nothing else|at what are you|You lean back and kick your feet|Face what?|Backstab what?
  matchre ADV aren't close enough|You must be closer|It would help if you were closer
	matchre ATTACKBRAWLFAIL You can not slam with that|Please rephrase that command\.|Wouldn't it be better if you used a melee weapon\?
	match ATTACKTWOHANDSTOW You need two hands to wield this weapon!
	match ATTACKGOODHIT lands a
  matchre RETURN already in a position|But you are already dodging|pointlessly hack|There is nothing else to face!|Blindsiding is much more effective when you use a melee weapon.
  matchre ATTACKRETURN You move into a position to|Roundtime|You slip out of concealment
  matchre ATTMELEEFLYING is flying too high for you to attack\.|is flying far too high to hit with your
	matchre ATTACKBADBACKSTAB You can't backstab that.
	matchre ATTACKBACKSTABHIDE You must be hidden to blindside.
  #HAND
	if (%hand = "left") then var attackcommand %att left
  else var attackcommand %att
  #BACKSTAB
	if (($hidden = 1) && (%usingbackstab = 1)) then
	{
	  if (%hand = "left") then var attackcommand backstab left
	  else var attackcommand backstab
  }
  put %attackcommand
	matchwait 5
	var timeoutsub ATTACKMELEE
  var timeoutcommand %attackcommand
	goto TIMEOUT

ATTACKSTAND:
  gosub STAND
  goto ATTACKMELEE

ATTACKBACKSTABHIDE:
  gosub HIDELOGIC
  goto ATTACKMELEE

ATTACKRETURN:
  math weapon%currentweaponcount add 1
  return

ATTACKBADBACKSTAB:
  var usingbackstab 0
  goto ATTACKMELEE

ATTACKFACE:
  gosub FACE
  if %badface = 1 then
  {
    var badface 0
    return
  }
  else goto ATTACKMELEE

ATTACKBRAWLFAIL:
  if %usingtactics = 1 then var tacticsdone 1
  if %usingexpert = 1 then
  {
    var expertdone 1
    var expertpause 1
  }
  if %avoidshock = "YES" then var facebrawlfail 1
  gosub FACENEXT
  if %badface = 1 then
  {
    var badface 0
    return
  }
  return

ATTMELEEFLYING:
  if $hidden = 1 then gosub UNHIDE
  gosub FACE
  if %badface = 1 then
  {
    var badface 0
    return
  }
  goto ATTACKMELEE

ATTACKGOODHIT:
  var lasthit 1
  math weapon%currentweaponcount add 1
  return

ATTACKTWOHANDSTOW:
  if matchre ("$righthand", "%cambitem1") then put wear %cambitem1
  if matchre ("$lefthand", "%cambitem1") then put wear %cambitem1
  gosub STOW left
  goto ATTACKMELEE

ATTACKTHROWNKNIVESP:
	pause
ATTACKTHROWNKNIVES:
	matchre FACE at what are you
	matchre RETURN There is nothing else to face!
	matchre ATTACKTHROWNKNIVESP %waitstring
	matchre RETURN Roundtime|What are you trying to|You must hold the
	matchre THROWSTOW You need a free hand to
  put hurl
  matchwait 5
	var timeoutsub ATTACKTHROWNKNIVES
  var timeoutcommand hurl
	goto TIMEOUT
	
	
ATTACKTHROWNP:
	pause
ATTACKTHROWN:
	matchre FACE at what are you
	matchre RETURN There is nothing else to face!
	matchre ATTACKTHROWNP %waitstring
	matchre THROWGET Roundtime|What are you trying to|You must hold the
	match THROWGET What are you trying to lob?
	matchre THROWSTOW You need a free hand to
	#matchre ATTACKTHROWNSWAP You must hold the
  if %hand = "left" then var attackcommand %att left
  else var attackcommand %att
  put %attackcommand
  matchwait 5
	var timeoutsub ATTACKTHROWN
  var timeoutcommand %attackcommand
	goto TIMEOUT

THROWSTOW:
  if %hand = "left" then gosub STOW right
  else gosub STOW left
  goto ATTACKTHROWN

ATTACKTHROWNSWAP:
  gosub SWAP
  goto ATTACKTHROWN


ATTACKWHIRLWINDP:
  pause
ATTACKWHIRLWIND:
	matchre ATTACKWHIRLWINDP %waitstring
  match ATTACKWHIRLWINDRETURN Roundtime:
  match ATTACKWHIRLBAD Only skilled Barbarians can utilize this technique!
  match RETURN With your fist?  That might hurt.
  match ATTACKWHIRLWINDSTOW You must free up your left hand first.
  put whirlwind
  matchwait 5
	var timeoutsub ATTACKWHIRLWIND
  var timeoutcommand whirlwind
	goto TIMEOUT

ATTACKWHIRLWINDRETURN:
  if (%goodoffhand = 1) then
  {
    if ((%offhand = "right") || (%offhand = "left")) then gosub STOW %offhand
  }
  return

ATTACKWHIRLBAD:
  put #echo %alertwindow Yellow Attempted to whirlwind when the character is not able to!  Turning whirlwind off.
  var whirlwind NO
  put #var whirlwind NO
  return

ATTACKWHIRLWINDSTOW:
  gosub STOW left
  goto ATTACKWHIRLWIND


BOWAIMP:
	pause
BOWAIM:
  if %aiming = 1 then return
	#ACM_POWERSHOT
	if ((%acms = "YES") && (%powershot = "YES") && (%usingstealth != 1) && (%t >= %nextacmpowershot)) then
  {
    if (%usingdualload != 1) then
    {
			var usingacm 1
			var acmtype powershot
			goto ATTACKACM
	  }
  }
	matchre BOWAIMP %waitstring
	matchre BOWLOADLOGIC isn't loaded!
	match BOWAIMSTOW You need both hands in order to aim.
	matchre BOWAIMSTOW But the .* in your right hand isn't a ranged weapon!
	matchre FACE at what are you|I could not find what you were referring to.
	matchre BOWAIMSUCCESS You begin to target|You are already targetting|You shift your target to 
	matchre RETURN Face what?|There is nothing else to face!|You don't have a ranged weapon to aim with!
	
	put aim
	matchwait 5
	var timeoutsub BOWAIM
	var timeoutcommand aim
	goto TIMEOUT
	gosub STATUSCHECK
	return

BOWAIMSUCCESS:
  var aiming 1
  RETURN

BOWAIMSTOW:
  gosub STOW left
  goto BOWAIM

BOWLOAD:
  var bowloadammo $0
  goto BOWLOADMAIN
BOWLOADP:
	pause
BOWLOADMAIN:
	matchre BOWLOADP %waitstring
	matchre BOWLOADSTOW is already loaded|to load the|You load|You reach into your|You can not load the
	matchre BOWLOADGETITEM You don't have the proper ammunition
	match BOWDLBAD You are not skilled enough to dual-load
	match BOWNOEAGLE You focus on the image of an eagle but are unable to draw upon its majesty.
	match BOWNOWINDS Such a feat would be impossible without the winds to guide you.
	match BOWNOSTW Such a feat would be impossible without the winds to guide you\.
	match BOWNOSTEADY Such a feat would be impossible without steadier hands.
	match BOWNOAMMO What weapon are you trying to load?
	if %usingdualload = 1 then put load my %bowloadammos
	else put load my %bowloadammo
	matchwait 5
	var timeoutsub BOWLOADMAIN
  if %usingdualload = 1 then var timeoutcommand load my %bowloadammos
  else var timeoutcommand load my %bowloadammo
	goto TIMEOUT

BOWLOADSTOW:
  if matchre ("$lefthand", "%ubowammo") then gosub STOWITEM %bowloadammo
  return

BOWLOADGETITEM:
  if %usingdualload = 1 then goto BOWNOAMMO
  gosub STOW left
  gosub GETITEM %bowloadammo
  goto BOWLOADMAIN

BOWDLBAD:
  var usingdualload 0
  var dualload NO
  put #var dualload NO
  put #echo Yellow Not skilled enough to dual-load!  Turning variable off.
  return

BOWNOWINDS:
  var usingdualload 0
  goto BOWLOADMAIN

BOWNOEAGLE:
  var usingdualload 0
  goto BOWLOADMAIN
  
BOWNOSTW:
  var usingdualload 0
  goto BOWLOADMAIN
  
BOWNOSTEADY:
  var usingdualload 0
  goto BOWLOADMAIN

BOWNOAMMO:
  if (("%autoupkeep" = "YES") && ("%auonammo" = "YES")) then
  {
    var goupkeep 1
    var autype ammo
    return
  }
  else
  {
    gosub DEEPSLEEP
    put #echo >$alertwindow Yellow Out of ammo for %weapontype!  Please address!
    put #flash
    put #play Advance
    if ("%bugout" = "YES") then goto BUGOUT
    else goto BOWNOAMMO2
  }

BOWNOAMMO2:
  echo ===OUT OF AMMO===
  put #flash
  put #play Advance
  pause 5
  goto BOWNOAMMO2


DEFSTANCEP:
  pause  
DEFSTANCE:
  matchre DEFSTANCEP %waitstring|You don't seem to be able to move|It's all a blur!
  matchre RETURN Viewing current combat stance...|Setting your Evasion stance to 100%, 
  put stance set 100 0 100 0
  matchwait 5
	var timeoutsub DEFSTANCE
  var timeoutcommand stance set 100 0 100 0
	goto TIMEOUT


EANALYZEP:
  pause
EANALYZE:
  var lasthit 1
  matchre RETURN Roundtime:|With a keen eye you study the battlefield
	matchre EANALYZEP %waitstring
  matchre EANAADV Analyze what?
  put analyze %eanalyzetype
  matchwait 5
	var timeoutsub EANALYZE
  var timeoutcommand analyze %analyzetype
	goto TIMEOUT
  
EANAADV:
  gosub ADV
  goto EANALYZE


FACENEXTP:
	pause
FACENEXT:
	if %avoidshock = "YES" then
	{
	  gosub TARGETSELECT
	  var facebrawlfail 0
	  return
	}
	else
	{
	  var badface 0
	  matchre FACENEXTP %waitstring
	  matchre RETURN You turn
	  matchre FACEINVALID Face what?|nothing else to face|There isn't anything like that here to face\!
	  match FACEDEAD What's the point in facing
	  put face next
	  matchwait 5
	  var timeoutsub FACE
    var timeoutcommand face next
	  goto TIMEOUT
	}
	
FACEP:
	pause
FACE:
	if ("%avoidshock" = "YES") then
	{
	  gosub TARGETSELECT
	  var facebrawlfail 0
	  return
	}
	else
	{
	  var badface 0
	  var mob 0
	  var mobnum 0
	  var mobpos 0
	  gosub FACEASSESS
	  if (%mob = 0) then
	  {
	    var goodtarget 0
	    var badface 1
	    return
	  }
	  if ("%mobpos" = "Facing") then return
    if contains("flanking|behind|advancing","%mobpos") then
    {
      gosub FACETARGET %Ordinal(%mobnum) %mob
      var goodtarget 1 
    }
	  if contains("%mobpos","moving") then
    {
      #gosub block stop
      gosub FACETARGET %Ordinal(%mobnum) %mob
      var goodtarget 1
    }
    if contains("%mobpos","facing") then var goodtarget 1
    return
	
	
FACEASSESSP:
  pause
FACEASSESS:
	if ($monstercount < 1) then return
  matchre FACEASSESSP %waitstring
	matchre FACEVALUES ^An? .*(\b\w+(?:\S+)?\b) \((\d+):.*\) is (facing|flanking|behind|advancing on|moving to flank|moving behind) you at
	matchre FACEVALUES ^.*(\b\w+(?:\S+)?\b) \((\d+):.*\) is (facing|flanking|behind|advancing on|moving to flank|moving behind) you at
	match FACEASSESSRETURN A good positive attitude never hurts.
	put assess
	put yes
	matchwait 5
	var timeoutsub FACEASSESS
  var timeoutcommand assess
	goto TIMEOUT

FACEASSESSRETURN:
  #put #echo Yellow No match!
  gosub FACENEXT
  return

FACEVALUES:
	var mob $1
	var mobnum $2
	var mobpos $3
	#echo %mob %mobnum %mobpos
	return

FACETARGET:
  var facetargetstring $0
  goto FACETARGETMAIN
FACETARGETP:
	pause
FACETARGETMAIN:
  var badface 0
	matchre FACETARGETP %waitstring
	matchre RETURN nothing else to face|You are already facing|You turn
	match FACEDEAD What's the point in facing
	matchre FACEINVALID Face what\?|There isn't anything like that here to face\!
	matchre FACETARGETRET You are too closely engaged
	put face %facetargetstring
	matchwait 5
	var timeoutsub FACETARGET
  var timeoutcommand face %facetargetstring
	goto TIMEOUT

FACEINVALID:
  var badface 1
  var goodtarget 0
  if %avoidshock = "YES" then
  {
    var shockcritter 1
    var currentcritter 0
  }
  return
	
FACEDEAD:
  if (%avoidshock = "YES") then
  {
    put look
    pause 1
    gosub MONTEST
    var currentcritter 0
    var shockcritter 1
  }
  var goodtarget 0
  var badface 1
  var deadcheck 1
  #gosub MONTEST
  put look
  pause .5
  return

FACETARGETRET:
  gosub RETREAT
  goto FACETARGETMAIN


FIREP:
  pause
FIRE:
  if ((%usingstealth = 1) && ($guild != "Paladin")) then gosub HIDELOGIC
  var aiming 0
  var aimready 0
  math weapon%currentweaponcount add 2
  matchre FIREP %waitstring
  matchre FIREP Strangely, you don't feel like fighting right now\.|That weapon must be in your right hand to fire\!
  matchre BOWLOADLOGIC isn't loaded\!
  matchre AMMOGET lands nearby|falls to the ground\!|falls to the floor\!
  matchre RETURN Roundtime|There is nothing else to face!|What are you trying to attack?|But you don't have a ranged|You can't fire|How can you poach|You remain concealed by your surroundings,|Face what?|How can you snipe if you are not hidden?|I could not find what you were referring to\.
  if ((%usingstealth = 1) && ($hidden = 1)) then 
  {
    if (($guild = "Thief") || ($guild = "Ranger")) then
    {
      if $snipe = "YES" then put snipe
      else put poach
    }
    else put poach
  }
  else put fire
  matchwait 5
	var timeoutsub FIRE
  var timeoutcommand fire
	goto TIMEOUT
	
FIREAMMOGET:
  gosub AMMOGET %ubowammo
  return


HIDELOGIC:
  if matchre ("%bufflist", "rm") then
  {
    if %mist != 1 then return
  }
  if %misdirection = "YES" then
  {
    if $SpellTimer.Misdirection.active != 1 then return
  }
  if %pantherform = "YES" then
  {
    if $SpellTimer.Panther.active != 1 then return
  }
  if matchre ("%bufflist", "shadows") then
  {
    if $SpellTimer.Shadows.active != 1 then return
  }
  if matchre ("%bufflist", "obfuscation") then 
  {
    if $SpellTimer.Obfuscation.active != 1 then return
  }
  if matchre ("%bufflist", "mis") then
  {
    if $SpellTimer.Misdirection.active != 1 then return
  }
  var hideattempts 0
  goto HIDE
  return


FLEERETREAT:
  var retreatcount 0
  goto FLEERETREATMAIN
FLEERETREATMAINP:
  pause
FLEERETREATMAIN:
  if %retreatcount > 6 then
  {
    var fleegood 0
    goto FLEE
  }
  matchre FLEERETREATCONT You retreat back to pole range.|You try to back away from|You stop advancing on|You sneak back out|You try to back out of combat but are unable to get away!|You try to sneak out of combat,
  matchre RETURN You retreat from combat.|You are already as far away as you can get!
  match RETURN As you start to move, a shooting pain ripples up your leg, which stops you short.
  match STAND You must stand first.
  matchre FLEERETREATMAINP %waitstring
  put retreat
  matchwait 5
	var timeoutsub FLEERETREATMAIN
  var timeoutcommand retreat
  goto TIMEOUT


FLEERETREATCONT:
  math retreatcount add 1
  goto FLEERETREATMAIN

FLEEP:
  pause
FLEE:
  matchre FLEEP %waitstring
  matchre FLEECONT You foresee the situation deteriorating rapidly.|You realize you're out of your element!|Either you're looking really tasty|You feel the wrenching pain of dejection as you|Hoping the gods will come to your rescue, you mutter|You suddenly realize that you may be completely outclassed in this match.|You suddenly realize that the hunter may be the hunted\.|For some inexplicable reason, you can't flee from this area\.  You frantically attempt to disengage from combat\.|Scanning the area for an escape route, you turn
  match RETURN You assess your combat situation and realize you don't see anything engaged with you.
  match RETURN How do you expect to flee with your right leg in that condition?
  match RETURN How do you expect to flee with your left leg in that condition?
  put flee
  matchwait 5
	var timeoutsub FLEE
  var timeoutcommand flee
  goto TIMEOUT
  
FLEECONT:
  if %fleegood = 1 then return
  pause .1
  goto FLEECONT


HIDEP:
	pause
HIDE:
  if %hideattempts >= 2 then return
  if $hidden != 0 then RETURN
  matchre RETURN You melt into the background,|But you're already hidden!|You blend in with your surroundings
	matchre HIDEP %waitstring
	matchre HIDEBAD notices your attempt to hide!|discovers you, ruining your hiding place!
	put hide
	matchwait 5
	var timeoutsub HIDE
  var timeoutcommand hide
  goto TIMEOUT

HIDEBAD:
  math hideattempts add 1
  goto HIDE


NVTACTICSP:
  pause
NVTACTICS:
  matchre NVTACTICSP %waitstring
  matchre RETURN Roundtime|What are you trying to attack?
  matchre NVTACTICSADV You must be closer to 
  put %tmaneuver
  matchwait 5
	var timeoutsub NVTACTICS
  var timeoutcommand %tmaneuver
	goto TIMEOUT

NVTACTICSADV:
  gosub ADV
  goto NVTACTICS


RETREATP:
  pause
RETREAT:
  matchre RETREAT You retreat back to pole range.|You try to back away from|You stop advancing on|You sneak back out|You try to back out of combat but are unable to get away!|You try to sneak out of combat,|discovers you trying to sneak out of combat, revealing your hiding place!|You stop advancing.
  matchre RETURN You retreat from combat.|You are already as far away as you can get!
  match STAND You must stand first.
  matchre RETREATP %waitstring
  put retreat
  matchwait 5
  var timeoutsub RETREAT
  var timeoutcommand retreat
	goto TIMEOUT


SMITETESTP:
  pause
SMITETEST:
  matchre SMITETESTP %waitstring
  matchre SMITEGOOD Your conviction is enough to deliver
  matchre SMITEBAD Your conviction is shaken and spent.
  put smite check
  matchwait 5
  var timeoutsub SMITETEST
  var timeoutcommand smite check
	goto TIMEOUT

SMITEGOOD:
  var smitesleft 1
  return
  
SMITEBAD:
  var smitesleft 0
  return


STANCECHANGEP:
  pause
STANCECHANGE:
  matchre STANCECHANGEP %waitstring
  matchre RETURN You are now set|Setting your
  put stance %stance
  matchwait 5
  var timeoutsub STANCECHANGE
  var timeoutcommand stance %stance
	goto TIMEOUT


THROWBONDP:
  pause
THROWBOND:
  if %weapontype = "lt" then
  {
    if %ltbond != "YES" then return
  }
  else
  {
    if %weapontype = "ht" then
    {
      if %htbond != "YES" then return
    }
  }
  matchre RETURN and flies toward you!|suddenly leaps toward you!|You don't have any bonds to invoke!|Strong magic shields the bonded item from your grasp.|Are you sure you want to do that?|Roundtime
  matchre THROWBONDP %waitstring
	put invoke bond
	matchwait 5
	var timeoutsub THROWBOND
  var timeoutcommand invoke bond
  goto TIMEOUT


THROWGETP:
	pause
THROWGET:
  math weapon%currentweaponcount add 1
  if ((%weapontype = "lt") && (%ltbond = "SPECIAL")) then return
  if ((%weapontype = "ht") && (%htbond = "SPECIAL")) then return
  matchre THROWGETP %waitstring
  matchre RETURN You pick up|You fade in for a moment as you pick up|You are already holding that.|You pull|You get
  matchre RETURN ^But that is already in your inventory\.|^You should untie the
  matchre THROWBOND What were you|Sheesh, it's still alive!
	put get %weaponname
	matchwait 5
	var timeoutsub THROWGET
  var timeoutcommand get %weaponname
	goto TIMEOUT
	

UNHIDEP:
	pause
UNHIDE:
  if $hidden != 1 then return
  matchre RETURN You come out of hiding.|But you are not hidden|You slip out of hiding, although you remain invisible.
  matchre UNHIDEP %waitstring
  match UNHIDESTAND You try to creep out of hiding but your injuries cause you to stumble and crash to the ground!
  put unhide
  matchwait 5
	var timeoutsub UNHIDE
  var timeoutcommand unhide
	goto TIMEOUT

UNHIDESTAND:
  gosub STAND
  return
  


#####MOVEMENT_SUBS#####

KNEELP:
  pause
KNEEL:
  matchre KNEELP %waitstring
  matchre RETURN Subservient type, eh?|You kneel down upon the ground.|You rise to a kneeling position.|You kneel.
  put kneel
  matchwait 5
	var timeoutsub KNEEL
  var timeoutcommand kneel
	goto TIMEOUT


LOOKROOMP:
  pause
LOOKROOM:
  matchre LOOKROOMP %waitstring
  matchre RETURN ^Obvious exits\:|^Obvious paths\:
  put look
  matchwait 5
	var timeoutsub LOOKROOM
  var timeoutcommand look
	goto TIMEOUT


LIEP:
  pause
LIE:
  matchre LIEP %waitstring
  matchre RETURN You lie down\.|You are already lying down\.
  put lie
  matchwait 5
	var timeoutsub LIE
  var timeoutcommand lie
	goto TIMEOUT


MOVE:
  var roomtarget $0
  var nextstarcheck 0
MOVEMAIN:
  put #echo Yellow AutoMove Target: %roomtarget
  pause 0.1
  match RETURN YOU HAVE ARRIVED!
  match MOVEMAIN AUTOMAPPER MOVEMENT FAILED!
  match MOVEMAIN SHOP CLOSED
  match MOVEMAIN THROWN IN JAIL
  put #goto %roomtarget
  matchwait 120
  goto MOVEMAIN

TRAVEL:
  var traveltarget $0
  var nextstarcheck 0
TRAVELMAIN:
  put #echo Yellow Travel Target: %traveltarget
  pause 0.1
  match RETURN REACHED YOUR DESTINATION
  put .travel %traveltarget
  matchwait %movetimeout
  goto TRAVELMAIN

OLDMOVE:
  var roomtarget $0
  delay 0.0001
  var move.skip 0
  var move.retry 0
  var move.fail 0
  var move.room $0
  if $roomid = 0 then
  {
    put #mapper reset
    pause 1
    if $roomid = 0 then
    {
      put #flash
      put #play JustArrived
      if !def(alertwindow) then  put #echo Yellow Genie has lost track of your room number and cannot move!
      else put #echo >$alertwindow Yellow Genie has lost track of your room number and cannot move!
    }
  }
  goto MOVE.GOTO

MOVE.RETRY:
  math move.retry add 1
  if %move.retry > 3 then goto move.fail
  echo ***
  echo *** Retrying move to $1 $2 in %move.retry second(s).
  echo ***
  pause %move.retry
  goto MOVE.GOTO

MOVE.GOTO:
  #gosub retreat
  matchre MOVE.GOTO ^\.\.\.wait|^Sorry\,
  matchre MOVE.RETURN ^YOU HAVE ARRIVED
  matchre MOVE.RETURN ^Darkness settles like a thick cloak 
  matchre MOVE.SKIP ^SHOP CLOSED
  matchre MOVE.RETRY ^MOVE FAILED
  matchre MOVE.FAIL ^DESTINATION NOT FOUND
  matchre MOVE.RETRY ^You can't go
  matchre MOVE.RETRY ^You're still recovering from your recent attack\.
  matchre MOVE.RETREAT ^You are engaged
  matchre MOVE.RETREAT ^You can't do that while engaged\!
  put #goto %roomtarget
  matchwait 120
	var timeoutsub MOVE.GOTO
  var timeoutcommand #goto %roomtarget
	goto TIMEOUT

MOVE.FAIL:
  var move.fail 1
  goto MOVE.RETURN

MOVE.RETREAT:
  pause 0.1
  gosub RETREAT
  pause 0.1
  goto MOVE.RETRY

MOVE.SKIP:
  var move.skip 1

MOVE.RETURN:
  pause 0.001
  pause 0.1
  pause 0.1
  #put #mapper reset
  return

MOVEANYROOM:
  var moveroomlist n|ne|e|se|s|sw|w|nw|out|up|down
  var moveroomcount 0
  goto MOVEANYROOMMAIN
MOVEANYROOMMAINP:
  pause
MOVEANYROOMMAIN:
  eval roomtry element("%moveroomlist", %moveroomcount)
  matchre MOVEANYROOMMAINP %waitstring
  match MOVEANYROOMFAIL You can't go there.
  match MOVEANYROOMMAINP You're still recovering from your recent attack.
  matchre RETURN ^Obvious
  matchre MOVEANYROOMRET You are engaged to
  put %roomtry
  matchwait 5
	var timeoutsub MOVEANYROOMMAIN
  var timeoutcommand %roomtry
	goto TIMEOUT

MOVEANYROOMFAIL:
  math moveroomcount add 1
  goto MOVEANYROOMMAIN

MOVEANYROOMRET:
  gosub RETREAT
  goto MOVEANYROOMMAIN
  

MOVELOOP:
  if %mlmovetarget > %mlcount then return
  if %roomtarget = "galley" then
  {
    action (speech) off
    var galleydone 0
    gosub GALLEYTRAVEL
    action (speech) on
  }
  else
  {
    if %mlstring(%mlmovetarget) = "start" then
    {
      if %startingroom != 0 then
      {
        gosub MOVE %startingroom
      }
    }
    else
    {
      if matchre("%mlstring(%mlmovetarget)", "move .*") then gosub MOVEROOMS %mlstring(%mlmovetarget)
      else
      {
        if matchre("%mlstring(%mlmovetarget)", "go .*") then gosub MOVEROOMS %mlstring(%mlmovetarget)
        else
        {
          gosub MOVE %mlstring(%mlmovetarget)
        }
      }
    }
  }
  math mlmovetarget add 1
  goto MOVELOOP


GALLEYTRAVEL:
  action (galley) on
  put #echo %alertwindow [UPKEEP] Starting galley travel from Zone: $zoneid, Room: $roomid.
  if $zoneid = "107a" then echo Waiting to arrive.
  else
  {
    if $zoneid = 107 then
    {
      var startingzone 107
      if $roomid != "113" then
      {
        gosub MOVE 113
        put go galley
      }
      if $zoneid != "107a" then echo Waiting for the galley.
    }
    if $zoneid = 108 then
    {
      var startingzone 108
      if $roomid != "151" then
      {
        gosub MOVE 151
        put go galley
      }
      if $zoneid != "107a" then echo Waiting for the galley.
    }
  }
  goto GALLEYLOOP

GALLEYLOOP:
  if %galleydone = 1 then goto GALLEYEND
  pause 1
  goto GALLEYLOOP
  
GALLEYEND:
  echo galleyend.  Startingzone: %startingzone
  put look
  pause 1
  if matchre("$roomexits", "southwest" then put sw
  if matchre("$roomexits", "north" then put n
  pause 1
  put #echo %alertwindow [UPKEEP] Completed galley travel in Zone: $zoneid.
  action (galley) off
  return



MOVEROOMS:
  pause .1
  pause .01
  if ("$1" = "move") then var movement $2
  else var movement $0
  goto MOVEROOMSMAIN
MOVEROOMSMAINP:
  pause
MOVEROOMSMAIN:
  matchre MOVEROOMSMAINP %waitstring
  matchre RETURN ^Obvious
  matchre RETURN ^You can't
  match RETURN Please rephrase that command.
  matchre MOVEROOMSRET You are engaged to
  put %movement
  matchwait 10
	var timeoutsub MOVEROOMS
  var timeoutcommand %movement
	goto TIMEOUT

MOVEROOMSRET:
  gosub RETREAT
  goto MOVEROOMSMAIN
  

ROLLP:
  pause
ROLL:
  matchre ROLLP %waitstring
  matchre ROLL You roll around on the ground in an attempt to extinguish the fire\.|You continue to roll around frantically.  It seems to be doing some good\.
  match RETURN You roll around on the ground, completely extinguishing the flames.
  match RETURN You roll around on the ground.
  match ROLLLIE You're not lying down.  What do you want to roll?
  put roll
  matchwait 5
	var timeoutsub ROLL
  var timeoutcommand roll
	goto TIMEOUT

ROLLLIE:
  gosub LIE
  goto ROLL


SITP:
  pause
SIT:
  matchre SITP %waitstring
  matchre RETURN You sit down\.|You sit up\.|You are already sitting\.
  put sit  
  matchwait 5
	var timeoutsub SIT
  var timeoutcommand sit
	goto TIMEOUT


SNEAKROOMS:
  pause .1
  pause .01
  var movement $0
  goto SNEAKROOMSMAIN
SNEAKROOMSMAINP:
  pause
SNEAKROOMSMAIN:
  matchre SNEAKROOMSMAINP %waitstring
  matchre RETURN ^Obvious
  matchre RETURN ^You can't|
  match SNEAKROOMSATFEET You find yourself unable to sneak with items at your feet.
  put sneak %movement
  put stand
  matchwait 5
	var timeoutsub SNEAKROOMS
  var timeoutcommand stand
	goto TIMEOUT

SNEAKROOMSATFEET:
  gosub STOWALL
  gosub STOWFEET
  goto SNEAKROOMSMAIN
  

STANDP:
  pause
STAND:
  if (($prone = 1) || ($sitting = 1) || ($kneeling = 1)) then
  {
		matchre RETURN You are already standing.|You stand back up.|You stand up in the water.
		matchre STAND ^The weight of all your possessions prevents you from standing\.$|^You are so unbalanced you cannot manage to stand\.$|^You are overburdened and cannot manage to stand\.$
		match RETURN You're unconscious!
		matchre STANDP %waitstring
		put stand
		matchwait 5
		var timeoutsub STAND
		var timeoutcommand stand
		goto TIMEOUT
  }
  else return


#####THIEF_SUBS#####


KHRI:
  var khristring $0
  goto KHRIMAIN
KHRIP:
  pause
KHRIMAIN:
  matchre KHRIP %waitstring
  matchre KHRIRETURN Roundtime|You're already using the|You have not recovered from your previous use|Your body is willing, but you can't seem to concentrate
  matchre KHRIKNEEL Your mind and body are willing, but you feel you lack the skill to begin that khri.
  put khri %khristring
  matchwait 5
	var timeoutsub KHRI
  var timeoutcommand khri %khristring
	goto TIMEOUT

KHRIKNEEL:
  gosub KNEEL
  goto KHRIMAIN
  
KHRIRETURN:
  if $sitting = 1 then gosub STAND
  if $kneeling = 1 then gosub STAND
  if $prone = 1 then gosub STAND
  return


KHRISTOP:
  var khristopstring $0
  goto KHRISTOPMAIN
KHRISTOPP:
  pause
KHRISTOPMAIN:
  matchre KHRISTOPP %waitstring
  matchre RETURN You attempt to relax your mind from
  put khri stop %khristopstring
  matchwait 5
	var timeoutsub KHRISTOP
  var timeoutcommand khri stop %khristopstring
	goto TIMEOUT


#####BARBARIAN_SUBS#####

BERSERK:
  var berserktype $0
  goto BERSERKMAIN
BERSERKP:
  pause
BERSERKMAIN:
  if (%t < %nextberserk) then return
  matchre BERSERKP %waitstring
  match BERSERKWRONG You have no idea how to do that.
  match BERSERKTRAIN You have not been trained in that manner of berserking.
  matchre BERSERKRETURN Roundtime|The momentous rage of the avalanche replenishes your energy\!|A ravenous energy fills your limbs and you feel yourself growing healthier\!|You struggle\, but find yourself lacking the inner fire to enact such a rage\!|A vortex of malice springs into being\, expanding your focus and steadying your shield arm\!|Fury storming forth\, your pulse whips itself up to a furious tempo\!|You sense the rage within you well up and explode in a wild rage of dangerous power\.|You form the epicenter of a violent rage bent on crumbling your enemies\!|The momentus eruption of the volcano hardens you against damage\!|Careful control and timing of rage can provide reflexes capable of weathering even a landslide\.|In a flash your body fills with a flood of resilient rage\!|A supernatural strength and need to lash out at your foes inhabits you\.|A supernatural timing pulses through your veins, steadying your reaction against reflex based contests\!|The .* in your hands suddenly feels easier to wield, and more capable of powerful attacks\.|Unleashing a blizzard of hate, its raging violence amplifies the damage of your attacks\!|Fury wells up from within and swirls into a raging hurricane that leaves you in the calm eye of its center, supremely focused\.
  match BERSERKRETURN Your hands shake in anticipation of releasing the fury of the tsunami down upon your foes!
  matchre BERSERKRETURN But you are already enraged with that berserk\.
  match BERSERKPAUSE Your inner fire lacks the strength to fuel such a rage at this time.
  put berserk %berserktype
  matchwait 5
	var timeoutsub BERSERKMAIN
  var timeoutcommand berserk %berserktype
	goto TIMEOUT
	
BERSERKALREADY:
  put #echo %alertwindow Yellow Attempted to start a berserk that was already up!
  goto BERSERKRETURN

BERSERKPAUSE:
  var nextberserk %t
  math nextberserk add 120
  return

BERSERKRETURN:
  gosub MEDITATEPOWER
  return

BERSERKWRONG:
  put #echo >$alertwindow Yellow Tried to start %berserktype berserk, but that is not a valid form!  Please investigate.
  put #flash
  put #play JustArrived
  return

BERSERKTRAIN:
  put #echo >$alertwindow Yellow Tried to start %berserktype berserk, but you are not trained in that yet!  Please investigate.
  put #flash
  put #play JustArrived
  return

BERSERKSTOPALLP:
  pause
BERSERKSTOPALL:
  matchre BERSERKP %waitstring
  match BARBRETURN A good positive attitude never hurts.
  match BARBRETURN Maybe try berserking first?
  put berserk stop all
  put yes
  matchwait 5
	var timeoutsub BERSERKSTOPALL
  var timeoutcommand berserk stop all
	goto TIMEOUT


FORM:
  var formtype $0
  goto FORMMAIN
FORMP:
  pause
FORMMAIN:
  matchre FORMP %waitstring
  match FORMBAD You find yourself unable to focus on an additional form.  Perhaps try stopping one first?
  match FORMWRONG You have no idea how to do that.
  match FORMTRAIN You have not been trained in that form.
  matchre BARBRETURN But you are already practicing that form!|Roundtime
  put form start %formtype
  matchwait 5
	var timeoutsub FORMMAIN
  var timeoutcommand form start %formtype
	goto TIMEOUT

FORMBAD:
  put #echo >$alertwindow Yellow Tried to start %formtype form, but there were already 5 forms up!  Please investigate.
  put #flash
  put #play JustArrived
  return

FORMWRONG:
  put #echo >$alertwindow Yellow Tried to start %formtype form, but that is not a valid form!  Please investigate.
  put #flash
  put #play JustArrived
  return

FORMTRAIN:
  put #echo >$alertwindow Yellow Tried to start %formtype form, but you are not trained in that yet!  Please investigate.
  put #flash
  put #play JustArrived
  return
  
BARBRETURN:
  gosub MEDITATEPOWER
  return

FORMSTOPP:
  pause
FORMSTOP:
  matchre FORMSTOPP %waitstring
  matchre BARBRETURN But you are not practicing that form!|You feel your inner fire cool as you finish practicing the Form|The powerful gait of the Buffalo form
  put form stop %formtype
  matchwait 5
	var timeoutsub FORMSTOP
  var timeoutcommand form stop %formtype
	goto TIMEOUT

FORMSTOPALLP:
  pause
FORMSTOPALL:
  matchre FORMSTOPALLP %waitstring
  matchre BARBRETURN You relax your body and cease practicing all form types\.|You feel your inner fire cool as you finish practicing the Form|You have to be practicing a form to be able to stop it\.
  put form stop all
  matchwait 5
	var timeoutsub FORMSTOPALL
  var timeoutcommand form stop all
	goto TIMEOUT


MEDITATEPOWERP:
  pause
MEDITATEPOWER:
  matchre MEDITATEPOWERP %waitstring
  match RETURN You feel a jolt as your vision snaps shut.
  match MEDITATEPOWERP But you are currently starting a meditation, and cannot focus your mind on another.
  put meditate power
 	matchwait 5
	var timeoutsub MEDITATEPOWER
	var timeoutcommand meditate power
	goto TIMEOUT
	
	
MEDITATIONP:
  pause
MEDITATION:
  matchre MEDITATIONP %waitstring
  match MEDITATIONBAD You find yourself unable to focus on an additional meditation.  Perhaps try stopping one first?
  match MEDITATIONWRONG You have no idea how to do that.
  match MEDITATIONTRAIN You have not been trained in that type of meditation.
  match MEDITATIONRETURN Roundtime
  match RETURN Your inner fire lacks the strength to empower such a potent mental activity.
  put meditate %meditationtype
  matchwait 5
  var timeoutsub MEDITATION
  var timeoutcommand meditate %meditationtype
	goto TIMEOUT

MEDITATIONRETURN:
  gosub STAND
  gosub MEDITATEPOWER
  return

MEDITATIONBAD:
  #put #echo >$alertwindow Yellow Tried to start %meditationtype meditation, but there were already 3 meditations up!  Please investigate.
  #put #flash
  #put #play JustArrived
  gosub MEDITATEPOWER
  return

MEDITATIONWRONG:
  put #echo >$alertwindow Yellow Tried to start %meditationtype meditation, but that is not a valid form!  Please investigate.
  put #flash
  put #play JustArrived
  return
  
MEDITATIONTRAIN:
  put #echo >$alertwindow Yellow Tried to start %meditationtype meditation, but you are not trained in that yet!  Please investigate.
  put #flash
  put #play JustArrived
  return

MEDITATIONSTOPP:
  pause
MEDITATIONSTOP:
  matchre MEDITATIONSTOPP %waitstring
  match RETURN You take a deep breath and exhale, releasing the beneficial flames burning deep within your mind.
  put meditation stop %medittype
  matchwait 5
  var timeoutsub MEDITATIONSTOP
  var timeoutcommand meditation stop %medittype
	goto TIMEOUT

ROARP:
  pause
ROAR:
  var nextroar%roartype %t
  math nextroar%roartype add 120
  matchre ROARP %waitstring
  matchre ROARFACE You are not facing an enemy to roar at!
  matchre RETURN Roundtime|Strain though you might, you cannot muster|You have not been trained in that roar.
  match RETURN You strain but are unable to muster the voice necessary to intimidate your foe!
  put roar quiet %roartype
  matchwait 5
  var timeoutsub ROAR
  var timeoutcommand roar quiet %roartype
	goto TIMEOUT

ROARFACE:
  gosub FACE
  if %badface = 1 then
  {
    var badface 0
    return
  }
  goto ROAR

WARHORNP:
  pause
WARHORN:
  matchre WARHORNP %waitstring
  matchre RETURN Roundtime
  put exhale warhorn lure
  matchwait 5
  var timeoutsub WARHORN
  var timeoutcommand exhale %warhornitem lure
	goto TIMEOUT



#####MAGIC_LOGIC#####
  
CASTRESET:
	var cambcharge 0
  var cambcharge1 0
  var cambcharge2 0
  var ready 0
  var prepped 0
  var charged 0
  var invoked 0
  var harnessed 0
  var spelldifficulty -1
  var spellpercent 100
  var spellprepping
  var prepmana 0
  var cambmana 0
  var harnmana 0
  var harntapped 0
  var cambmana1 0
  var cambmana2 0
  var tattoocast 0
  var tmcast 0
  var debilcast 0
  var cycliccast 0
  var casting 0
  var spellsymb 0
  var cambtapped 0
  var cambsplitting 0
  var splittingmana 0
  var splitcount 0
  var multicast 0
  var scancel 0
  var ctoverride 0
  var omcast 0
  var preptime 0
  return

CASTINGLOGIC:
  #NECRO
  if ("%necrosafety" = "YES") then
  {
    gosub NSAFETYCHECK
    if (%necrogood != 1) then return
  }
  #DIFFICULTY_SETTING
  if (%spelldifficulty = -1) then gosub SPELLSTATCHECK %spellprepping
  if (%spellsymb != 1) then
  {
    if (%spelldifficulty > 0) then
    {
      if ((%spellmana != %nativemana) && (%spellmana != 0) then
      {
        var spellpercent 100
        #var spellpercent %sorcdifficulty%spelldifficultypercent
      }
      else
      {
        if (%tmcast = 1) then var spellpercent 100
        else var spellpercent %difficulty%spelldifficultypercent
      }
    }
    else
    {
      put #echo Yellow Unknown spell!
      var spellpercent 100
    }
  }
  else var spellpercent 100
  #put #echo Yellow spellpercent: %spellpercent
  #EARLY_READINESS
  if ((%spelldifficulty > 0) && (%spellpercent < 100) then
  {
    var spellpreptest $spelltime
    math spellpreptest divide $spellpreptime
    math spellpreptest * 100
    if (%spellpreptest >= %spellpercent) then
    {
      var ready 1
      put #echo Yellow Ready due to being %spellpreptest% done vs %spellpercent% for the difficulty!
    }
  }
  #EARLY_HARNESSING
  if ((%harnmana > 0) && (%harnessed = 0)) then
  {
    #echo spellpreptime: $spellpreptime
    var harnesstest %spellpercent
    math harnesstest divide 100
    math harnesstest * $spellpreptime
    #echo total prep time: %harnesstest
    math harnesstest subtract %harnesstime
    #echo harness prep time: %harnesstest
    if ($spelltime >= %harnesstest) then
    {
      #echo harnesstest: %harnesstest
      #echo spelltime: $spelltime
      gosub HARNESS
    }
  }
  #NEEDS_PREP
  if (%prepped != 1) then
  {
    gosub ARRANGEMANA
    if ($concentration >= %minconcentration) then gosub PREP
  }
  #PREPPED
  if (%prepped = 1) then
  {
    if ((contains("%rituals", "|%spellprepping|")) && (%invoked != 1)) then gosub RITUAL
    if (%charged != 1) then
    {
      if (%cambtapped > 0) then
      {
        if (%t > %cambtapped) then gosub CHARGE
      }
      else gosub CHARGE
    }
  }
  #READY_TO_CAST
  if ((%ready = 1) && (%cambtapped != 1)) then 
  {
    #SYMBIOSIS
    if (%spellsymb = 1) then
    {
      #if (%symbiosis = 0) then gosub PREPSYMBIOSIS
      gosub PREPSYMBIOSIS
    }
    else
    {
      if (%symbiosis = 1) then gosub RELSYMBIOSIS
    }
    #HARNESSING
    if ((%harnmana > 0) && (%harnessed = 0)) then gosub HARNESS
    gosub CAST
  }
  else
  {
    var preptimetest %t
    math preptimetest subtract %preptime
    if %preptimetest > 300 then gosub SPELLCANCEL
  }
  return

ARRANGEMANA:
  var harnmana 0
  var cambmana 0
  #Lock_checking
  if (%buffingonly != 1) then
  {
    if $Arcana.LearningRate < 20 then var arcanalock 0
    if $Arcana.LearningRate > 31 then var arcanalock 1
    if $Arcana.Ranks >= 1750 then var arcanalock 1
    if $Attunement.LearningRate < 20 then var attunelock 0
    if $Attunement.LearningRate > 31 then var attunelock 1
    if $Attunement.Ranks >= 1750 then var attunelock 1
  }
  else
  {
    var attunelock 0
    var arcanalock 0
  }
  if (("%straightcast" = "YES") && (%tattoocast != 1)) then
  {
    if ((%attunelock = 1) && (%arcanalock = 1)) then
    {
      math prepmana add %addmana
      var addmana 0
      return
    }
  }
  #if ((contains("%rituals", "|%spellprepping|")) && (%invoked != 1)) then gosub RITUAL
  #Arrange_logic
  if ("%harnessing" = "YES") then
  {
    if ("%cambrinth" = "NO") then var harnmana %addmana
    else
    {  
      if (%arcanalock = 1) then var harnmana %addmana
      else
      {
        if (%addmana > %totalcamb) then
        {
          var cambmana %totalcamb
          var harnmana %addmana
          math harnmana subtract %totalcamb
        }  
        else var cambmana %addmana 
      }
    }
    if ((%harnmana > 0) && (%harnmana > %harnessmax)) then
    {
      var hsplitcounter 1
      gosub HARNSPLITLOOP
    }
    else
    {
      var harnnumber 1
      var harnmana1 %harnmana
    }
    #HARNESS_TIME
    var harnesstime %harnnumber
    math harnesstime * 2
    math harnesstime add 1.5
  }
  else
  {
    if %cambrinth = "YES" then
    {
      if %addmana <= %totalcamb then var cambmana %addmana
      else var cambmana %totalcamb
    }
    else
    {
      math prepmana add %addmana
      var addmana 0
    }
  }
  
  return


CASTCLEANUP:
  if ((%pcast = 1) || (%kcast = 1)) then goto CASTCLEANUPSIMPLE
  goto CASTCLEANUPMAIN

CASTCLEANUPSIMPLE:
  if %spellprepping = "shadowling" then gosub INVOKESHADOW
  if %spellprepping = "iots" then put invoke circle
  if %spellprepping = "bg" then
  {
    gosub PERCSELF
    var bgdone 0
	}
	if %spellprepping = "mab" then
	{
	  send prep cantrip r s
	  send gesture ballista
	  pause 1
	  gosub BALLISTARUB
	}
	if %pcast = 1 then put #parse PCASTING COMPLETE!
	if %astralcast = 1 then return
  if %kcast = 1 then
  {
    if (%buffing = 1) then gosub PERCSELF
    gosub CASTRESET
    return
  }
  if %multicast = 1 then goto MULTICASTRESET
  exit
  
CASTCLEANUPMAIN:
  if (%scancel = 1) then
  {
    gosub SPELLCANCEL
  }
  if (%symbiosis = 1) then
  {
    gosub PREPSYMBIOSIS
    gosub RELSYMBIOSIS
  }
  if ($Attunement.LearningRate > 33) then var attunelock 1
  if ($Arcana.LearningRate > 33) then var arcanalock 1
  if ("%spellprepping" = "db") then var dbready 1
	if ("%spellprepping" = "ignite") then
	{
	  if (%buffing != 1) then gosub RELNSPELL ignite
	  if (%ignitestow = 1) then
	  {
	    var ignitestow 0
	    var stowitem %ignitebackup
	    gosub STOWITEM
	  }
	}
  if ("%spellprepping" = "mab") then
	{
	  send prep cantrip r s
	  send gesture ballista
	  pause 1
	  gosub BALLISTARUB
	}
	if ("%spellprepping" = "iots") then put invoke circle
  if ("%spellprepping" = "shadowling") then gosub INVOKESHADOW
	if (("%spellprepping" = "tkt") || ("%spellprepping" = "tks")) then
	{
  	gosub GETITEM %tktitem
    gosub STOWITEM %tktitem
	}
	gosub CASTRESET
	if %buffing = 1 then gosub PERCSELF
	var nextcast %t
	math nextcast add %castingthrottle
	return



SPELLCANCEL:
  var scancel 0
  if (%harnmana > 0) then gosub RELMANA
  if ("$preparedspell" != "None") then gosub RELSPELL
  gosub CASTRESET
  return


SPELLVARSLOOP:
  math spellvarscount add 1
  if %spellvarscount > %buffnum then return
  var spellname %buff%spellvarscount
  gosub SPELLIDENT
  var buff%spellvarscountvar %spellvar
  #echo buff%spellvarscountvar: %buff%spellvarscountvar
  goto SPELLVARSLOOP

OMSPELLVARSLOOP:
  math spellvarscount add 1
  if %spellvarscount > %ombuffnum then return
  var spellname %ombuff%spellvarscount
  gosub SPELLIDENT
  var ombuff%spellvarscountvar %spellvar
  #echo ombuff%spellvarscountvar: %ombuff%spellvarscountvar
  goto OMSPELLVARSLOOP

SPELLIDENT:
  if %spellname = "aa" then var spellvar SpellTimer.AspirantsAegis
  if %spellname = "ab" then var spellvar SpellTimer.AirBubble
  if %spellname = "abs" then var spellvar SpellTimer.Absolution
  if %spellname = "aeg" then var spellvar SpellTimer.AegisofGranite 
  if %spellname = "ags" then var spellvar SpellTimer.AggressiveStance
  if %spellname = "art" then var spellvar SpellTimer.ArtificersEye
  if %spellname = "as" then var spellvar SpellTimer.AntiStun
  if %spellname = "aus" then var spellvar SpellTimer.AuraSight
  if %spellname = "auspice" then var spellvar SpellTimer.Auspice
  if %spellname = "ava" then var spellvar SpellTimer.AvrenAevareae
  if %spellname = "awaken" then var spellvar SpellTimer.Awaken
  if %spellname = "bc" then var spellvar SpellTimer.BraunsConjecture
  if %spellname = "benediction" then var spellvar SpellTimer.Benediction
  if %spellname = "bless" then var spellvar SpellTimer.Bless
  if %spellname = "bloodthorns" then var spellvar SpellTimer.Bloodthorns
  if %spellname = "bs" then var spellvar SpellTimer.BloodStaunching
  if %spellname = "bg" then var spellvar SpellTimer.BlufmorGaraen
  if %spellname = "blur" then var spellvar SpellTimer.Blur
  if %spellname = "bue" then var spellvar SpellTimer.ButchersEye
  if %spellname = "care" then var spellvar SpellTimer.CaressoftheSun
  if %spellname = "centering" then var spellvar SpellTimer.Centering
  if %spellname = "ch" then var spellvar SpellTimer.CalcifiedHide
  if %spellname = "clarity" then var spellvar SpellTimer.Clarity
  if %spellname = "col" then var spellvar SpellTimer.CageofLight
  if %spellname = "cotc" then var spellvar SpellTimer.ClawsoftheCougar
  if %spellname = "courage" then var spellvar SpellTimer.Courage
  if %spellname = "cv" then var spellvar SpellTimer.ClearVision
  if %spellname = "da" then var spellvar SpellTimer.DivineArmor
  if %spellname = "dc" then var spellvar SpellTimer.DestinyCipher
  if %spellname = "db" then var spellvar SpellTimer.DragonsBreath
  if %spellname = "dema" then var spellvar SpellTimer.DesertsMaelstrom
  if %spellname = "dr" then var spellvar SpellTimer.DivineRadiance
  if %spellname = "drum" then var spellvar SpellTimer.DrumsoftheSnake
  if %spellname = "ease" then var spellvar SpellTimer.EaseBurden
  if %spellname = "echo" then var spellvar SpellTimer.EchoesofAether
  if %spellname = "ecry" then var spellvar SpellTimer.EilliesCry
  if %spellname = "eli" then var spellvar SpellTimer.Elision
  if %spellname = "em" then var spellvar SpellTimer.EarthMeld
  if %spellname = "emc" then var spellvar SpellTimer.EmuinsCandlelight
  if %spellname = "enrichment" then var spellvar SpellTimer.Enrichment
  if %spellname = "es" then var spellvar SpellTimer.EtherealShield
  if %spellname = "etc" then var spellvar SpellTimer.EmbedtheCycle
  if %spellname = "ey" then var spellvar SpellTimer.EssenceofYew
  if %spellname = "fin" then var spellvar SpellTimer.Finesse
  if %spellname = "fotf" then var spellvar SpellTimer.FailureoftheForge
  if %spellname = "gf" then var spellvar SpellTimer.GroundingField
  if %spellname = "gg" then var spellvar SpellTimer.GlythtidesGift
  if %spellname = "ghoulflesh" then var spellvar SpellTimer.Ghoulflesh
  if %spellname = "gi" then var spellvar SpellTimer.GamIrnan
  if %spellname = "gol" then var spellvar SpellTimer.GiftofLife
  if %spellname = "halo" then var spellvar SpellTimer.Halo
  if %spellname = "harm" then var spellvar SpellTimer.Harmony
  if %spellname = "hes" then var spellvar SpellTimer.HeroicStrength
  if %spellname = "hol" then var spellvar SpellTimer.HandsofLirisa
  if %spellname = "ignite" then var spellvar SpellTimer.Ignite
  if %spellname = "ic" then var spellvar SpellTimer.IronConstitution
  if %spellname = "inst" then var spellvar SpellTimer.Instinct
  if %spellname = "iots" then var spellvar SpellTimer.InvocationoftheSpheres
  if %spellname = "ivm" then var spellvar SpellTimer.IvoryMask
  if %spellname = "ks" then var spellvar SpellTimer.KuraSilma
  if %spellname = "lw" then var spellvar SpellTimer.LayWard
  if %spellname = "lgv" then var spellvar SpellTimer.LastGiftofVithwokIV
  if %spellname = "maf" then var spellvar SpellTimer.ManifestForce
  if %spellname = "mapp" then var spellvar SpellTimer.MajorPhysicalProtection
  if %spellname = "mef" then var spellvar SpellTimer.MentalFocus
  if %spellname = "meg" then var spellvar SpellTimer.MembrachsGreed
  if %spellname = "mis" then var spellvar SpellTimer.Misdirection
  if %spellname = "mpp" then var spellvar SpellTimer.MinorPhysicalProtection
  if %spellname = "mf" then var spellvar SpellTimer.MurrulasFlames
  if %spellname = "mo" then var spellvar SpellTimer.MarshalOrder
  if %spellname = "mof" then var spellvar SpellTimer.MantleofFlame
  if %spellname = "mon" then var spellvar SpellTimer.MemoryofNature
  if %spellname = "name" then var spellvar SpellTimer.NamingofTears
  if %spellname = "non" then var spellvar SpellTimer.Nonchalance
  if %spellname = "nou" then var spellvar SpellTimer.Noumena
  if %spellname = "oath" then var spellvar SpellTimer.OathoftheFirstborn
  if %spellname = "obfuscation" then var spellvar SpellTimer.Obfuscation
  if %spellname = "phk" then var spellvar SpellTimer.PlatinumHandsofKertigen
  if %spellname = "php" then var spellvar SpellTimer.PhilosophersPreservation
  if %spellname = "pg" then var spellvar SpellTimer.PiercingGaze
  if %spellname = "pom" then var spellvar SpellTimer.PersistenceofMana
  if %spellname = "pop" then var spellvar SpellTimer.PerseveranceofPeriel
  if %spellname = "pfe" then var spellvar SpellTimer.ProtectionfromEvil
  if %spellname = "psy" then var spellvar SpellTimer.PsychicShield
  if %spellname = "rage" then var spellvar SpellTimer.RageoftheClans
  if %spellname = "repr" then var spellvar SpellTimer.RedeemersPride
  if %spellname = "refresh" then var spellvar SpellTimer.Refresh
  if %spellname = "rei" then var spellvar SpellTimer.ResearchersInsight
  if %spellname = "rits" then var spellvar SpellTimer.RiverintheSky
  if %spellname = "rw" then var spellvar SpellTimer.RighteousWrath
  if %spellname = "sl" then var spellvar SpellTimer.SanyuLyba
  if %spellname = "seer" then var spellvar SpellTimer.SeersSense
  if %spellname = "shadowling" then var spellvar SpellTimer.Shadowling
  if %spellname = "shadows" then var spellvar SpellTimer.Shadows
  if %spellname = "sk" then var spellvar SpellTimer.SyamelyoKuniyo
  if %spellname = "sks" then var spellvar SpellTimer.SkeinofShadows
  if %spellname = "sol" then var spellvar SpellTimer.ShieldofLight
  if %spellname = "solace" then var spellvar SpellTimer.Solace
  if %spellname = "sos" then var spellvar SpellTimer.SoulShield
  if %spellname = "sott" then var spellvar SpellTimer.SensesoftheTiger
  if %spellname = "soul" then var spellvar SpellTimer.SoulAblaze
  if %spellname = "sr" then var spellvar SpellTimer.SentinelsResolve
  if %spellname = "stc" then var spellvar SpellTimer.StellarCollector
  if %spellname = "stw" then var spellvar SpellTimer.SeetheWind
  if %spellname = "substratum" then var spellvar SpellTimer.Substratum
  if %spellname = "suf" then var spellvar SpellTimer.SureFooting
  if %spellname = "sw" then var spellvar SpellTimer.SwirlingWinds
  if %spellname = "tk" then var spellvar SpellTimer.TamsinesKiss
  if %spellname = "tksh" then var spellvar SpellTimer.TelekineticShield
  if %spellname = "tranquility" then var spellvar SpellTimer.Tranquility
  if %spellname = "trc" then var spellvar SpellTimer.TrabeChalice
  if %spellname = "turi" then var spellvar SpellTimer.TurmarIllumination
  if %spellname = "tw" then var spellvar SpellTimer.Tailwind
  if %spellname = "voi" then var spellvar SpellTimer.VeilofIce
  if %spellname = "vigor" then var spellvar SpellTimer.Vigor
  if %spellname = "will" then var spellvar SpellTimer.WillofWinter
  if %spellname = "ws" then var spellvar SpellTimer.WolfScent
  if %spellname = "wotp" then var spellvar SpellTimer.WisdomofthePack
  if %spellname = "worm" then var spellvar SpellTimer.WormsMist
  if %spellname = "ys" then var spellvar SpellTimer.YntrelSechra
  return  


KHRIVARS:
  if %khridebiltype = prowess then var khridebilvar SpellTimer.KhriProwess
  if %khridebiltype = guile then var khridebilvar SpellTimer.KhriGuile
  if %khridebiltype = credence then var khridebilvar SpellTimer.KhriCredence
  if %khridebiltype = terrify then var khridebilvar SpellTimer.KhriTerrify
  if %khridebiltype = intimidate then var khridebilvar SpellTimer.KhriIntimidate
  if %khridebiltype = eliminate then var khridebilvar SpellTimer.KhriEliminate
  return



CYCSPELLVARSLOOP:
  math spellvarscount add 1
  if %spellvarscount > 3 then return
  if %spellc%spellvarscount = "ac" then var spellc%spellvarscountvar SpellTimer.AetherCloak
  if %spellc%spellvarscount = "ad" then var spellc%spellvarscountvar SpellTimer.AesandryDarlaeth
  if %spellc%spellvarscount = "af" then var spellc%spellvarscountvar SpellTimer.AwakenForest
  if %spellc%spellvarscount = "bes" then var spellc%spellvarscountvar SpellTimer.BearStrength
  if %spellc%spellvarscount = "botf" then var spellc%spellvarscountvar SpellTimer.BlessingoftheFae
  if %spellc%spellvarscount = "care" then var spellc%spellvarscountvar SpellTimer.CaressoftheSun
  if %spellc%spellvarscount = "cs" then var spellc%spellvarscountvar SpellTimer.CheetahSwiftness
  if %spellc%spellvarscount = "eye" then var spellc%spellvarscountvar SpellTimer.EyeofKertigen
  if %spellc%spellvarscount = "fae" then var spellc%spellvarscountvar SpellTimer.FaenellasGrace
  if %spellc%spellvarscount = "ghs" then var spellc%spellvarscountvar SpellTimer.GhostShroud
  if %spellc%spellvarscount = "ghs" then var spellc%spellvarscountvar SpellTimer.GhostShroud
  if %spellc%spellvarscount = "gj" then var spellc%spellvarscountvar SpellTimer.GlythtidesJoy
  if %spellc%spellvarscount = "hodi" then var spellc%spellvarscountvar SpellTimer.HodiernasLilt
  if %spellc%spellvarscount = "how" then var spellc%spellvarscountvar SpellTimer.HolyWarrior
  if %spellc%spellvarscount = "mom" then var spellc%spellvarscountvar SpellTimer.MaskoftheMoons
  if %spellc%spellvarscount = "regenerate" then var spellc%spellvarscountvar SpellTimer.Regenerate
  if %spellc%spellvarscount = "rev" then var spellc%spellvarscountvar SpellTimer.Revelation
  if %spellc%spellvarscount = "roc" then var spellc%spellvarscountvar SpellTimer.RiteofContrition
  if %spellc%spellvarscount = "rog" then var spellc%spellvarscountvar SpellTimer.RiteofGrace
  if %spellc%spellvarscount = "sanctuary" then var spellc%spellvarscountvar SpellTimer.Sanctuary
  if %spellc%spellvarscount = "sov" then var spellc%spellvarscountvar SpellTimer.StepsofVuan
  if %spellc%spellvarscount = "tr" then var spellc%spellvarscountvar SpellTimer.TruffenyisRally  
  goto CYCSPELLVARSLOOP

CYCTMDBVARS:
  if %spellcyctm = "aban" then var spellc4var SpellTimer.AbandonedHeart
  if %spellcyctm = "ars" then var spellc4var SpellTimer.ArbitersStylus
  if %spellcyctm = "fr" then var spellc4var SpellTimer.FireRain
  if %spellcyctm = "gs" then var spellc4var SpellTimer.GuardianSpirit
  if %spellcyctm = "iz" then var spellc4var SpellTimer.IcutuZaharenela
  if %spellcyctm = "pyre" then var spellc4var SpellTimer.Pyre
  if %spellcyctm = "rim" then var spellc4var SpellTimer.Rimefang
  if %spellcyctm = "ros" then var spellc4var SpellTimer.RingofSpears
  if %spellcyctm = "sa" then var spellc4var SpellTimer.SoulAttrition
  if %spellcyctm = "sls" then var spellc4var SpellTimer.StarlightSphere
  if %spellcyctm = "usol" then var spellc4var SpellTimer.UniversalSolvent
  if %spellcycdebil = "alb" then var spellc5var SpellTimer.AlbredasBalm
  if %spellcycdebil = "dalu" then var spellc5var SpellTimer.DamarisLullaby
  if %spellcycdebil = "dema" then var spellc5var SpellTimer.DesertsMaelstrom
  if %spellcycdebil = "ee" then var spellc5var SpellTimer.ElectrostaticEddy
  if %spellcycdebil = "hyh" then var spellc5var SpellTimer.HydraHex
  if %spellcycdebil = "shw" then var spellc5var SpellTimer.ShadowWeb
  return


#####MAGIC_SUBS#####


CASTP:
	pause
CAST:
  var casttarget
  if %spellprepping = "aeg" then
  {
    if $SpellTimer.MantleofFlame.active = 1 then gosub RELNSPELL mof
  }
  if %spellprepping = "mof" then
  {
    if $SpellTimer.AegisofGranite.active = 1 then gosub RELNSPELL aeg
  }
  if %spellprepping = "sap" then var casttarget augmentation
  if %spellprepping = "bless" then
  {
    if ("$righthandnoun" = "wine") then var casttarget wine
  }
  if (%spellprepping = "devour") then
  {
    if matchre ("$roomobjs", "(\w+) ((which|that) appears dead|\(dead\))") then
	  {
	    var ritualmonster $1
	    gosub CONSUME
	  }
	  else
	  {
      if ((matchre("$righthandnoun", "material")) || (matchre("$lefthandnoun", "material"))) then 
      else
      {
        if (("$righthand" != "Empty") && ("$lefthand" != "Empty")) then
        {
          gosub STOW right
        }
        gosub GETITEM material
        if ((matchre("$righthandnoun", "material")) || (matchre("$lefthandnoun", "material"))) then 
        else
        {
          gosub SPELLCANCEL
          return
        }
      }
	  }
  }
  if %spellprepping = "ignite" then
  {
    if %ctoverride != 1 then
    {
      if ("$righthand" != "Empty") then var irighthandnoun $righthandnoun
      else var irighthandnoun ----
      if ("$lefthand" != "Empty") then var ilefthandnoun $lefthandnoun
      else var ilefthandnoun ----
      #echo IgniteWeapons: %igniteweapon
      #echo Righthand: %irighthandnoun
      #echo Lefthand: %ilefthandnoun
      if ((matchre ("%igniteweapon", "%irighthandnoun")) || (matchre ("%igniteweapon", "%ilefthandnoun"))) then
      {
        if (matchre ("%igniteweapon", "%irighthandnoun")) then
        {
          #echo Right hand!
          var casttarget $righthand
        }
        else
        {
          #echo Left hand!
          var casttarget $lefthand
        }
      }
      else
      {
        #echo Ignite: Grabbing a weapon to cast on.
        var ignitestow 1
        gosub GETITEM %ignitebackup
        var casttarget %ignitebackup
      }
      if $SpellTimer.Ignite.active = 1 then
      {
        gosub RELNSPELL ignite
        #if %lastignite != %casttarget then waitfor The flames dancing
        #var lastignite %casttarget
      }
    }
    else if $SpellTimer.Ignite.active = 1 then gosub RELNSPELL ignite
  }
  if %spellprepping = "hyh" then var casttarget male offense
  if %spellprepping = "om" then var casttarget orb
  if %spellprepping = "resection" then gosub PERFORMCUT
  if %spellprepping = "rits" then var casttarget %ritstype
  #if %spellprepping = "shadowling" then put release shadowling
  if %spellprepping = "tks" then
	{
	  if matchre ("$roomobjs", "%tktitem") then
    {
    }
    else
    {
      gosub GETITEM %tktitem
      gosub DROPITEM %tktitem
    }
  }
  if %spellprepping = "tkt" then
	{
    if matchre ("$roomobjs", "%tktitem") then
    {
    }
    else
    {
      gosub GETITEM %tktitem
      gosub DROPITEM %tktitem
    }
  }
  if %cycliccast = 1 then
	{
	  var nextcyc %t
    math nextcyc add 300
	}
	if %debilcast = 1 then
	{
	  var casttarget creature  
	  if %spellprepping = "pv" then var casttarget
		if %spellprepping = "rend" then var casttarget %rendtarget
	}
  if %tmcast = 1 then
 	{
 	  var casttarget
 	  if $SpellTimer.AetherCloak.active = 1 then
	  {
	    var currentcyc 0
	    var nextcyc 0
	    put rel ac
	  }
	  if %spellprepping = "acs" then var casttarget
	  var deadcheck 1
	}
 	if %spellprepping = "etf" then var casttarget electricity
  if %spellprepping = "col" then
  {
    if $Time.isKatambaUp = 1 then var casttarget katamba
	  else
	  {
	    if $Time.isXibarUp = 1 then var casttarget xibar
	    else
	    {
	      if $Time.isYavashUp = 1 then var casttarget yavash
	      else var casttarget ambient
      }
    }
  }
  if %spellprepping = "hyh" then var casttarget %hyhcast
	if %spellprepping = "hw" then var casttarget chest  
	if %spellprepping = "iots" then
	{
	  gosub RELNSPELL iots
	  #echo %verena|%szeldia|%dawgolesh|%merewalda
	  if %verena = 1 then
	  {
	    var casttarget verena
	  }
	  else
	  {
	    if %szeldia = 1 then
	    {
	      var casttarget szeldia
	    }
	    else
	    {
	      if %dawgolesh = 1 then
	      {
	        var casttarget dawgolesh
	      }
	      else
	      {
	        if %merewalda = 1 then
	        {
	          var casttarget merewalda
	        }
	      }
	    }
	  }
	}
  matchre CASTP %waitstring
	matchre CASTCLEANUP You gesture.|You gesture at|You wave your hand|With a wave of your hand|You roll your hands in an elliptical|You clasp your hands together|You cup your hand before|You clap your hands once|Your spell|You press your fist|You reach with your fist toward the ground.|You speak a few words of righteousness|You whisper|Tendrils of flame|You make a holy gesture|You close your eyes and take several slow|You clench your hands into fists and grit your teeth|You don't think you can manage to ignite another weapon at the moment.|The flames dancing along your fingertips|Mentally steeling yourself in preparation for|You shudder involuntarily|You release an accompaniment of elemental|You thrust your (right|left) arm before you, fingers splayed\.|With a wave of your hand, your vitality is fully restored\.|You strike your heel against the ground|A sense of calm focus|Roundtime|Your heart skips a beat as your spell|You clench your fists, pressing your fingernails painfully into your flesh\.|You place your hands on your temples\.|You raise your fist toward the sun\.|You raise your hand in an imaginary toast to Glythtide\.|You drop briefly to one knee as you firmly press your palms into the ground\.|You steeple your fingers together to channel the spell's energies\.|You close your eyes and focus on the old hero, Lirisa\.|You swear|With a chirurgeon's care, you press your fingertips against the side of your neck\.
	matchre CASTBAD Currently lacking the skill|You don't have a spell prepared!|Your target pattern dissipates because|You can't cast that on anyone else!|You strain, but are too|The spell pattern resists the influx|I could not find what you were referring to.|You must specify one of the thirteen planets\.|The spell pattern resists the influx of .* mana and fails completely\.|You attempt to quiet your mind, focusing on your planar link\.|Steadying your breath, you briefly point one arm up and the other towards the ground, forming a conduit through your body\.
	#match CASTFACE You can't cast that at yourself!
	#matchre CASTLOOT is already dead, so that's a bit pointless.
	match CASTCLEANUP You can't cast that at yourself!
	matchre CASTCLEANUP is already dead, so that's a bit pointless.
	if %ctoverride = 1 then var casttarget %ctoverridevar
	if %omcast = 1 then put touch orb
	else put cast %casttarget
	matchwait 5
	var timeoutsub CAST
	if %omcast = 1 then var timeoutcommand touch orb
	else var timeoutcommand cast %casttarget
	goto TIMEOUT



PVPPREP:
  var pvpprepstring $0
  goto PVPPREPMAIN
PVPPREPP:
  pause
PVPPREPMAIN:
  matchre PVPPREPP %waitstring
	matchre RETURN You trace a|You raise your|You raise an|You begin chanting|With rigid|With meditative|With calm|With tense|You mutter|You briskly utter a few sharp words|Darkly gleaming motes of
	match RETURN As you attempt to prepare the spell, a sense of overwhelming peace washes over you.
	matchre RETURN You begin to hum|You begin your enchante|The first gentle notes|With a sharp cut to your voice|Low, hummed tones form|You begin to chant a mesmerizing|With a resounding "POP"|You begin to sing, a gentle|Wrapped in winter|You weave a soft|Slow, rich tones|Though softly humming|In a low tone you|The wailing of lost souls|Turning your focus solemnly inward|You hear the slow, rich tones of|as you trace your finger along mana|Images of streaking stars falling from the heavens flash across your vision|With great force, you slap your hands together|You direct your attention toward the heavens|You whistle an intricate sequence|A radiant glow wreathes your hands|A strong wind swirls around you|Glowing geometric patterns arc between|Light withdraws from around you|Calmly reaching out with one hand,|In one fluid motion, you bring your palms|You start frantically flailing your hands|Shadow and light collide wildly around|You gaze skyward and trace the planetary|You spin about wildly, whirling around with a feral|Throwing your head back, you release a savage roar|You gaze at your hands, touching your thumb to each|Accompanied with a flash of light, you clap your hands|Droplets of water coalesce around your fingertips|Turning your head slightly and gazing directly|Inhaling deeply, you adopt a cyclical rhythm in your breaths|You clasp your silvery-white flame shrouded hands together|Focusing intently, you slice seven straight lines through|You exhale softly, your breath flowing into a shimmering cloud|You inhale sharply, invoking the
	matchre PVPPREPREL you're already preparing|You have already fully prepared|You are already preparing
	match RETURN Something in the area interferes with your spell preparations.
	put prep %pvpprepstring
	matchwait

PVPPREPREL:
  gosub RELSPELL
  goto PVPPREP

PVPCAST:
  var pvpcaststring $0
  goto PVPCASTMAIN
PVPCASTP:
  pause
PVPCASTMAIN:
  matchre PVPCASTP %waitstring
	matchre RETURN You gesture.|You gesture at|You wave your hand|With a wave of your hand|You roll your hands in an elliptical|You clasp your hands together|You cup your hand before|You clap your hands once|Your spell|You press your fist|You reach with your fist toward the ground.|You speak a few words of righteousness|You whisper|Tendrils of flame|You make a holy gesture|You close your eyes and take several slow|You clench your hands into fists and grit your teeth|You don't think you can manage to ignite another weapon at the moment.|The flames dancing along your fingertips|Mentally steeling yourself in preparation for|You shudder involuntarily|You release an accompaniment of elemental|You thrust your (right|left) arm before you, fingers splayed\.|With a wave of your hand, your vitality is fully restored\.|You strike your heel against the ground|A sense of calm focus|Roundtime|Your heart skips a beat as your spell|You clench your fists, pressing your fingernails painfully into your flesh\.|You place your hands on your temples\.|You raise your fist toward the sun\.|You raise your hand in an imaginary toast to Glythtide\.|You drop briefly to one knee as you firmly press your palms into the ground\.|You steeple your fingers together to channel the spell's energies\.|You close your eyes and focus on the old hero, Lirisa\.|You swear|With a chirurgeon's care, you press your fingertips against the side of your neck\.
	matchre RETURN Currently lacking the skill|You don't have a spell prepared!|Your target pattern dissipates because|You can't cast that on anyone else!|You strain, but are too|The spell pattern resists the influx|I could not find what you were referring to.|You must specify one of the thirteen planets\.|The spell pattern resists the influx of .* mana and fails completely\.|You attempt to quiet your mind, focusing on your planar link\.|Steadying your breath, you briefly point one arm up and the other towards the ground, forming a conduit through your body\.
	match RETURN You can't cast that at yourself!
	matchre RETURN is already dead, so that's a bit pointless.
	put cast %pvpcaststring
	matchwait


CASTLOOT:
  gosub LOOT
  goto CAST
	
CASTBAD:
	if $preparedspell != "None" then gosub RELSPELL
  if (%harnmana > 0) then gosub RELMANA
	goto CASTRESET

CASTFACE:
  var castfacecheck 1
  gosub FACE
  if %badface = 1 then
  {
    var badface 0
    return
  }
  var castfacecheck 0
  goto CAST


CHARGE:
  if %cambmana = 0 then
  {
    var charged 1
    return
  }
  if %cambtapped > 0 then
  {
    if %t > %cambtapped then
    {
      goto CHARGELOOP
    }
    else return
  }
  #CAMBRINTH_DEVICE_SPLITTING
  if %cambmana > %totalcamb then var cambmana %totalcamb
  if %cambmana > %cambitem1mana then
  {
    var cambnumber 2
    var cambmodulus %cambmana
    math cambmodulus modulus 2
    var cambmana1 %cambmana
    math cambmana1 subtract %cambmodulus
    math cambmana1 divide 2
    var cambmana2 %cambmana1
    math cambmana1 add %cambmodulus
    var cambnumber 2
    if %cambmana1 > %cambitem1mana then
    {
      var cambmana1 %cambitem1mana
      var cambmana2 %cambmana
      math cambmana2 subtract %cambmana1
    }
    if %cambmana2 > %cambitem2mana then
    {
      var cambmana2 %cambitem2mana
      var cambmana1 %cambmana
      math cambmana1 subtract %cambmana2
    }  
  }
  else
  {
    var cambnumber 1
    var cambmana1 %cambmana
    var cambmana2 0
  }
  #echo cambmana1: %cambmana1
  #echo cambmana2: %cambmana2
  var cambnumbercount 1
  #echo cambnumber: %cambnumber
  gosub CHARGESPLIT
  var cambcount 1
  var splitcount 1
  var invokecount 1
  goto CHARGELOOP
  
CHARGESPLITLOOP:
  var cambsplitting %cambmana%cambnumbercount
  math cambsplitting divide %splitcounter
  if (%cambsplitting <= %harnessmax) then
  {
    var cambitem%cambnumbercountsplit %splitcounter
    var cambitem%cambnumbercountmod %cambmana%cambnumbercount
    math cambitem%cambnumbercountmod modulus %splitcounter
    var camb%cambnumbercountsplit1 %cambmana%cambnumbercount
    math camb%cambnumbercountsplit1 subtract %cambitem%cambnumbercountmod
    math camb%cambnumbercountsplit1 divide %splitcounter
    #echo cambitem%cambnumbercountsplit: %cambitem%cambnumbercountsplit
    var splitcounter2 2
    var ctotal%cambnumbercount 0
    gosub CHARGESPLITLOOP2
    return
  }
  else
  {
    math splitcounter add 1
    goto CHARGESPLITLOOP
  }

CHARGESPLITLOOP2:
  if %splitcounter2 > %splitcounter then
  { 
    math camb%cambnumbercountsplit1 add %cambitem%cambnumbercountmod
    math ctotal%cambnumbercount add %camb%cambnumbercountsplit1
    #echo camb%cambnumbercountsplit1: %camb%cambnumbercountsplit1
    return
  }
  var camb%cambnumbercountsplit%splitcounter2 %camb%cambnumbercountsplit1
  math ctotal%cambnumbercount add %camb%cambnumbercountsplit%splitcounter2
  #echo camb%cambnumbercountsplit%splitcounter2: %camb%cambnumbercountsplit%splitcounter2
  math splitcounter2 add 1
  goto CHARGESPLITLOOP2
  

CHARGESPLIT:
  if %cambnumbercount > %cambnumber then return
  var cambitems %cambnumbercount
  if (%cambmana%cambnumbercount > %harnessmax) then
  {
    var splitcounter 2
    gosub CHARGESPLITLOOP
  }
  else
  {
    var ctotal%cambnumbercount %cambmana%cambnumbercount
    var cambitem%cambnumbercountsplit 0
  }
  math cambnumbercount add 1
  goto CHARGESPLIT


CHARGELOOPP:
  pause
CHARGELOOP:
  if %cambcount > %cambitems then goto INVOKECAMB
  if %cambitem%cambcountsplit > 1 then
  {
    if %splitcount > %cambitem%cambcountsplit then
    {
      math cambcount add 1
      var splitcount 1
      goto CHARGELOOP
    }
  }
  if %cambitem%cambcountworn = "NO" then
  {
    if ((matchre ("$righthandnoun", "%cambitem%cambcount")) || (matchre ("$lefthandnoun", "%cambitem%cambcount"))) then
    else
    {
      gosub GETITEM %cambitem%cambcount
    }
  }
  var cambtapped 0
  matchre CHARGELOOPP %waitstring
  matchre CHARGESUCC You are able to channel|How much do you want to charge
  matchre CHARGEFAIL You fail to channel
  matchre CHARGEREM Try though you may|You'll have to hold it, set it
  matchre CHARGETAP You strain
  match CHARGEINJURED You are in no condition to do that.
  match CHARGEGET You'll have to hold it, set it on the ground, or put it on something first.
  #echo cambcount: %cambcount
  #echo splitcount: %splitcount
  if %cambitem%cambcountsplit > 1 then put charge my %cambitem%cambcount %camb%cambcountsplit%splitcount
  else put charge my %cambitem%cambcount %cambmana%cambcount
  matchwait 5
	var timeoutsub CHARGELOOP
	if %cambitem%cambcountsplit > 1 then var timeoutcommand charge my %cambitem%cambcount %camb%cambcountsplit%splitcount
  else var timeoutcommand charge my %cambitem%cambcount %cambmana%cambcount
	goto TIMEOUT

CHARGEGET:
  gosub GETITEM %cambitem%cambcount
  goto CHARGELOOP

CHARGEINJURED:
  if ("%autoupkeep" = "YES") then
  {
    var goupkeep 1
    var autype wounds
    return
  }
  else
  {
    if ("%bugout" = "YES") then
    {
      put #echo >$alertwindow Yellow Tried to use cambrinth, but you're too injured!  Please address!
      goto BUGOUT
    }
    else goto CHARGEINJURED2
  }

CHARGEINJURED2:
  put #echo Yellow Alarm: Attention Needed - Too injured for cambrinth!
  put #flash
  put #play Advance
  pause 5
  goto CHARGEINJURED

CHARGEFAIL:
  put #echo Yellow Alarm: Attention Needed - Cambrinth amount is more than your skill can support!
  put #flash
  put #play Advance
  pause 5
  goto CHARGEFAIL

CHARGESUCC:
  if %cambitem%cambcountsplit > 1 then
  {
    math cambcharge add %camb%cambcount%splitcount
    math cambcharge%cambcount add %camb%cambcount%splitcount
    if %splitcount > %cambitem%cambcountsplit then
    {
      math cambcount add 1
      var splitcount 1
      if ((matchre ("$righthand", "%cambitem%cambcount")) || (matchre ("$lefthand", "%cambitem%cambcount"))) then
	    {
		    gosub STOWITEM %cambitem%cambcount
	    }
      #if %cambitem%cambcountworn = "NO" then
      #{
      #  gosub STOWITEM %cambitem%cambcount
      #}
    }
    else
    {
      math splitcount add 1
      goto CHARGELOOP
    }
  }
  else
  {
    if ((matchre ("$righthand", "%cambitem%cambcount")) || (matchre ("$lefthand", "%cambitem%cambcount"))) then
		{
			gosub STOWITEM %cambitem%cambcount
		}
    math cambcharge add %cambmana%cambcount
    math cambcharge%cambcount add %cambmana%cambcount
    math cambcount add 1
    var splitcount 1
  }
  goto CHARGELOOP

CHARGEREM:
  gosub REMITEM %cambitem%cambcount
  goto CHARGELOOP

CHARGESTOW:
  gosub STOWALL
  goto CAMBREM

CHARGETAP:
  var cambtapped %t
  math cambtapped add 5
  return


INVOKECAMBP:
  pause
INVOKECAMB:
	if %cambitem%invokecountworn = "NO" then
  {
    if ((matchre ("$righthandnoun", "%cambitem%invokecount")) || (matchre ("$lefthandnoun", "%cambitem%invokecount"))) then
    else
    {
      gosub GETITEM %cambitem%invokecount
    }
  }
	matchre INVOKECAMBP %waitstring
	matchre INVOKESUCC You reach for its center|Your link to|dim, almost magically null.
	matchre INVOKEREM Try though you may
	#echo ctotal%invokecount: %ctotal%invokecount
	if %dedicatedcambrinth != "YES" then put invoke my %cambitem%invokecount %ctotal%invokecount
	else put invoke my %cambitem%invokecount %ctotal%invokecount spell
	matchwait 5
	var timeoutsub INVOKECAMB
  if %dedicatedcambrinth != "YES" then var timeoutcommand invoke %cambitem%invokecount %ctotal%invokecount
	else var timeoutcommand invoke %cambitem%invokecount %ctotal%invokecount spell
	goto TIMEOUT

INVOKESUCC:
	if ((matchre ("$righthand", "%cambitem%invokecount")) || (matchre ("$lefthand", "%cambitem%invokecount"))) then
	{
		gosub STOWITEM %cambitem%invokecount
	}
  if %cambnumber > %invokecount then
  {
    math invokecount add 1
    goto INVOKECAMB
  }
  else
  {
    var charged 1
    RETURN
  }

INVOKEREM:
  gosub REMITEM %cambitem%invokecount
  goto INVOKECAMB


HARNESS:
  if %harnmana = 0 then
  {
    var harnessed 1
    return
  }
  if (%harntapped > 0) then
  {
    if (%t > %harntapped) then
    {
      goto HARNLOOP
    }
    else return
  }
  var harncount 1
  goto HARNLOOP

HARNSPLITLOOP:
  var harnsplitting %harnmana
  math harnsplitting divide %hsplitcounter
  if %harnsplitting <= %harnessmax then
  {
    var harnnumber %hsplitcounter
    var harnmanamod %harnmana
    math harnmanamod modulus %hsplitcounter
    var harnmana1 %harnmana
    math harnmana1 subtract %harnmanamod
    math harnmana1 divide %hsplitcounter
    var hsplitcounter2 2
    gosub HARNSPLITLOOP2
    return
  }
  else
  {
    math hsplitcounter add 1
    goto HARNSPLITLOOP
  }

HARNSPLITLOOP2:
  if %hsplitcounter2 > %hsplitcounter then
  { 
    math harnmana1 add %harnmanamod
    #echo Harnmana1: %harnmana1
    return
  }
  var harnmana%hsplitcounter2 %harnmana1
  #echo harnmana%hsplitcounter2: %harnmana%hsplitcounter2
  math hsplitcounter2 add 1
  goto HARNSPLITLOOP2

HARNLOOPP:
  pause 1
HARNLOOP:
  var harntapped 0
  if %harncount > %harnnumber then return
  matchre HARNLOOP %waitstring
  match HARNSUCC You tap into the mana
  match HARNTAP Strain though you may
  put harness %harnmana%harncount
  matchwait 5
	var timeoutsub HARNLOOP
  var timeoutcommand harness %harnmana%harncount
	goto TIMEOUT

HARNSUCC:
  var harnessed 1
  math harncount add 1
  goto HARNLOOP

HARNTAP:
  if %harnnumber >  1 then
  {
    if %harncount = 2 then 
    {
      #echo harnmana%harncount: %harnmana%harncount
      math harnmana subtract %harnmana%harncount
    }
    else var harnmana 0
    var harnessed 1
  }
  else
  {
    var harntapped %t
    math harntapped add 5
  }
  return


HARNESSSIMPLEP:
  pause
HARNESSSIMPLE:
  matchre HARNESSSIMPLEP %waitstring
  matchre RETURN Roundtime
  put harness %harnessamount
  matchwait


PERCP:
	pause
PERC:
	if (($guild = "Barbarian") || ($guild = "Thief")) then return
  matchre PERCP %waitstring
  matchre RETURN Roundtime:|You are a bit too busy performing to do that.|You aren't trained in the ways of magic.|Something in the area is interfering with your ability to perceive power\.
  match RETURN Strangely, you can sense absolutely nothing.
  put perceive
  matchwait 5
	var timeoutsub PERC
  var timeoutcommand perceive
	goto TIMEOUT

PERCLUNAR:
	if (($guild = "Barbarian") || ($guild = "Thief")) then return
  matchre RETURN Roundtime:|You are a bit too busy performing to do that.
  match RETURN Something in the area is interfering with your ability to perceive power.
  matchre PERCP %waitstring
  put perceive mana 
	matchwait 5
	var timeoutsub PERCLUNAR
  var timeoutcommand perceive mana
	goto TIMEOUT


PERCSELFP:
	pause
PERCSELF:
	if (($guild = "Barbarian") || ($guild = "Thief")) then return
  matchre PERCSELFP %waitstring
  matchre RETURN Roundtime:|You are a bit too busy performing to do that\.|You aren't trained in the ways of magic\.|A good positive attitude never hurts\.
  put perceive self
  put yes
  matchwait 5
	var timeoutsub PERCSELF
  var timeoutcommand perceive self
	goto TIMEOUT


PREPP:
	pause
PREP:
	var preptime %t
  var prepped 1
	var casting 1
	if (%tattoocast = 1) then 
	{
	  gosub PREPTATTOO
	  if %tmcast = 1 then gosub RETARGET
    return
  }
  if %tmcast = 1 then
  {
    gosub PREPTAR
    return
  }
  gosub PREPSPELL
  return

PREPSPELLP:
  pause
PREPSPELL:
  matchre PREPSPELLP %waitstring
	matchre PREPBADHEAVYTM You are still too fatigued from your previous efforts to manifest another major feat of offensive magic.
	matchre RETURN You trace a|You raise your|You raise an|You begin chanting|With rigid|With meditative|With calm|With tense|You mutter|You briskly utter a few sharp words|Darkly gleaming motes of
	match RETURN As you attempt to prepare the spell, a sense of overwhelming peace washes over you.
	matchre RETURN You begin to hum|You begin your enchante|The first gentle notes|With a sharp cut to your voice|Low, hummed tones form|You begin to chant a mesmerizing|With a resounding "POP"|You begin to sing, a gentle|Wrapped in winter|You weave a soft|Slow, rich tones|Though softly humming|In a low tone you|The wailing of lost souls|Turning your focus solemnly inward|You hear the slow, rich tones of|as you trace your finger along mana|Images of streaking stars falling from the heavens flash across your vision|With great force, you slap your hands together|You direct your attention toward the heavens|You whistle an intricate sequence|A radiant glow wreathes your hands|A strong wind swirls around you|Glowing geometric patterns arc between|Light withdraws from around you|Calmly reaching out with one hand,|In one fluid motion, you bring your palms|You start frantically flailing your hands|Shadow and light collide wildly around|You gaze skyward and trace the planetary|You spin about wildly, whirling around with a feral|Throwing your head back, you release a savage roar|You gaze at your hands, touching your thumb to each|Accompanied with a flash of light, you clap your hands|Droplets of water coalesce around your fingertips|Turning your head slightly and gazing directly|Inhaling deeply, you adopt a cyclical rhythm in your breaths|You clasp your silvery-white flame shrouded hands together|Focusing intently, you slice seven straight lines through|You exhale softly, your breath flowing into a shimmering cloud|You inhale sharply, invoking the
	matchre PREPREL you're already preparing|You have already fully prepared|You are already preparing
	match SPELLCANCEL Something in the area interferes with your spell preparations.
	match SPELLCANCEL As quickly as you form the spell pattern in your mind it slips away from you again.
	match PREPPLAYING You should stop playing before you do that.
	match PREPBADUNKNOWN You have no idea how to cast that spell.
	if %prepmana != 0 then var prepstring %spellprepping %prepmana
	else var prepstring %spellprepping
	put prep %prepstring
	matchwait 5
	var timeoutsub PREPSPELL
  var timeoutcommand prep %prepstring
	goto TIMEOUT

PREPREL:
  gosub RELSPELL
  goto PREP

PREPPLAYING:
  gosub PLAYSTOP
  goto PREP

PREPBADHEAVYTM:
  gosub RELSPELL
  gosub CASTRESET
  return

PREPBADUNKNOWN:
  if ("%bugout" = "YES") then
  {
    put #echo %alertwindow [Magic] Tried to prep a spell you don't know!  Bugging out.
    put #flash
    put #play JustArrived
    goto BUGOUT
  }
  else
  {
    put #echo %alertwindow [Magic] Tried to prep a spell you don't know!
    put #flash
    put #play JustArrived
    goto PREPBADUNKNOWN2
  }

PREPBADUNKNOWN2:
  echo ===PREPPING A SPELL YOU DON'T KNOW===
  put #flash
  put #play Advance
  pause 5
  goto PREPBADUNKNOWN2
  

INVOKETATTOOP:
  pause
INVOKETATTOO:
  matchre INVOKETATTOOP %waitstring
  match RETURN You brace yourself as you activate your tattoo and feel empowered, as its magic washes over you.
  match RETURN You brace yourself as you activate your tattoo, but nothing happens.  Its magic appears depleted.
  match RETURN You brace yourself as you activate your tattoo, but nothing happens as you're already under a heroic effect.
  match RETURN Something in the area is interfering with the magical device.
  match INVOKETATTOOP Something in the area is interfering with the magical device.
  put invoke tattoo
  matchwait 5
	var timeoutsub INVOKETATTOO
  var timeoutcommand invoke tattoo
	goto TIMEOUT


PREPTATTOOP:
  pause
PREPTATTOO:
  matchre PREPTATTOOP %waitstring
  matchre RETURN Closing your eyes, you carefully bend some mana streams
  matchre PREPTATTOOBAD Invoke what?
  matchre PREPTATTOOUNHIDE You cannot use the tattoo while maintaining the effort to stay hidden.
  match RETURN Something in the area is interfering with the magical device.
  match RETURN You are in no condition to do that.
  put invoke tattoo
	matchwait 5
	var timeoutsub PREPTATTOO
  var timeoutcommand invoke tattoo
	goto TIMEOUT
  
PREPTATTOOUNHIDE:
  gosub UNHIDE
  goto PREPTATTOO

PREPTATTOOBAD:
  put #echo %alertwindow [Magic] Tried to invoke a tattoo, but did not have one!  Turning off variable.
  var tattoobuff NO
  put #var tattoobuff NO
  return


PREPTARP:
	pause
PREPTAR:
	#var cambcharge 0
  matchre SPELLCANCEL You are not engaged to anything, so you must specify a target to focus on!|You cannot target
	matchre RETURN You begin to weave mana lines into
	matchre PREPTARREL you're already preparing|You have already fully prepared|You are already preparing
	matchre SPELLCANCEL Something in the area interferes with your spell preparations.
	matchre PREPTARP %waitstring
  if %ctoverride = 1 then var targetstring %spellprepping %prepmana %ctoverridevar
  else var targetstring %spellprepping %prepmana
	put target %targetstring
	matchwait 5
	var timeoutsub PREPTAR
  var timeoutcommand target
	goto TIMEOUT

PREPTARREL:
  gosub RELSPELL
  goto PREPTAR


RESEARCHSTATUSP:
  pause
RESEARCHSTATUS:
  matchre RESEARCHSTATUSP ...wait|type ahead|stunned|while entangled in a web.
  matchre RETURN You're not researching anything!|You believe that|You have completed
  put research status
  matchwait 5
  var timeoutsub RESEARCHSTATUS
  var timeoutcommand research status
	goto TIMEOUT



RESEARCH:
  var researchstring $1
  goto RESEARCHMAIN
RESEARCHP:
  pause
RESEARCHMAIN:
  var researching 1
  var rprojectactive 1
  matchre RESEARCHP ...wait|type ahead|stunned|while entangled in a web.
	matchre RESEARCHMAIN there is still more to learn
	match RESEARCHREL You realize that your prepared spell would interfere with your magical research.
	matchre RETURN You tentatively reach out and begin|You are already busy at research!|You confidently begin|You require some special means of|You begin to bend the mana streams|With some trepidation, you begin to push the mana streams|Abandoning the normal discipline required to manipulate the mana streams
	put research %researchstring 300
	matchwait 5
  var timeoutsub RESEARCHMAIN
  var timeoutcommand research %researchstring 300
	goto TIMEOUT

RESEARCHREL:
  gosub RELSPELL
  goto RESEARCHMAIN


RETARGETP:
  pause
RETARGET:
  matchre RETARGETP %waitstring
  matchre RETARGETP Your desire to prepare this offensive spell suddenly slips away.
  matchre SPELLCANCEL You are not engaged to anything, so you must specify a target to focus on!|You must be preparing a spell in order to target it!
  matchre RETURN You begin to weave mana lines into|Your target pattern is already around|You cannot target|You are already preparing an area target pattern!
  put target
  matchwait 5
	var timeoutsub RETARGET
  var timeoutcommand target
	goto TIMEOUT


PREPSYMBIOSISP:
  pause
PREPSYMBIOSIS:
  matchre PREPSYMBIOSISP %waitstring
  matchre RETURN But you've already prepared the|You recall the exact details of the
  match RETURN As quickly as you form the spell pattern in your mind it slips away from you again.
  put prepare symbiosis
  matchwait 5
	var timeoutsub PREPSYMBIOSIS
  var timeoutcommand prepare symbiosis
	goto TIMEOUT


RELALLP:
	pause
RELALL:
  if (($guild = "Barbarian") || ($guild = "Thief")) then return
	var nextcyc 0
	var currentcyc 0
	gosub CASTRESET
	matchre RELALLP %waitstring
	matchre RETURN You let your concentration|You aren't preparing a spell.|You aren't harnessing any mana.|You have no cyclic spell active to release.
	match RETURN Release?  You can't even sense mana right now.
	put release all
	matchwait 5
	var timeoutsub RELALL
  var timeoutcommand release all
	goto TIMEOUT


RELINVIS:
  if $SpellTimer.KhriSilence.active = 1 then gosub KHRISTOP silence
  if $SpellTimer.KhriVanish.active = 1 then gosub KHRISTOP vanish
  if $SpellTimer.StepsofVuan.active = 1 then gosub RELNSPELL sov
  if $SpellTimer.RefractiveField.active = 1 then gosub RELNSPELL rf
  if $SpellTimer.EyesoftheBlind.active = 1 then gosub RELNSPELL eotb
  return


RELMANAP:
	pause
RELMANA:
	matchre RELMANAP %waitstring
	matchre RETURN You release all the streams|You aren't harnessing any mana\.|You release your connection
	put release mana
  matchwait 5
	var timeoutsub RELMANA
  var timeoutcommand release mana
	goto TIMEOUT


RELNSPELL:
  var relnspellstring $0
  goto RELNSPELLMAIN
RELNSPELLP:
  pause
RELNSPELLMAIN:
	matchre RELNSPELLP %waitstring
  matchre RETURN Your body is no longer imbued with Fire\.|The Earth energy flows from your body, returning to its rightful place in the ground beneath your feet\.|You feel the energy of|The warm feeling in your hand goes away\.|The refractive field surrounding you fades away.|Your corruption fades, revealing you to the world once more\.|Release what?|An unpleasant sensation jolts through your body as your synthetic reinforcement becomes unthreaded, leaving you feeling weakened as well as slower\.
  put release %relnspellstring
  matchwait 5
	var timeoutsub RELNSPELL
  var timeoutcommand release %relnspellstring
	goto TIMEOUT


RELSPELLP:
	pause
RELSPELL:
	matchre RELSPELLP %waitstring
	matchre RETURN You let your concentration|You aren't preparing a spell.
	match RETURN Release?  You can't even sense mana right now.
	put release spell
	matchwait 5
	var timeoutsub RELSPELL
  var timeoutcommand release spell
	goto TIMEOUT


RELCYCLICP:
	pause
RELCYCLIC:
  #put #echo Yellow Release cyclic.
	if ("$guild" = "Barbarian") then return
	if ("$guild" = "Thief") then return
	if ("$guild" = "Necromancer") then
	{
	  if ((%necrosafety = "YES") && ((%riteofgrace = "YES")) then
	  {
	    if $SpellTimer.RiteofGrace.active = 1 then
	    {
	      if %releaserog != 1 then return
	    }
	  }
	}
	var nextcyc 0
	var currentcyc 0
	matchre RELCYCLICP %waitstring
	match RETURN You have no cyclic spell active to release.
	match RETURN Release?  You can't even sense mana right now.
  put release cyclic
	matchwait .5
	goto RELCYCLIC2

RELCYCLIC2P:
	pause
RELCYCLIC2:
	matchre RELCYCLIC2P %waitstring
	match RETURN You have no cyclic spell active to release.
	match RETURN Release?  You can't even sense mana right now.
	put release cyclic
	matchwait 2
	return


RELSYMBIOSISP:
  pause
RELSYMBIOSIS:
  matchre RELSYMBIOSISP %waitstring
  matchre RETURN But you haven't prepared a symbiosis!|You pause for a moment|Are you sure you'd lke to remove the
  match RETURN Release?  You can't even sense mana right now.
  put release symbiosis
  matchwait 5
	var timeoutsub RELSYMBIOSIS
  var timeoutcommand release symbiosis
	goto TIMEOUT


RITUAL:
  gosub STOWALL
  gosub GETITEM %ritualfocus
  gosub RITUALINVOKE
  gosub STOWALL
  return

RITUALINVOKEP:
  pause
RITUALINVOKE:
  var invoked 1
  matchre RITUALINVOKEP %waitstring
  matchre RETURN You must begin preparing a ritual spell|You make sweeping gestures|Invoke what?|toward the sky and will the mana streams|toward the ceiling and will the mana streams|Kneeling down, you draw|reverently above your head and steadily harness mana streams through it.|Roundtime\:
  matchre RITUALINVOKESTOW You must be able to handle your .* with both hands to use it for a ritual\.
  matchre RITUALINVIS Magical rituals are exceedingly obvious.  You cannot do it while remaining hidden.
  match RITUALINJURED You are in no condition to do that.
  match RITUALMISSING You'll have to hold it, set it on the ground, or put it on something first.
  put invoke %ritualfocus
  matchwait 5
	var timeoutsub RITUALINVOKE
  var timeoutcommand invoke %ritualfocus
	goto TIMEOUT

RITUALINJURED:
  if ("%autoupkeep" = "YES") then
  {
    var goupkeep 1
    var autype wounds
    return
  }
  else
  {
    if ("%bugout" = "YES") then
    {
      put #echo >$alertwindow Yellow Tried to invoke ritual focus, but you're too injured!  Please address!
      goto BUGOUT
    }
    else goto CHARGEINJURED2
  }
  
RITUALINJURED2:
  put #echo Yellow Alarm: Attention Needed - Too injured for ritual focus!
  put #flash
  put #play Advance
  pause 5
  goto RITUALINJURED

RITUALINVOKESTOW:
  gosub STOW left
  goto RITUALINVOKE

RITUALINVIS:
  gosub RELINVIS
  goto RITUALINVOKE

RITUALMISSING:
  gosub GETITEM %ritualfocus
  goto RITUALINVOKE

TMFOCUSINVOKEP:
  pause
TMFOCUSINVOKE:
  matchre TMFOCUSINVOKEP %waitstring
  matchre RETURN Roundtime:|Invoke what?|
  put invoke %tmfocusitem
  matchwait 5
	var timeoutsub TMFOCUSINVOKE
  var timeoutcommand invoke %tmfocusitem
	goto TIMEOUT


WANDINVOKE:
  var wandinvokestring $0
  goto WANDINVOKEMAIN
WANDINVOKEP:
  pause
WANDINVOKEMAIN:
  var wandinvokegood 1
  matchre WANDINVOKEP %waitstring
  matchre RETURN The world around you seems to slow as the spell grips your mind\.|The spell pulses through your soul, rekindling your holy rage\.|Mentally steeling yourself in preparation for the unnatural action|A glistening net of coiling tendrils|Your blood rises as images of ferocious battles play across your mind\.  You feel the fervor of combat grip you\.|You harness the currents of air and channel them around yourself\.|The overwhelming sense of unity with your hidden brothers and sisters sharpens your intuition, kin and prey alike\.|Your blood begins to boil and with a mighty shout you allow the rage within to flow outward for all to see\.|^You feel the strange aliveness in your limbs renew itself\.
  match WANDINVOKESTOW You must be able to handle your disc with both hands to use it for a ritual.
  matchre WANDINVOKEBAD ^The \w+ remains inert\.
  match RETURN You are in no condition to do that.
  put invoke my %wandinvokestring
  matchwait 5
	var timeoutsub WANDINVOKE
  var timeoutcommand invoke my %wandinvokestring
	goto TIMEOUT

WANDINVOKEBAD:
  var wandinvokegood 0
  return

WANDINVOKESTOW:
  gosub STOWALL
  gosub GETITEM %wandinvokestring
  goto WANDINVOKE

WEATHER:
  var inside 0
  goto WEATHERMAIN
WEATHERP:
  pause
WEATHERMAIN:
  matchre WEATHERP %waitstring
  match RETURN You glance up at the sky.
  match WEATHERINSIDE You glance outside.
  match WEATHERINSIDE That's a bit hard to do while inside.
  put weather
  matchwait 5
	var timeoutsub WEATHERMAIN
  var timeoutcommand weather
	goto TIMEOUT
	
WEATHERINSIDE:
  var inside 1
  return
	
#####UPKEEP_SUBS#####


BUNDLEROPEGETLOOP:
  gosub ROPEASK
  gosub STOWALL
  math ropestoget subtract 1
  if %ropestoget < 1 then return
  else goto BUNDLEROPEGETLOOP


BUYLOOP:
  if %buyloopcount > %buylooptotal then RETURN
  gosub ORDER
  pause 1
  gosub PAY
  gosub STOWITEM %buytarget
  math buyloopcount add 1
  goto BUYLOOP


ENTERVAULTP:
  pause
ENTERVAULT:
  #if ($zoneid = 67) then move go door
  matchre ENTERVAULTP %waitstring
  matchre ENTERVAULTNONE The attendant says, "Hey bub, are you lost?|The attendant says, "Hey lady, are you lost?
  matchre ENTERVAULTPAY The Dwarven attendant grabs you by the wrist\.|The attendant catches your arm and says,
  matchre ENTERVAULTOPEN The attendant opens a small panel and fiddles with some controls
  matchre ENTERVAULT2 The attendant steps in front of
  match ENTERVAULTPAUSE The attendant grabs your arm and halts you.  "You ain't going in there,
  put go arch
  matchwait 5
	var timeoutsub ENTERVAULT
  var timeoutcommand go arch
	goto TIMEOUT
  
ENTERVAULT2:
  matchre ENTERVAULT3 The attendant steps in front of
  matchre ENTERVAULTOPEN The attendant opens a small panel and fiddles with some controls
  put go second arch
  matchwait 5
	var timeoutsub ENTERVAULT2
  var timeoutcommand go second arch
	goto TIMEOUT
  
ENTERVAULT3:
  matchre ENTERVAULT4 The attendant steps in front of
  matchre ENTERVAULTOPEN The attendant opens a small panel and fiddles with some controls
  put go third arch
  matchwait 5
	var timeoutsub ENTERVAULT3
  var timeoutcommand go third arch
	goto TIMEOUT

ENTERVAULT4:
  matchre RETURN The attendant steps in front of
  matchre ENTERVAULTOPEN The attendant opens a small panel and fiddles with some controls
  put go fourth arch
  matchwait 5
	var timeoutsub ENTERVAULT4
  var timeoutcommand go fourth arch
	goto TIMEOUT
 
ENTERVAULTPAUSE:
  pause 10
  goto ENTERVAULT 
 
ENTERVAULTNONE:
  if (("%vaultmove" = "YES") && ("%vaulttown" = "%townname")) then
  {
    move go desk
    put ring bell
    pause .5
    move out
    waitfor A young Dwarf trots up to you and says,
    goto ENTERVAULT
  }
  else
  { 
    return
  }
  
ENTERVAULTPAY:
  move go desk
  gosub VAULTPAY
  move out
  goto ENTERVAULT
 
VAULTPAYP:
  pause 
VAULTPAY:
  matchre VAULTPAYP %waitstring
  match VAULTPAYNOMONEY You don't have that much money!
  match RETURN You hand the Dwarven clerk your payment.
  put pay 5000
  matchwait
  var timeoutsub VAULTPAY
  var timeoutcommand pay 5000
	goto TIMEOUT
 
VAULTPAYNOMONEY:
  gosub MOVE teller
  gosub COINWITHDRAW 5 gold %currency
  if ("%currency" != "Kronar") then
  {
    gosub MOVE exchange
    var excurrency Kronar
    var examount 5 gold %currency
    gosub EXCHANGE
  }
  gosub MOvE vault
  move go desk
  goto VAULTPAY
  
 
ENTERVAULTOPEN:
  var vaultsuccess 1
  put pull lever
  pause .5
  move go door
  put open vault
  return
  
DEBTPAY:
  var debtpaystring $0
  goto DEBTPAYMAIN
DEBTPAYP:
  pause
DEBTPAYMAIN:
  matchre DEBTPAYP %waitstring
  match RETURN The clerk nods and takes your money, noting that your debt is now settled.
  put pay %debtpaystring
  matchwait 5
	var timeoutsub DEBTPAY
  var timeoutcommand pay %debtpaystring
	goto TIMEOUT
  
EXCHANGEP:
  pause
EXCHANGE:
  matchre EXCHANGEP %waitstring
  matchre RETURN You hand your|You don't have that many|You count|One of the guards mutters|The money-changer says crossly
  match EXCHANGENOTHERE There is no money-changer here.
  put exchange %examount to %excurrency
  matchwait 5
	var timeoutsub EXCHANGE
  var timeoutcommand exchange %examount to %excurrency
	goto TIMEOUT
  
EXCHANGENOTHERE:
  gosub MOVE exchange
  goto EXCHANGE
  
EXITVAULT:
  put close vault
  pause .5
  move go door
  move go arch
  move out
  if ($zoneid = 1) then
  {
    move out
  }
  if ($zoneid = 67) then
  {
    move out
    move east
    put #mapper reset
  }
  return


GEMPOUCHGETLOOP:
  gosub GEMPOUCHASK
  gosub STOWALL
  math pouchestoget subtract 1
  if %pouchestoget < 1 then return
  else goto GEMPOUCHGETLOOP

GEMPOUCHASKP:
  pause
GEMPOUCHASK:
  if $zoneid = 150 then
  {
    if matchre("$roomobjs" "gemsmith") then var actualappraiser gemsmith
    else
    {
      if matchre("$roomobjs" "Wickett") then var actualappraiser Wickett
      else
      {
        if matchre("$roomobjs" "gembuyer") then var actualappraiser gembuyer
        else
        {
          if matchre("$roomobjs" "clerk") then var actualappraiser clerk
          else
          {
            if matchre("$roomobjs" "attendant") then var actualappraiser attendant
            else
            {
              echo Waiting for Wickett, gemsmith, gembuyer, clerk, or attendant.
              pause 60
              goto GEMPOUCHASK
            }
          }
        }
      }
    }
  }
  else var actualappraiser %appraiser
  matchre GEMPOUCHASKP %waitstring
  matchre GEMPOUCHASKSTOW Free one of your hands first.
  matchre GEMPOUCHASKGOOD hands you (a|an) (\S+) gem pouch\.
  matchre RETURN Usage: ASK|"All I know about are skins 
  put ask %actualappraiser for gem pouch
  matchwait 5
  var timeoutsub GEMPOUCHASK
  var timeoutcommand var actualappraiser %appraiser
	goto TIMEOUT
  
GEMPOUCHASKSTOW:
  gosub STOWALL
  goto GEMPOUCHASK
  
GEMPOUCHASKGOOD:
  var didgetpouch 1
  return


ORDERP:
  pause
ORDER:
  matchre ORDERP ...wait|type ahead|stunned|while entangled in a web.
  matchre RETURN Brother Durantine nods slowly|Friar Othorp grins broadly|Sister Nongwen smiles and nods|Sister Imadrail smiles and nods
  put order %buytarget
  matchwait 5
	var timeoutsub order
  var timeoutcommand order %buytarget
	goto TIMEOUT


PAYP:
  pause
PAY:
  matchre PAYP ...wait|type ahead|stunned|while entangled in a web.
  matchre RETURN Durantine waves a small censer|Othorp prays over your purchase|Sister Nongwen carefully|Sister Imadrail reverently
  put offer %cost
  matchwait 5
	var timeoutsub PAY
  var timeoutcommand offer %cost
	goto TIMEOUT
	
	
ROPEASKP:
  pause
ROPEASK:
  matchre ROPEASKP %waitstring
  matchre ROPEASKGOOD hands you a rope\.|hands you some bundling rope
  matchre ROPEASKSTOW Your hands are full
  matchre RETURN Usage: ASK|"All I know about are skins 
  put ask %furrier for bundling rope
  matchwait 5
	var timeoutsub ROPEASK
  var timeoutcommand ask %furrier for bundling rope
	goto TIMEOUT

ROPEASKSTOW:
  gosub STOWALL
  goto ROPEASK

ROPEASKGOOD:
  var didgetrope 1
  return


TITHE:
echo 0: $0
echo 1: $1
echo 2: $2
  var tithecurrency $1
  var tithebox $2
  goto TITHEMAIN
TITHEP:
  pause
TITHEMAIN:
  var tithegood 0
  matchre TITHEP %waitstring
  matchre TITHEGOOD A warm, soothing sensation washes over your soul.
  match RETURN A good positive attitude never hurts.
  put put 5 silver %tithecurrency in %tithebox
  put yes
  matchwait 5
	var timeoutsub TITHE
  var timeoutcommand put 5 silver %tithecurrency in %tithebox
	goto TIMEOUT
  
TITHEGOOD:
  var tithesuccess 1
  return
  
  
WEALTHCHECK:
  var copperkro 0
  var bronzekro 0
  var silverkro 0
  var goldkro 0
  var platinumkro 0
  var copperlir 0
  var bronzelir 0
  var silverlir 0
  var goldlir 0
  var platinumlir 0
  var copperdok 0
  var bronzedok 0
  var silverdok 0
  var golddok 0
  var platinumdok 0
  var totalkro 0
  var totallir 0
  var totaldok 0

  action (wealth) var copperkro $1; var totalkro $2 when .+ (\d+) copper Kronars \((\d+) copper Kronars\).
  action (wealth) var bronzekro $1; var totalkro $2 when .+ (\d+) bronze.+Kronars \((\d+) copper Kronars\).
  action (wealth) var silverkro $1; var totalkro $2 when .+ (\d+) silver.+Kronars \((\d+) copper Kronars\).
  action (wealth) var goldkro $1; var totalkro $2 when .+ (\d+) gold.+Kronars \((\d+) copper Kronars\).
  action (wealth) var platkro $1; var totalkro $2 when .+ (\d+) platinum.+Kronars \((\d+) copper Kronars\).
  action (wealth) var copperlir $1; var totallir $2 when .+ (\d+) copper Lirums \((\d+) copper Lirums\).
  action (wealth) var bronzelir $1; var totallir $2 when .+ (\d+) bronze.+Lirums \((\d+) copper Lirums\).
  action (wealth) var silverlir $1; var totallir $2 when .+ (\d+) silver.+Lirums \((\d+) copper Lirums\).
  action (wealth) var goldlir $1; var totallir $2 when .+ (\d+) gold.+Lirums \((\d+) copper Lirums\).
  action (wealth) var platlir $1; var totallir $2 when .+ (\d+) platinum.+Lirums \((\d+) copper Lirums\).
  action (wealth) var copperdok $1; var totaldok $2 when .+ (\d+) copper Dokoras \((\d+) copper Dokoras\).
  action (wealth) var bronzedok $1; var totaldok $2 when .+ (\d+) bronze.+Dokoras \((\d+) copper Dokoras\).
  action (wealth) var silverdok $1; var totaldok $2 when .+ (\d+) silver.+Dokoras \((\d+) copper Dokoras\).
  action (wealth) var golddok $1; var totaldok $2 when .+ (\d+) gold.+Dokoras \((\d+) copper Dokoras\).
  action (wealth) var platdok $1; var totaldok $2 when .+ (\d+) platinum.+Dokoras \((\d+) copper Dokoras\).
  put wealth
  pause 1
  action (wealth) off
  return



#####TREASURE_SUBS#####


ARRANGEP:
	pause
ARRANGE:
  #pause 1
	if %arrcount < 1 then return
  matchre RETURN You complete|That has already been arranged as much as you can manage.
  match ARRANGENOSKIN That creature cannot produce skins.
  matchre ARRANGEP %waitstring
  matchre ARRANGESUB You begin to arrange|You make a mistake in the|You continue arranging
  matchre ARRANGEBADSKIN You work at|Arrange what\?|You make a serious mistake|has already been skinned\.|cannot be skinned\, so you can't arrange|currently being arranged to produce a skin\,  and cannot be changed\.
  put arrange %arrangetype
  matchwait 5
	var timeoutsub ARRANGE
  var timeoutcommand arrange %arrangetype
	goto TIMEOUT
	
ARRANGESUB:
  math arrcount subtract 1
  goto ARRANGE

ARRANGENOSKIN:
  var arrangetype
  goto ARRANGE

ARRANGEBADSKIN:
  var badskin 1
  return


BUNDLEP:
	pause
BUNDLE:
  matchre BUNDLEP %waitstring 
  match RETURN You bundle up
  match RETURN You carefully fit 
  matchre BUNDLEBAD That's not going to work.|What were you referring to?
  match BUNDLEMAKENEW Where did you intend to put that?
  put bundle
  matchwait 5
  var timeoutsub BUNDLE
  var timeoutcommand bundle
  goto TIMEOUT

BUNDLEMAKENEW:
  gosub BUNDLEMAKE
  gosub BUNDLETIE
  gosub BUNDLEADJUST
  gosub WEARITEM my bundle
  RETURN

BUNDLEADJUSTP:
  pause
BUNDLEADJUST:
  matchre BUNDLEADJUSTP %waitstring 
  matchre RETURN You adjust your tight bundle so that you can more easily
  matchre BUNDLEADJUST You adjust your tight bundle to make it neat and compact
  put adjust my bundle
  matchwait 5
	var timeoutsub BUNDLEADJUST
  var timeoutcommand adjust my bundle
	goto TIMEOUT
	

BUNDLEMAKEP:
	pause
BUNDLEMAKE:
  gosub GETITEM bundling rope
  pause 2
  if ((matchre("$righthandnoun", "rope")) || (matchre("$lefthandnoun", "rope"))) then
  {
	  matchre BUNDLEMAKEP %waitstring 
	  match RETURN You bundle up
	  match RETURN You carefully fit 
	  matchre BUNDLEBAD That's not going to work.|What were you referring to?
	  put bundle
	  matchwait 5
    var timeoutsub BUNDLEMAKE
    var timeoutcommand bundle
    goto TIMEOUT
	}
	else goto BUNDLEMAKENOROPE
	
BUNDLEBAD:
  gosub STOWALL
  return

BUNDLEMAKENOROPE:
  if (("%autoupkeep" = "YES") && (%bundlerope > 0)) then
  {
    var goupkeep 1
    var autype gem
    return
  }
  else
  {  
    gosub DEEPSLEEP
    put #echo >$alertwindow Yellow Out of bundling ropes!  Please address!
    put #flash
    put #play Advance
    if (%bugout = "YES") then goto BUGOUT
    else goto BUNDLEMAKENOROPE2
  }
  
BUNDLEMAKENOROPE2:
  echo ===OUT OF BUNDLING ROPES===
  put #flash
  put #play Advance
  pause 5
  goto BUNDLEMAKENOROPE2
  

BUNDLESWAP:
  if ("%dropskins" = "YES") then
  {
    if ("%hand" = "left") then gosub DUMPITEM $righthandnoun
    else gosub DUMPITEM $lefthandnoun
    return
  }
  if (%currentweapon = -1) then
  {
    if ("$lefthand" != "Empty") then gosub LOWERITEM $lefthandnoun
    if ("$righthand" != "Empty") then gosub LOWERITEM $righthandnoun
  }
  else
  {
    if tolower("%weapon%currentweapon") != "brawl" then 
    {
      if ("%hand" = "left") then 
      {
        if ("$lefthand" != "Empty") then
        {
          gosub STOW left
        }
        if ("$righthand" != "Empty") then
        {
          gosub LOWERITEM $righthandnoun
        }
      }
      else 
      {
        if ("$righthand" != "Empty") then
        {
          gosub STOW right
        }
        if ("$lefthand" != "Empty") then
        {
          gosub LOWERITEM $lefthandnoun
        }
      }
    }
    else
    {
      if ("$lefthand" != "Empty") then gosub LOWERITEM $lefthandnoun
      if ("$righthand" != "Empty") then gosub LOWERITEM $righthandnoun
    }
  }
  return  
  
  
BUNDLETIEP:
  pause
BUNDLETIE:
  matchre BUNDLETIEP 	%waitstring
  matchre BUNDLETIE Once you've tied off your bundle
  matchre RETURN Using the length of the rope|But this bundle has already been tied off!|Tie what?
  #matchre BUNDLEMAKE Tie what?
  put tie my bundle
  matchwait 5
	var timeoutsub BUNDLETIE
  var timeoutcommand tie my bundle
	goto TIMEOUT


COINGET:
  if !matchre ("$roomobjs", "(coin|coins)") then return
  gosub GETITEM coin
  goto COINGET


DISSECTP:
  pause
DISSECT:
  matchre DISSECTP %waitstring
  matchre RETURN Roundtime:|What exactly are you trying to dissect\?|The corpse has been defiled already\.|Perhaps the \w+ \w+ should be left alone\.
  match DISSECTSTOW You need at least one free hand for that!
  match DISSECTBADU That'd be a waste of time.  The rotted remains of the unliving are a poor study of how a body functions when alive.
  match DISSECTBAD You do not yet possess the knowledge required to perform this task.
  put dissect
  matchwait 5
	var timeoutsub DISSECT
  var timeoutcommand dissect
	goto TIMEOUT

DISSECTSTOW:
  gosub STOW left
  goto DISSECT

DISSECTBADU:
  put #echo >$alertwindow Yellow Attempted to dissect an undead creature.  Dissect should not be turned on in this hunting area!  Turning it off.
  var dissect NO
  put #var dissect NO
  put #var save
  return

DISSECTBAD:
  put #echo >$alertwindow Yellow You're not skilled enough to dissect!  Turning it off.
  var dissect NO
  return

COUNTITEM:
  var countitemstring $0
  goto COUNTITEMMAIN
COUNTITEMP:
  pause
COUNTITEMMAIN:
  matchre COUNTITEMP %waitstring
  matchre COUNTITEMGOOD You count .* (?:in|on) the \w+ and see there (?:are|is) (.*) left\.
  matchre COUNTITEMGOOD You count .* and see there (?:are|is) (.*) left\. 
  match COUNTITEMBAD I could not find what you were referring to.
  put count %countitemstring
  matchwait 5
	var timeoutsub COUNTITEMMAIN
  var timeoutcommand count %countitemstring
	goto TIMEOUT

COUNTITEMGOOD:
  #echo 0: $0
  #echo 1: $1
  var countitemlist $1
  eval countitemlist replace("%countitemlist", "-", "|")
  eval countitemlist replace("%countitemlist", " hundred", "-hundred")
  eval countitemlist replace("%countitemlist", " ", "|")
  eval countitemlist replace("%countitemlist", "-hundred", " hundred")
  #echo countitemlist: %countitemlist
  gosub WORDTONUMLOOP %countitemlist
  #echo wordtonumtotal: %wordtonumtotal
  var countitemtotal %wordtonumtotal
  return

COUNTITEMBAD:
  var countitemtotal 0
  return

COUNTCONTAINERAMMO:
  var countcontainerstring $0
  goto COUNTCONTAINERAMMOMAIN
COUNTCONTAINERAMMOP:
  pause
COUNTCONTAINERAMMOMAIN:
  matchre COUNTCONTAINERAMMOP %waitstring
  match RETURN You count up the items in your
  put count %countcontainerstring
  matchwait 5
  var timeoutsub COUNTCONTAINERAMMO
  var timeoutcommand count %countcontainerstring
	goto TIMEOUT


CONVERTANDADD:
  if (%%ammotypecountloop > %%ammotypetriggerlistcount) then return
  var countitemlist %%ammotypetriggerlist(%%ammotypecountloop)
  eval countitemlist replace("%countitemlist", "-", "|")
  eval countitemlist replace("%countitemlist", " hundred", "-hundred")
  eval countitemlist replace("%countitemlist", " ", "|")
  eval countitemlist replace("%countitemlist", "-hundred", " hundred")
  gosub WORDTONUMLOOP %countitemlist
  math %ammotypetotalcount add %wordtonumtotal
  math %ammotypecountloop add 1
  goto CONVERTANDADD


WORDTONUMLOOP:
  var wordnumindex 0
  eval wordtonumcount count("$0", "|")
  var wordtonumlist $0
  var wordtonumtotal 0
WORDTONUMMAIN:
  if %wordnumindex > %wordtonumcount then return
  var wordnumber 0
  gosub WORDTONUMBER %wordtonumlist(%wordnumindex)
  math wordtonumtotal add %wordnumber
  if %wordnumber != 0 then
  {
		#if %wordnumindex = 0 then var wordnumstring %wordnumber
		#else var wordnumstring %wordnumstring|%wordnumber
  }
  else
  {
    #if %wordnumindex = 0 then var wordnumstring %wordtonumlist(%wordnumindex)
		#else var wordnumstring %wordnumstring|%wordtonumlist(%wordnumindex)
  }
  math wordnumindex add 1 
  goto WORDTONUMMAIN

WORDTONUMBER:
  if $0 = "one" then var wordnumber 1
  if $0 = "two" then var wordnumber 2
  if $0 = "three" then var wordnumber 3
  if $0 = "four" then var wordnumber 4
  if $0 = "five" then var wordnumber 5
  if $0 = "six" then var wordnumber 6
  if $0 = "seven" then var wordnumber 7
  if $0 = "eight" then var wordnumber 8
  if $0 = "nine" then var wordnumber 9
  if $0 = "ten" then var wordnumber 10
  if $0 = "eleven" then var wordnumber 11
  if $0 = "twelve" then var wordnumber 12
  if $0 = "thirteen" then var wordnumber 13
  if $0 = "fourteen" then var wordnumber 14
  if $0 = "fifteen" then var wordnumber 15
  if $0 = "sixteen" then var wordnumber 16
  if $0 = "seventeen" then var wordnumber 17
  if $0 = "eighteen" then var wordnumber 18
  if $0 = "nineteen" then var wordnumber 19
  if $0 = "twenty" then var wordnumber 20
  if $0 = "thirty" then var wordnumber 30
  if $0 = "forty" then var wordnumber 40
  if $0 = "fifty" then var wordnumber 50
  if $0 = "sixty" then var wordnumber 60
  if $0 = "seventy" then var wordnumber 70
  if $0 = "eighty" then var wordnumber 80
  if $0 = "ninety" then var wordnumber 90
  if $0 = "one hundred" then var wordnumber 100
  if $0 = "two hundred" then var wordnumber 200
  if $0 = "three hundred" then var wordnumber 300
  if $0 = "four hundred" then var wordnumber 400
  if $0 = "five hundred" then var wordnumber 500
  if $0 = "six hundred" then var wordnumber 600
  if $0 = "seven hundred" then var wordnumber 700
  if $0 = "eight hundred" then var wordnumber 800
  if $0 = "nine hundred" then var wordnumber 900
  return
  
  
GEMPOUCHCOUNT:
  math pouchcount add 1
  if %pouchcount > 11 then return
  gosub NUMBERTOWORD
  gosub GEMPOUCHLOOK
  if %pouchfull = 0 then
  {
    math gempouchesnum add 1
  }
  if %pouchfull = -1 then
  {
    var pouchcount 12
    return
  }
  goto GEMPOUCHCOUNT


GEMFINDEMPTYPOUCH:
  math pouchcount add 1
  if %pouchcount > 11 then return
  gosub NUMBERTOWORD
  gosub GEMPOUCHLOOK
  if %pouchfull = 0 then return
  if %pouchfull = 12 then
  {
    var pouchcount -1
    return
  }
  goto GEMFINDEMPTYPOUCH


GEMFINDFULLPOUCH:
  math pouchcount add 1
  if %pouchcount > 11 then return
  gosub NUMBERTOWORD
  gosub GEMPOUCHLOOK
  if %pouchfull = 1 then return
  if %pouchfull = -1 then
  {
    var pouchcount 12
    return
  }
  goto GEMFINDFULLPOUCH

NUMBERTOWORD:
  if %pouchcount = 1 then var pouchnum first
  if %pouchcount = 2 then var pouchnum second
  if %pouchcount = 3 then var pouchnum third
  if %pouchcount = 4 then var pouchnum fourth
  if %pouchcount = 5 then var pouchnum fifth
  if %pouchcount = 6 then var pouchnum sixth
  if %pouchcount = 7 then var pouchnum seventh
  if %pouchcount = 8 then var pouchnum eighth
  if %pouchcount = 9 then var pouchnum ninth
  if %pouchcount = 10 then var pouchnum tenth
  if %pouchcount = 11 then var pouchnum eleventh
  return


GEMPOUCHLOOKP:
  pause
GEMPOUCHLOOK:
  matchre GEMPOUCHLOOKP %waitstring
  match GEMPOUCHLOOKNONE I could not find what you were referring to.
  match GEMPOUCHLOOKFULL You sort through the contents of the gem pouch and find 500 gems in it.  It is tied.
  matchre GEMPOUCHLOOKEMPTY You sort through the contents of the gem pouch and find (([1-9]|[1-9][0-9]|[1-4][0-9][0-9])) (gems|gem) in it\.
  match GEMPOUCHLOOKEMPTY The gem pouch is empty.
  put count %pouchnum gem pouch in my %storage
  matchwait 5
	var timeoutsub GEMPOUCHLOOK
  var timeoutcommand count %pouchnum gem pouch in %storage
	goto TIMEOUT

GEMPOUCHLOOKNONE:
  var pouchfull -1
  return

GEMPOUCHLOOKFULL:
  var pouchfull 1
  echo Full pouch!
  return
  
GEMPOUCHLOOKEMPTY:
  var pouchfull 0
  echo Empty pouch!
  return

GEMPOUCHNONE:
  if (("%autoupkeep" = "YES") && (%gempouches > 0)) then
  {
    var goupkeep 1
    var autype gem
    return
  }
  else
  {
    gosub DEEPSLEEP
    put #echo >$alertwindow Yellow Out of gem pouches!  Please address!
    put #flash
    put #play Advance
    if (%bugout = "YES") then goto BUGOUT
    else goto GEMPOUCHNONE2
  }

GEMPOUCHNONE2:
  echo ===OUT OF GEM POUCHES===
  put #flash
  put #play Advance
  pause 5
  goto GEMPOUCHNONE2


GEMGETP:
  pause
GEMGET:
  if !matchre ("$roomobjs", "\b(%gems1|%gems2|%gems3|%gems4|%gweths)\b(,|\.| and)") then return
  matchre GEMGETP %waitstring
  matchre RETURN Stow what?|What were you referring to?
  matchre GEMGET ^You open your
  matchre GEMGETBAD You need a free hand to pick that up\.
  matchre GEMPOUCHFULL ^You think the .*gem pouch is too full|^You put your
  matchre TIEPOUCH You've already got a wealth of gems in there!
  match RETURN You can't pick that up with your hand that damaged.
  put stow gem
  matchwait 5
	var timeoutsub GEMGET
  var timeoutcommand stow gem
	goto TIMEOUT

GEMGETBAD:
  gosub STOW left
  goto GEMGET

GEMPOUCHFULL:
  gosub STOWALL
  gosub REMITEM gem pouch
  gosub STOWITEM gem pouch
  var pouchcount 0
  gosub GEMFINDEMPTYPOUCH
  if %pouchcount = 12 then goto GEMPOUCHNONE
  gosub GETITEM %pouchnum gem pouch
  gosub WEARITEM gem pouch
  gosub STORE gem gem pouch
  gosub STOWALL
  goto GEMGET


GWETHGET:
  if matchre ("$roomobjs", "\b(%gweths)\b(,|\.| and)") then
  {
    if %savegwethstones = "YES" then
    {
      gosub GETITEM stones
      if %lootalerts = "YES" then put #echo %alertwindow Yellow [Treasure]: Found a gweth stone!
      gosub PUTITEM my stones in my %storage
    }
    if (matchre ("$roomobjs", "\b(%gweths)\b(,|\.| and)")) then goto GWETHGET
  }
  return

BOXGET:
  if matchre ("$roomobjs", "\b(%boxtype) (%boxes)\b(,|\.| and)") then
  {
    var boxitem $1 $2
    gosub GETITEM %boxitem
    #if %lootalerts = "YES" then put #echo %alertwindow [Treasure]: Found a box!
    gosub PUTITEM my %boxitem in my %boxstorage
    if (%putsucceed = 0) then
    {
      if ("%auonboxes" = "YES") then
      {
        var goupkeep 1
        var autype boxes
        gosub DUMPITEM %boxitem
      }
      else
      {
        put #echo %alertwindow Yellow [Treasure]: Failed to put %boxitem in box storage!  Turning off box collecting and revering loot type to 'treasure'.
        gosub DUMPITEM %boxitem
        var loottype treasure
        put #var m%varsetloottype treasure
        var collectboxes NO
        put #var m%varsetcollectboxes NO
        put #var save
      }
      return
    }
  }
  if matchre ("$roomobjs", "(%boxtype) (%boxes)") then goto BOXGET
  return


LOOTP:
  pause
LOOT:
  if ("%noloot" = "YES") then return
  if !matchre ("$roomobjs", "((which|that) appears dead|\(dead\))") then return
  matchre RETURN You search|You should probably wait until|You find nothing of interest.|I could not find what you were referring to.
  match LOOT and get ready to search it!
  match RETURN You can't search or loot in here!
  matchre LOOTP %waitstring
  put loot %loottype
  matchwait 5
	var timeoutsub LOOT
  var timeoutcommand loot %loottype
	goto TIMEOUT


LOOTCHECK:
  #put #echo Yellow Coin.
  if ("%collectcoin" = "YES") then gosub COINGET
  #put #echo Yellow gwethstones
  if ("%savegwethstones" = "YES") then gosub GWETHGET
  #put #echo Yellow gem
  if ("%collectgem" = "YES") then gosub GEMGET
  #put #echo Yellow boxes
  if ("%collectboxes" = "YES") then gosub BOXGET
  #put #echo Yellow scroll
  if ("%collectscroll" = "YES") then gosub SCROLLGET
  #put #echo Yellow maps
  if ("%collectmaps" = "YES") then gosub MAPGET
  #put #echo Yellow nuggets
  if ("%collectnuggets" = "YES") then gosub NUGGETSGET
  #put #echo Yellow bars
  if ("%collectbars" = "YES") then gosub BARSGET
  #put #echo Yellow materials
  if ("%collectmaterials" = "YES") then gosub MATERIALSGET
  #put #echo Yellow misc
  if ("%misckeeplist" != "none") then
  {
    eval keeplistnum count("%misckeeplist", "|")
    var miscgetcounter 0
    gosub MISCGET
  }
  return


MAPGET:
  if matchre ("$roomobjs", "\b(%treasuremaps)\b(,|\.| and)") then
  {
    gosub GETITEM map
    if %lootalerts = "YES" then put #echo %alertwindow Yellow [Treasure]: Found a treasure map!
    gosub STOWITEM map
  }
  if matchre ("$roomobjs", "\b(%treasuremaps)\b(,|\.| and)") then goto MAPGET
  return

MATERIALSGET:
  if matchre ("$roomobjs", "\b(%materials) (%materialsnouns)\b(,|\.| and)") then
  {
    var materialadj $1
    var materialnoun $2
    gosub GETITEM %materialnoun
    if %lootalerts = "YES" then put #echo %alertwindow Yellow [Treasure]: Found a %materialadj %materialnoun rare material!
    gosub STOWITEM %materialnoun
  }
  if matchre ("$roomobjs", "\b(%materials) (%materialsnouns)\b(,|\.| and)") then goto MATERIALSGET
  return


MISCGETP:
  pause
MISCGET:
  if %miscgetcounter > %keeplistnum then return
  #echo keepitem: %misckeeplist(%miscgetcounter)
  if matchre ("$roomobjs", "%misckeeplist(%miscgetcounter)") then
  {
    if %lootalerts = "YES" then put #echo %alertwindow Yellow [Treasure]: Found a misc item - %misckeeplist(%miscgetcounter)!
    gosub GETITEM %misckeeplist(%miscgetcounter)
    gosub STOWITEM %misckeeplist(%miscgetcounter)
  }
  math miscgetcounter add 1
  goto MISCGET    


NUGGETSGET:
  if matchre ("$roomobjs", "\b(%nuggetmaterials) nugget\b(,|\.| and)") then
  {
    var nuggetadj $1
    gosub GETITEM nugget
    #if %lootalerts = "YES" then put #echo %alertwindow Yellow [Treasure]: Found a %nuggetadj nugget
    gosub STOWITEM nugget
  }
  if matchre ("$roomobjs", "\b(%nuggetmaterials) nugget\b(,|\.| and)") then goto NUGGETSGET
  return


BARSGET:
  if matchre ("$roomobjs", "\b(%nuggetmaterials) bar\b(,|\.| and)") then
  {
    var baradj $1
    gosub GETITEM bar
    #if %lootalerts = "YES" then put #echo %alertwindow Yellow [Treasure]: Found a %baradj bar!
    gosub STOWITEM my bar
  }
  if matchre ("$roomobjs", "\b(%nuggetmaterials) bar\b(,|\.| and)") then goto BARSGET
  return


SCROLLGET:
  if matchre("$roomobjs", ".*(?<!page of )(?<!fetid antelope )\b(%scrolls)\b(,|\.| and)") then
  {
    var foundscroll $1
    if %lootalerts = "YES" then put #echo %alertwindow Yellow [Treasure]: Found a scroll - %foundscroll! 
    gosub STOWITEM %foundscroll
  }
  if matchre("$roomobjs", ".*(?<!page of )(?<!fetid antelope )\b(%scrolls)\b(,|\.| and)") then goto SCROLLGET
  return


SKINNINGP:
	pause
SKINNING:
  matchre RETURN You can't skin something that's not dead\!|but end up destroying the skin\.|You carefully fit|renders your skinning attempt|You hideously bungle|You make a series of cuts|cannot be skinned|I don't know|twists and slips in your grip|You claw wildly|Skin what\?|You manage to slice it to dripping tatters\.
	match SKINSTOW You must have one hand free to skin.
	match SKININJURED You're too wounded to be skinning anything!
	matchre SKINNINGP %waitstring
	matchre RETURN Roundtime: \d+
	put skin
  matchwait 5
	var timeoutsub SKINNING
  var timeoutcommand skin
	goto TIMEOUT

SKINSTOW:
  gosub STOWALL
  goto SKINNING

SKININJURED:
  if ("%autoupkeep" = "YES") then
  {
    var goupkeep 1
    var autype wounds
  }
  else
  {
    put #echo >$alertwindow Yellow Tried to skin, but you're too injured!  Please address!
    put #flash
    put #play Advance
    if ("%bugout" = "YES") then goto BUGOUT
    else goto SKININJURED2
  }
  return

SKININJURED2:
  put #echo Yellow ===FAILED TO SKIN DUE TO WOUNDS!===
  put #flash
  put #play Advance
  pause 5
  goto SKININJURED2
  
  return


TIEPOUCHP:
  pause
TIEPOUCH:
  matchre TIEPOUCHP %waitstring
  matchre TIEGEMGET You tie up the gem pouch.|The gem pouch has already been tied off.
  put tie gem pouch
  matchwait 5
	var timeoutsub TIEPOUCH
  var timeoutcommand tie gem pouch
	goto TIMEOUT


TIEGEMGETP:
  pause
TIEGEMGET:
  if matchre ("$righthandnoun", "\b(%gems1|%gems2|%gems3|%gems4|%gweths)\b(,|\.| and)") then gosub STOW right
  if matchre ("$lefthandnoun", "\b(%gems1|%gems2|%gems3|%gems4|%gweths)\b(,|\.| and)") then gosub STOW left
  goto GEMGET


#####ARMOR_SWAP_SUBS#####
ARMORCHECK:
  var firstarmorcheck 1
  gosub STOWALL
  gosub WEARARMOR %shielditem
  if (%weararmorworn != 1) then
  {
    gosub GETITEM %shielditem
    if ("$righthand" != "Empty") then
    {
      gosub WEARITEM %shielditem
      if ("$righthand" = "Empty") then
      {
        var shieldworn 1
        #put #echo Yellow Wore Shield!
      }
      else
      {
        put #echo %alertwindow Yellow [Armor]: Could not wear shield!  Please address!
        put #echo Yellow Could not wear shield!  Please address!
        if ("%bugout" = "YES") then goto BUGOUT
        else goto ARMORPROBLEM
      }
    }
    else
    {
      put #echo %alertwindow Yellow [Armor]: Could not find shield to wear!  Please address!
      put #echo Yellow Could not find shield to wear!  Please address!
      if ("%bugout" = "YES") then goto BUGOUT
      else goto ARMORPROBLEM
    } 
  }
  else
  {
    #put #echo Yellow Shield worn!
  }
  #PARRY_STICK
  gosub WEARARMOR %parrystickitem
  if (%weararmorworn != 1) then
  {
    gosub GETITEM %parrystickitem
    if ("$righthand" != "Empty") then
    {
      gosub WEARITEM %parrystickitem
      if ("$righthand" = "Empty") then
      {
        var parrystickworn 1
        #put #echo Yellow Wore Parry Stick!
      }
      else
      {
        put #echo %alertwindow Yellow [Armor]: Could not wear parry stick!  Please address!
        put #echo Yellow Could not wear parry stick!  Please address!
        if ("%bugout" = "YES") then goto BUGOUT
        else goto ARMORPROBLEM
      }
    }
    else
    {
      put #echo %alertwindow Yellow [Armor]: Could not find parry stick to wear!  Please address!
      put #echo Yellow Could not find parry stick to wear!  Please address!
      if ("%bugout" = "YES") then goto BUGOUT
      else goto ARMORPROBLEM
    } 
  }
  else
  {
    #put #echo Yellow Shield worn!
  }
  #KNUCKLES
  gosub WEARARMOR %knucklesitem
  if (%weararmorworn != 1) then
  {
    gosub GETITEM %knucklesitem
    if ("$righthand" != "Empty") then
    {
      gosub WEARITEM %knucklesitem
      if ("$righthand" = "Empty") then
      {
        var knucklesworn 1
        #put #echo Yellow Wore knuckles!
      }
      else
      {
        put #echo %alertwindow Yellow [Armor]: Could not wear knuckles!  Please address!
        put #echo Yellow Could not wear knuckles!  Please address!
        if ("%bugout" = "YES") then goto BUGOUT
        else goto ARMORPROBLEM
      }
    }
    else
    {
      put #echo %alertwindow Yellow [Armor]: Could not find knuckles to wear!  Please address!
      put #echo Yellow Could not find knuckles to wear!  Please address!
      if ("%bugout" = "YES") then goto BUGOUT
      else goto ARMORPROBLEM
    } 
  }
  else
  {
    #put #echo Yellow Knuckles worn!
  }
  var armorloop 0
  gosub ARMORCHECKLOOP
  return

ARMORPROBLEM:
  echo ===ARMOR PROBLEM!===
  put #flash
  put #play Advance
  pause 5
  goto ARMORPROBLEM
    
ARMORCHECKLOOP:
  math armorloop add 1
  if %armorloop > %armornum then return
  gosub WEARARMOR %armor%armorloopitem
  if (%weararmorworn != 1) then
  {
    gosub GETITEM %armor%armorloopitem
    if ("$righthand" != "Empty") then
    {
      gosub WEARITEM %armor%armorloopitem
      if ("$righthand" = "Empty") then
      {
        var %armor%armorloopworn 1
        #put #echo Yellow Wore Armor %armorloop!
      }
      else
      {
        put #echo %alertwindow Yellow [Armor]: Could not wear Armor %armorloop!  Please address!
        put #echo Yellow Could not wear Armor %armorloop!  Please address!
        if ("%bugout" = "YES") then goto BUGOUT
        else goto ARMORPROBLEM
      }
    }
    else
    {
      put #echo %alertwindow Yellow [Armor]: Could not find Armor %armorloop to wear!  Please address!
      put #echo Yellow Could not find Armor %armorloop to wear!  Please address!
      if ("%bugout" = "YES") then goto BUGOUT
      else goto ARMORPROBLEM
    } 
  }
  else
  {
    #put #echo Yellow Armor %armorloop worn!
  }
  goto ARMORCHECKLOOP


ARMORREMBOXPOP:
  var armorremcount 0
  gosub ARMORREMBOXPOPLOOP
  gosub REMITEM %shielditem
  gosub STOWITEM %shielditem
  gosub REMITEM %knucklesitem
  gosub STOWITEM %knucklesitem
  return

ARMORREMBOXPOPLOOP:
  math armorremcount add 1
  if (%armorremcount > %armornum) then return
  gosub REMITEM %armor%armorremcountitem
  gosub STOWITEM %armor%armorremcountitem
  goto ARMORREMBOXPOPLOOP

#####LOCKSMITHING_SUBS#####


BOXCOINGETP:
  pause
BOXCOINGET:
  matchre BOXCOINGETP \.\.\.wait|type ahead|stunned|while entangled in a web\.
  match BOXCOINGET You pick up
  match RETURN What were you referring to?
  put get coin from my %boxitem
  matchwait
 
BOXFILLPOUCHP:
  pause
BOXFILLPOUCH:
  matchre BOXFILLPOUCHP \.\.\.wait|type ahead|stunned|while entangled in a web\.
	matchre RETURN ^You take|^There aren't any|You fill your|You open your|You have to be holding
	matchre BOXFILLPOUCHTIE The gem pouch is too valuable|You'll need to tie it up
	matchre BOXFILLPOUCHFULL is too full to fit any more gems!|You can't fill anything with
	put fill my gem pouch with my %boxitem
	matchwait
 
BOXFILLPOUCHTIE:
  gosub TIEPOUCH
  goto BOXFILLPOUCH

BOXFILLPOUCHFULL:
  gosub REMITEM gem pouch
  gosub STOWITEM gem pouch
  var pouchcount 0
  gosub GEMFINDEMPTYPOUCH
  if %pouchcount = 12 then goto GEMPOUCHNONE
  gosub GETITEM %pouchnum gem pouch
  gosub WEARITEM gem pouch
  gosub STORE gem gem pouch
  goto BOXFILLPOUCH

BOXLOOTCHECKP:
  pause
BOXLOOTCHECK:
	matchre BOXLOOTCHECKP \.\.\.wait|type ahead|stunned|while entangled in a web\.
	#matchre stow_Gear (gear|\bbolt\b|\bnut\b|glarmencoupler|spangleflange|rackensprocket|flarmencrank)
	matchre BOXLOOTGETMISC (map|treasure map|Treasure map)
  matchre BOXLOOTGETMISC (nugget|ingot|(?!bar of)\bbar\b|jadeite|kyanite|bark|parchment|\bdira\b|papyrus|papyrus roll|tablet|vellum|\bscroll\b|\broll\b|ostracon|leaf|\brune\b)
  matchre RETURN In the|nothing|What
	put look in my %boxitem
	matchwait

BOXLOOTGETMISC:
  var itemtoget $1
  gosub GETITEM %itemtoget in my %boxitem
  gosub STOWITEM %itemtoget
  #put #echo >Log Yellow Found a %itemtoget!
  goto BOXLOOTCHECK


BOXSTORAGECHECKP:
  pause
BOXSTORAGECHECK:
  var foundboxes 0
	matchre BOXSTORAGECHECKP \.\.\.wait|type ahead|stunned|while entangled in a web\.
	matchre BOXSTORAGECHECKYES (%boxes)
  matchre RETURN In the|nothing|What
  match RETURN I could not find what you were referring to.
	put look in my %boxstorage
	matchwait
  
BOXSTORAGECHECKYES:
  var foundboxes 1
  return
  

DISARMP:
  pause
DISARM:
  matchre DISARMP \.\.\.wait|type ahead|stunned|while entangled in a web\.
  match DISARM2Q An aged grandmother could defeat this trap in her sleep.
  match DISARM2Q This trap is a laughable matter, you could do it blindfolded!
  match DISARM2Q This trap is a laughable matter -- you could do it blindfolded!
  match DISARM2Q trap is a trivially constructed gadget which you can take down any time.
  match DISARM2Q will be a simple matter for you to disarm.
  match DISARM2C should not take long with your skills.
  match DISARM2C with only minor troubles.
  match DISARM2C You think this trap is precisely at your skill level.
  match DISARM2C The trap has the edge on you, but you've got a good shot at disarming the
  match DISARM2C The odds are against you, but with persistence you believe you could disarm the
  match DISARM2C You have some chance of being able to disarm the
  match DISARM2C would be a longshot.
  match DISARM2C Prayer would be a good start for any attempt of yours at disarming the
  match DISARM2C You have an amazingly minimal chance at disarming the
  match DISARM2C You really don't have any chance at disarming this
  match DISARM2C You probably have the same shot as a snowball does crossing the desert.
  match DISARM2C You could just jump off a cliff and save yourself the frustration of attempting this
  match DISARM2C A pitiful snowball encased in the Flames of Ushnish would fare better than you.
  match DISARM You get the distinct feeling your careless examination caused something to shift inside the trap mechanism.  This is not likely to be a good thing.
  match DISARM fails to reveal to you what type of trap protects it.
  match RETURN You guess it is already disarmed.
  match RETURN Roundtime:
  put disarm my %boxitem identify
  matchwait

DISARM2Q:
  var disarmtype
  goto DISARM2
  
DISARM2C:
  var disarmtype careful
  goto DISARM2 
  
DISARM2P:
  pause
DISARM2:
  matchre DISARM2P \.\.\.wait|type ahead|stunned|while entangled in a web\.
  match RETURN Roundtime:
  match DISARM2 You work with the trap for a while but are unable to make any progress.
  matchre DISARM is not yet fully disarmed\.|You work with the trap for a while but are unable to make any progress\.
  put disarm my %boxitem %disarmtype
  matchwait


DISMANTLEP:
  pause
DISMANTLE:
  matchre DISMANTLEP \.\.\.wait|type ahead|stunned|while entangled in a web\.
  matchre RETURN Roundtime
  match DISMANTLE You can not dismantle the
  if ("%dismantletype" = "none") then put dismantle my %boxitem
  else put dismantle my %boxitem %dismantletype
  matchwait  


PICKP:
  pause
PICK:
  if (%baddisarm = 1) then
  {
    gosub DISARM2put st
  }
  matchre PICKP \.\.\.wait|type ahead|stunned|while entangled in a web\.
  match PICK fails to teach you anything about the lock guarding it.
  match PICK2Q An aged grandmother could open this in her sleep.
  match PICK2Q This lock is a laughable matter, you could do it blindfolded!
  match PICK2Q This lock is a laughable matter -- you could do it blindfolded!
  match PICK2Q The lock is a trivially constructed piece of junk barely worth your time.
  match PICK2Q will be a simple matter for you to unlock.
  match PICK2C should not take long with your skills.
  match PICK2C with only minor troubles.
  match PICK2C You think this lock is precisely at your skill level.
  match PICK2C The lock has the edge on you, but you've got a good shot at picking open the
  match PICK2C The odds are against you, but with persistence you believe you could pick open the
  match PICK2C You have some chance of being able to pick open the
  match PICK2C would be a longshot.
  match PICK2C Prayer would be a good start for any attempt of yours at picking open the
  match PICK2C You have an amazingly minimal chance at picking open the
  match PICK2C You really don't have any chance at picking open this
  match PICK2C You probably have the same shot as a snowball does crossing the desert.
  match PICK2C You could just jump off a cliff and save yourself the frustration of attempting this
  match PICK2C A pitiful snowball encased in the Flames of Ushnish would fare better than you.
  match RETURN It's not even locked, why bother?
  put pick my %boxitem identify
  matchwait
    
PICK2Q:
  var picktype
  goto PICK2
  
PICK2C:
  var picktype careful
  goto PICK2
  
PICK2P:
  pause
PICK2:
  if (%baddisarm = 1) then
  {
    gosub DISARM
    goto BOXPOPPINGLOOP   
  }
  matchre PICK2P \.\.\.wait|type ahead|stunned|while entangled in a web\.
  match PICK You discover another lock protecting the
  match PICK2 You are unable to make any progress towards opening the lock.
  match RETURN Roundtime:
  #match RETURN With a soft click, you remove your lockpick and open and remove the lock.
  put pick my %boxitem %picktype
  matchwait


TURNSKELETONKEY:
  var skelkeystring $0
  goto TURNSKELETONKEYMAIN
TURNSKELETONKEYP:
  pause
TURNSKELETONKEYMAIN:
  matchre TURNSKELETONKEYP %waitstring
  matchre RETURN You turn a vardite skeleton key at .* and a soft glow surrounds it\.
  matchre RETURN You attempt to turn .*, but that doesn't seem to do much\.
  put turn my skeleton key at my %skelkeystring
  matchwait

PULLBUCKETP:
  pause
PULLBUCKET:
  matchre PULLBUCKETP %waitstring
  match PULLBUCKET [OOC: PULL the bucket again within the next 30 seconds to flush it.].
  match RETURN After a moment, a dull *THUD* echoes from within the bucket.
  put pull my %bucketitem
  matchwait
  

BOXPOPPINGKHRI:
  var firstbpkhristring 1
  var bpkhristring 
  if ("%boxpopkhrifocus" = "YES") then
  {
    if ($SpellTimer.KhriFocus.active != 1) then
    {
      if (%firstbpkhristring = 1) then
      {
        var firstbpkhristring 0
        var bpkhristring focus
      }
      else var bpkhristring %bpkhristring|focus
    }
  }
  if ("%boxpopkhrihasten" = "YES") then
  {
    if ($SpellTimer.KhriHasten.active != 1) then
    {
      if (%firstbpkhristring = 1) then
      {
        var firstbpkhristring 0
        var bpkhristring hasten
      }
      else var bpkhristring %bpkhristring|hasten
    }
  }
  if ("%boxpopkhriplunder" = "YES") then
  {
    if ($SpellTimer.KhriPlunder.active != 1) then
    {
      if (%firstbpkhristring = 1) then
      {
        var firstbpkhristring 0
        var bpkhristring plunder
      }
      else var bpkhristring %bpkhristring|plunder
    }
  }
  if ("%boxpopkhrisafe" = "YES") then
  {
    if ($SpellTimer.KhriSafe.active != 1) then
    {
      if (%firstbpkhristring = 1) then
      {
        var firstbpkhristring 0
        var bpkhristring safe
      }
      else var bpkhristring %bpkhristring|safe
    }
  }
  if ("%boxpopkhrisight" = "YES") then
  {
    if ($SpellTimer.KhriSight.active != 1) then
    {
      if (%firstbpkhristring = 1) then
      {
        var firstbpkhristring 0
        var bpkhristring sight
      }
      else var bpkhristring %bpkhristring|sight
    }
  }
  if (%firstbpkhristring = 0) then
  {
    eval bpkhristring replace("%bpkhristring", "|", " ")
    gosub KHRI %bpkhristring
  }
  return

LOCKSMITHCAST:
  if %burglerf = "YES" then
  {
    if (($SpellTimer.RefractiveField.active = 0) || ($SpellTimer.RefractiveField.duration < 2)) then
    {
      if %casting = 1 then
      {
        gosub RELSPELL
        gosub RELSYMBIOSIS
      }
      var spellprepping rf
      var prepmana 5
      var addmana 0
      var casting 1
      gosub PREP
      pause %burglerfdelay
      gosub CAST
    }
  }
  return


#####BARD_SUBS#####


SCREAMDEFIANCEP:
  pause
SCREAMDEFIANCE:
  matchre SCREAMDEFIANCEP %waitstring
  matchre RETURN You are unable to gather the will to overcome your stunned condition\.|You scream out!|You gather your will and overcome your stunned condition.|Building inspiration from tales of|Your defiant will subsides\.|You strain to muster an even greater defiant decry\.|You open your mouth, then close it suddenly, looking somewhat like a fish\.|There is no need for violence here\.
  put scream defiance
  matchwait 5
	var timeoutsub SCREAMDEFIANCE
  var timeoutcommand scream defiance
	goto TIMEOUT
	
	
WHISTLEPIERCEP:
  pause
WHISTLEPIERCE:
  matchre WHISTLEPIERCEP %waitstring
  matchre RETURN You take a deep breath, then exhale strongly over the tip of your curved tongue\.|Your throat feels too strained to perform another piercing whistle right now\.|You can't seem to summon the strength to perform a piercing whistle right now\.
  put whistle piercing
  matchwait 5
	var timeoutsub WHISTLEPIERCE
  var timeoutcommand whistle piercing
	goto TIMEOUT



#####MM_SUBS#####


INVOKESHADOWP:
  pause
INVOKESHADOW:
  matchre INVOKESHADOWP %waitstring
  matchre RETURN You gesture, adjusting the pattern|Invoke what?|You're not sure what would happen
  put invoke %shadowlingnoun
  matchwait 5
	var timeoutsub INVOKESHADOW
  var timeoutcommand invoke shadowling
	goto TIMEOUT


MOONCHECK:
  var moonsout 0
  if $Time.isKatambaUp = 1 then var moonsout 1
  if $Time.isXibarUp = 1 then var moonsout 1
  if $Time.isYavashUp = 1 then var moonsout 1
  return


SHIFTMOONP:
  pause
SHIFTMOON:
  matchre RETURN You are unable to see your target clearly enough for that.
  matchre SHIFTMOONGOOD You sense your moonbeam
  put gesture %smmoon %smtarget
  matchwait 5
	var timeoutsub SHIFTMOON
  var timeoutcommand gesture %smoon $smtarget
	goto TIMEOUT

SHIFTMOONGOOD:
  var smgood 1
  return



#####NECRO_LOGIC#####


COUNTMATERIAL:
  action (material) var rummagestring $1 when You rummage (.+)
  gosub RUMMAGE %storage
  pause .5
  action (material) off
  eval materialnum count("%rummagestring","material")
  return


DEVOURLOOP:
  gosub CASTINGLOGIC
  pause 1
  if %casting != 1 then
  {
    return
  }
  goto DEVOURLOOP


NSAFETYCHECK:
  var necrogood 1
  eval roomplayerslength length("$roomplayers")
  if %roomplayerslength != 0 then 
  {
    var roomplayers $roomplayers
    gosub RPLAYERSCRUB
    var rcounter 0
    eval nsafenum count("%necrowhitelist", "|")
    eval rplayernum count("%roomplayers", "|")
    #TURNING_TO_LOWERCASE
    eval roomplayers tolower("%roomplayers")
    eval necrowhitelist tolower("%necrowhitelist")
    gosub RPLAYERSORT
    if %roomplayers != "" then
    {
      echo Not engaging in spellcasting for Necro Safety!  Player(s) in the room: %roomplayers.
      var necrogood 0       
    }
  }
  return	


NRITUAL:
  var necroskin 0
  if matchre ("$roomobjs", "(\w+) ((which|that) appears dead|\(dead\))") then var ritualmonster $1
  if ("%preserve" = "YES") then gosub PRESERVE
  if ("%devour" = "YES") then
  {
    if $SpellTimer.Devour.active != 1 then
    {
      gosub HEALTHCHECK
      if %healthcheckgood != 1 then
      {
        gosub CASTRESET
        var spellprepping devour
        var prepmana %devourprepmana
        var addmana %devouraddmana
        var spellsymb 0
        var casting 1
        var scancel 0
        var prepped 0
        var charged 0
        var harnessed 0
        gosub DEVOURLOOP
        var necroskin 1
        return
      }
    }
  }
  if ("%harvest" = "YES") then
  {
    if matchre("$roomobjs", "(%skinnablecritters) ((which|that) appears dead|\(dead\))") then
    {
      gosub COUNTMATERIAL
      if (%materialnum < %harveststorenum) then
      {
        gosub HARVEST
        var necroskin 1
      }
    }
  }
  if ("%dissect" = "YES") then
  {
    if (matchre("$roomobjs", "(%skinnablecritters) ((which|that) appears dead|\(dead\))") then
    {
      if ($Skinning.LearningRate > $Thanatology.LearningRate) then
      {
        gosub NECRODISSECT
        var necroskin 1
      }
    }
  }
  return





#####NECRO_SUBS#####

PERFORMCUTP:
  pause
PERFORMCUT:
	matchre PERFORMCUTP %waitstring
  matchre RETURN You draw a slight cut across your palm
  put perform cut
  matchwait 5
	var timeoutsub PERFORMCUT
  var timeoutcommand perform cut
	goto TIMEOUT


CONSUMEP:
  pause
CONSUME:
	matchre CONSUMEP %waitstring
  matchre RETURN This ritual may only be performed on a creature's corpse.|Roundtime:|A skinned creature is worthless for your purposes.|Rituals do not work upon constructs\.|This corpse has already been prepared for consumption\.
  put perform consume on %ritualmonster
  matchwait 5
	var timeoutsub CONSUME
  var timeoutcommand perform consume on %ritualmonster
	goto TIMEOUT


NECRODISSECTP:
  pause
NECRODISSECT:
  matchre DISSECTP %waitstring
  matchre RETURN Roundtime:|A skinned creature is worthless for your purposes.
  matchre NECRODISSECTBAD This ritual may only be performed on a creature's corpse.|This ritual may only be performed on a corpse.|A failed or completed ritual has rendered this corpse unusable for your purposes.
  matchre NECRODISSECTBAD The preservation ritual that has been performed on this corpse prevents a meaningful dissection.|The harvesting ritual performed on this corpse prevents a meaningful dissection.
  put perform dissect on %ritualmonster
  matchwait 5
	var timeoutsub NECRODISSECT
  var timeoutcommand perform dissect on %ritualmonster
	goto TIMEOUT

NECRODISSECTBAD:
  var necroskin 0
  return


HARVESTP:
  pause
HARVEST:
  matchre HARVESTP %waitstring
  matchre HARVESTDISP Roundtime:
  matchre HARVESTBAD This ritual may only be performed on a creature's corpse.|Rituals do not work upon constructs.|This corpse has already been harvested.|A skinned creature is worthless for your purposes.|A failed or completed ritual has rendered this corpse unusable for your purposes.
  matchre HARVESTFULL You need a hand free to perform this ritual.
  match HARVEST2 You cannot harvest useful material
  put perform harvest on %ritualmonster
  matchwait 5
	var timeoutsub HARVEST
  var timeoutcommand perform harvest on %ritualmonster
	goto TIMEOUT
  
HARVESTFULL:
  gosub STOWALL
  goto HARVEST 
  
HARVESTBAD:
  var necroskin 0
  return

HARVEST2:
  gosub PRESERVE
  goto HARVEST

HARVESTDISP:
  if ("%harveststore" = "YES") then
  {
    gosub COUNTMATERIAL
    if %materialnum > %harveststorenum then goto HARVESTDROP
    else
    {
      gosub STOWITEM material
      return
    }
  }
  else goto HARVESTDROP


HARVESTDROPP:
  pause
HARVESTDROP:
  matchre HARVESTDROPP %waitstring
  matchre RETURN Having no further use|What were you referring to?|In a moment of foolishness
  put drop material
  matchwait 5
	var timeoutsub HARVESTDROP
  var timeoutcommand drop material
	goto TIMEOUT


PRESERVEP:
  pause
PRESERVE:
	matchre PRESERVEP %waitstring
  matchre RETURN This ritual may only be performed on a creature's corpse.|Roundtime:|A skinned creature is worthless for your purposes.|This corpse has already been preserved.|Rituals do not work upon constructs.
  put perform preserve on %ritualmonster
  matchwait 5
	var timeoutsub PRESERVE
  var timeoutcommand perform preserve on %ritualmonster
	goto TIMEOUT

#####RANGER_SUBS#####
POUNCEP:
  pause
POUNCE:
  matchre POUNCEP %waitstring
  match RETURN Roundtime
  match RETURN You're too tired from the last time you pounced on some prey.
  match POUNCESTAND You'd have better luck if you stood up first.
  match RETURN What are you trying to attack?
  put pounce
  matchwait 5
  var timeoutsub POUNCE
  var timeoutcommand pounce
	goto TIMEOUT

POUNCESTAND:
  gosub STAND
  goto POUNCE

#####TRADER_SUBS#####

INVESTP:
  pause
INVEST:
  matchre INVESTP %waitstring
  match INVESTRETREAT You cannot do that while focusing on combat!
	matchre RETURN Roundtime|The frosty tessera begins to frost over, but quickly returns to normal\.|The clear tessera attempts to tap into your starlight aura, but finds it depleted\.
	put ask tessera about invest
  matchwait 5
	var timeoutsub INVEST
  var timeoutcommand ask tessera about invest
	goto TIMEOUT
  
INVESTRETREAT:
  gosub RETREAT
  goto INVEST


STARLIGHTCHECK:
  var badxibar 0
  var badyavash 0
  var badstars 0
  var starlight -1
  gosub TRADEROBSERVE
  var nextstarcheck %t
  math nextstarcheck add 900
  echo badxibar: %badxibar
  echo badyavash: %badyavash
  echo badstars: %badstars
  if ($SpellTimer.Noumena.active = 1) then
  {
    if ((($Time.isDay = 0) && (%badstars = 0)) || (($Time.isDay = 0) && (%badstars = 2)) || (%badxibar = 0) || (%badyavash = 0)) then
    {
      var starlight 1
    }
    else
    {
      var starlight 0
    }
  }
  else
  {
    if ((($Time.isDay = 0) && (%badstars = 0)) || (%badxibar = 0) || (%badyavash = 0)) then 
    {
      var starlight 1
    }
    else var starlight 0
  }
  return

TRADEROBSERVEP:
  pause
TRADEROBSERVE:
  match TRADEROBSERVEP %waitlist
  match TOBSERVERET You are a bit too distracted to be observing something.
  match RETURN That's a bit hard to do while inside.
  match RETURN Roundtime:
  put observe heavens
  matchwait 5
  var timeoutsub TRADEROBSERVE
  var timeoutcommand observe heavens
	goto TIMEOUT
	
TOBSERVERET:
  gosub RETREAT
  goto TRADEROBSERVE

TASKASKP:
  pause
TASKASK:
  matchre TASKASKP %waitstring
  match RETURN Mags frowns and shakes her head.  "Sorry, me hearin' isnae what it used tae be.  Come again?"
  match TASKFIND The firewood peddler Mags looks at you and says, "You are already on a task.  Please complete that task, or you may ask to cancel the job by asking me FOR TASK CANCEL."
  matchre TASKACCEPT The firewood peddler Mags says, "I do have a small task I'd like for you to perform\.  I need (\d*) (.*)\.  If you could get those for me, I would greatly appreciate it\."
  matchre TASKBAD The firewood peddler Mags says, "I am sorry, you must wait before I can give you a task\."
  put ask mags for task
  matchwait 5
  var timeoutsub TASKASK
  var timeoutcommand ask mags for task
	goto TIMEOUT
  
TASKACCEPTP:
  pause
TASKACCEPT:
  matchre TASKACCEPTP %waitstring
  matchre TASKFIND The firewood peddler Mags says, "Well, then.  Get to it.  Remember, I need \d* .*\.  Also, I will treat each item you give me as one item\."  The firewood peddler Mags glares at you, "So, don't try to give me a huge bundle, I'll only credit you for one\!"
  put accept task
  matchwait 5
  var timeoutsub TASKACCEPT
  var timeoutcommand accept task
	goto TIMEOUT

TASKFINDP:
  pause
TASKFIND:
  matchre TASKFINDP %waitstring
  match RETURN You look in your task journal and see the following entry:
  put task
  matchwait 5
  var timeoutsub TASKFIND
  var timeoutcommand task
	goto TIMEOUT
	
	
TASKMOVE:
  if ($zoneid != 1) then gosub TRAVEL crossing
  if (!matchre("$roomobjs" "Mags")) then gosub MOVE mags
  return
  
TASKBAD:
  put #echo Yellow Mags is on cooldown!
  pause 10
  goto TASKASK
  
TASKFORAGELOOP:
  if (%heldquantity >= %quantity) then return
  gosub FORAGE %forageitem
  if (matchre ("$righthand", "%forageitem")) then
  {
    gosub STOW right
    math heldquantity add 1
  }
  goto TASKFORAGELOOP
  
TASKGIVELOOP:
  gosub GETITEM %forageitem
  gosub TASKGIVEMAGS 
  if (%givingdone = 1) then return
  else goto TASKGIVELOOP

TASKGIVEMAGSP:
  pause
TASKGIVEMAGS:
  matchre TASKGIVEMAGSP %waitstring
  matchre RETURN The firewood peddler Mags takes the .* and says, "Thanks, .*\!  I need .* more\."
  matchre TASKGIVEGOOD The firewood peddler Mags says, "Thank you very much, .*\.  I have a few things here for you, thank you so much for your help\."
  put give mags
  matchwait 5
  var timeoutsub TASKGIVEMAGS
  var timeoutcommand give mags
	goto TIMEOUT
  
TASKGIVEGOOD:
  var givingdone 1
  return


#####WM_SUBS#####


BALLISTALOADP:
  pause
BALLISTALOAD:
  matchre BALLISTALOADP %waitstring
	matchre RETURN Roundtime|ballista is already loaded with a large rock!|What weapon are you trying to load?
	put load ballista
  matchwait 5
	var timeoutsub BALLISTALOAD
  var timeoutcommand load ballista
	goto TIMEOUT


BALLISTARUBP:
  pause
BALLISTARUB:	
	matchre BALLISTARUBP %waitstring
  matchre RETURN generates is focused only where it is facing\.|well enough to overcome the strength of its magnetic field\.|Rub what?
  matchre BALLISTARUB generates flares up with every single shot.
  put rub ballista
  matchwait 5
	var timeoutsub BALLISTARUB
  var timeoutcommand rub ballista
	goto TIMEOUT


BGATTACKP:
  pause  
BGATTACK:
  if %bgdone = 1 then return
  matchre BGATTACKP %waitstring
  matchre BGATTACK With a sharp overhand motion|With a casual flick of your wrists|You sweep your hands in
  #matchre BGNEWTARGET I don't think so.
  matchre RETURN I could not find what you were referring to.|you slap your|I do not understand what you mean.
  #matchre BGLOOT You wave to
  matchre RETURN You point at|You wave to|I don't think so.
  match RETURN You wave.
  put %bggesture %bgmon
  matchwait 5
	var timeoutsub BGATTACK
  var timeoutcommand %bggesture %bgmon
	goto TIMEOUT

BGATTACKDONE:
  var bgdone 1
  return
  
BGLOOT:
  if $SpellTimer.BlufmorGaraen.active = 1 then
  {
    gosub LOOT
    goto BGATTACK
  }
  else return
  
BGNEWTARGET:
  if $monstercount < 1 then
  {
    var goodtarget 0
    var shockcritter 1
    var currentcritter 0
    return
  }
  gosub MONSTERARRAY
  goto BGATTACK
  
  
BREAKWEAPON:
  var breakweaponstring $0
  goto BREAKWEAPONMAIN
BREAKWEAPONP:
  pause
BREAKWEAPONMAIN:
  matchre BREAKWEAPONP %waitstring
  matchre RETURN Focusing your will\, you rip the .* asunder, returning it to the Elemental planes\.|Break what\?|You can't break that\.
  put break my %breakweaponstring
  matchwait 5
	var timeoutsub BREAKWEAPON
  var timeoutcommand break my %breakweaponstring
	goto TIMEOUT
  

DOMAINSTARTP:
  pause  
DOMAINSTART:
  matchre DOMAINSTARTGOOD The strands anchor themselves to the ground,|The new lines of power are in conflict with the existing domain!  With a subtle show of power,
  matchre DOMAINSTARTBAD As the ritual winds toward its climax|The new lines of power are small compared to the existing ones, leaving the domain unaffected.
  matchre DOMAINSTARTP %waitstring
  put summon %domaintype domain 
  matchwait 5
	var timeoutsub DOMAINSTART
  var timeoutcommand summon %domaintype domain 
	goto TIMEOUT
 
DOMAINSTARTGOOD:
  var domainactive 1
  var domainactivetype %domaintype
  return

DOMAINSTARTBAD:
  var domainactive 0
  return


EXHALEP:
  pause	
EXHALE:
  var dbready 0
  matchre EXHALEP %waitstring
  matchre RETURN You sharply inhale, drawing upon|Your throat is too sore to breathe fire|You slowly and deliberately empty your filled lungs.|There is nothing else to face!
  put exhale
  matchwait 5
	var timeoutsub EXHALE
  var timeoutcommand put exhale
	goto TIMEOUT

EXHALETARGETP:
  pause	
EXHALETARGET:
  var dbready 0
  matchre EXHALEP %waitstring
  matchre RETURN You sharply inhale, drawing upon|You slowly and deliberately empty your filled lungs.|There is nothing else to face!|You'll need to pick a target to exhale fire at.
  match RETURN Your throat is too sore to breathe fire again so soon!
  matchre EXHALETLOOT That's just a wee bit pointless now, don't you think?
  put exhale %exhaletarget
  matchwait 5
	var timeoutsub EXHALETARGET
  var timeoutcommand exhale %exhaletarget
	goto TIMEOUT

EXHALETLOOT:
  gosub LOOT
  pause 1
  goto EXHALETARGET


PATHCHECKP:
  pause
PATHCHECK:
  match PATHCHECKNO With a moment of reflection, you realize you aren't investing any energy into manipulating the aether.
  match PATHCHECKYES You focus your magical senses on the aethereal landscape around you.
	matchre PATHCHECKP %waitstring
  put pathway check
  matchwait 5
	var timeoutsub PATHCHECK
  var timeoutcommand pathway check
	goto TIMEOUT

PATHCHECKNO:
  var pathwayactive 0
  return

PATHCHECKYES:
  var pathwayactive 1
  return


PATHSENSEP:
  pause
PATHSENSE:
  matchre PATHSENSEP %waitstring
  match RETURN You turn your perceptions inward
  put pathway sense
  matchwait 5
	var timeoutsub PATHSENSE
  var timeoutcommand pathway sense
	goto TIMEOUT


PATHSTART:
  var summpath $0
  goto PATHSTARTMAIN
PATHSTARTP:
  pause
PATHSTARTMAIN:
  var pathway 1
  matchre RETURN You focus on|You are already manipulating the aether to your benefit.
  matchre PATHSTARTBAD You lack the necessary charge
  matchre PATHSTARTP %waitstring
  put pathway focus %summpath
  matchwait 5
	var timeoutsub PATHSTART
  var timeoutcommand pathway focus %summpath
	goto TIMEOUT

PATHSTARTBAD:
  var pathway 0
  return


PATHSTOPP:
  pause
PATHSTOP:
  var pathway 0
  matchre RETURN You aren't focusing on any of the aethereal pathways.
  matchre RETURN You gently relax your mind and release your hold on the aethereal pathways.
  matchre PATHSTOPP %waitstring
  put pathway stop
  matchwait 5
	var timeoutsub PATHSTOP
  var timeoutcommand pathway stop
	goto TIMEOUT


SUMMONP:
	pause
SUMMON:
  if %summfull = 1 then var summarg impedance
  else var summarg admittance
  matchre RETURN you feel that you can still gather|you feel that you have reached your limit|You align yourself to it, briefly decreasing|You continue meditating
  matchre SUMMFULL You so heavily embody the Elemental Plane
  matchre SUMMEMPTY Try though you might
  matchre SUMMONP %waitstring
  put summon %summarg
  matchwait 5
	var timeoutsub SUMMON
  var timeoutcommand summon %summarg
	goto TIMEOUT

SUMMEMPTY:
  var summfull 0
  return

SUMMFULL:
  var summfull 1
  return

SUMMONCHARGEP:
	pause
SUMMONCHARGE:
  matchre RETURN you feel that you can still gather|you feel that you have reached your limit|You align yourself to it, briefly decreasing|You continue meditating
  matchre SUMMONCHARGEFULL You so heavily embody the Elemental Plane
  matchre SUMMONCHARGEP %waitstring
  put summon admittance
	matchwait
	var timeoutsub SUMMONCHARGE
  var timeoutcommand summon admittance
	goto TIMEOU
	
SUMMONCHARGEFULL:
  put #echo Yellow Charging complete!
  exit

SUMMONWEAPON:
  var argument $0
SUMMONWEAPONMAIN:
  matchre SUMMONWEAPONMAIN %waitstringgood
  matchre BADNEWS %waitstringbad
  match NOCHARGE You lack the elemental charge to summon a weapon.
  match RETURN Roundtime
  #matchre RETURN Closing your eyes, you grunt briefly in effort as you sense a small \w+ ethereal fissure open in front of you\.  Thrusting your hand through, you draw out (a|an) \w+ \w+\.
  #match SUMMONWEAPONSTOW How can you summon a weapon, when your hands are full?
  send summon weapon %argument
  matchwait 5
  goto COMBOERROR

SUMMONWEAPONNOCHARGE:
  put #echo Yellow You're out of elemental charge!
  exit

SUMMONWEAPONSHAPE:
  var argument $0
SUMMONWEAPONSHAPEMAIN:
  matchre SUMMONWEAPONSHAPEMAIN %waitstringgood
  matchre BADNEWS %waitstringbad
  matchre RETURN You reach out with your will and reshape your \w+ into .*\.
  match SUMMONWEAPONNOCHARGE You lack the elemental charge to modify your weapon.
  send shape $righthandnoun to %argument
  matchwait 5
  goto COMBOERROR

SUMMONWEAPONPULL:
  var argument $0
SUMMONWEAPONPULLMAIN:
  matchre SUMMONWEAPONPULLMAIN %waitstringgood
  matchre BADNEWS %waitstringbad
  match RETURN That's as heavy as you can make it!
  match RETURN Roundtime
  #matchre RETURN Closing your eyes, you grunt briefly in effort as you sense a small \w+ ethereal fissure open in front of you\.  Thrusting your \w+ \w+ through, you bind more material to your \w+, and pull it back out\.  
  send pull my %argument
  matchwait 5
  goto COMBOERROR
  
SUMMONWEAPONPUSH:
  var argument $0
SUMMONWEAPONPUSHMAIN: 
    matchre SUMMONWEAPONPUSHMAIN %waitstringgood
    matchre BADNEWS %waitstringbad
    match return Roundtime
    send push my %argument
    matchwait 5
    goto COMBOERROR

SUMMONWEAPONTURN:
  var argument $0
SUMMONWEAPONTURNMAIN:
    matchre SUMMONWEAPONTURNMAIN %waitstringgood
    matchre BADNEWS %waitstringbad
    match return Roundtime
    send turn %argument
    matchwait 5
    goto COMBOERROR

SUMMONWEAPONBREAK:
  var argument $0
SUMMONWEAPONBREAKMAIN:
    matchre SUMMONWEAPONBREAKMAIN %waitstringgood
    matchre BADNEWS %waitstringbad
    match RETURN Focusing your will
    match RETURN Break what?
    send break my %argument
    matchwait 5
    goto COMBOERROR


SUMMONWEAPONTRAINP:
  pause
SUMMONWEAPONTRAIN:
  matchre SUMMONWEAPONTRAINP %waitstring
  matchre RETURN You lack the elemental charge to summon a weapon\.
  matchre SUMMONWEAPONSET Closing your eyes, you grunt briefly in effort as you sense a small earthen ethereal fissure open in front of you\.  Thrusting your hand through, you draw out a.*stone (\w+)\.
  match SUMMONWEAPONSTOW How can you summon a weapon, when your hands are full?
  put summon weapon
  matchwait 5
	var timeoutsub SUMMONWEAPONTRAIN
  var timeoutcommand summon weapon
	goto TIMEOUT

SUMMONWEAPONSET:
  var summweaponname $1
  return

SUMMONWEAPONSTOW:
  gosub STOW left
  goto SUMMONWEAPONTRAIN


COMMANDWARRIORP:
  pause
COMMANDWARRIOR:
  matchre COMMANDWARRIORP %waitstring
  matchre RETURN Roundtime|EXAMPLES\:|Command who to do what\?|A .* ignores your command\.|You have already shifted your /w+ alfar warrior's behavior too recently, it will take a bit before it may again\.
  put command warrior to %warriorcommand
  matchwait 5
	var timeoutsub COMMANDWARRIOR
  var timeoutcommand command warrior to %warriorcommand
	goto TIMEOUT


MANIPULATEP:
  pause
MANIPULATE:
  matchre MANIPULATEP %waitstring
  matchre RETURN Roundtime|You're already manipulating|Manipulate what?|You attempt to empathically|You strain, but|seem to be beyond your ken. 
  put manipulate friendship %manipadj %maniptarget
  matchwait 5
	var timeoutsub MANIPULATE
  var timeoutcommand manipulate friendship %manipadj %maniptarget
	goto TIMEOUT

PERCHEALTHP:
  pause
PERCHEALTH:
  matchre PERCHEALTHP %waitstring
  matchre RETURN Roundtime|You fail to sense anything, however.|You close your eyes, drawing all your thoughts inward
  match RETURN Strangely, you can sense absolutely nothing.
  match RETURN You're in no shape to perceive anyone else's health right now!
  put perceive health
  matchwait 5
	var timeoutsub PERCHEALTH
  var timeoutcommand perceive health
	goto TIMEOUT

ICUTUTOUCHINGP:
  pause
ICUTUTOUCHING:
  var nextiztouch %t
  math nextiztouch add %iztimer
  matchre ICUTUTOUCHINGP %waitstring
  match ICUTUADV You aren't close enough to attack.
  match RETURN A good positive attitude never hurts.
  match RETURN Roundtime
  #You stab your curled ashen fingers at a sinuous ice adder.
  #The spell pattern collapses at the last moment due to the undead state of a sinuous ice adder.
  put touch
  put yes
  matchwait 5
	var timeoutsub ICUTUTOUCHING
  var timeoutcommand touch
	goto TIMEOUT

ICUTUADv:
  gosub ADV
  goto ICUTUTOUCHING

GAZESANOWRETP:
  pause
GAZESANOWRET:
  var sanowretready 0
  matchre GAZESANOWRETP %waitstring
  matchre RETURN You gaze intently into your|You need to be wearing or holding that first.
  put gaze %sanowretitem
  matchwait 5
	var timeoutsub GAZESANOWRET
  var timeoutcommand gaze %sanowretitem
	goto TIMEOUT


###PVP_SUBS###

MANEUVERTEST:
  eval maneuvernum count("%maneuverlist", "|")
  var maneuvertest 0
  var maneuver -1
  var closestmane 0
  gosub MANEUVERTESTLOOP
  if (%maneuver = -1) then
  {
    var secondsleft 90
    math secondsleft subtract %closestmane
    put #echo Yellow No maneuvers are off cooldown!  Closest maneuver: %secondsleft sec.
    exit
  }
  return

MANEUVERTESTLOOP:
  #echo maneuvertest: %maneuvertest  maneuvernum: %maneuvernum
  if (%maneuvertest > %maneuvernum) then return
  var manetest $unixtime
	math manetest subtract $%maneuverlist(%maneuvertest)last
	#echo %maneuverlist(%maneuvertest)last: $%maneuverlist(%maneuvertest)last
  #echo manetest: %manetest
	if (%manetest > 90) then
	{
	  var maneuver %maneuvertest
	  return
	}
	else
	{
	  if (%manetest > %closestmane) then var closestmane %manetest
	}
	math maneuvertest add 1
	goto MANEUVERTESTLOOP




ATTACKACMCOMBO:
  var argument $0
ATTACKACMCOMBOMAIN:
  matchre ATTACKACMCOMBOMAIN %waitstringgood
  match ATTACKACMCOMBOMAIN You must recover your position before attempting another maneuver so quickly.
  matchre ATTACKACMCBADNEWS %waitstringbad
  #match ATTACKACMCRETURN Roundtime:
  matchre ATTACKACMCRETURN ^You take a step back and (heft|ready) your \w+ behind you\.|^Taking a full step back, you plant your feet and .*\.|^You lower your shoulders and .*\.|^You take a step back and ready an upraised palm\.|^You angle to the side and .*\.|^You crouch down and draw your weapons close\.|^You step to the side and adjust your stance\.|^You take a step back and .*\.|^You square up your feet and arch your back while searching for an engaged enemy to target\.|You raise .* before you and prepare to strike\.|^You brace your shoulder against the .* to increase the power of the next shot\.
  matchre ATTACKACMCRETURN  ^\* .* is slain before your eyes!|^You take a step back and set your staff into a twirling motion\.
  #match RETURN With a loud twang, you let fly your
  #match ATTACKACMCSTOW You must free up your left hand first.
  matchre ATTACKACMCSTAND You'll need to stand up first\.|You must be standing to perform that maneuver\.
  matchre ATTACKACMCRANGE ^You aren't close enough to attack\.
  matchre ATTACKACMCGONE ^What are you trying to attack\?
  matchre ATTACKACMCWRONG With your fist\?  That might hurt\.|This weapon lacks the edge necessary to cleave your enemy with\.|Your hands must be empty to deliver such a blow\.|A pike or halberd weapon is necessary to impale your enemy with\.|Only a staff is suitable for the complex motions of the twirl maneuver\.|This works best when you use a suitable ranged weapon\.|This works best when you use a suitable weapon\.|This works best when you are dual wielding suitable weapons\.
  matchre ATTACKACMCFAIL You must rest a bit longer before attempting that maneuver again\.
  match ATTACKACMCBADNAME You cannot figure out how to do that.
  send maneuver %argument
  matchwait 5
  gosub COMBOERROR

ATTACKACMCSTOW:
  gosub STOW left
  goto ATTACKACMCOMBOMAIN

ATTACKACMCRETURN:
  #put #var %manenamelast $unixtime
  #put #echo Yellow Maneuver complete!
  return

ATTACKACMCGONE:
  put #echo Yellow Maneuver failed - gone!
  return

ATTACKACMCRANGE:
  put #echo Yellow Maneuver failed - range!  Advancing!
  gosub ADV
  goto ATTACKACMCOMBOMAIN
  return

ATTACKACMCSTAND:
  gosub STAND
  goto ATTACKACMCOMBOMAIN

ATTACKACMCWRONG:
  send #echo Yellow ACM attempted with improper item(s) in hands!
  exit

ATTACKACMCFAIL:
  #send #echo Yellow ACM is still on cooldown!
  #var failtest $unixtime
  #math failtest subtract 80
  #put #var %manenamelast %failtest
  exit

ATTACKACMCBADNAME:
  send #echo Yellow ACM attempted with bad syntax!
  exit

ATTACKACMCBADNEWS:
  put #echo Yellow You've been disrupted!
  exit

COMBOERROR:
  put #echo Yellow Something went wrong.
  exit

###ARMOR_SUBS###
ARMORSET:
  math testcount add 1
  if %testcount > 4 then return
  gosub ARMORSETRUN
  goto ARMORSET
  
ARMORSETRUNP:
  pause
ARMORSETRUN:
  if %%armortypearmor%testcountworn = 0 then
  {
    if %%armorotypearmor%testcount != "none" then
    {
      gosub REMITEM %%armorotypearmor%testcount
      var %armorotypearmor%testcountworn 0
      gosub STOWITEM %%armorotypearmor%testcount
    }
    if %%armortypearmor%testcount != "none" then
    {
      gosub GETITEM %%armortypearmor%testcount
      var %armortypearmor%testcountworn 1
      gosub WEARITEM %%armortypearmor%testcount
    }
  }
  return

NEWARMORFIND:
  action (armor) on
  action (armor) var shieldworn 1 when %shielddesc
  action (armor) var armor1worn 1 when %armor1desc
  action (armor) var armor2worn 1 when %armor2desc
  action (armor) var armor3worn 1 when %armor3desc
  action (armor) var armor4worn 1 when %armor4desc
  gosub INVARMOR
  pause 1
  action (armor) off
  return

INVARMOR:
  matchre RETURN [Type INVENTORY HELP for more options]|You aren't wearing anything like that.
  put inv armor
  matchwait 5
	var timeoutsub INVARMOR
  var timeoutcommand inv armor
	goto TIMEOUT


###HEALTH###
INFOCHECKP:
  pause
INFOCHECK:
  matchre INFOCHECKP %waitstring
  matchre RETURN A good positive attitude never hurts.
  put info
  put yes
  matchwait 5
	var timeoutsub INFOCHECK
  var timeoutcommand info
	goto TIMEOUT

BURDENCHECKP:
  pause
BURDENCHECK:
  matchre BURDENCHECKP %waitstring
  match RETURN Encumbrance :
  put encumbrance
  matchwait 5
	var timeoutsub BURDENCHECK
  var timeoutcommand encumbrance
	goto TIMEOUT

HEALTHCHECKP:
  pause
HEALTHCHECK:
  #echo healthcheck
  var healthcheckgood 0
  matchre HEALTHCHECKP %waitstring
  matchre HEALTHCHECKCLEAN You have no significant injuries.
  matchre RETURN A good positive attitude never hurts.
  put health
  put yes
  matchwait 5
	var timeoutsub HEALTHCHECK
  var timeoutcommand yes
	goto TIMEOUT

HEALTHCHECKCLEAN:
  var healthcheckgood 1
  return
  
BLEEDCHECKP:
  pause
BLEEDCHECK:
  #echo bleedcheck
  var nextbleed %t
  math nextbleed add 90
  gosub BLEEDCLEAN
  matchre BLEEDCHECKP %waitstring
  matchre BLEEDING ^Bleeding$
  matchre RETURN A good positive attitude never hurts.
  put health
  put yes
  matchwait 5
	var timeoutsub BLEEDCHECK
  var timeoutcommand yes
	goto TIMEOUT
  
BLEEDING:
  if ("%tendarea" != "YES") then
  {
    if (%head = 1)) then gosub tend head
    if (%neck = 1)) then gosub tend neck
    if (%chest = 1) then gosub tend chest
    if (%abdomen = 1) then gosub tend abdomen
    if (%back = 1) then gosub tend back
    if (%tail = 1) then gosub tend tail
    if (%rightarm = 1) then gosub tend right arm
    if (%leftarm = 1) then gosub tend left arm
    if (%righthand = 1) then gosub tend right hand
    if (%lefthand = 1) then gosub tend left hand
    if (%rightleg = 1) then gosub tend right leg
    if (%leftleg = 1) then gosub tend left leg
    if (%righteye = 1) then gosub tend right eye
    if (%lefteye = 1) then gosub tend left eye
  }
  else
  {
    if ((%head = 1) || (%neck = 1) || (%chest = 1) || (%abdomen = 1) || (%back = 1) || (%tail = 1) || (%rightarm = 1) || (%leftarm = 1) || (%righthand = 1) || (%lefthand = 1) || (%rightleg = 1) || (%leftleg = 1) || (%righteye = 1) || (%lefteye = 1)) then gosub TEND external
    if ((%inthead = 1) || (%intneck = 1) || (%intchest = 1) || (%intabdomen = 1) || (%intback = 1) || (%inttail = 1) || (%intrightarm = 1) || (%intleftarm = 1) || (%intrighthand = 1) || (%intlefthand = 1) || (%intrightleg = 1) || (%intleftleg = 1) || (%intrighteye = 1) || (%intlefteye = 1)) then gosub TEND internal
  }
  return

TEND:
  var tendlocation $0
TENDP:
  pause
TENDMAIN:
  if ("%tendlocation" = "stunned") then
  {
    var nextbleed %t
    return
  }
  matchre TENDP %waitstring
  matchre RETURN ^You work|^That area|^Look again|^Your .+ too injured|TEND {MY|<character>} {area}|You are a bit too busy performing to do that.|^You fumble|That area is not bleeding\.|You skillfully remove
  put tend my %tendlocation
  matchwait 5
	var timeoutsub TENDMAIN
  var timeoutcommand tend my %tendlocation
	goto TIMEOUT
  
BLEEDCLEAN:
  var head 0
  var neck 0
  var chest 0
  var abdomen 0
  var back 0
  var tail 0
  var rightarm 0
  var leftarm 0
  var righthand 0
  var lefthand 0
  var rightleg 0
  var leftleg 0
  var righteye 0
  var lefteye 0
  return
  
HEALTHCHECK2:
  if $guild = "Empath" then 
  {
    gosub HEALTHRESET
    gosub HEALTHPERC
    gosub HEALTHOUTPUT
  }
  else
  {
    gosub HEALTHRESET
    gosub HEALTHVERB
    gosub HEALTHOUTPUT
  }
  exit

HEALTHPERC:
  action var TEMP $1_$2 when ^Wounds to the (LEFT|RIGHT) (\w+):$
  action var TEMP $1 when ^Wounds to the (\w+):$
  action var %TEMP_MYW_E 1 when Fresh External:.*?\-\-\s+insignificant$
  action var %TEMP_MYW_I 1 when Fresh Internal:.*?\-\-\s+insignificant$
  action var %TEMP_MYS_E 1 when Scars External:.*?\-\-\s+insignificant$
  action var %TEMP_MYS_I 1 when Scars Internal:.*?\-\-\s+insignificant$
  action var %TEMP_MYW_E 2 when Fresh External:.*?\-\-\s+negligible$
  action var %TEMP_MYW_I 2 when Fresh Internal:.*?\-\-\s+negligible$
  action var %TEMP_MYS_E 2 when Scars External:.*?\-\-\s+negligible$
  action var %TEMP_MYS_I 2 when Scars Internal:.*?\-\-\s+negligible$
  action var %TEMP_MYW_E 3 when Fresh External:.*?\-\-\s+minor$
  action var %TEMP_MYW_I 3 when Fresh Internal:.*?\-\-\s+minor$
  action var %TEMP_MYS_E 3 when Scars External:.*?\-\-\s+minor$
  action var %TEMP_MYS_I 3 when Scars Internal:.*?\-\-\s+minor$
  action var %TEMP_MYW_E 4 when Fresh External:.*?\-\-\s+more than minor$
  action var %TEMP_MYW_I 4 when Fresh Internal:.*?\-\-\s+more than minor$
  action var %TEMP_MYS_E 4 when Scars External:.*?\-\-\s+more than minor$
  action var %TEMP_MYS_I 4 when Scars Internal:.*?\-\-\s+more than minor$
  action var %TEMP_MYW_E 5 when Fresh External:.*?\-\-\s+harmful$
  action var %TEMP_MYW_I 5 when Fresh Internal:.*?\-\-\s+harmful$
  action var %TEMP_MYS_E 5 when Scars External:.*?\-\-\s+harmful$
  action var %TEMP_MYS_I 5 when Scars Internal:.*?\-\-\s+harmful$
  action var %TEMP_MYW_E 6 when Fresh External:.*?\-\-\s+very harmful$
  action var %TEMP_MYW_I 6 when Fresh Internal:.*?\-\-\s+very harmful$
  action var %TEMP_MYS_E 6 when Scars External:.*?\-\-\s+very harmful$
  action var %TEMP_MYS_I 6 when Scars Internal:.*?\-\-\s+very harmful$
  action var %TEMP_MYW_E 7 when Fresh External:.*?\-\-\s+damaging$
  action var %TEMP_MYW_I 7 when Fresh Internal:.*?\-\-\s+damaging$
  action var %TEMP_MYS_E 7 when Scars External:.*?\-\-\s+damaging$
  action var %TEMP_MYS_I 7 when Scars Internal:.*?\-\-\s+damaging$
  action var %TEMP_MYW_E 8 when Fresh External:.*?\-\-\s+very damaging$
  action var %TEMP_MYW_I 8 when Fresh Internal:.*?\-\-\s+very damaging$
  action var %TEMP_MYS_E 8 when Scars External:.*?\-\-\s+very damaging$
  action var %TEMP_MYS_I 8 when Scars Internal:.*?\-\-\s+very damaging$
  action var %TEMP_MYW_E 9 when Fresh External:.*?\-\-\s+severe$
  action var %TEMP_MYW_I 9 when Fresh Internal:.*?\-\-\s+severe$
  action var %TEMP_MYS_E 9 when Scars External:.*?\-\-\s+severe$
  action var %TEMP_MYS_I 9 when Scars Internal:.*?\-\-\s+severe$
  action var %TEMP_MYW_E 10 when Fresh External:.*?\-\-\s+very severe$
  action var %TEMP_MYW_I 10 when Fresh Internal:.*?\-\-\s+very severe$
  action var %TEMP_MYS_E 10 when Scars External:.*?\-\-\s+very severe$
  action var %TEMP_MYS_I 10 when Scars Internal:.*?\-\-\s+very severe$
  action var %TEMP_MYW_E 11 when Fresh External:.*?\-\-\s+devastating$
  action var %TEMP_MYW_I 11 when Fresh Internal:.*?\-\-\s+devastating$
  action var %TEMP_MYS_E 11 when Scars External:.*?\-\-\s+devastating$
  action var %TEMP_MYS_I 11 when Scars Internal:.*?\-\-\s+devastating$
  action var %TEMP_MYW_E 12 when Fresh External:.*?\-\-\s+very devastating$
  action var %TEMP_MYW_I 12 when Fresh Internal:.*?\-\-\s+very devastating$
  action var %TEMP_MYS_E 12 when Scars External:.*?\-\-\s+very devastating$
  action var %TEMP_MYS_I 12 when Scars Internal:.*?\-\-\s+very devastating$
  action var %TEMP_MYW_E 13 when Fresh External:.*?\-\-\s+useless$
  action var %TEMP_MYW_I 13 when Fresh Internal:.*?\-\-\s+useless$
  action var %TEMP_MYS_E 13 when Scars External:.*?\-\-\s+useless$
  action var %TEMP_MYS_I 13 when Scars Internal:.*?\-\-\s+useless$
  send perceive health self
  waitforre ^You .+ vitality
  return

HEALTHVERB:
  put health
  return

HEALTHRESET:
  var ABDOMEN_MYW_E 0
  var ABDOMEN_MYW_I 0
  var ABDOMEN_MYS_E 0
  var ABDOMEN_MYS_I 0
  var BACK_MYW_E 0
  var BACK_MYW_I 0
  var BACK_MYS_E 0
  var BACK_MYS_I 0
  var CHEST_MYW_E 0
  var CHEST_MYW_I 0
  var CHEST_MYS_E 0
  var CHEST_MYS_I 0
  var HEAD_MYW_E 0
  var HEAD_MYW_I 0
  var HEAD_MYS_E 0
  var HEAD_MYS_I 0
  var LEFT_ARM_MYW_E 0
  var LEFT_ARM_MYW_I 0
  var LEFT_ARM_MYS_E 0
  var LEFT_ARM_MYS_I 0
  var LEFT_EYE_MYW 0
  var LEFT_EYE_MYW 0
  var LEFT_EYE_MYS 0
  var LEFT_EYE_MYS 0
  var LEFT_HAND_MYW_E 0
  var LEFT_HAND_MYW_I 0
  var LEFT_HAND_MYS_E 0
  var LEFT_HAND_MYS_I 0
  var LEFT_LEG_MYW_E 0
  var LEFT_LEG_MYW_I 0
  var LEFT_LEG_MYS_E 0
  var LEFT_LEG_MYS_I 0
  var NECK_MYW_E 0
  var NECK_MYW_I 0
  var NECK_MYS_E 0
  var NECK_MYS_I 0
  var RIGHT_ARM_MYW_E 0
  var RIGHT_ARM_MYW_I 0
  var RIGHT_ARM_MYS_E 0
  var RIGHT_ARM_MYS_I 0
  var RIGHT_EYE_MYW_E 0
  var RIGHT_EYE_MYW_I 0
  var RIGHT_EYE_MYS_E 0
  var RIGHT_EYE_MYS_I 0
  var RIGHT_HAND_MYW_E 0
  var RIGHT_HAND_MYW_I 0
  var RIGHT_HAND_MYS_E 0
  var RIGHT_HAND_MYS_I 0
  var RIGHT_LEG_MYW_E 0
  var RIGHT_LEG_MYW_I 0
  var RIGHT_LEG_MYS_E 0
  var RIGHT_LEG_MYS_I 0
  var SKIN_MYW_E 0
  var SKIN_MYW_I 0
  var SKIN_MYS_E 0
  var SKIN_MYS_I 0
  var TAIL_MYW_E 0
  var TAIL_MYW_I 0
  var TAIL_MYS_E 0
  var TAIL_MYS_I 0
  return

HEALTHOUTPUT:
  echo ABDOMEN_MYW_E %ABDOMEN_MYW_E
  echo ABDOMEN_MYW_I %ABDOMEN_MYW_I
  echo ABDOMEN_MYS_E %ABDOMEN_MYS_E
  echo ABDOMEN_MYS_I %ABDOMEN_MYS_I
  echo BACK_MYW %BACK_MYW
  echo BACK_MYW %BACK_MYW
  echo BACK_MYS %BACK_MYS
  echo BACK_MYS %BACK_MYS
  echo CHEST_MYW_E %CHEST_MYW_E
  echo CHEST_MYW_I %CHEST_MYW_I
  echo CHEST_MYS_E %CHEST_MYS_E
  echo CHEST_MYS_I %CHEST_MYS_I
  echo HEAD_MYW_E %HEAD_MYW_E
  echo HEAD_MYW_I %HEAD_MYW_I
  echo HEAD_MYS_E %HEAD_MYS_E
  echo HEAD_MYS_I %HEAD_MYS_I
  echo LEFT_ARM_MYW_E %LEFT_ARM_MYW_E
  echo LEFT_ARM_MYW_I %LEFT_ARM_MYW_I
  echo LEFT_ARM_MYS_E %LEFT_ARM_MYS_E
  echo LEFT_ARM_MYS_I %LEFT_ARM_MYS_I
  echo LEFT_EYE_MYW_E %LEFT_EYE_MYW_E
  echo LEFT_EYE_MYW_I %LEFT_EYE_MYW_I
  echo LEFT_EYE_MYS_E %LEFT_EYE_MYS_E
  echo LEFT_EYE_MYS_I %LEFT_EYE_MYS_I
  echo LEFT_HAND_MYW_E %LEFT_HAND_MYW_E
  echo LEFT_HAND_MYW_I %LEFT_HAND_MYW_I
  echo LEFT_HAND_MYS_E %LEFT_HAND_MYS_E
  echo LEFT_HAND_MYS_I %LEFT_HAND_MYS_I
  echo LEFT_LEG_MYW_E %LEFT_LEG_MYW_E
  echo LEFT_LEG_MYW_I %LEFT_LEG_MYW_I
  echo LEFT_LEG_MYS_E %LEFT_LEG_MYS_E
  echo LEFT_LEG_MYS_I %LEFT_LEG_MYS_I
  echo NECK_MYW_E %NECK_MYW_E
  echo NECK_MYW_I %NECK_MYW_I
  echo NECK_MYS_E %NECK_MYS_E
  echo NECK_MYS_I %NECK_MYS_I
  echo RIGHT_ARM_MYW_E %RIGHT_ARM_MYW_E
  echo RIGHT_ARM_MYW_I %RIGHT_ARM_MYW_I
  echo RIGHT_ARM_MYS_E %RIGHT_ARM_MYS_E
  echo RIGHT_ARM_MYS_I %RIGHT_ARM_MYS_I
  echo RIGHT_EYE_MYW_E %RIGHT_EYE_MYW_E
  echo RIGHT_EYE_MYW_I %RIGHT_EYE_MYW_I
  echo RIGHT_EYE_MYS_E %RIGHT_EYE_MYS_E
  echo RIGHT_EYE_MYS_I %RIGHT_EYE_MYS_I
  echo RIGHT_HAND_MYW_E %RIGHT_HAND_MYW_E
  echo RIGHT_HAND_MYW_I %RIGHT_HAND_MYW_I
  echo RIGHT_HAND_MYS_E %RIGHT_HAND_MYS_E
  echo RIGHT_HAND_MYS_I %RIGHT_HAND_MYS_I
  echo RIGHT_LEG_MYW_E %RIGHT_LEG_MYW_E
  echo RIGHT_LEG_MYW_I %RIGHT_LEG_MYW_I
  echo RIGHT_LEG_MYW_E %RIGHT_LEG_MYW_E
  echo RIGHT_LEG_MYS_I %RIGHT_LEG_MYS_I
  echo SKIN_MYW_E %SKIN_MYW_E
  echo SKIN_MYW_I %SKIN_MYW_I
  echo SKIN_MYS_E %SKIN_MYS_E
  echo SKIN_MYS_I %SKIN_MYS_I  
  echo TAIL_MYW_E %TAIL_MYW_E
  echo TAIL_MYW_I %TAIL_MYW_I
  echo TAIL_MYS_E %TAIL_MYS_E
  echo TAIL_MYS_I %TAIL_MYS_I
  return
  
###COLLECTING###
COLLECTP:
	pause
COLLECT:
	matchre COLLECTP %waitstring
	matchre RETURN You begin exploring the area, searching for .*\.  In almost no time, you manage to identify \d+ of them but leave them where they are, undisturbed\.
	matchre RETURN /You manage to collect|The room is too cluttered to find anything here!|You find something dead and lifeless, is this what you were looking for?|Searching and searching, you fail to find anything./
	match COLLECTR You cannot collect anything while in combat!
	matchre RETURN You forage around|You wander around and|You begin to forage/
	matchre RETURN You are sure you knew what you were looking for|You are certain you could find what you were looking for/|As you rummage around|You are certain you could find
	match BADCOLLECT You survey the area and realize that any collecting efforts would be futile.
	match FULLHANDS You really need to have at least one hand free to properly collect something.
	put collect %collectitem practice
	matchwait 5
	var timeoutsub COLLECT
  var timeoutcommand collect %collectitem
	goto TIMEOUT

FULLHANDS:
  gosub STOWALL
  goto COLLECT

BADCOLLECT:
  var collect NO
  return

COLLECTR:
  gosub RETREAT
  goto COLLECT
  
KICKP:
	pause
KICK:
  if $standing != 1 then gosub STAND
  #if matchre ("$roomobjs", "a pile of rocks") then var kickitem rock
  #if matchre ("$roomobjs", "a pile of dust bunnies") then var kickitem bunnies
  matchre KICKP %waitstring
  match KICK You take a step back
  matchre KICKS You can't do that from your position.|You can't quite manage
  matchre RETURN I could not find|Now what did the|You lean back and kick your feet|Now THAT would be a trick!
  put kick pile
  matchwait 5
  var timeoutsub KICK
  var timeoutcommand kick pile
  goto TIMEOUT

KICKS:
  gosub STAND
  goto KICK
  
###HUNTING###
HUNTP:
	pause
HUNT:
  match NOHUNT You find yourself unable to hunt in this area.
	match RETURN Roundtime:
	matchre HUNTP %waitstring
	put hunt
  matchwait 5
  var timeoutsub HUNT
  var timeoutcommand hunt
  goto TIMEOUT

NOHUNT:
  var %hunt NO
  return

JUSTICECHECKP:
  pause
JUSTICECHECK:
  matchre JUSTICECHECKP %waitstring
  matchre RETURN You're fairly certain this area is lawless and unsafe.|After assessing the area, you think local law enforcement keeps an eye on what's going on here.|After assessing the area, you believe there is some kind of unusual law enforcement in this area.
  put justice
  matchwait 5
  var timeoutsub JUSTICECHECK
  var timeoutcommand justice
  goto TIMEOUT

###MUSIC###
ASSESSINSTRUMENTP:
  pause
ASSESSINSTRUMENT:
  matchre ASSESSINSTRUMENTP %waitstring
  match RETURN Roundtime:
  match ASSESSINSTWOUNDED You are in no condition to properly assess your ability to work on your
  matchre RETURN You cannot assess the .* properly while in combat\!
  put assess my %instrument
  matchwait 5
  var timeoutsub ASSESSINSTRUMENT
  var timeoutcommand assess my %instrument
  goto TIMEOUT

ASSESSINSTRWOUNDED:
  var goupkeep 1
  return

PLAYP:
  pause
PLAY:
  matchre PLAYP %waitstring
  matchre PLAYSUCCESS You're already playing a song!|You begin a|You effortlessly begin|You fumble slightly|You struggle to begin|You begin some
  match PLAYUNHIDE That would give away your hiding place!
  put play %songtype on %instrument
  matchwait 5
  var timeoutsub PLAY
  var timeoutcommand play %songtype on %instrument
  goto TIMEOUT

PLAYUNHIDE:
  gosub UNHIDE
  gosub RELINVIS
  goto PLAY

PLAYSUCCESS:
  var playing 1
  return

PLAYSTOPP:
  pause
PLAYSTOP:
  var playing 0
  var humming 0
  matchre PLAYSTOPP %waitstring
  matchre RETURN You stop playing your song.|In the name of love?|But you're not performing anything\!
  put stop play
  matchwait 5
  var timeoutsub PLAYSTOP
  var timeoutcommand stop play
  goto TIMEOUT

HUMP:
  pause
HUM:
  matchre HUMP %waitstring
  matchre HUMSUCCESS You're already humming a song!|You begin a|You effortlessly begin|You fumble slightly|You struggle to begin
  put hum %humsong
  matchwait 5
  var timeoutsub HUM
  var timeoutcommand hum %humsong
  goto TIMEOUT

HUMSUCCESS:
  var playing 1
  var humming 1
  return

INSTMAINTAIN:
  if matchre ("$lefthand", "%instrument") then gosub SWAP
  if matchre ("$righthand", "%instrument") then
  else
  {
    gosub GETITEM %instrument
  }
  if matchre ("$lefthand", "%instrument") then gosub SWAP
  if ("$lefthand" != "Empty") then
  {
    gosub STOW left
  }
  gosub GETITEM %instcleancloth
  gosub INSTDRY
  gosub INSTCLEAN
  gosub STOWITEM %instcleancloth
  return

INSTCLEANP:
  pause
INSTCLEAN:
  matchre INSTCLEANP %waitstring
  matchre RETURN Roundtime|(is|are) not in need of cleaning.
  matchre INSTCLEANGET You must be holding
  matchre INSTDRY Maybe you should dry (it|them) off before attempting to clean (it|them).
  put clean %instrument with %instcleancloth
  matchwait 5
  var timeoutsub INSTCLEAN
  var timeoutcommand clean %instrument with %instcleancloth
  goto TIMEOUT
  
INSTCLEANGET:
  gosub STOW right
  gosub GETITEM %instrument
  goto INSTCLEAN
  
INSTDRYP:
  pause
INSTDRY:
  matchre INSTDRYP %waitstring
  matchre RETURN is not in need of drying.
  match INSTDRYNONE You must be holding
  matchre INSTWRING Your cloth absorbs the water without too much trouble, but remains very wet afterwards.|Using your cloth, you expertly drain|You stare at your
  match RETURN You're a bit too injured to be attempting something like that.
  put wipe my %instrument with %instcleancloth
  matchwait 5
  var timeoutsub INSTDRY
  var timeoutcommand wipe my %instrument with %instcleancloth
  goto TIMEOUT

INSTDRYNONE:
  gosub GETITEM %instrument
  goto INSTDRY

INSTWRINGP:
  pause
INSTWRING:
  matchre INSTWRINGP %waitstring
  matchre INSTCLEAN squeezing out the last bit of water.
  matchre INSTWRING water dribbling down your hands to splash at your feet.|water pouring out to splash at your feet.
  put wring my %instcleancloth
  matchwait 5
  var timeoutsub INSTWRING
  var timeoutcommand wring my %instcleancloth
  goto TIMEOUT 


STUDYART:
  var artstring $0
  goto STUDYARTMAIN
STUDYARTP:
  pause
STUDYARTMAIN:
  matchre STUDYARTP %waitstring
  match RETURN Roundtime:
  put study %artstring
  matchwait 5
  var timeoutsub STUDYARTMAIN
  var timeoutcommand wipe my %instrument with %instcleancloth
  goto TIMEOUT

GETARTLIST:
  if ($roomid = 534) then var artlist sculpture|painting|carving|statue|second painting
  if ($roomid = 535) then var artlist painting|triptych|statue|figurine|second painting
  if ($roomid = 536) then var artlist cylinder|sculpture|statue|painting|second painting
  if ($roomid = 537) then var artlist sphere|panel|painting|canvas|statue
  if ($roomid = 538) then var artlist painting|second painting|diorama|figure|statue
  return

ARTMOVELOOP:
  if (%artroomscounter > %artroomslen) then return
  gosub MOVE %artrooms(%artroomscounter)
  gosub STUDYLOOP
  if $Scholarship.LearningRate > 33 then var scholarlock 1
  if $Scholarship.LearningRate < 21 then var scholarlock 0
  if $Scholarship.Ranks >= 1750 then var scholarlock 1
  if %scholarlock = 1 then return
  math artroomscounter add 1
  goto ARTMOVELOOP

STUDYLOOP:
  gosub GETARTLIST
  eval artlistlen count("%artlist", "|")
  var studyloopcounter 0
STUDYLOOPMAIN:
  if (%studyloopcounter > %artlistlen) then return
  gosub STUDYART %artlist(%studyloopcounter)
  if $Scholarship.LearningRate > 33 then var scholarlock 1
  if $Scholarship.LearningRate < 21 then var scholarlock 0
  if $Scholarship.Ranks >= 1750 then var scholarlock 1
  if %scholarlock = 1 then return
  math studyloopcounter add 1
  goto STUDYLOOPMAIN



AWAKEP:
  pause
AWAKE:
  matchre AWAKEP %waitstring
  matchre RETURN You awaken from your reverie and begin to take in the world around you|But you are not sleeping!
  put awake
  matchwait 5
  var timeoutsub AWAKE
  var timeoutcommand awake
  goto TIMEOUT

DEEPSLEEPP:
  pause
DEEPSLEEP:
  matchre DEEPSLEEPP %waitstring
  matchre DEEPSLEEP You relax and allow your mind to enter a state of rest.|You stir yourself from the depths of relaxation and prepare for another night.|You stir yourself from the depths of relaxation and prepare for another day.
  matchre RETURN You draw deeper into rest, trying to destress from a hard (day's|night's) adventuring.
  put sleep
  matchwait 5
  var timeoutsub DEEPSLEEP
  var timeoutcommand sleep
  goto TIMEOUT

RPATOGGLEP:
  pause
RPATOGGLE:
  matchre RPATOGGLEP %waitstring
  matchre RPAPAUSE You pause your roleplaying award.
  matchre RPAACTIVE You unpause your
  matchre RPATIMER You need to wait a few minutes before doing that again.
  matchre RPABAD But you don't have an active roleplaying award to pause!
  put rpa toggle
  matchwait 5
  var timeoutsub RPATOGGLE
  var timeoutcommand rpa toggle
  goto TIMEOUT

RPATIMER:
  return

RPAACTIVE:
  var rpastatus 1
  return

RPAPAUSE:
  var rpastatus 0
  return

RPABAD:
  var rpastatus -1
  return

STUDYALMANACP:
	pause
STUDYALMANAC:
  matchre STUDYALMANACP %waitstring
  matchre ALMANACRETURN Roundtime:
  matchre BADALMANAC You've gleaned all the insight you can from
  match RETURN Study what?
  matchre RETURN But you aren't holding .*
  put study my %almanacitem
  matchwait 5
  var timeoutsub STUDYALMANAC
  var timeoutcommand study my %almanacitem
  goto TIMEOUT
  
ALMANACRETURN:
  var nextalmanac %t
  math nextalmanac add 610
  return

BADALMANAC:
  var nextalmanac %t
  math nextalmanac add 120
  return   

STUDYTOMEP:
  pause
STUDYTOME:
  var tomeofloreready 0
  matchre STUDYTOMEP %waitstring
  match RETURN You immerse yourself in the wisdom of your
  match RETURN However, you find that you lack the concentration to focus on your studies.
  match STUDYTOMEGET You need to be holding that first.
  put study my %tomeofloreitem
  matchwait 5
  var timeoutsub STUDYTOME
  var timeoutcommand study my %tomeofloreitem
  goto TIMEOUT

STUDYTOMEGET:
  gosub GETITEM %tomeofloreitem
  goto STUDYTOME

WRITEJOURNALP:
  pause
WRITEJOURNAL:
  matchre WRITEJOURNALP %waitstring
  matchre WRITEJOURNALGOOD Flipping to a blank page, you pluck the|As you open your
  matchre WRITEJOURNALBAD Having recently written in
  put write %ejournalitem
  matchwait 5
  var timeoutsub WRITEJOURNAL
  var timeoutcommand write %ejournalitem
  goto TIMEOUT

WRITEJOURNALGOOD:
  var ejournalused 1
  return

WRITEJOURNALBAD:
  var ejournalused 0
  return

TARANTULATURNP:
  pause
TARANTULATURN:
  var turngood 0
  matchre TARANTULATURNP %waitstring
  match TTURNGOOD With a *click*, your changes snap into place. 
  match RETURN However, your changes fail to lock into place.
  match TARANTULATURNBAD What skill did you want to attune
  put turn %tarantulaitem to %tarantulaskill%tskill
  matchwait 5
  var timeoutsub TARANTULATURN
  var timeoutcommand turn %tarantulaitem to %tarantulaskill%tskill
  goto TIMEOUT

TTURNGOOD:
  var turngood 1
  return

TARANTULATURNBAD:
  put #echo %alertwindow Could not turn tarantula to the %tarantulaskill%tskill.  Please investigate.  Turning off tarantula use.
  var tarantula NO
  return

TARANTULARUBP:
  pause
TARANTULARUB:
  matchre TARANTULARUBP %waitstring
  match TRUBGOOD It is mere moments afterward that you feel an itching, tingling, and crawling sensation all across the inside of your skull.
  matchre RETURN You try, but the|But you currently aren't learning any
  put rub %tarantulaitem
  matchwait 5
  var timeoutsub TARANTULARUB
  var timeoutcommand rub %tarantulaitem
  goto TIMEOUT
  
TRUBGOOD:
  #put #echo %alertwindow Used tarantula on %tarantulaskill%tskill.
  return
  
STUDYP:
	pause
STUDY:
  match TURN Why do you need to study this chart again?
  match RETURN Roundtime:
  match RETURN You need to be holding your compendium to study it.
  matchre STUDYP %waitstring
  put study my compendium
  matchwait 5
  var timeoutsub STUDY
  var timeoutcommand study my compendium
  goto TIMEOUT

STUDYTEXTP:
	pause
STUDYTEXT:
  matchre TEXTNEXT In a sudden moment of clarity, the information
  matchre TEXTNEXTBAD Why do you need to study this chart again?
  matchre RETURN /Roundtime: \d+/
  matchre STUDYTEXTP %waitstring
  put study my %textbookitem
  matchwait 5
  var timeoutsub STUDYTEXT
  var timeoutcommand study my %textbookitem
  goto TIMEOUT
  
TEXTNEXTBAD:
  var textlist%textpositionnext %t
  math textlist%textpositionnext add 1200
  var textagain 1
  var nexttext 0
  return
  
TEXTNEXT:
  var textlist%textpositionnext %t
  math textlist%textpositionnext add 1200
  #echo Page is done!  textlist%textpositionnext: %textlist%textpositionnext
  return

TURNTEXTP:
  pause
TURNTEXT:
  matchre TURNTEXTP %waitstring
  matchre RETURN You turn to the section on
  matchre BADTEXT That section does not exist within your
  match TURNTEXTGET You need to be holding your
  put turn my %textbookitem to %textmonster
  matchwait 5
  var timeoutsub TURNTEXT
  var timeoutcommand turn my %textbookitem to %textmonster
  goto TIMEOUT

BADTEXT:
  var badtextturn 1
  return

TURNTEXTGET:
  gosub GETITEM %textbookitem
  goto TURNTEXT

TEACHP:
  pause
TEACH:
  eval tempteach tolower("$roomplayers")
  eval teachtarget tolower("%teachtarget")
  if !matchre ("%tempteach", "%teachtarget") then return
  matchre TEACHP %waitstring
  matchre RETURN You begin to lecture|I don't understand which skill you wish to teach.|is already listening to you|I don't understand which skill you wish to teach.|You have already offered|I could not find who you were referring to.|That person is too busy teaching their own students to listen to your lesson.
  match TEACHBAD You cannot listen to a teacher and teach at the same time!
  put teach %teachskill to %teachtarget 
  matchwait 5
  var timeoutsub TEACH
  var timeoutcommand teach %teachskill to %teachtarget
  goto TIMEOUT

TEACHBAD:
  gosub TEACHASSESS
  return

TEACHSTOPP:
  pause
TEACHSTOP:
  matchre TEACHSTOPP %waitstring
  matchre RETURN But you aren't teaching anyone.|You stop teaching.
  put stop teach
  matchwait 5
  var timeoutsub TEACHSTOP
  var timeoutcommand stop teach
  goto TIMEOUT

TEACHASSESSP:
  pause
TEACHASSESS:
  matchre TEACHASSESSP %waitstring
  matchre RETURN Roundtime: 
  put assess teach
  matchwait 5
  var timeoutsub TEACHASSESS
  var timeoutcommand assess teach
  goto TIMEOUT


TURNP:
  pause
TURN:
  math turncount add 1
  if %turncount = 1 then
  {
    put turn compendium
    match STUDY You turn to the section
    matchre TURNP %waitstring
    matchwait 5
    var timeoutsub TURN
    var timeoutcommand turn compendium
    goto TIMEOUT
  }
  else
  {
    math nextstudy add 1200
    gosub STOW left
    return
  }
  
PICKBOXP:
  pause
PICKBOX:
  matchre PICKBOXP %waitstring
  matchre LOCKBOX You set about picking your training box.  With a faint \*CLICK\* it opens.|But the training box isn't locked!|It's not even locked, why bother?
  matchre RETURN You set about picking the training box, but it quickly becomes apparent you are not making any progress.|Pick what?|But you aren't holding
  matchre BADLOCK The lock feels warm, as if worked too often recently, so you stop your attempt to pick it.
  put pick my %locksmithboxitem
  matchwait 5
  var timeoutsub PICKBOX  
  var timeoutcommand pick my %locksmithboxitem
  goto TIMEOUT

BADLOCK:
  var picksleft 0
  return

LOCKBOXP:
  pause
LOCKBOX:
  matchre LOCKBOXP %waitstring
  matchre RETURN You quickly lock the training box and pocket the key.|The training box is already locked.
  put lock my %locksmithboxitem
  matchwait 5
  var timeoutsub LOCKBOX
  var timeoutcommand lock my %locksmithboxitem
  goto TIMEOUT

SKINTRAINERP:
  pause
SKINTRAINER:
  matchre SKINTRAINERP %waitstring
  matchre REPAIRSKINTRAINER You skillfully peel back the leather from the frame underneath\.|A .* has already been sliced open\.  Maybe you should REPAIR it\.
  matchre BADSKINTRAIN The leather looks frayed, as if worked too often recently, so you stop your attempt to skin it\.
  matchre RETURN You must be holding .* to skin it\.
  put skin %skinfatraineritem
  matchwait 5
  var timeoutsub SKINTRAINER
  var timeoutcommand skin %skinfatraineritem
  goto TIMEOUT

BADSKINTRAIN:
  var skinsleft 0
  return

REPAIRSKINTRAINERP:
  pause
REPAIRSKINTRAINER:
  matchre REPAIRSKINTRAINERP %waitstring
  matchre RETURN With some needle and thread, you quickly stitch .* back together\.|A .* isn't in need of repair\.
  put repair my %skinfatraineritem
  matchwait 5
  var timeoutsub REPAIRSKINTRAINER
  var timeoutcommand repair my %skinfatraineritem
  goto TIMEOUT

  
WINDCHECKP:
  return
WINDCHECK:
  matchre WINDCHECKP %waitstring
  matchre YESWIND You're already riding on something.
  matchre NOWIND You need to be holding the|You cannot really do anything on
  put mount windboard
  matchwait 5
  var timeoutsub WINDCHECK
  var timeoutcommand mount windboard
  goto TIMEOUT

YESWIND:
  var windmounted 1
  return
  
NOWIND:
  var windmounted 0
  return

WINDCHARGEP:
  pause
WINDCHARGE:
  matchre WINDCFULL The windboard is already fully charged, so there's no need to charge it more.
  matchre WINDCHARGEP %waitstring
  matchre RETURN You strain, but lack the mental stamina to charge the windboard this much.
  match WINDCSUCC Roundtime:
  put charge windboard 50
  matchwait 5
  var timeoutsub WINDCHARGE
  var timeoutcommand charge windboard 50
	goto TIMEOUT

WINDCFULL:
  var windboardcharge 50
  put #var windboardcharge %windboardcharge
  return

WINDCSUCC:
  math windboardcharge add 10
  if %windboardcharge > 49 then var windboardcharge 50
  put #var windboardcharge %windboardcharge
  if %windboardcharge = 50 then return
  else goto WINDCHARGE

WINDMOUNTP:
  pause
WINDMOUNT:
  math windboardcharge subtract 1
  put #var windboardcharge %windboardcharge
  matchre WINDMOUNTP %waitstring
  match WINDMRET You cannot really do anything on your windboard while in combat.
  match RETURN You put your
  put mount windboard
  matchwait 5
  var timeoutsub WINDMOUNT
  var timeoutcommand mount windboard
	goto TIMEOUT

WINDMRET:
  gosub RETREAT
  goto WINDMOUNT

WINDDISMOUNTP:
  pause
WINDDISMOUNT:
  matchre WINDDISMOUNTP %waitstring
  matchre RETURN You step off your|You're not riding around on
  put dismount windboard
  matchwait 5
  var timeoutsub WINDDISMOUNT
  var timeoutcommand dismount windboard
	goto TIMEOUT
  
WINDTRICKP:
  pause
WINDTRICK:  
  matchre WINDTRICKP %waitstring
  match RETURN Roundtime:
  match WINDTRET You cannot really do anything on your windboard while in combat.
  put %windboardtrick windboard
  matchwait 5
  var timeoutsub WINDTRICK
  var timeoutcommand %windboardtrick windboard
	goto TIMEOUT

WINDTRET:
  gosub RETREAT
  goto WINDTRICK
  
APPRAISE:
  var appraisestring $0
  goto APPRAISEMAIN
APPRAISEP:
  pause
APPRAISEMAIN:
  matchre APPRAISEP %waitstring
  match APPRET You cannot appraise that when you are in combat!
  matchre RETURN Roundtime:|Appraise what\?|You need to be either holding it or wearing it\.|You try to sneak out of combat
  match RETURN Appraise what?  Type APPRAISE HELP for more information.
  put appraise %appraisestring
  matchwait 5
  var timeoutsub APPRAISE
  var timeoutcommand appraise %appraisestring
	goto TIMEOUT
  
APPRET:
  gosub RETREAT
  goto APPRAISE
  
APPRAISECREATUREP:
  pause
APPRAISECREATURE:
  gosub MONSTERARRAY
  eval monsterarray element("%monsterarray", 0)
  eval monsterarray replace("%monsterarray", " ", "|")
  eval arraylen count("%monsterarray", "|")
  eval appraisemon element("%monsterarray", %arraylen)
  #echo AppraiseMon: %appraisemon
  #echo ArrayLen: %arraylen
  if %arraylen = 0 then
  {  
    var nextrecall %t
    return
  }
  matchre APPRAISECREATUREP %waitstring
  matchre RETURN Roundtime:|You cannot appraise that when you are in combat!|You don't see anything of interest in that direction\.
  match RETURN Appraise what?  Type APPRAISE HELP for more information.
  matchre RETURN The /* appears to be in good condition\.
  match RETURN Perhaps that's not such a wise thing to do.
  match RETURN I could not find what you were referring to.
  match RETURN It's hard to appraise the
  match RETURN You can't determine anything about this creature.
  put appraise %appraisemon quick
  matchwait 5
  var timeoutsub APPRAISECREATURE
  var timeoutcommand appraise %appraisemon quick
	goto TIMEOUT
 
RECALLP:
  pause
RECALL:
  gosub MONSTERARRAY
  eval monsterarray element("%monsterarray", 0)
  eval monsterarray replace("%monsterarray", " ", "|")
  eval arraylen count("%monsterarray", "|")
  eval recallmon element("%monsterarray", %arraylen)
  if %arraylen = 0 then
  {  
    var nextrecall %t
    return
  }
  matchre RECALLP %waitstring
  matchre RETURN Roundtime:|You are far too occupied by present matters|You search your mind
  put recall %recallmon
  matchwait 5
  var timeoutsub RECALL
  var timeoutcommand recall %recallmon
	goto TIMEOUT
  
MONSTERARRAY:
  var monsterarray $monsterlist
  eval monsterarray replace("%monsterarray", ", ", "|")
  eval monsterarray replacere("%monsterarray", " that appears stunned", "")
  eval monsterarray replacere("%monsterarray", " that appears to be sleeping", "")
  eval monsterarray replacere("%monsterarray", " that is sleeping", "")
  eval monsterarray replacere("%monsterarray", " that is surrounded by a shimmering shield", "")
  eval monsterarray replacere("%monsterarray", " that is flying around", "")
  eval monsterarray replacere("%monsterarray", " that appears immobilized", "")
  eval monsterarray replacere("%monsterarray", " that is trying to remain hidden", "")
  eval monsterarray replacere("%monsterarray", " that is webbed", "")
  eval monsterarray replacere("%monsterarray", " that is lying down", "")
  eval monsterarray replacere("%monsterarray", " that is sitting", "")
  eval monsterarray replacere("%monsterarray", " that is caught in a cage of swirling darkness", "")
  return
  
###BRAIDING###
FORAGEP:
	pause
FORAGE:
	matchre FORAGEP %waitstring
	match RETURN You manage to find
	match FORAGEFULL You really need to have at least one hand free to forage properly.
	match FORAGEDUMP The room is too cluttered to find anything here!
	match FORAGE Roundtime:
	put forage %forageitem
	matchwait

FORAGEFULL:
  if matchre ("$righthand", "%braidtarget") then
  else
  {
    gosub STOW right
  }
  if matchre ("$lefthand", "%braidtarget") then
  else
  {
    gosub STOW left
  }
  goto FORAGE
  
FORAGEDUMP:
  gosub DUMPJUNK
  pause 20
  goto FORAGE
  
  
DUMPJUNKP:
  pause
DUMPJUNK:
  matchre DUMPJUNKP %waistring
  match RETURN You should just kick yourself in the shin.  There is no junk here.
  match RETURN [You have marked this room to be cleaned by the janitor.  It should arrive shortly.]
  match RETURN The janitor was recently summoned to this room.
  put dump junk
  matchwait
  
BRAID:
  if matchre ("$righthand", "%braidobjects") then gosub BRAIDING
  else
  { 
    if matchre ("$lefthand", "%braidobjects") then
    {
      gosub BRAIDING
    }
    else
    { 
      var forageitem %braidtarget
      gosub FORAGE
      goto BRAID
    }
  }
  return

BRAIDINGP:
	pause
BRAIDING:
	matchre BRAIDINGP %waitstring
	matchre BRAIDFORAGE You need to have more material|You need to be holding that first.|Braid what?
	match BRAIDPULL mistake
	match BRAIDDUMP wasted effort.
	match RETURN Roundtime:
	matchre BRAIDSTOW You need both hands to do that.
	put braid my %braidtarget
	matchwait

BRAIDSTOW:
  if matchre ("$righthand", "%braidtarget") then
  else
  {
    gosub STOW right
  }
  if matchre ("$lefthand", "%braidtarget") then
  else
  {
    gosub STOW left
  }
  goto BRAIDING
  
  
BRAIDDUMP:
  gosub DUMPITEM %braidtarget
  return

BRAIDDUMP2:
  gosub DUMPITEM $righthandnoun
  return

BRAIDFORAGE:
  var forageitem %braidtarget
  gosub FORAGE
  goto BRAIDING
 
BRAIDPULLP:
	pause
BRAIDPULL:
	matchre BRAIDPULLP %waitstring
	matchre BRAIDDUMP2 /rope|testing it thoroughly./
	put pull my %braidtarget
	matchwait

CLIMBPRACTICEP:
  pause
CLIMBPRACTICE:
  matchre CLIMBPRACTICEP %waitstring
  matchre CLIMBNOPLAY Tossing one end of the rope over your shoulder, you mime a convincing climb while pulling the rope hand over hand.
  matchre RETURN The rope's will quickly fades away|You finish practicing your climbing skill|Your focus diverts away from the rope
  matchre CLIMBTOOHARD This climb is too difficult, so you stop practicing\.|This climb is no challenge at all
  matchre CLIMBSTAND You should probably be standing to attempt this.
  if %climbingrope = "YES" then put climb %climbobject
  else put climb practice %climbobject
  matchwait

CLIMBTOOHARD:
  var climbing NO
  return

CLIMBSTAND:
  gosub STAND
  goto CLIMBPRACTICE

CLIMBNOPLAY:
  var playing 0
  var humming 0
  return

BADCLIMB:
  var climbing NO
  goto PERFORMLOOP

	
#CLERICSTUFF

COMMSENSEP:
  pause
COMMSENSE:
  var mercomup 0
  var tamcomup
  var tamsinegood 1
  var meraudgood 1
  var elunedgood 1
  matchre COMMSENSEP %waitstring
  match RETURN Roundtime: 
  put commune sense
  matchwait

COMMUNEP:
  pause
COMMUNE:
  matchre COMMUNEP %waitstring
  match COMMUNEBAD You stop as you realize that you have attempted a commune too recently in the past.
  matchre RETURN Roundtime|You grind some dirt in your fist|You feel warmth spread throughout your body|As you commune you sense that the ground is already consecrated\.
  put commune %commune
  matchwait
  
COMMUNEBAD:
  var communegood 0
  return

UNROLLMATP:
  pause
UNROLLMAT:
  matchre UNROLLMATP %waitstring
  matchre RETURN You reverently lay|You need to be holding that first!
  put unroll %prayermatitem
  matchwait

ROLLMATP:
  pause
ROLLMAT:
  matchre ROLLMATP %waitstring
  matchre RETURN You carefully gather up|It is already rolled up!
  put roll mat
  matchwait

KNEELLMATP:
  pause
KNEELMAT:
  matchre KNEELMATP %waitstring
  matchre RETURN You humbly kneel
  put kneel mat
  matchwait

KISSMATP:
  pause
KISSMAT:
  matchre KISSMATP %waitstring
  matchre RETURN You bend forward to kiss|You get a sense that you have
  put kiss mat
  matchwait

POURWINEP:
  pause
POURWINE:
  matchre POURWINEP %waitstring
  matchre RETURN You quietly pour some 
  put pour wine on mat
  matchwait

DIRTRUMMAGEP:
  pause
DIRTRUMMAGE:
  var dirtfull 0
  matchre DIRTRUMMAGEP %waitstring
  matchre RETURN determining it has a little dirt in it\.|determining that it is over a quarter full\.|determining that it is over half full\.| determining that it is over three quarters full\.|determining that it is almost full of dirt\!
  match RUMMAGEDIRTGOOD determining that it is full of dirt!
  put rummage %dirtstackeritem
  matchwait

RUMMAGEDIRTGOOD:
  var dirtfull 1
  return

DIRTPUSHP:
  pause
DIRTPUSH:
  matchre DIRTPUSHP %waitstring
  matchre RETURN You push the release catch on your
  put push %dirtstackeritem
  matchwait

DRAGONLIGHTP:
  pause
DRAGONLIGHT:
  matchre DRAGONLIGHTP %waitstring
  matchre RETURN You quickly flick
  put point %lighteritem at incense
  matchwait

WAVEINCP:
  pause
WAVEINC:
  matchre WAVEINCP %waitstring
  matchre RETURN I do not understand what you mean.|You wave your|You wave some
  put wave incense at %wavetarget
  matchwait
  
SPRINKLEP:
  pause
SPRINKLE:
  var goodsprinkle 1
  matchre SPRINKLEP %waitstring
  matchre RETURN I do not understand what you mean.|You sprinkle
  match SPRINKLEBAD Sprinkle that?  I don't think so.
  match RETURN USAGE: SPRINKLE (item) on (person|creature|item|ROOM)
  put sprinkle %sprinkleitem on %sprinkletarget
  matchwait

SPRINKLEBAD:
  var goodsprinkle 0
  return

SNUFFINCP:
  pause
SNUFFINC:
  matchre SNUFFINCP %waitstring
  matchre RETURN I do not understand what you mean.|You snuff out|What were you referring to?|But that isn't
  put snuff incense
  matchwait

DANCEP:
  pause
DANCE:
  matchre DANCEP %waitstring
  matchre DANCE Conclusion, but|You begin to dance,|Your actions grow in intensity|but you falter, destroying
  matchre RETURN Your dance reaches its conclusion|In your condition?|USAGE: DANCE
  #|You feel that your gods have smiled
  put dance %dancetarget
  matchwait

RECITE:
  put recite %recitation
  return

PRAYBADGEP:
  pause
PRAYBADGE:
  matchre PRAYBADGEP %waitstring
  match RETURN Roundtime:
  put pray %pilgrimbadgeitem
  matchwait

PRAYGODP:
  pause
PRAYGOD:
  matchre PRAYGODP %waitstring
  matchre RETURN You glance heavenward|You throw your head back and howl|Praying for|You raise your hands lightly|Bristling up against a sudden sense of evil|You slowly square your shoulders|You tap the center of your forehead|You whisper your prayer into the wind|With a pat you double-check|Quietly touching your lip|You mutter a prayer to|You grumble ominously|Aligning your thoughts with the song of the inner earth
  put pray %praydeity
  matchwait

LOOKPINP:
  pause
LOOKPIN:
  matchre LOOKPINP %waitstring
  matchre GOODPIN A thin layer of dust|Traces of the anloral's|The characteristic soft blue hue|Unsightly fingers of dirt have conquered
  match RETURN It is clean,
  put look my %anloralpinitem
  matchwait

GOODPIN:
  var pindirty 1
  return
  
CLEANPINP:
  pause
CLEANPIN:
  matchre LOOKPINP %waitstring
  matchre RETURN You pour some holy water from|The immaculate anloral
  match CLEANPINNOWATER Clean it with what?
  #That doesn't appear to be something you can clean.
  match CLEANPINNOBLESS You should not use mundane water to clean a sacred object.
  put clean %anloralpinitem with my water in %watercontainer
  matchwait

CLEANPINNOWATER:
  if %elunedcommune = "YES" then 
  {
    if %elunedgood = 1 then
    {
      gosub COMMUNEELUNED
      gosub STOWALL
      gosub GETITEM %anloralpinitem
      gosub GETITEM %watercontainer
      goto CLEANPIN
    }
    else var nextpin %t
    math nextpin add 180
  }
  else
  {
    put #echo %alertwindow Yellow Water container is out of holy water you don't know the Eluned commune.  Turning off anloral pin.
    put #flash
    put #play JustArrived
    var anloralpin NO
  }
  return

STAYIN:
  put look
  pause 20
  return
  
CLEANPINNOBLESS:
  if $guild = "Cleric" then gosub BLESSCAST
  goto CLEANPIN


TARGETSELECT:
  put look
  pause 1
  var shockcritter 1
  var specialmanipuse 0
  if ($SpellTimer.Absolution.active != 1) then var noshockcritters %normnoshockcritters
  else var noshockcritters %absnoshockcritters
  gosub MONSTERARRAY
  if matchre("%monsterarray", "%noshockcritters") then
  {
    eval tslength count("%monsterarray", "|")
    var tsloop 0
    var critternum 1
    var targetlist %noshockcritters
    var faceadj first
    var goodtarget 0 
    gosub TARGETSELECTLOOP
    #put #echo Yellow goodtarget: %goodtarget
    if (%goodtarget = 1) then
    {
      #echo MonsterArray: %monsterarray 
      #echo Element: %tsloop
      if %facebrawlfail = 1 then var faceadj next
      else var faceadj first
      var currentcritter %montest
      var shockcritter 0
      if matchre("%monsterarray", "%specialmanipulate") then var specialmanipuse 1
      gosub FACETARGET %faceadj %montest
      gosub TACTICSRESET
    }
  }
  else
  {
    if %justmanipulated = 1 then
    {
      if %manipcount < 1 then
      {
        var goodtarget 0
        var currentcritter 0
        var shockcritter 1
        return
      }
      if %mlcounter <= %malength then math mlcounter add 1
      eval facemon element("%monsterarray", %mlcounter)
      eval facemon replace("%facemon", " ", "|")
      eval arraylen count("%facemon", "|")
      eval facemon element("%facemon", %arraylen)
      var facenum 0
      if %facemon = %mon1 then math facenum add 1
      if %manipcount > 1 then
      {
        if %facemon = %mon2 then math facenum add 1
      }
      if %facenum = 0 then var faceadj first
      if %facenum = 1 then var faceadj second
      if %facenum = 2 then var faceadj third
      var goodtarget 1
      var justmanipulated 0
      var shockcritter 1
      var currentcritter %facemon
      gosub FACETARGET %faceadj %facemon

    }
    else
    {
      var targetlist %critters 
      var goodtarget 0
      gosub TARGETSELECTLOOP
      if %goodtarget = 1 then
      {
        gosub FACETARGET first %montest
        var currentcritter %montest
      }
      var shockcritter 1
    }
  }
  return
   
TARGETSELECTLOOP:
  if %tsloop > %tslength then return
  eval montest element("%monsterarray", %tsloop)
  if matchre ("%montest", "%targetlist") then
  {
    eval montest replace("%montest", " ", "|")
    eval arraylen count("%montest", "|")
    eval montest element("%montest", %arraylen)
    var goodtarget 1
    return
  }
  math tsloop add 1
  goto TARGETSELECTLOOP

Base.ListExtract:
  var Base.ListVar $1
  var Base.NounListVar $2
  var Base.ItemCountVar $3

  eval %Base.ListVar replace("%%Base.ListVar", ", ", "|")
  eval %Base.ListVar replacere("%%Base.ListVar", "( and )(?:a |an |some )(?!.*and (a |an |some ))","|")
  var %Base.ListVar |%%Base.ListVar
  eval %Base.ItemCountVar count("%%Base.ListVar", "|")
  var %Base.NounListVar %%Base.ListVar
Base.ListExtract.Loop.Trim:
  eval %Base.NounListVar replacere ("%%Base.NounListVar", "\|[\w'-]+ ", "|")
  if contains("%%Base.NounListVar", " ") then goto Base.ListExtract.Loop.Trim
	return

TAPADJECTIVE:
  var tap $0
  eval tap replace("%tap", " ", "|"
  eval taplength count("%tap","|")
  echo tap: %tap
  echo taplength: %taplength
  if (%taplength = 2) then var adjtap %tap(0) %tap(1)
  if (%taplength = 1) then var adjtap %tap(0)
  if (%taplength = 0) then var adjtap
  return

TAPNOUN:
  var tap $0
  eval tap replace("%tap", " ", "|"
  eval taplength count("%tap","|")
  #echo taplength: %taplength
  if %taplength > 0 then var nountap %tap(%taplength)
  else var nountap %tap(0)
  return

TAPSHORTEN:
  var tap $0
  eval tap replace("%tap", " ", "|"
  eval tap replacere("%tap", "\ba\b\|", ""
  eval tap replacere("%tap", "\ban\b\|", ""
  eval tap replacere("%tap", "\bsome\b\|", ""
  eval taplength count("%tap","|")
  #echo taplength: %taplength
  if %taplength > 0 then var shorttap %tap(0) %tap(%taplength)
  else var shorttap %tap(0)
  return
  
TAPSHORTENMAT:
  var tap $0
  eval tap replace("%tap", " ", "|"
  eval tap replacere("%tap", "\ba\b\|", ""
  eval tap replacere("%tap", "\ban\b\|", ""
  eval tap replacere("%tap", "\bsome\b\|", ""
  eval taplength count("%tap","|")
  #echo taplength: %taplength
  var matadj %taplength
  math matadj subtract 1
  if %taplength > 0 then var shorttap %tap(%matadj) %tap(%taplength)
  else var shorttap %tap(0)
  return

PREMIUMRINGGOP:
  pause
PREMIUMRINGGO:
  matchre PREMIUMRINGGOP %waitstring
  matchre PREMIUMRINGGOOD The world grows blurry and indistinct for a moment.  You look around and find yourself at...
  matchre PREMIUMRINGBAD cannot do that again yet.
  match PREMIUMRINGRETREAT You need to get out of combat, first!
  #[You may do that about an hour from now.]
  put push %premiumringitem
  matchwait

PREMIUMRINGRETREAT:
  gosub RETREAT
  goto PREMIUMRINGGO

PREMIUMRINGGOOD:
  var goodring 1
  return
  
PREMIUMRINGBAD:
  var goodring 0
  return

PREMIUMRINGBACK:
  var premringleaving $0
  goto PREMIUMRINGBACKMAIN
PREMIUMRINGBACKP:
  pause
PREMIUMRINGBACKMAIN:
  matchre PREMIUMRINGBACKP %waitstring
  matchre RETURN The world grows blurry and indistinct for a moment.  You look around and find yourself at...
  match RETURN You need to be in Fang Cove to do that!
  match RETURN The metal band pulses weakly, but nothing else happens.
  matchre PREMBADRETURN cannot do that again yet\.
  put pull %premiumringitem
  matchwait

PREMGOODRETURN:
  var goodring 1
  return

PREMBADRETURN:
  if ("%premringleaving" = "portal") then
  {
    var goodring 0
    return
  }
  put #echo %alertwindow Yellow [UPKEEP]: Unable to return yet due to premium ring timer.  Waiting and retrying.
  pause 60
  goto PREMIUMRINGBACK

# REPLACE input:
#               v-no quotes, yes %
#               v       v-no % (but probably should still be an existing variable, or else it is given a starting %) 
#               v       v          v- no %
# gosub REPLACE %INDEX "NEWVALUE" "ARRAYNAME"

REPLACE:
var arrayl $1|$2|$3
eval %arrayl(2) replacere("%%arrayl(2)","^(?<First>(?:[^|]*\|){%arrayl(0)})[^|]*(?<Last>\|.*)?","${First}%%arrayl(1)${Last}")
return 

LIBEND: